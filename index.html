<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
    <title>kå…”å½</title>
    <script src="https://unpkg.com/dexie/dist/dexie.js"></script>
    <style>
      /* --- åŸºç¡€å’Œå…¨å±€æ ·å¼ --- */
      :root {
        /* â–¼â–¼â–¼ ä¿®æ”¹è¿™ 3 è¡Œ â–¼â–¼â–¼ */
        --primary-bg: #ffffff; /* é»˜è®¤èƒŒæ™¯æ”¹ç™½è‰² */
        --primary-text: #000000; /* é»˜è®¤æ–‡å­—æ”¹é»‘è‰² */

        /* å»ºè®®ï¼šé»˜è®¤ç»„ä»¶é¢œè‰²è®¾ä¸ºé»‘è‰²å¸¦æä½é€æ˜åº¦ï¼Œè¿™æ ·åœ¨ç™½èƒŒæ™¯ä¸‹å°±æ˜¯æµ…ç°è‰²ï¼Œå¾ˆå¥½çœ‹ */
        --capsule-bg: rgba(0, 0, 0, 0.05);
        --text-color: #f0f0f0;
        ---text-secondary-color: var(--text-color);
        --accent-color: #00ffff;
        --blur-effect: blur(10px);
        /* â–¼â–¼â–¼ æ–°å¢è¿™ä¸€è¡Œ â–¼â–¼â–¼ */
        --app-font: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      }

      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }

      html,
      body {
        width: 100%;
        height: 100%;
        overflow: hidden;
        /* â–¼â–¼â–¼ ä¿®æ”¹è¿™ä¸€è¡Œï¼Œä½¿ç”¨å˜é‡ â–¼â–¼â–¼ */
        font-family: var(--app-font);
        background-color: var(--primary-bg);
        color: var(--text-color);
      }

      ::placeholder {
        color: var(--text-secondary-color);
        opacity: 0.7;
      }

      /* --- ä¸»å±å¹•å®¹å™¨ --- */
      .phone-screen {
        width: 100vw;
        height: 100vh;
        padding: 25px 15px;
        display: flex;
        flex-direction: column;
        gap: 20px;
      }

      /* --- é€šç”¨èƒ¶å›Š/æ°”æ³¡æ ·å¼ --- */
      .glass-bubble {
        background-color: var(--capsule-bg);
        backdrop-filter: var(--blur-effect);
        -webkit-backdrop-filter: var(--blur-effect);
        border: 1px solid rgba(255, 255, 255, 0.18);
      }

      /* --- é¡¶éƒ¨å°èƒ¶å›Š (çŠ¶æ€æ ) --- */
      .status-bar {
        width: fit-content;
        margin: 0 auto;
        padding: 5px 15px;
        border-radius: 50px;
        display: flex;
        align-items: center;
        font-size: 12px;
        gap: 10px;
      }
      .status-bar .separator {
        color: var(--text-secondary-color);
      }

      /* --- ç¬¬äºŒä¸ªå¤§èƒ¶å›Š (ä¸»ä¿¡æ¯æ ) --- */
      .main-info-bar {
        display: flex;
        align-items: center;
        border-radius: 50px;
        padding: 5px;
        height: 60px;
        flex-shrink: 0;
      }
      .main-info-bar .profile-dot {
        width: 50px;
        height: 50px;
        background-color: rgba(255, 255, 255, 0.2);
        border-radius: 50%;
        flex-shrink: 0;
      }
      .main-info-bar .input-area {
        flex-grow: 1;
        padding: 0 15px;
        display: flex;
        flex-direction: column;
        justify-content: center;
        gap: 4px;
        align-items: center; /* <<< æ–°å¢è¿™ä¸€è¡Œ */
      }
      .main-info-bar input[type='text'] {
        background: none;
        border: none;
        color: var(--text-color);
        font-size: 16px;
        width: 100%;
        outline: none;
        text-align: center; /* <<< æ–°å¢è¿™ä¸€è¡Œ */
      }

      .main-info-bar .date-capsule {
        background-color: var(--capsule-nested-bg);
        color: var(--text-secondary-color);
        opacity: 0.8; /* <-- æ–°å¢ */
        font-size: 10px;
        padding: 2px 8px;
        border-radius: 20px;
        width: fit-content;
      }
      .main-info-bar .lock-widget {
        position: relative;
        width: 50px;
        height: 50px;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
      }
      .main-info-bar .heart-lock {
        width: 30px;
        height: 30px;
        fill: none;
        stroke: var(--text-secondary-color);
        stroke-width: 2;
      }
      .main-info-bar .temperature {
        position: absolute;
        font-size: 12px;
        font-weight: bold;
        color: var(--text-color);
      }

      /* --- ä¸­é—´å’Œåº•éƒ¨å†…å®¹åŒº --- */
      .content-section {
        display: flex;
        gap: 15px;
      }
      .main-info-bar + .content-section {
        margin-top: 35px;
      }
      .content-section + .content-section {
        margin-top: 40px;
      }
      .content-section .left-panel,
      .content-section .right-panel {
        width: 50%;
        display: flex;
        flex-direction: column;
        gap: 15px;
      }

      /* --- APP ç½‘æ ¼ä¸å›¾æ ‡ --- */
      .app-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        grid-template-rows: auto auto;
        gap: 15px;
      }
      .app-container {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 6px;
      }
      .app-icon img {
        width: 55px;
        height: 55px;
        border-radius: 22%;
        object-fit: cover;
        border: 1px solid rgba(255, 255, 255, 0.25);
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
      }
      /* æ‰¾åˆ° .app-name */
      .app-name {
        font-size: 11px;
        color: var(--text-secondary-color);
        opacity: 0.8; /* <-- æ–°å¢ */
      }

      /* --- å³ä¾§å¤´åƒå’Œè¾“å…¥åŒº --- */
      .profile-section {
        position: relative;
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 2;
      }
      .profile-avatar {
        width: 90px;
        height: 90px;
        border-radius: 50%;
        object-fit: cover;
        border: 3px solid var(--primary-bg);
      }

      /* --- èŒç³»å¯¹è¯æ°”æ³¡ --- */
      .chat-widget {
        position: absolute;
        top: -8px; /* ã€ä¿®æ”¹ã€‘å†å‘ä¸Šç§»åŠ¨ä¸€ç‚¹ */
        right: -10px;
        padding: 6px 10px;
        border-radius: 16px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        transition: transform 0.2s ease;
      }
      .chat-widget:hover {
        transform: scale(1.05);
      }
      .chat-widget::after {
        content: '';
        position: absolute;
        bottom: -5px;
        left: 25px;
        width: 0;
        height: 0;
        border: 8px solid transparent;
        border-top-color: var(--capsule-bg);
      }
      .chat-widget input {
        background: none;
        border: none;
        color: var(--text-color);
        width: 38px;
        font-size: 11px;
        outline: none;
        text-align: center;
      }

      /* --- å¤´åƒä¸‹æ–¹çš„è¾“å…¥æ°”æ³¡ --- */
      .thought-bubble {
        border-radius: 20px;
        padding: 15px;
        display: flex;
        flex-direction: column;
        gap: 10px;
        margin-top: -40px;
        padding-top: 50px;
        z-index: 1;
      }
      .thought-bubble textarea {
        background: none;
        border: none;
        color: var(--text-color);
        resize: none;
        height: 28px;
        font-size: 14px;
        outline: none;
      }
      .prompt-capsule {
        display: flex;
        align-items: center;
        background-color: var(--capsule-nested-bg);
        border-radius: 20px;
        padding: 5px 10px;
      }
      .prompt-capsule .magic-wand-svg {
        width: 16px;
        height: 16px;
        fill: var(--accent-color);
        flex-shrink: 0;
        margin-right: 8px;
      }
      .prompt-capsule input {
        background: none;
        border: none;
        color: var(--text-color);
        font-size: 12px;
        width: 100%;
        outline: none;
      }
      /* ================== æ‹ç«‹å¾— & èƒ¶å·ç»„ä»¶ (å›¾2 åŒæ¬¾æ¯”ä¾‹ç‰ˆ) ================== */
      
      /* 1. æœ€å¤–å±‚å®¹å™¨ */
      .polaroid-widget-container {
        position: relative;
        width: 100%;
        /* é”å®šæ•´ä½“å®½é«˜æ¯”ï¼Œé˜²æ­¢å˜å½¢ */
        aspect-ratio: 1 / 1.1; 
        height: auto; 
        display: flex;
        justify-content: center;
        overflow: visible;
        margin-top: 5px;
      }

      /* 2. å·¦ä¾§æ‹ç«‹å¾—å¡ç‰‡ (å¤§å›¾) */
      .polaroid-card {
        position: absolute;
        
        /* --- ğŸ”´ ä½ç½®ä¸å¤§å°æ ‡æ³¨ --- */
        left: 5%;       /* è·ç¦»å·¦è¾¹ 5% */
        top: 5%;        /* è·ç¦»é¡¶éƒ¨ 5% */
        width: 65%;     /* å®½åº¦å æ®å®¹å™¨çš„ 65% */
        
        /* --- ğŸ”´ å€¾æ–œè§’åº¦æ ‡æ³¨ --- */
        transform: rotate(-2deg); /* å‘å·¦å¾®æ­ª -2åº¦ */
        
        background-color: #fff;
        padding: 4% 4% 18% 4%; /* ä¸‹æ–¹ç•™ç™½å¤§ä¸€ç‚¹ç”¨äºå†™å­— */
        box-shadow: 0 5px 15px rgba(0,0,0,0.15);
        z-index: 1; /* åœ¨åº•å±‚ */
        border-radius: 4px;
        transition: transform 0.3s ease;
        cursor: pointer;
      }
      
      .polaroid-card:hover {
        transform: scale(1.02) rotate(-2deg);
        z-index: 5;
      }

      /* æ‹ç«‹å¾—å†…éƒ¨å›¾ç‰‡ */
      .polaroid-inner {
        width: 100%;
        aspect-ratio: 1 / 1; /* æ­£æ–¹å½¢ */
        background-color: #f8f8f8;
        overflow: hidden;
        border: 1px solid #eee;
      }
      .polaroid-inner img {
        width: 100%;
        height: 100%;
        object-fit: cover;
      }
      
      .polaroid-footer {
        position: absolute;
        bottom: 6%; 
        width: 100%;
        left: 0;
        text-align: center;
      }
      .polaroid-text {
        font-family: 'Courier New', monospace;
        font-size: clamp(10px, 3vw, 14px); 
        color: #888;
        letter-spacing: 1px;
        
        /* ğŸŸ¢ æ–°å¢ï¼šè®©é¼ æ ‡å˜æˆå°æ‰‹ï¼Œå¹¶ä¸”å¢åŠ å±‚çº§é˜²æ­¢è¢«é®æŒ¡ */
        cursor: pointer;
        position: relative;
        z-index: 10; 
      }
      
      /* ğŸŸ¢ æ–°å¢ï¼šé¼ æ ‡æ‚¬åœæ—¶å˜è‰²ï¼Œæç¤ºå¯ç‚¹å‡» */
      .polaroid-text:hover {
        color: var(--accent-color);
      }


      /* 3. å³ä¾§èƒ¶å·æ¡ (ä¸‰å¼ å°å›¾) */
      .film-strip {
        position: absolute;
        
        /* --- ğŸ”´ ä½ç½®ä¸å¤§å°æ ‡æ³¨ (å…³é”®ä¿®æ”¹) --- */
        right: 8%;      /* è·ç¦»å³è¾¹ 8% (æ•°å€¼è¶Šå¤§è¶Šå¾€å·¦é ï¼Œäº§ç”Ÿé‡å æ„Ÿ) */
        top: 22%;       /* è·ç¦»é¡¶éƒ¨ 22% (æ¯”æ‹ç«‹å¾—ä½ï¼Œå½¢æˆé”™è½) */
        width: 26%;     /* å®½åº¦å æ®å®¹å™¨çš„ 26% */
        
        /* --- ğŸ”´ å€¾æ–œè§’åº¦æ ‡æ³¨ --- */
        transform: rotate(6deg); /* å‘å³æ­ª 6åº¦ */
        
        /* æ ·å¼å¾®è°ƒï¼šè®©å®ƒæ›´åƒç…§ç‰‡æ¡è€Œä¸æ˜¯ç»ç’ƒ */
        background-color: #fff; 
        padding: 3%;
        display: flex;
        flex-direction: column;
        gap: 8px; /* ç…§ç‰‡ä¹‹é—´çš„é—´è· */
        
        box-shadow: 0 8px 20px rgba(0,0,0,0.25); /* é˜´å½±åŠ æ·±ï¼Œå¢åŠ ç«‹ä½“æ„Ÿ */
        z-index: 10; /* åœ¨é¡¶å±‚ï¼Œå‹ä½æ‹ç«‹å¾— */
        border-radius: 2px;
      }

      .film-frame {
        width: 100%;
        aspect-ratio: 1 / 1;
        background-color: #eee;
        overflow: hidden;
        cursor: pointer;
        transition: transform 0.2s;
        /* ç»™å°ç…§ç‰‡åŠ ä¸€ç‚¹ç‚¹å†…æè¾¹ï¼Œæ›´åƒå¤§å¤´è´´ */
        border: 1px solid rgba(0,0,0,0.05); 
      }
      .film-frame img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        filter: saturate(0.8); /* ç¨å¾®é™ä½é¥±å’Œåº¦ï¼Œæ›´æœ‰èƒ¶ç‰‡æ„Ÿ */
      }
      .film-frame:hover {
        transform: scale(1.05);
        filter: brightness(1.1);
      }

      /* --- åº•éƒ¨å†…å®¹åŒº (å›¾ç‰‡ä¸Šä¼ ) --- */
      .image-uploader {
        border-radius: 20px;
        padding: 10px;
        display: flex;
        flex-direction: column;
        gap: 10px;
        aspect-ratio: 1 / 1;
      }
      .image-placeholder {
        border: 2px dashed rgba(255, 255, 255, 0.3);
        border-radius: 15px;
        flex-grow: 1;
        display: flex;
        align-items: center;
        justify-content: center;
        color: var(--text-secondary-color);
        font-size: 14px;
      }
      .image-uploader input[type='text'] {
        background: none;
        border: none;
        outline: none;
        color: var(--text-color);
        text-align: center;
        font-size: 12px;
      }
      /* åœ¨ <style> æ ‡ç­¾å†…æ·»åŠ è¿™æ®µ CSS */
      .image-placeholder {
        cursor: pointer; /* é¼ æ ‡æ‚¬åœæ—¶æ˜¾ç¤ºä¸ºå¯ç‚¹å‡»çš„æ‰‹æŒ‡ */
        background-size: cover; /* å›¾ç‰‡è¦†ç›–æ•´ä¸ªåŒºåŸŸ */
        background-position: center; /* å›¾ç‰‡å±…ä¸­æ˜¾ç¤º */
        background-repeat: no-repeat;
        transition: background-color 0.3s ease; /* æ·»åŠ ä¸€ç‚¹è¿‡æ¸¡æ•ˆæœ */
      }
      .image-placeholder:hover {
        background-color: rgba(255, 255, 255, 0.05); /* æ‚¬åœæ—¶èƒŒæ™¯è‰²å˜äº®ä¸€ç‚¹ */
      }
      /* ================== èŒç³»å¼¹çª—é€šç”¨æ ·å¼ ================== */
      .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.6);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1000;
        opacity: 0;
        visibility: hidden;
        transition: opacity 0.3s ease, visibility 0.3s ease;
      }

      .modal-overlay.show {
        opacity: 1;
        visibility: visible;
      }

      .modal-content {
        /* â–¼â–¼â–¼ ä¿®æ”¹è¿™ä¸€è¡Œï¼šè®©å¼¹çª—èƒŒæ™¯ä¹Ÿè·Ÿéšå…¨å±€è®¾ç½® â–¼â–¼â–¼ */
        background-color: var(--primary-bg);

        padding: 25px;
        border-radius: 20px;
        /* å»ºè®®æŠŠè¾¹æ¡†é¢œè‰²ä¹Ÿæ”¹æ·¡ä¸€ç‚¹ï¼Œæˆ–è€…ç›´æ¥ç”¨å˜é‡ï¼Œä¸ç„¶åœ¨ç™½è‰²èƒŒæ™¯ä¸‹ç™½è¾¹æ¡†çœ‹ä¸è§ */
        /* border: 1px solid rgba(255, 255, 255, 0.2);  <-- åŸæ¥çš„ */
        border: 1px solid var(--capsule-bg); /* <-- å»ºè®®æ”¹æˆè¿™æ ·ï¼Œæˆ–è€…ä¿ç•™åŸæ · */

        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        text-align: center;
        position: relative;
        width: 85%;
        max-width: 320px;
        transform: scale(0.9);
        transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
      }

      .modal-overlay.show .modal-content {
        transform: scale(1);
      }

      .modal-content h3 {
        color: var(--text-color);
        margin-bottom: 10px;
      }

      .modal-content p {
        color: var(--text-secondary-color);
        font-size: 14px;
        margin-bottom: 20px;
      }

      .modal-buttons {
        display: flex;
        gap: 10px;
        justify-content: center;
      }

      .modal-content button {
        background-color: var(--capsule-bg);
        color: var(--text-color);
        border: 1px solid rgba(255, 255, 255, 0.2);
        padding: 10px 20px;
        border-radius: 25px;
        cursor: pointer;
        font-size: 14px;
        transition: background-color 0.2s ease, transform 0.2s ease;
      }

      .modal-content button:hover {
        background-color: rgba(255, 255, 255, 0.2);
        transform: translateY(-2px);
      }

      .modal-content .close-btn {
        position: absolute;
        top: 10px;
        right: 15px;
        background: none;
        border: none;
        font-size: 24px;
        color: var(--text-secondary-color);
        padding: 0;
      }

      /* æ–‡æœ¬ç¼–è¾‘å¼¹çª—çš„ç‰¹æ®Šæ ·å¼ */
      #textEditArea {
        width: 100%;
        height: 100px;
        background-color: var(--capsule-bg);
        border-radius: 15px;
        border: 1px solid rgba(255, 255, 255, 0.2);
        color: var(--text-color);
        padding: 10px;
        font-size: 14px;
        resize: none;
        margin-bottom: 20px;
        outline: none;
      }

      #saveTextBtn {
        background-color: var(--accent-color);
        color: #000;
        font-weight: bold;
      }

      /* å›¾ç‰‡ä¸Šä¼ åŒºåŸŸçš„æ ·å¼ (æ–°å¢) */
      .profile-dot {
        background-size: cover;
        background-position: center;
        cursor: pointer;
      }
      /* ================== å¤–è§‚è®¾ç½®å¼¹çª—æ ·å¼ ================== */
      .settings-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding: 10px;
        background-color: var(--capsule-bg);
        border-radius: 15px;
      }

      .settings-item label {
        color: var(--text-secondary-color);
        font-size: 14px;
      }

      .settings-item button {
        padding: 5px 15px;
        font-size: 13px;
      }

      .color-input-group {
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .color-input-group input[type='color'] {
        width: 30px;
        height: 30px;
        border: none;
        border-radius: 8px;
        padding: 2px;
        cursor: pointer;
        background-color: transparent;
      }
      /* éšè—åŸç”Ÿé¢œè‰²é€‰æ‹©å™¨çš„è¾¹æ¡†å’ŒèƒŒæ™¯ */
      .color-input-group input[type='color']::-webkit-color-swatch-wrapper {
        padding: 0;
      }
      .color-input-group input[type='color']::-webkit-color-swatch {
        border: 1px solid rgba(255, 255, 255, 0.3);
        border-radius: 6px;
      }

      .color-input-group input[type='text'] {
        background: none;
        border: none;
        color: var(--text-color);
        font-size: 14px;
        width: 80px;
        text-align: right;
        outline: none;
      }

      .settings-item input[type='range'] {
        width: 50%;
        -webkit-appearance: none;
        appearance: none;
        background: transparent;
        cursor: pointer;
      }
      /* ç¾åŒ–æ»‘å—è½¨é“ */
      .settings-item input[type='range']::-webkit-slider-runnable-track {
        background: var(--capsule-nested-bg);
        height: 6px;
        border-radius: 3px;
      }
      /* ç¾åŒ–æ»‘å—æŒ‰é’® */
      .settings-item input[type='range']::-webkit-slider-thumb {
        -webkit-appearance: none;
        appearance: none;
        margin-top: -5px; /* ä½¿æŒ‰é’®å‚ç›´å±…ä¸­ */
        background-color: var(--accent-color);
        height: 16px;
        width: 16px;
        border-radius: 50%;
      }

      /* ä¸»å±å¹•å£çº¸æ ·å¼ */
      .phone-screen {
        background-size: cover;
        background-position: center;
        background-repeat: no-repeat;
        transition: background-image 0.5s ease-in-out;
      }
      /* ================== å¤–è§‚è®¾ç½®å¼¹çª—æ–°å¢æ ·å¼ ================== */
      .wallpaper-preview-container {
        display: flex;
        align-items: center;
        gap: 10px;
      }
      .wallpaper-preview {
        width: 60px;
        height: 60px;
        border-radius: 10px;
        background-size: cover;
        background-position: center;
        border: 1px solid rgba(255, 255, 255, 0.2);
        background-color: #333;
      }
      .settings-section-divider {
        margin-top: 25px;
        margin-bottom: 10px;
        border-top: 1px solid rgba(255, 255, 255, 0.1);
        padding-top: 15px;
      }
      .settings-section-divider label {
        color: var(--text-color);
        font-weight: bold;
      }
      .editable-app-list {
        list-style: none;
        padding: 0;
        margin: 0;
      }
      .editable-app-list li {
        display: flex;
        align-items: center;
        padding: 8px;
        border-radius: 10px;
        margin-bottom: 8px;
        /* â–¼â–¼â–¼ ä¿®æ”¹è¿™ä¸€è¡Œï¼šä» rgba(0, 0, 0, 0.2) æ”¹ä¸ºå˜é‡ â–¼â–¼â–¼ */
        background-color: var(--capsule-bg);
        /* å»ºè®®åŠ ä¸Šè¾¹æ¡†ï¼Œè¿™æ ·åœ¨çº¯ç™½èƒŒæ™¯ä¸‹æ›´æœ‰å±‚æ¬¡æ„Ÿ */
        border: 1px solid rgba(255, 255, 255, 0.1);
      }

      .editable-app-list img {
        width: 35px;
        height: 35px;
        border-radius: 8px;
        margin-right: 12px;
      }
      .editable-app-list span {
        flex-grow: 1;
        font-size: 14px;
        color: var(--text-secondary-color);
      }
      .editable-app-list button {
        font-size: 12px;
        padding: 4px 12px;
      }
      #saveSettingsBtn {
        background-color: var(--accent-color);
        color: #000;
        font-weight: bold;
      }

      /* ================== ç¼–è¾‘Appå¼¹çª—æ ·å¼ ================== */
      .settings-item-column {
        display: flex;
        flex-direction: column;
        align-items: flex-start;
        width: 100%;
        margin-bottom: 15px;
      }
      .settings-item-column label {
        font-size: 14px;
        color: var(--text-secondary-color);
        margin-bottom: 8px;
      }
      .styled-input {
        width: 100%;
        padding: 10px;
        background-color: var(--capsule-bg);
        border: 1px solid rgba(255, 255, 255, 0.2);
        border-radius: 10px;
        color: var(--text-color);
        font-size: 14px;
        outline: none;
      }
      /* æ·»åŠ åˆ° <style> æ ‡ç­¾çš„æœ«å°¾ */
      .editable-app-list .button-group {
        display: flex;
        gap: 6px;
      }
      /* ================== API è®¾ç½®å¼¹çª—æ ·å¼ ================== */
      #apiSettingsModal .modal-content {
        text-align: left; /* è®©æ ‡ç­¾å·¦å¯¹é½ */
      }

      #apiSettingsModal select.styled-input {
        -webkit-appearance: none;
        appearance: none;
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' fill='%23f0f0f0' viewBox='0 0 16 16'%3E%3Cpath fill-rule='evenodd' d='M1.646 4.646a.5.5 0 0 1 .708 0L8 10.293l5.646-5.647a.5.5 0 0 1 .708.708l-6 6a.5.5 0 0 1-.708 0l-6-6a.5.5 0 0 1 0-.708z'/%3E%3C/svg%3E");
        background-repeat: no-repeat;
        background-position: right 10px center;
        background-size: 16px;
        padding-right: 35px; /* ä¸ºç®­å¤´ç•™å‡ºç©ºé—´ */
      }

      #apiSettingsModal .modal-buttons button {
        flex-grow: 1; /* è®©æŒ‰é’®å¹³åˆ†ç©ºé—´ */
      }
      /* ================== QQ åº”ç”¨é¡µé¢é€šç”¨æ ·å¼ ================== */
      .app-page {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        /* â–¼â–¼â–¼ ä¿®æ”¹è¿™ä¸€è¡Œï¼šè®©å®ƒè·Ÿéšå…¨å±€è®¾ç½® â–¼â–¼â–¼ */
        background-color: var(--primary-bg);
        z-index: 2000;
        display: flex;
        flex-direction: column;
        transform: translateX(100%);
        transition: transform 0.3s ease-in-out;
      }

      .app-page.active {
        transform: translateX(0); /* æ»‘å…¥å±å¹• */
      }

      .app-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 15px 20px;
        /* â–¼â–¼â–¼ ä¿®æ”¹è¿™ä¸€è¡Œï¼šä½¿ç”¨ç»„ä»¶é¢œè‰²å˜é‡ â–¼â–¼â–¼ */
        background-color: var(--capsule-bg);
        backdrop-filter: blur(10px); /* åŠ ä¸Šæ¯›ç»ç’ƒæ›´å¥½çœ‹ */
        -webkit-backdrop-filter: blur(10px);
        flex-shrink: 0;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      }

      .header-title {
        font-size: 18px;
        font-weight: bold;
      }

      .header-actions svg {
        cursor: pointer;
        stroke: var(--text-color);
      }

      /* ================== é€šè®¯å½•é¡µé¢æ ·å¼ ================== */
      .contacts-list {
        flex-grow: 1;
        overflow-y: auto;
      }

      .contact-avatar {
        width: 45px;
        height: 45px;
        border-radius: 50%;
        margin-right: 15px;
        object-fit: cover;
      }

      .contact-info {
        flex-grow: 1;
        display: flex;
        flex-direction: column;
        gap: 4px;
      }

      .contact-name {
        font-size: 16px;
        color: var(--text-color);
      }

      .contact-last-msg {
        font-size: 14px;
        color: #8e8e93; /* ç°è‰²å­—ä½“ */
      }

      .contact-time {
        font-size: 12px;
        color: #8e8e93;
        align-self: flex-start;
        margin-top: 2px;
      }

      /* ================== èŠå¤©è¯¦æƒ…é¡µæ ·å¼ ================== */
      /* èŠå¤©é¡µé¡¶éƒ¨ */
      .chat-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        position: relative;
        padding: 10px;
        /* â–¼â–¼â–¼ ä¿®æ”¹è¿™ä¸€è¡Œ â–¼â–¼â–¼ */
        background-color: var(--capsule-bg);
        backdrop-filter: blur(10px); /* æ¨èåŠ ä¸Š */
        -webkit-backdrop-filter: blur(10px);
        flex-shrink: 0;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      }
      .back-btn {
        background: none;
        border: none;
        color: var(--text-color);
        font-size: 24px;
        font-weight: bold;
        cursor: pointer;
        padding: 0 10px;
      }

      .chat-header-placeholder {
        width: 44px; /* ä¸è¿”å›æŒ‰é’®å®½åº¦å¤§è‡´ç›¸ç­‰ï¼Œç”¨äºå¹³è¡¡å¸ƒå±€ */
      }
      /* ä¿®æ”¹ .char-status-bar æ ·å¼ */
      .char-status-bar {
        flex-grow: 1; /* è®©å®ƒå æ®è¿”å›æŒ‰é’®å’Œå ä½ç¬¦ä¹‹é—´çš„æ‰€æœ‰ç©ºé—´ */
        display: flex;
        justify-content: center; /* æ ¸å¿ƒï¼šè®©å†…éƒ¨å…ƒç´ æ°´å¹³å±…ä¸­ */
        align-items: center;
        gap: 15px; /* æ§åˆ¶å¤´åƒä¹‹é—´çš„é—´è· */
        cursor: pointer;
      }

      /* å®šä¹‰ .header-avatar æ ·å¼ */
      .header-avatar {
        width: 40px; /* è°ƒæ•´ä¸ºä½ å¸Œæœ›çš„å¤§å° */
        height: 40px; /* è°ƒæ•´ä¸ºä½ å¸Œæœ›çš„å¤§å° */
        border-radius: 50%;
        object-fit: cover;
        border: 2px solid rgba(0, 0, 0, 0.3); /* æ·»åŠ ä¸€ç‚¹æ·±è‰²è¾¹æ¡†è®©å®ƒæ›´çªå‡º */
        background-color: #555; /* å›¾ç‰‡åŠ è½½å¤±è´¥æ—¶çš„å ä½é¢œè‰² */
      }

      /* èŠå¤©æ¶ˆæ¯åŒºåŸŸ */
      #qq-chat-page {
        /* ç¡®ä¿èŠå¤©é¡µé¢æ˜¯ flex å¸ƒå±€ */
        display: flex;
        flex-direction: column;
      }

      .chat-messages {
        flex-grow: 1; /* æ ¸å¿ƒï¼šè®©æ¶ˆæ¯åŒºåŸŸå æ®æ‰€æœ‰å‰©ä½™ç©ºé—´ */
        overflow-y: auto; /* å½“æ¶ˆæ¯è¿‡å¤šæ—¶å¯ä»¥æ»šåŠ¨ */
        padding: 10px;
        display: flex;
        flex-direction: column;
      }

      .message {
        display: flex;
        align-items: flex-end;
        margin-bottom: 15px;
        max-width: 80%;
      }
      .message-avatar {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        object-fit: cover;
        flex-shrink: 0;
      }
      .message-content {
        padding: 10px 15px;
        border-radius: 18px;
        font-size: 16px;
        line-height: 1.4;
        display: flex; /* <-- æ–°å¢ */
        flex-direction: column; /* <-- æ–°å¢ */
        align-items: flex-start; /* <-- æ–°å¢ï¼Œä¿è¯å†…å®¹é å·¦/å³å¯¹é½ */
      }

      /* å¯¹æ–¹ (char) çš„æ¶ˆæ¯ */
      .char-message {
        align-self: flex-start;
      }
      .char-message .message-avatar {
        margin-right: 10px;
      }
      .char-message .message-content {
        background-color: #363638;
        border-top-left-radius: 5px;
      }
      /* è‡ªå·± (user) çš„æ¶ˆæ¯ */
      .user-message {
        align-self: flex-end;
      }
      .user-message .message-avatar {
        margin-left: 10px;
      }
      .user-message .message-content {
        background-color: #007aff; /* è“è‰²æ°”æ³¡ */
        color: white;
        border-top-right-radius: 5px;
        order: -1; /* è®©å†…å®¹åœ¨å¤´åƒå·¦è¾¹ */
      }

      /* åº•éƒ¨è¾“å…¥æ¡†åŒºåŸŸ */
      .chat-input-area {
        display: flex;
        align-items: center;
        padding: 10px;
        /* â–¼â–¼â–¼ ä¿®æ”¹è¿™ä¸€è¡Œ â–¼â–¼â–¼ */
        background-color: var(--capsule-bg);
        backdrop-filter: blur(10px); /* æ¨èåŠ ä¸Š */
        -webkit-backdrop-filter: blur(10px);
        flex-shrink: 0;
        gap: 10px;
      }

      #chat-input-box {
        flex-grow: 1;
        background-color: #363638;
        border: none;
        border-radius: 20px;
        padding: 10px 15px;
        color: var(--text-color);
        font-size: 16px;
        outline: none;
      }

      .chat-send-btn {
        background-color: #007aff;
        color: white;
        border: none;
        border-radius: 8px;
        padding: 8px 15px;
        font-size: 14px;
        cursor: pointer;
        font-weight: bold;
      }
      .chat-send-btn.api {
        background-color: #30d158; /* çœŸå®å‘é€ç”¨ç»¿è‰²åŒºåˆ† */
      }
      /* ================== èŠå¤©è®¾ç½®é¢æ¿æ ·å¼ ================== */
      .settings-item-column textarea.styled-input {
        min-height: 80px; /* ç»™æ–‡æœ¬åŸŸä¸€ä¸ªåˆé€‚çš„æœ€å°é«˜åº¦ */
        resize: vertical; /* å…è®¸ç”¨æˆ·å‚ç›´è°ƒæ•´å¤§å° */
      }
      /* ================== ç”¨æˆ·é¢„è®¾åˆ—è¡¨æ ·å¼ ================== */
      .user-preset-item {
        display: flex;
        align-items: center;
        padding: 8px;
        border-radius: 10px;
        margin-bottom: 8px;
        /* â–¼â–¼â–¼ ä¿®æ”¹è¿™ä¸€è¡Œ â–¼â–¼â–¼ */
        background-color: var(--capsule-bg);
        border: 1px solid rgba(255, 255, 255, 0.1); /* æ–°å¢è¾¹æ¡† */
        cursor: pointer;
        transition: background-color 0.2s ease;
      }

      .user-preset-item:hover {
        background-color: rgba(255, 255, 255, 0.1);
      }
      .user-preset-item img {
        width: 35px;
        height: 35px;
        border-radius: 50%; /* åœ†å½¢å¤´åƒ */
        margin-right: 12px;
        object-fit: cover;
        flex-shrink: 0;
      }
      .user-preset-item .preset-info {
        flex-grow: 1;
        overflow: hidden; /* é˜²æ­¢æ–‡æœ¬è¿‡é•¿æº¢å‡º */
      }
      .user-preset-item .preset-name {
        font-size: 14px;
        color: var(--text-color);
        display: block; /* ç‹¬å ä¸€è¡Œ */
      }
      .user-preset-item .preset-persona-preview {
        font-size: 12px;
        color: var(--text-secondary-color);
        opacity: 0.8;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        display: block; /* ç‹¬å ä¸€è¡Œ */
      }
      .user-preset-item .delete-preset-btn {
        font-size: 12px;
        padding: 4px 12px;
        background-color: #ff3b30;
        color: white;
        border: none;
        font-weight: bold;
        border-radius: 20px;
        flex-shrink: 0;
        margin-left: 10px;
        cursor: pointer;
      }
      /* ================== NPC å’Œ è¡¨æƒ…åŒ…åº“ æ–°å¢æ ·å¼ ================== */
      .editable-app-list .npc-item-info {
        flex-grow: 1;
        display: flex;
        flex-direction: column;
        gap: 4px;
        overflow: hidden;
      }
      .editable-app-list .npc-name {
        font-size: 14px;
        color: var(--text-color);
        white-space: nowrap;
        text-overflow: ellipsis;
        overflow: hidden;
      }
      .editable-app-list .npc-relation {
        font-size: 12px;
        color: var(--text-secondary-color);
        opacity: 0.8;
        white-space: nowrap;
        text-overflow: ellipsis;
        overflow: hidden;
      }

      .sticker-tab-btn {
        flex: 1;
        padding: 10px;
        background: none;
        border: none;
        color: var(--text-secondary-color);
        cursor: pointer;
        font-size: 14px;
        border-bottom: 2px solid transparent;
        transition: all 0.2s ease;
      }
      .sticker-tab-btn.active {
        color: var(--accent-color);
        border-bottom-color: var(--accent-color);
      }

      .sticker-tab-content {
        display: none;
      }
      .sticker-tab-content.active {
        display: block;
      }

      .sticker-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
        gap: 10px;
      }
      .sticker-item {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 5px;
        padding: 5px;
        border-radius: 8px;
        background-color: rgba(255, 255, 255, 0.05);
        position: relative;
      }
      .sticker-item img {
        width: 100%;
        aspect-ratio: 1 / 1;
        object-fit: contain;
      }
      .sticker-item p {
        font-size: 11px;
        color: var(--text-secondary-color);
        margin: 0;
        text-align: center;
        width: 100%;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }
      .sticker-item .delete-sticker-btn {
        position: absolute;
        top: -5px;
        right: -5px;
        width: 20px;
        height: 20px;
        background-color: #ff3b30;
        color: white;
        border: none;
        border-radius: 50%;
        cursor: pointer;
        display: none; /* é»˜è®¤éšè— */
        align-items: center;
        justify-content: center;
        font-size: 14px;
        line-height: 20px;
      }
      .sticker-item:hover .delete-sticker-btn {
        display: flex; /* æ‚¬åœæ—¶æ˜¾ç¤º */
      }
      .sticker-item.selected {
        outline: 2px solid var(--accent-color);
        background-color: rgba(0, 255, 255, 0.2);
      }
      #stickerLibraryModal.manage-mode .sticker-item .delete-sticker-btn {
        display: none; /* åœ¨ç®¡ç†æ¨¡å¼ä¸‹éšè—å•ä¸ªåˆ é™¤æŒ‰é’® */
      }
      #stickerLibraryModal.manage-mode .sticker-item {
        cursor: pointer; /* æç¤ºç”¨æˆ·å¯ä»¥ç‚¹å‡» */
      }
      /* ================== æ°”æ³¡ç¼–è¾‘å™¨å¼¹çª—æ ·å¼ ================== */
      .bubble-editor-preview-area {
        background-color: rgba(0, 0, 0, 0.3);
        border-radius: 15px;
        padding: 15px;
        margin-bottom: 20px;
        border: 1px solid var(--capsule-bg);
        /* æ¨¡æ‹ŸèŠå¤©çª—å£çš„flexå¸ƒå±€ */
        display: flex;
        flex-direction: column;
        gap: 10px;
      }
      .bubble-editor-preview-area .message {
        max-width: 70%; /* é¢„è§ˆæ—¶æ°”æ³¡å°ä¸€ç‚¹ */
      }
      .bubble-editor-preview-area .message-content {
        font-size: 14px;
      }

      .bubble-editor-controls {
        flex-grow: 1;
        overflow-y: auto;
      }
      /* ================== æ°”æ³¡ç¼–è¾‘å™¨ V2 æ–°å¢æ ·å¼ ================== */
      .bubble-overlay-image {
        position: absolute;
        top: 10px;
        left: 10px;
        width: 50%;
        pointer-events: none; /* é»˜è®¤ä¸å¯äº¤äº’ï¼ŒJSä¼šè¦†ç›– */
      }

      .bubble-target-selector {
        display: flex;
        background-color: var(--capsule-bg);
        border-radius: 10px;
        padding: 5px;
        margin-bottom: 15px;
      }
      .bubble-target-selector label {
        flex: 1;
        text-align: center;
        padding: 8px;
        border-radius: 8px;
        cursor: pointer;
        transition: background-color 0.2s ease;
        font-size: 14px;
      }
      .bubble-target-selector input[type='radio'] {
        display: none;
      }
      .bubble-target-selector input[type='radio']:checked + label {
        background-color: var(--accent-color);
        color: #000;
        font-weight: bold;
      }
      /* ä¸ºäº†è®© radio input:checked + label ç”Ÿæ•ˆï¼Œéœ€è¦åè½¬ label å’Œ input çš„ä½ç½® */
      .bubble-target-selector label {
        display: block;
      }

      .editor-section-title {
        display: block;
        margin-top: 15px;
        margin-bottom: 5px;
        color: var(--text-color);
        font-weight: bold;
        font-size: 14px;
        border-bottom: 1px solid var(--capsule-bg);
        padding-bottom: 5px;
      }

      #visualEditorTab .settings-item {
        padding: 5px 0;
        margin-bottom: 5px;
      }
      #visualEditorTab .settings-item-column {
        margin-bottom: 5px;
      }
      #visualEditorTab .settings-item label,
      #visualEditorTab .settings-item-column label {
        font-size: 13px;
        flex-shrink: 0;
        width: 100px;
      }

      #bubbleBgColor {
        width: 38px !important;
        height: 38px !important;
        padding: 2px !important;
        border-radius: 10px !important;
      }
      /* ================== æ°”æ³¡ç¼–è¾‘å™¨ V3 æ–°å¢æ ·å¼ ================== */
      .control-group {
        padding: 10px;
        margin-top: 5px;
        border-radius: 10px;
        background-color: rgba(0, 0, 0, 0.2);
        border: 1px solid var(--capsule-bg);
      }
      #visualEditorTab .settings-item {
        align-items: center; /* å‚ç›´å±…ä¸­ */
      }
      #visualEditorTab input[type='checkbox'] {
        transform: scale(1.2); /* è®©å¤é€‰æ¡†å¤§ä¸€ç‚¹ */
      }
      /* ================== é€šè®¯å½•åˆ†ç»„æ ·å¼ (æ–°) ================== */
      .contact-group {
        /* è¿™æ˜¯æ¯ä¸ªåˆ†ç»„çš„å¤–å±‚å®¹å™¨ */
        border-bottom: 1px solid rgba(255, 255, 255, 0.08);
      }

      .contact-group:last-of-type {
        border-bottom: none; /* æœ€åä¸€ä¸ªåˆ†ç»„ä¸éœ€è¦åº•éƒ¨åˆ†å‰²çº¿ */
      }

      .contact-group-header {
        /* è¿™æ˜¯åˆ†ç»„çš„æ ‡é¢˜ï¼Œä¹Ÿå°±æ˜¯å¯ä»¥ç‚¹å‡»å±•å¼€/æŠ˜å çš„åŒºåŸŸ */
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 12px 20px;
        cursor: pointer;
        font-size: 14px;
        font-weight: bold;
        color: var(--text-color);
        list-style: none; /* éšè— <details> é»˜è®¤çš„å°ä¸‰è§’ */
        transition: background-color 0.2s ease;
      }

      .contact-group-header::-webkit-details-marker {
        display: none; /* åŒæ ·ä¸º Webkit æµè§ˆå™¨éšè—é»˜è®¤å°ä¸‰è§’ */
      }

      .contact-group-header:hover {
        background-color: #2c2c2e;
      }

      .group-name-wrapper {
        display: flex;
        align-items: center;
        gap: 8px; /* å›¾æ ‡å’Œæ–‡å­—çš„é—´è· */
      }

      .group-toggle-icon {
        transition: transform 0.2s ease-in-out;
        display: inline-block; /* å…è®¸ transform ç”Ÿæ•ˆ */
      }

      /* å½“åˆ†ç»„å±•å¼€æ—¶ï¼Œæ—‹è½¬å›¾æ ‡ */
      .contact-group[open] > .contact-group-header .group-toggle-icon {
        transform: rotate(90deg);
      }

      .group-member-count {
        color: #8e8e93; /* äººæ•°ç»Ÿè®¡ç”¨ç°è‰²å­—ä½“ */
        font-weight: normal;
      }
      /* ================== åˆ†ç»„ç®¡ç†å¼¹çª—æ ·å¼ (æ–°) ================== */
      .group-manage-item {
        display: flex;
        align-items: center;
        padding: 8px;
        border-radius: 10px;
        margin-bottom: 8px;
        /* â–¼â–¼â–¼ ä¿®æ”¹è¿™ä¸€è¡Œ â–¼â–¼â–¼ */
        background-color: var(--capsule-bg);
        border: 1px solid rgba(255, 255, 255, 0.1); /* æ–°å¢è¾¹æ¡† */
      }

      .group-manage-item .group-info {
        flex-grow: 1;
        display: flex;
        flex-direction: column;
        gap: 2px;
      }
      .group-manage-item .group-name {
        font-size: 14px;
        color: var(--text-color);
      }
      .group-manage-item .group-char-count {
        font-size: 12px;
        color: var(--text-secondary-color);
      }
      .group-manage-item .group-controls {
        display: flex;
        gap: 8px;
        align-items: center;
      }
      .group-manage-item .control-label {
        display: flex;
        align-items: center;
        gap: 4px;
        font-size: 12px;
        color: var(--text-secondary-color);
        cursor: pointer;
      }
      .group-manage-item .group-controls button {
        font-size: 12px;
        padding: 4px 10px;
      }
      .group-manage-item .pin-group-btn.pinned {
        background-color: var(--accent-color);
        color: #000;
      }
      .group-manage-item.is-ungrouped .group-controls {
        visibility: hidden; /* è®©æœªåˆ†ç»„åŒºåŸŸçš„æ§ä»¶ä¸å¯è§ */
      }
      /* ================== èŠå¤©è¾“å…¥åŒºå·¥å…·æ  (æ–°) ================== */
      .chat-tool-btn {
        flex-shrink: 0;
        width: 38px;
        height: 38px;
        border-radius: 50%;
        border: none;
        background-color: #363638;
        color: var(--text-color);
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: background-color 0.2s, transform 0.2s;
      }

      .chat-tool-btn:hover {
        background-color: #4a4a4c;
      }

      /* æŒ‰é’®æ¿€æ´»æ—¶çš„æ—‹è½¬æ•ˆæœ */
      .chat-tool-btn.active svg {
        transform: rotate(45deg);
        transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
      }
      .chat-tool-btn svg {
        transition: transform 0.3s ease;
      }

      .chat-tool-panel {
        /* â–¼â–¼â–¼ ä¿®æ”¹è¿™ä¸€è¡Œ â–¼â–¼â–¼ */
        background-color: var(--capsule-bg);
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);

        width: 100%;
        overflow: hidden;
        transition: height 0.3s ease-in-out;
        height: 0;
        border-top: 1px solid rgba(255, 255, 255, 0.1);
        flex-shrink: 0;
      }

      /* å½“å·¥å…·æ æ‰“å¼€æ—¶ï¼Œè°ƒæ•´èŠå¤©æ¶ˆæ¯åŒºåŸŸçš„ paddingï¼Œé¿å…é®æŒ¡ */
      #qq-chat-page.toolbar-open .chat-messages {
        padding-bottom: 280px; /* é¢„ç•™å‡ºå·¥å…·æ çš„é«˜åº¦ - å¢å¤§ */
        transition: padding-bottom 0.3s ease-in-out;
      }

      #qq-chat-page .chat-messages {
        transition: padding-bottom 0.3s ease-in-out;
      }

      /* ä¸»å·¥å…·æ ç½‘æ ¼å¸ƒå±€ */
      .toolbar-grid {
        display: flex; /* æ ¸å¿ƒä¿®æ”¹ï¼šå°† grid æ”¹ä¸º flex */
        gap: 10px;
        padding: 15px;
        height: 100%;
        align-items: center; /* æ¨èæ·»åŠ ï¼šè®©æ‰€æœ‰é¡¹ç›®åœ¨å‚ç›´æ–¹å‘ä¸Šå±…ä¸­å¯¹é½ï¼Œæ›´ç¾è§‚ */
        overflow-x: auto; /* æ¨èæ·»åŠ ï¼šå¦‚æœæœªæ¥é¡¹ç›®å¢å¤šï¼Œå¯ä»¥æ¨ªå‘æ»šåŠ¨è€Œä¸æ˜¯æ¢è¡Œ */
      }

      .toolbar-grid-item {
        background-color: rgba(255, 255, 255, 0.08);
        border-radius: 12px;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        gap: 4px;
        color: var(--text-secondary-color);
        border: none;
        cursor: pointer;
        transition: background-color 0.2s;
      }
      /* â–¼â–¼â–¼ æŠŠä¸‹é¢è¿™æ®µæ–°ä»£ç æ·»åŠ åˆ°ä½ çš„ <style> é‡Œ â–¼â–¼â–¼ */
      .toolbar-grid-item svg {
        width: 28px; /* ä½ å¯ä»¥æ”¹æˆ 24px æˆ–å…¶ä»–ä½ è§‰å¾—åˆé€‚çš„å¤§å° */
        height: 28px; /* ä¿æŒå’Œå®½åº¦ä¸€è‡´ */
      }

      .toolbar-grid-item:hover {
        background-color: rgba(255, 255, 255, 0.15);
      }
      .toolbar-grid-item.placeholder {
        background-color: transparent;
        cursor: default;
      }

      .toolbar-grid-item span {
        font-size: 12px;
      }
      /* ================== ç”¨æˆ·è¡¨æƒ…åŒ…é¢æ¿æ–°å¢æ ·å¼ ================== */
      .user-sticker-panel-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0 15px;
        height: 40px;
        flex-shrink: 0;
        border-bottom: 1px solid rgba(255, 255, 255, 0.08);
      }
      .user-sticker-panel-header span {
        font-size: 14px;
        color: var(--text-secondary-color);
      }
      .user-sticker-panel-header button {
        background: none;
        border: 1px solid var(--capsule-bg);
        color: var(--text-color);
        padding: 4px 12px;
        border-radius: 20px;
        font-size: 12px;
        cursor: pointer;
      }
      /* ================== ç”¨æˆ·è¡¨æƒ…é¢æ¿åˆ†ç±»åŠŸèƒ½æ–°å¢æ ·å¼ ================== */
      #user-sticker-panel.manage-mode .sticker-item {
        cursor: pointer; /* åœ¨ç®¡ç†æ¨¡å¼ä¸‹ï¼Œé¼ æ ‡å˜æˆå°æ‰‹ */
      }
      #user-sticker-panel.manage-mode .sticker-item.selected {
        outline: 2px solid var(--accent-color);
        background-color: rgba(0, 255, 255, 0.2);
      }
      .user-sticker-panel-header button {
        padding: 4px 12px;
        border-radius: 20px;
        font-size: 12px;
        cursor: pointer;
        background: none;
        border: 1px solid var(--capsule-bg);
        color: var(--text-color);
        transition: background-color 0.2s;
      }
      .user-sticker-panel-header button:hover {
        background-color: var(--capsule-bg);
      }

      .sticker-category-tabs {
        display: flex;
        gap: 10px;
        padding: 8px 15px;
        border-bottom: 1px solid rgba(255, 255, 255, 0.08);
        flex-shrink: 0;
        overflow-x: auto; /* å¦‚æœåˆ†ç±»å¤ªå¤šï¼Œå¯ä»¥æ¨ªå‘æ»šåŠ¨ */
      }
      .sticker-category-tab {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 5px;
        cursor: pointer;
        padding: 5px;
        border-radius: 8px;
        border: 2px solid transparent;
        transition: all 0.2s ease;
      }
      .sticker-category-tab:hover {
        background-color: rgba(255, 255, 255, 0.1);
      }
      .sticker-category-tab.active {
        border-color: var(--accent-color);
        background-color: rgba(0, 255, 255, 0.1);
      }
      .sticker-category-tab img {
        width: 35px;
        height: 35px;
        border-radius: 6px;
        object-fit: cover;
      }
      .sticker-category-tab span {
        font-size: 10px;
        color: var(--text-secondary-color);
        white-space: nowrap;
      }

      #existing-categories-list .category-radio-item {
        display: block;
        padding: 10px;
        margin-bottom: 8px;
        border-radius: 8px;
        background-color: var(--capsule-bg);
        cursor: pointer;
      }
      #existing-categories-list .category-radio-item:hover {
        background-color: rgba(255, 255, 255, 0.2);
      }
      /* ================== åˆ†ç±»åˆ é™¤æŒ‰é’®æ–°å¢æ ·å¼ ================== */
      .sticker-category-tab {
        position: relative; /* ä¸ºäº†è®©åˆ é™¤æŒ‰é’®å¯ä»¥ç»å¯¹å®šä½ */
      }

      .sticker-category-tab .delete-category-btn {
        position: absolute;
        top: -5px;
        right: -5px;
        width: 20px;
        height: 20px;
        background-color: #ff3b30;
        color: white;
        border: none;
        border-radius: 50%;
        cursor: pointer;
        display: none; /* é»˜è®¤éšè— */
        align-items: center;
        justify-content: center;
        font-size: 14px;
        line-height: 20px;
        z-index: 10;
      }

      /* ä»…åœ¨ç®¡ç†æ¨¡å¼ä¸‹æ˜¾ç¤ºåˆ é™¤æŒ‰é’® */
      #user-sticker-panel.manage-mode .sticker-category-tab:not([data-category-name='æœªåˆ†ç±»']) .delete-category-btn {
        display: flex;
      }
      .message-content img.message-image,
      .message-content img.message-sticker {
        max-width: 100%; /* å›¾ç‰‡æœ€å¤§å®½åº¦ä¸è¶…è¿‡æ°”æ³¡å®½åº¦ */
        max-height: 200px; /* é™åˆ¶ä¸€ä¸ªæœ€å¤§é«˜åº¦ï¼Œé˜²æ­¢å›¾ç‰‡è¿‡å¤§ */
        border-radius: 12px; /* ç»™å›¾ç‰‡ä¹ŸåŠ ä¸Šåœ†è§’ */
        display: block; /* é¿å…å›¾ç‰‡ä¸‹æ–¹æœ‰ç©ºéš™ */
        background-color: rgba(0, 0, 0, 0.2); /* åŠ è½½æ—¶çš„èƒŒæ™¯è‰² */
      }

      /* å¯¹äºè¡¨æƒ…åŒ…ï¼Œæˆ‘ä»¬å¯èƒ½å¸Œæœ›å®ƒèƒŒæ™¯é€æ˜ï¼Œå°ºå¯¸å¯ä»¥æ›´å¤§ä¸€ç‚¹ */
      .message-content img.message-sticker {
        background: transparent;
        max-width: 120px;
        max-height: 120px;
        /* ç§»é™¤å†…è¾¹è·ï¼Œè®©è¡¨æƒ…è´´ç´§æ°”æ³¡ */
        margin: -10px -15px;
      }

      /* å½“æ°”æ³¡ä¸­åªæœ‰å›¾ç‰‡æ—¶ï¼Œç§»é™¤å†…è¾¹è·ï¼Œè®©å›¾ç‰‡å¡«å……æ°”æ³¡ */
      .message-content:has(> img:only-child) {
        padding: 0;
        background: transparent; /* èƒŒæ™¯è®¾ä¸ºé€æ˜ï¼Œç”±å›¾ç‰‡æœ¬èº«å†³å®šå¤–è§‚ */
      }

      /* ================== è¯­éŸ³æ¶ˆæ¯æ ·å¼ (æ–°) ================== */
      .voice-message-container {
        display: flex;
        align-items: center;
        gap: 8px;
        cursor: pointer;
        padding: 2px 5px;
        border-radius: 12px;
        transition: background-color 0.2s ease;
        width: fit-content; /* <-- æ–°å¢ï¼šè®©å®¹å™¨å®½åº¦è‡ªé€‚åº”å†…å®¹ */
        min-width: 100px; /* <-- æ–°å¢ï¼šç»™æ³¢çº¹ä¸€ä¸ªæœ€å°çš„å±•ç¤ºå®½åº¦ */
      }

      .voice-message-container:hover {
        background-color: rgba(0, 0, 0, 0.1); /* æ‚¬åœæ—¶ç»™ä¸€ç‚¹åé¦ˆ */
      }

      .voice-icon {
        font-size: 20px; /* éº¦å…‹é£å›¾æ ‡å¤§å° */
        flex-shrink: 0;
      }

      .voice-waveform {
        display: flex;
        align-items: center;
        height: 20px; /* æ³¢çº¹çš„é«˜åº¦ */
        gap: 2px;
      }

      .voice-waveform span {
        background-color: currentColor; /* æ³¢çº¹é¢œè‰²è·Ÿéšæ°”æ³¡æ–‡å­—é¢œè‰² */
        width: 3px;
        height: 100%; /* <<< æ–°å¢è¿™ä¸€è¡Œï¼Œè®©å£°æ³¢æŸ±å­æœ‰é«˜åº¦ */
        border-radius: 3px;
        animation: wave 1.2s infinite ease-in-out;
        transform-origin: bottom;
      }

      /* ç»™æ¯ä¸ªæ³¢çº¹æ¡åŠ ä¸Šä¸åŒçš„åŠ¨ç”»å»¶è¿Ÿï¼Œå½¢æˆæ­¤èµ·å½¼ä¼çš„æ•ˆæœ */
      .voice-waveform span:nth-child(2) {
        animation-delay: -1.1s;
      }
      .voice-waveform span:nth-child(3) {
        animation-delay: -1s;
      }
      .voice-waveform span:nth-child(4) {
        animation-delay: -0.9s;
      }
      .voice-waveform span:nth-child(5) {
        animation-delay: -0.8s;
      }
      .voice-waveform span:nth-child(6) {
        animation-delay: -0.7s;
      }
      .voice-waveform span:nth-child(7) {
        animation-delay: -0.6s;
      }

      /* æ³¢çº¹åŠ¨ç”» */
      @keyframes wave {
        0%,
        40%,
        100% {
          transform: scaleY(0.2);
        }
        20% {
          transform: scaleY(1);
        }
      }

      /* â€œè½¬æ–‡å­—â€åçš„æ–‡æœ¬æ ·å¼ */
      .voice-transcript {
        font-size: 13px;
        color: var(--text-secondary-color);
        opacity: 0.8;
        margin-top: 8px;
        padding-top: 8px;
        border-top: 1px solid rgba(255, 255, 255, 0.1);
        display: none; /* é»˜è®¤éšè— */
        width: 100%;
      }
      /* ================== ä¸–ç•Œä¹¦é¡µé¢æ ·å¼ (æ–°) ================== */
      .worldbook-list-item {
        display: flex;
        align-items: center;
        padding: 15px 20px;
        border-bottom: 1px solid rgba(255, 255, 255, 0.08);
        cursor: pointer;
        transition: background-color 0.2s ease;
      }
      /* â–¼â–¼â–¼ åœ¨ .worldbook-list-item æ ·å¼ä¸‹é¢æ·»åŠ è¿™ä¸ª â–¼â–¼â–¼ */
      .worldbook-content-wrapper {
        display: flex;
        align-items: center;
        flex-grow: 1; /* è®©å†…å®¹åŒºå æ®å¤§éƒ¨åˆ†ç©ºé—´ */
        overflow: hidden; /* é˜²æ­¢ä¹¦åè¿‡é•¿æ—¶æ’‘ç ´å¸ƒå±€ */
      }

      .worldbook-list-item:hover {
        background-color: #2c2c2e;
      }

      .worldbook-icon {
        width: 45px;
        height: 45px;
        flex-shrink: 0;
        margin-right: 15px;
        display: flex;
        align-items: center;
        justify-content: center;
        background-color: rgba(255, 255, 255, 0.1);
        border-radius: 10px;
      }

      .worldbook-info {
        flex-grow: 1;
      }

      .worldbook-name {
        font-size: 16px;
        color: var(--text-color);
        font-weight: bold;
      }

      .worldbook-stats {
        font-size: 13px;
        color: #8e8e93;
        margin-top: 4px;
      }

      .add-worldbook-btn-container {
        padding: 20px;
        border-top: 1px solid rgba(255, 255, 255, 0.1);
      }

      .add-worldbook-btn {
        width: 100%;
        padding: 12px;
        font-size: 16px;
        font-weight: bold;
        background-color: var(--accent-color);
        color: #000;
        border: none;
        border-radius: 12px;
        cursor: pointer;
      }

      /* --- ä¸–ç•Œä¹¦è¯¦æƒ…é¡µ --- */
      .worldbook-entry-list {
        padding: 10px;
        flex-grow: 1;
        overflow-y: auto;
      }

      .worldbook-entry-item {
        background-color: #2c2c2e;
        border-radius: 15px;
        margin-bottom: 10px;
        padding: 15px;
        border: 1px solid rgba(255, 255, 255, 0.1);
      }

      .entry-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 12px;
      }

      .entry-name {
        font-size: 16px;
        font-weight: bold;
        color: var(--text-color);
      }

      .entry-controls button {
        background: none;
        border: 1px solid var(--capsule-bg);
        color: var(--text-color);
        padding: 4px 10px;
        font-size: 12px;
        border-radius: 20px;
        margin-left: 8px;
        cursor: pointer;
      }

      .entry-details {
        font-size: 14px;
        color: var(--text-secondary-color);
      }

      .entry-details p {
        margin-bottom: 8px;
      }

      .entry-details strong {
        color: var(--text-color);
        margin-right: 5px;
      }

      .keywords-container {
        display: flex;
        flex-wrap: wrap;
        gap: 6px;
      }

      .keyword-tag {
        background-color: rgba(255, 255, 255, 0.15);
        padding: 3px 8px;
        border-radius: 8px;
        font-size: 12px;
      }
      /* ================== ä¸–ç•Œä¹¦é¡µé¢æ ·å¼ç»“æŸ ================== */
      /* ================== å…³è”ä¸–ç•Œä¹¦å¼¹çª—æ ·å¼ (æ–°) ================== */
      #associateWorldBookModal .modal-content {
        text-align: left;
      }

      #worldbook-selection-list {
        list-style: none;
        padding: 0;
        margin: 0;
        max-height: 250px;
        overflow-y: auto;
        border: 1px solid var(--capsule-bg);
        border-radius: 10px;
        padding: 5px;
      }

      .worldbook-selection-item {
        display: block; /* è®©æ•´ä¸ª label å¯ç‚¹å‡» */
        padding: 12px 15px;
        border-radius: 8px;
        margin-bottom: 5px;
        cursor: pointer;
        transition: background-color 0.2s ease;
        display: flex;
        align-items: center;
        gap: 12px;
      }

      .worldbook-selection-item:hover {
        background-color: var(--capsule-bg);
      }

      .worldbook-selection-item input[type='checkbox'] {
        width: 18px;
        height: 18px;
        flex-shrink: 0;
        accent-color: var(--accent-color); /* è®©å‹¾é€‰åçš„é¢œè‰²æ›´å¥½çœ‹ */
      }

      .worldbook-selection-item .item-name {
        font-size: 15px;
        color: var(--text-color);
        flex-grow: 1;
      }
      /* ================== æ ·å¼ç»“æŸ ================== */
      /* ================== é€šè®¯å½•å·¦æ»‘åˆ é™¤ (æ–°) ================== */
      .contact-item-wrapper {
        overflow: hidden;
        position: relative;
        /* â–¼â–¼â–¼ ä¿®æ”¹è¿™ä¸€è¡Œ â–¼â–¼â–¼ */
        background-color: var(--primary-bg);
        border-bottom: 1px solid rgba(255, 255, 255, 0.08);
      }

      .contact-item-deletable {
        display: flex;
        align-items: stretch; /* è®©åˆ é™¤æŒ‰é’®å’Œå†…å®¹åŒºåŸŸç­‰é«˜ */
        transition: transform 0.3s ease;
      }

      .contact-item-content {
        display: flex;
        align-items: center;
        padding: 12px 20px;
        cursor: pointer;
        flex-grow: 1;
        /* â–¼â–¼â–¼ ä¿®æ”¹è¿™ä¸€è¡Œ â–¼â–¼â–¼ */
        background-color: var(--primary-bg);
        width: 100%;
        flex-shrink: 0;
      }

      /* åŒæ—¶ä¿®æ”¹æ‚¬åœé¢œè‰²ï¼Œä¸ç„¶é¼ æ ‡æ”¾ä¸Šå»è¿˜æ˜¯é»‘çš„ */
      .contact-item-content:hover {
        /* â–¼â–¼â–¼ ä¿®æ”¹è¿™ä¸€è¡Œï¼šä½¿ç”¨åŠé€æ˜ç»„ä»¶è‰² â–¼â–¼â–¼ */
        background-color: var(--capsule-bg);
      }

      .delete-char-btn {
        width: 80px; /* åˆ é™¤æŒ‰é’®çš„å®½åº¦ */
        flex-shrink: 0; /* é˜²æ­¢è¢«å‹ç¼© */
        border: none;
        background-color: #ff3b30; /* é†’ç›®çš„çº¢è‰² */
        color: white;
        font-weight: bold;
        font-size: 16px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      /* ================== è§†é¢‘é€šè¯ UI (æ–°) ================== */
      #video-call-screen {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: #111;
        z-index: 3000;
        display: flex; /* ä½¿ç”¨ flex æ–¹ä¾¿å¸ƒå±€ */
        flex-direction: column;
        justify-content: space-between;
        transition: opacity 0.3s ease;
      }

      /* å¤§å°å±ç”»é¢é€šç”¨æ ·å¼ */
      #video-call-large-view,
      #video-call-small-view {
        position: absolute;
        background-size: cover;
        background-position: center;
        background-repeat: no-repeat;
        background-color: #222;
        transition: all 0.3s ease-in-out;
      }

      /* å¤§å±æ ·å¼ */
      #video-call-large-view {
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
      }

      /* å°å±æ ·å¼ */
      #video-call-small-view {
        width: 28vw;
        height: 20vh;
        /* bottom: 120px;  <-- æ³¨é‡Šæˆ–åˆ é™¤è¿™è¡Œ */
        top: 25px; /* <-- æ–°å¢: è·ç¦»é¡¶éƒ¨25px */
        right: 15px;
        border-radius: 12px;
        border: 2px solid rgba(255, 255, 255, 0.3);
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.5);
        z-index: 3002;
        cursor: pointer;
      }

      /* æ— å›¾æ¨¡å¼ä¸‹å¯¹æ–¹ä¿¡æ¯ */
      #video-call-char-info {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        display: none; /* é»˜è®¤éšè— */
        flex-direction: column;
        align-items: center;
        gap: 15px;
        z-index: 3001;
      }

      #video-call-char-info img {
        width: 100px;
        height: 100px;
        border-radius: 50%;
        border: 3px solid rgba(255, 255, 255, 0.2);
      }

      #video-call-char-info span {
        color: var(--text-color);
        font-size: 18px;
        font-weight: bold;
        background-color: rgba(0, 0, 0, 0.3);
        padding: 5px 15px;
        border-radius: 20px;
      }

      /* å¯¹è¯å†…å®¹æµ®å±‚ */
      #video-call-dialogue-overlay {
        position: absolute;
        bottom: 120px; /* å’Œå°çª—åº•éƒ¨å¯¹é½ */
        left: 15px;
        right: 15px;
        max-height: 40%;
        overflow-y: auto;
        display: flex;
        flex-direction: column;
        gap: 8px;
        z-index: 3003;
        -webkit-mask-image: linear-gradient(to bottom, transparent 0%, black 15%);
        mask-image: linear-gradient(to bottom, transparent 0%, black 15%);
      }

      .video-dialogue-line {
        background-color: rgba(0, 0, 0, 0.5);
        color: #f0f0f0;
        padding: 8px 12px;
        border-radius: 10px;
        max-width: 80%;
        font-size: 15px;
        opacity: 0;
        animation: fadeIn 0.5s forwards;
      }

      .video-dialogue-line.user {
        align-self: flex-end;
        background-color: rgba(0, 122, 255, 0.6);
      }

      .video-dialogue-line.char {
        align-self: flex-start;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      /* åº•éƒ¨æ§åˆ¶æ  */
      #video-call-controls {
        width: 100%;
        padding: 20px;
        background: linear-gradient(to top, rgba(0, 0, 0, 0.7), transparent);
        display: flex;
        justify-content: space-around;
        align-items: center;
        z-index: 3004;
        position: absolute;
        bottom: 0;
      }

      .video-control-btn {
        background-color: rgba(255, 255, 255, 0.15);
        border: none;
        border-radius: 50%;
        width: 60px;
        height: 60px;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        color: white;
        cursor: pointer;
        transition: background-color 0.2s;
      }

      .video-control-btn:hover {
        background-color: rgba(255, 255, 255, 0.3);
      }

      .video-control-btn.hangup {
        background-color: #ff3b30;
      }

      .video-control-btn.hangup:hover {
        background-color: #ff4d43;
      }

      .video-control-btn svg {
        width: 28px;
        height: 28px;
        margin-bottom: 2px;
      }
      .video-control-btn span {
        font-size: 10px;
        display: none; /* ç®€æ´æ¨¡å¼ï¼Œå¯ä»¥å»æ‰è¿™è¡Œæ¥æ˜¾ç¤ºæ–‡å­— */
      }
      /* åœ¨è¿™ä¸ªæ³¨é‡Šå—çš„ä¸Šæ–¹æˆ–å†…éƒ¨æ·»åŠ  */
      #video-call-timer {
        position: absolute;
        top: 25px; /* å’ŒçŠ¶æ€æ å·®ä¸å¤šçš„é«˜åº¦ */
        left: 50%;
        transform: translateX(-50%);
        background-color: rgba(0, 0, 0, 0.4);
        color: var(--text-color);
        padding: 5px 15px;
        border-radius: 20px;
        font-size: 14px;
        z-index: 3005; /* ç¡®ä¿åœ¨æœ€é¡¶å±‚ */
        font-family: 'Courier New', Courier, monospace; /* ä½¿ç”¨ç­‰å®½å­—ä½“ï¼Œæ•°å­—è·³åŠ¨æ—¶ä¸ä¼šæ™ƒåŠ¨ */
      }
      /* ================== è§†é¢‘é€šè¯å¡ç‰‡æ ·å¼ (æ–°) ================== */
      .video-call-card {
        background-color: #2c2c2e;
        border-radius: 12px;
        padding: 12px 15px;
        display: flex;
        align-items: center;
        gap: 12px;
        cursor: pointer;
        border: 1px solid rgba(255, 255, 255, 0.1);
        transition: background-color 0.2s;
        min-width: 200px;
      }
      .video-call-card:hover {
        background-color: #3a3a3c;
      }
      .video-call-card-icon {
        font-size: 24px;
      }
      .video-call-card-info p {
        margin: 0;
        font-size: 15px;
      }
      .video-call-card-info span {
        font-size: 12px;
        color: var(--text-secondary-color);
      }

      /* ================== é€šè¯è®°å½•å¼¹çª—åˆ—è¡¨æ ·å¼ (æ–°) ================== */
      #call-history-list .history-item {
        background-color: var(--capsule-bg);
        padding: 12px;
        border-radius: 10px;
        margin-bottom: 8px;
        cursor: pointer;
        transition: background-color 0.2s ease;
      }
      #call-history-list .history-item:hover {
        background-color: rgba(255, 255, 255, 0.2);
      }
      #call-history-list .history-item-time {
        font-weight: bold;
        color: var(--text-color);
      }
      #call-history-list .history-item-duration {
        font-size: 13px;
        color: var(--text-secondary-color);
      }

      /* ================== é€šè¯è¯¦æƒ…å¼¹çª—æ ·å¼ (æ–°) ================== */
      #transcript-modal-content .transcript-line {
        margin-bottom: 10px;
      }
      #transcript-modal-content .transcript-line strong {
        color: var(--accent-color);
      }
      /* ================== äº¤æ˜“è®°å½•å¼¹çª—æ ·å¼ (æ–°) ================== */
      #transaction-log-list {
        list-style: none;
        padding: 0;
        margin: 0;
        max-height: 40vh;
        overflow-y: auto;
      }
      .transaction-log-item {
        display: flex;
        justify-content: space-between;
        padding: 12px 8px;
        border-bottom: 1px solid var(--capsule-bg);
      }
      .transaction-log-item:last-child {
        border-bottom: none;
      }
      .transaction-info {
        display: flex;
        flex-direction: column;
        gap: 4px;
      }
      .transaction-description {
        font-size: 14px;
        color: var(--text-color);
      }
      .transaction-date {
        font-size: 11px;
        color: var(--text-secondary-color);
      }
      .transaction-amount {
        font-size: 15px;
        font-weight: bold;
        align-self: center;
      }
      .transaction-amount.income {
        color: #30d158; /* ç»¿è‰²æ”¶å…¥ */
      }
      .transaction-amount.expense {
        color: #ff453a; /* çº¢è‰²æ”¯å‡º */
      }
      /* ================== è½¬è´¦å¡ç‰‡æ ·å¼ (æ–°) ================== */
      .transfer-card {
        background-color: #fa9d3b; /* èŒç³»çš„æ©™è‰²èƒŒæ™¯ï¼Œåƒçº¢åŒ… */
        color: white;
        border-radius: 10px;
        padding: 12px;
        min-width: 220px;
        cursor: pointer;
        transition: filter 0.2s ease, background-color 0.3s ease;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
      }
      .transfer-card:hover {
        filter: brightness(1.1);
      }

      .transfer-card-header {
        display: flex;
        align-items: center;
        gap: 8px;
        padding-bottom: 8px;
        border-bottom: 1px solid rgba(255, 255, 255, 0.3);
      }
      .transfer-card-header .transfer-icon {
        font-size: 24px;
      }
      .transfer-card-header p {
        font-size: 15px;
        margin: 0;
      }

      .transfer-card-body {
        padding: 15px 0;
        text-align: center;
      }
      .transfer-card-body .transfer-amount {
        font-size: 32px;
        font-weight: bold;
        margin: 0;
      }
      .transfer-card-body .transfer-remark {
        font-size: 14px;
        margin: 4px 0 0 0;
        opacity: 0.9;
      }

      .transfer-card-footer {
        font-size: 12px;
        color: rgba(255, 255, 255, 0.8);
        text-align: center;
      }

      .transfer-card-actions {
        display: flex;
        gap: 10px;
        margin-top: 12px;
        justify-content: center;
      }

      .transfer-card-actions .transfer-action-btn {
        background-color: rgba(255, 255, 255, 0.2);
        border: 1px solid white;
        color: white;
        padding: 6px 16px;
        border-radius: 20px;
        cursor: pointer;
        font-size: 13px;
        transition: background-color 0.2s;
      }
      .transfer-card-actions .transfer-action-btn:hover {
        background-color: rgba(255, 255, 255, 0.4);
      }

      /* å·²æ”¶æ¬¾/å·²é€€è¿˜çŠ¶æ€ */
      .transfer-card.accepted,
      .transfer-card.refused {
        background-color: #6e6e73; /* ç°è‰²è¡¨ç¤ºå·²å®Œæˆ */
      }

      /* å½“æ¶ˆæ¯æ°”æ³¡ä¸­åªæœ‰è½¬è´¦å¡ç‰‡æ—¶ï¼Œè®©æ°”æ³¡èƒŒæ™¯é€æ˜ï¼Œå¡ç‰‡å®Œå…¨å±•ç¤º */
      .message-content:has(> .transfer-card:only-child) {
        padding: 0;
        background: transparent;
      }
      /* ================== ç¤¼ç‰©å•†åº—å’Œè´­ç‰©è½¦æ ·å¼ (æ–°) ================== */
      .gift-list {
        display: grid;
        grid-template-columns: repeat(2, 1fr); /* ä¸¤åˆ—å¸ƒå±€ */
        gap: 15px;
      }
      .gift-item {
        background-color: var(--capsule-bg);
        border-radius: 12px;
        overflow: hidden;
        display: flex;
        flex-direction: column;
        border: 1px solid rgba(255, 255, 255, 0.1);
      }
      .gift-item-image {
        width: 100%;
        aspect-ratio: 1 / 1;
        background-color: #333; /* å ä½èƒŒæ™¯è‰² */
        background-size: cover;
        background-position: center;
      }
      .gift-item-info {
        padding: 10px;
        display: flex;
        flex-direction: column;
        gap: 5px;
        flex-grow: 1;
      }
      .gift-item-name {
        font-size: 14px;
        font-weight: bold;
        color: var(--text-color);
      }
      .gift-item-price {
        font-size: 13px;
        color: var(--accent-color);
      }
      .add-to-cart-btn {
        margin-top: auto; /* å°†æŒ‰é’®æ¨åˆ°åº•éƒ¨ */
        padding: 6px 10px;
        font-size: 12px;
        background-color: var(--capsule-nested-bg);
        border: none;
        border-radius: 20px;
        color: var(--text-color);
        cursor: pointer;
        transition: background-color 0.2s;
      }
      .add-to-cart-btn:hover {
        background-color: rgba(255, 255, 255, 0.3);
      }

      /* è´­ç‰©è½¦æ ·å¼ */
      .cart-item {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 10px 0;
        border-bottom: 1px solid var(--capsule-bg);
      }
      .cart-item:last-child {
        border-bottom: none;
      }
      .cart-item img {
        width: 50px;
        height: 50px;
        border-radius: 8px;
        object-fit: cover;
      }
      .cart-item-details {
        flex-grow: 1;
      }
      .cart-item-name {
        font-size: 14px;
      }
      .cart-item-price {
        font-size: 12px;
        color: var(--text-secondary-color);
      }
      .remove-cart-item-btn {
        background-color: #ff3b30;
        color: white;
        border: none;
        border-radius: 50%;
        width: 24px;
        height: 24px;
        cursor: pointer;
      }

      /* èŠå¤©ä¸­çš„ç¤¼ç‰©å¡ç‰‡æ ·å¼ */
      .gift-card {
        background: linear-gradient(135deg, #667eea, #764ba2);
        color: white;
        border-radius: 12px;
        padding: 15px;
        min-width: 230px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
      }
      .gift-card-header {
        display: flex;
        align-items: center;
        gap: 8px;
        padding-bottom: 8px;
        border-bottom: 1px solid rgba(255, 255, 255, 0.2);
      }
      .gift-card-header .gift-icon {
        font-size: 24px;
      }
      .gift-card-header p {
        margin: 0;
        font-weight: bold;
      }
      .gift-card-body {
        padding-top: 10px;
      }
      .gift-card-body ul {
        list-style: none;
        padding: 0;
        margin: 0;
        font-size: 14px;
      }
      .gift-card-body ul li {
        padding: 2px 0;
      }
      .message-content:has(> .gift-card:only-child) {
        padding: 0;
        background: transparent;
      }
      /* ================== ğŸ“ è‰è“ç‰›å¥¶Â·åƒç´ æ¸¸æˆæœº UI (æœ€ç»ˆèŒåŒ–ç‰ˆ) ğŸ“ ================== */

      /* 1. å¼¹çª—å®¹å™¨ï¼šåƒä¸€ä¸ªå¤å¤çš„æ¸¸æˆæœºå¤–å£³ */
      #fontManagerModal .modal-content {
        /* èƒŒæ™¯ï¼šæ”¹ä¸ºçº¯å‡€çš„èƒŒæ™¯ */
        background-color: #fff9fb; /* ä½ ä¹Ÿå¯ä»¥æ”¹æˆ #ffffff çº¯ç™½ */
        /* background-image: radial-gradient(#FFDEE9 15%, transparent 16%); */ /* å·²æ³¨é‡Š */
        /* background-size: 10px 10px; */ /* å·²æ³¨é‡Š */

        /* è¾¹æ¡†ï¼šåŒå±‚è®¾è®¡ï¼Œå†…ç™½å¤–ç²‰ */
        border: 4px solid #fff;
        outline: 4px solid #ffc6d9;
        border-radius: 30px;

        /* åƒç´ ç¡¬é˜´å½±ï¼šä¸æ¨¡ç³Šçš„è“è‰²é˜´å½± */
        box-shadow: 8px 8px 0px #a0c4ff, 8px 8px 0px 4px #fff; /* å¢åŠ ä¸€ç‚¹ç™½è‰²é—´éš”è®©é˜´å½±æ›´æ˜æ˜¾ */

        padding: 0;
        width: 90%;
        max-width: 360px;
        overflow: hidden;
        color: #7a656b;
        /* æ ¸å¿ƒï¼šä½¿ç”¨ç­‰å®½å­—ä½“å¢åŠ åƒç´ æ„Ÿ */
        font-family: 'Courier New', Courier, monospace, sans-serif;
      }

      /* 2. å¤´éƒ¨ï¼šåƒä¸€å¼ æ”¶æ®æˆ–è€…ç¥¨æ®çš„å¤´éƒ¨ */
      .cute-header {
        background: #fff;
        padding: 15px 20px;
        border-bottom: 3px dashed #ffc6d9; /* èŒç³»è™šçº¿ */
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      /* --- æ‰¾åˆ°è¿™å—ä»£ç è¿›è¡Œä¿®æ”¹ --- */

      .cute-header h3 {
        margin: 0;
        font-size: 18px;
        color: #ff8fab;
        font-weight: 900;
        text-shadow: 2px 2px 0px #ffe5ec;

        /* â–¼â–¼â–¼ æ–°å¢ï¼šä¸ºäº†è®©è£…é¥°çº¿å’Œæ–‡å­—å¯¹é½ â–¼â–¼â–¼ */
        display: flex;
        align-items: center;
        gap: 10px; /* æ–‡å­—å’Œè£…é¥°çº¿çš„é—´è· */
      }

      /* â–¼â–¼â–¼ æ–°å¢ï¼šç”¨ CSS ç”»ä¸€ä¸ªå¯çˆ±çš„è£…é¥°æ¡ (æ›¿ä»£ Emoji) â–¼â–¼â–¼ */
      /* æ‰¾åˆ°è¿™æ®µä»£ç è¿›è¡Œä¿®æ”¹ */
      .cute-header h3::before {
        content: '';
        display: inline-block;
        width: 8px; /*ç¨å¾®åŠ å®½ä¸€ç‚¹ç‚¹ï¼Œæ¸å˜æ›´æ˜æ˜¾*/
        height: 20px;

        /* â–¼â–¼â–¼ ä¿®æ”¹è¿™é‡Œï¼šä»æ·±ç²‰è‰²(#FF8FAB) æ¸å˜åˆ° æµ…ç²‰è‰²(#FFC6D9) â–¼â–¼â–¼ */
        background: linear-gradient(to right, #ff8fab, #ffc6d9);

        border-radius: 4px; /*ç¨å¾®æ”¹å°ä¸€ç‚¹åœ†è§’ï¼Œæ–¹å—æ„Ÿå¼ºä¸€ç‚¹ï¼Œé…åˆæ¸å˜å¥½çœ‹*/
        box-shadow: 2px 2px 0px #ffe5ec;
      }

      /* å…³é—­æŒ‰é’®ï¼šåƒç´ å—é£æ ¼ */
      .cute-close-btn {
        background: #ffc6d9;
        border: 2px solid #fff;
        color: #fff;
        width: 30px;
        height: 30px;
        border-radius: 50%; /* åœ†å½¢ */
        font-size: 14px;
        font-weight: bold;
        cursor: pointer;
        /* æŒ‰é’®ç«‹ä½“æ„Ÿ */
        box-shadow: 2px 2px 0px #ff8fab;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: transform 0.1s;
      }
      .cute-close-btn:active {
        transform: translate(2px, 2px);
        box-shadow: none;
      }

      /* 3. Tabsï¼šåƒè´´çº¸ä¸€æ · */
      .cute-tabs {
        display: flex;
        justify-content: center;
        gap: 8px;
        padding: 15px 15px 5px 15px;
        background: rgba(255, 255, 255, 0.6); /* åŠé€æ˜èƒŒæ™¯ */
      }
      .cute-tab-btn {
        flex: 1;
        border: 2px solid #ffc6d9;
        background: #fff;
        padding: 8px 0;
        border-radius: 12px;
        font-size: 12px;
        color: #ffb7b2;
        cursor: pointer;
        font-weight: bold;
        font-family: 'Courier New', monospace; /* åƒç´ æ„Ÿå­—ä½“ */
        position: relative;
        transition: all 0.1s;
      }
      /* é€‰ä¸­çŠ¶æ€ï¼šå˜æˆå®å¿ƒåƒç´ å— */
      .cute-tab-btn.active {
        background: #ffc6d9;
        color: #fff;
        /* åƒç´ åç§»æ•ˆæœ */
        box-shadow: 3px 3px 0px #ff8fab;
        transform: translate(-1px, -1px);
      }
      .cute-tab-btn.active::after {
        content: 'â™¥';
        position: absolute;
        top: -6px;
        right: -6px;
        font-size: 10px;
        color: #ff8fab;
        transform: rotate(15deg);
      }

      /* 4. å†…å®¹åŒºåŸŸ */
      .cute-tab-content {
        display: none;
        padding: 15px 20px 25px 20px;
      }
      .cute-tab-content.active {
        display: block;
      }

      /* 5. è¾“å…¥æ¡†ï¼šLCD å±å¹•é£æ ¼ */
      .cute-input-group {
        margin-bottom: 12px;
      }
      .cute-label {
        font-size: 12px;
        color: #ff9aa2;
        font-weight: bold;
        margin-bottom: 5px;
        background: #fff;
        display: inline-block;
        padding: 2px 8px;
        border-radius: 8px;
        border: 1px solid #ffc6d9;
      }
      .cute-input,
      .cute-textarea {
        width: 100%;
        padding: 12px;
        /* ç¨å¾®æ·±ä¸€ç‚¹çš„èƒŒæ™¯ï¼Œåƒå±å¹• */
        background: #fff0f5;
        border: 2px solid #ffc6d9;
        border-radius: 15px;
        outline: none;
        color: #666;
        font-size: 13px;
        font-family: 'Courier New', monospace;
        /* å†…é˜´å½±ï¼Œå¢åŠ å‡¹é™·æ„Ÿ */
        box-shadow: inset 2px 2px 5px rgba(255, 198, 217, 0.4);
      }
      .cute-input:focus {
        background: #fff;
        border-color: #a0c4ff; /* èšç„¦å˜è“ */
      }
      .cute-textarea {
        min-height: 80px;
        resize: none;
      }

      /* 6. ä¸»æŒ‰é’®ï¼šåƒä¸€å—ç³–æœ */
      .cute-btn-primary {
        width: 100%;
        background: #a0c4ff; /* å¥¶è“è‰² */
        border: 2px solid #fff;
        color: #fff;
        padding: 12px;
        border-radius: 16px;
        font-weight: bold;
        font-size: 14px;
        cursor: pointer;
        margin-top: 8px;
        /* ç³–æœé«˜å…‰ + ç¡¬é˜´å½± */
        box-shadow: inset 3px 3px 0px rgba(255, 255, 255, 0.4), /* å†…éƒ¨é«˜å…‰ */ 4px 4px 0px #749bc2; /* å¤–éƒ¨ç¡¬é˜´å½± */
        transition: transform 0.1s, box-shadow 0.1s;
        text-shadow: 1px 1px 0px #749bc2;
      }
      .cute-btn-primary:active {
        transform: translate(4px, 4px);
        box-shadow: inset 3px 3px 0px rgba(255, 255, 255, 0.4), 0px 0px 0px transparent;
      }

      /* --- æ‰¾åˆ°è¿™å—ä»£ç è¿›è¡Œä¿®æ”¹ --- */

      /* 7. å­—ä½“åˆ—è¡¨å®¹å™¨ */
      .font-list-container {
        max-height: 260px;
        overflow-y: auto;
        display: flex;
        flex-direction: column;
        gap: 12px;
        padding-right: 0; /* ä¿®æ”¹ï¼šä¸éœ€è¦ç»™æ»šåŠ¨æ¡ç•™ä½ç½®äº† */
        padding-top: 15px; /* ä¹‹å‰åŠ çš„é˜²é®æŒ¡é—´è·ä¿æŒä¸å˜ */

        /* â–¼â–¼â–¼ æ–°å¢ï¼šéšè— Firefox æ»šåŠ¨æ¡ â–¼â–¼â–¼ */
        scrollbar-width: none;
      }

      /* â–¼â–¼â–¼ ä¿®æ”¹ï¼šéšè— Chrome/Safari æ»šåŠ¨æ¡ â–¼â–¼â–¼ */
      .font-list-container::-webkit-scrollbar {
        display: none; /* ç›´æ¥éšè— */
      }
      /* ä¸‹é¢è¿™ä¸¤æ®µå…³äº track å’Œ thumb çš„ä»£ç å¯ä»¥åˆ æ‰æˆ–è€…æ³¨é‡Šæ‰ï¼Œå› ä¸ºå·²ç» display:none äº† */
      /* 
.font-list-container::-webkit-scrollbar-track { background: transparent; }
.font-list-container::-webkit-scrollbar-thumb { background: #FFC6D9; border-radius: 10px; }
*/

      /* â–¼â–¼â–¼ æ–°å¢ï¼šèŒç³»æ»‘å—æ ·å¼ (ç”¨äºå­—ä½“å¤§å°è°ƒæ•´) â–¼â–¼â–¼ */
      .cute-range-container {
        margin-bottom: 15px;
        background: #fff0f5;
        border: 2px dashed #ffc6d9;
        border-radius: 15px;
        padding: 10px 15px;
      }
      .cute-range-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 5px;
        font-size: 12px;
        font-weight: bold;
        color: #ff8fab;
      }
      .cute-range {
        -webkit-appearance: none;
        width: 100%;
        background: transparent;
      }
      .cute-range:focus {
        outline: none;
      }
      /* æ»‘å—è½¨é“ */
      .cute-range::-webkit-slider-runnable-track {
        width: 100%;
        height: 8px;
        cursor: pointer;
        background: #fff;
        border-radius: 4px;
        border: 1px solid #ffc6d9;
      }
      /* æ»‘å—æŒ‰é’® */
      .cute-range::-webkit-slider-thumb {
        -webkit-appearance: none;
        height: 16px;
        width: 16px;
        border-radius: 50%;
        background: #ff8fab;
        border: 2px solid #fff;
        box-shadow: 2px 2px 0px #ffc6d9;
        margin-top: -5px; /* å±…ä¸­ */
        cursor: pointer;
        transition: transform 0.1s;
      }
      .cute-range::-webkit-slider-thumb:hover {
        transform: scale(1.2);
      }
      /* â–²â–²â–² æ–°å¢ç»“æŸ â–²â–²â–² */

      /* 8. å­—ä½“å¡ç‰‡ï¼šåƒç´ é£ç¥¨æ® */
      .font-card {
        background: #fff;
        border: 2px dashed #ffc6d9; /* è™šçº¿è¾¹æ¡† */
        border-radius: 18px;
        padding: 12px;
        position: relative;
        transition: all 0.2s;
      }

      .font-card:hover {
        background: #fff9fb;
        border-color: #ff9aa2;
        transform: scale(1.02);
      }

      /* æ¿€æ´»çŠ¶æ€ */
      .font-card.active {
        background: #ebf8ff; /* æ·¡è“è‰²èƒŒæ™¯ */
        border: 2px solid #a0c4ff; /* å®çº¿è“è¾¹æ¡† */
        box-shadow: 4px 4px 0px #c6e4f5; /* è“è‰²ç¡¬é˜´å½± */
      }
      /* å³ä¸Šè§’çš„â€œä½¿ç”¨ä¸­â€æ ‡ç­¾ */
      .font-card.active::before {
        content: 'Current';
        position: absolute;
        top: -8px;
        right: 10px;
        background: #a0c4ff;
        color: #fff;
        font-size: 10px;
        padding: 2px 6px;
        border-radius: 6px;
        border: 2px solid #fff;
        transform: rotate(5deg);
        z-index: 2;
      }

      .font-name-tag {
        font-size: 13px;
        font-weight: bold;
        color: #ff8fab;
        display: flex;
        align-items: center;
        gap: 5px;
      }
      /* ç»™æ ‡é¢˜åŠ ä¸ªå°åœ†ç‚¹è£…é¥° */
      .font-name-tag::before {
        content: '';
        display: inline-block;
        width: 8px;
        height: 8px;
        background: #ffc6d9;
        border-radius: 50%;
      }

      .font-preview-text {
        font-size: 15px;
        color: #888;
        margin-top: 8px;
        padding: 5px;
        /* æ–‡å­—åŒºåŸŸèƒŒæ™¯ */
        background: rgba(0, 0, 0, 0.03);
        border-radius: 8px;
      }

      .font-card-footer {
        display: flex;
        justify-content: flex-end;
        gap: 6px;
        margin-top: 8px;
      }

      /* å°æŒ‰é’®ï¼šæ–¹å—æ„Ÿ */
      .mini-btn {
        padding: 4px 10px;
        border-radius: 8px;
        font-size: 11px;
        border: 1px solid transparent;
        cursor: pointer;
        font-weight: bold;
        font-family: 'Courier New', monospace;
      }
      .mini-btn.apply {
        background: #fff;
        border: 1px solid #a0c4ff;
        color: #a0c4ff;
      }
      .mini-btn.apply:hover {
        background: #a0c4ff;
        color: #fff;
      }
      .mini-btn.delete {
        background: #fff;
        border: 1px solid #ffb7b2;
        color: #ffb7b2;
      }
      .mini-btn.delete:hover {
        background: #ffb7b2;
        color: #fff;
      }

      /* æ‰¹é‡æç¤ºæ¡† */
      .batch-tip {
        font-size: 11px;
        color: #999;
        background: #fff;
        padding: 10px;
        border-radius: 12px;
        margin-bottom: 10px;
        text-align: center;
        border: 2px dotted #cfd8dc;
        line-height: 1.6;
      }
      code {
        background: #eee;
        padding: 2px 4px;
        border-radius: 4px;
        color: #555;
        font-family: monospace;
      }

    </style>
  </head>
  <body>
    <div class="phone-screen">
      <!-- é¡¶éƒ¨çŠ¶æ€æ  (ä¿æŒä¸å˜) -->
      <div class="status-bar glass-bubble">
        <span class="battery">92%</span>
        <span class="separator">|</span>
        <span class="time" id="current-time">10:25:00</span>
      </div>

      <!-- æœç´¢æ  (ä¿æŒä¸å˜) -->
      <div class="main-info-bar glass-bubble">
        <div id="profileDot" class="profile-dot"></div>
        <div class="input-area">
          <input id="mainChatInput" type="text" placeholder="å’ŒAIèŠç‚¹ä»€ä¹ˆ..." />
          <div class="date-capsule" id="current-date">11æœˆ8æ—¥ æ˜ŸæœŸäº”</div>
        </div>
        <div class="lock-widget">
          <svg class="heart-lock" viewBox="0 0 24 24">
            <path
              d="M12.1 18.55l-1.45-1.32C5.4 12.36 2 9.28 2 5.5 2 3.5 3.5 2 5.5 2c1.84 0 3.54.99 4.5 2.5C14.96 2.99 16.66 2 18.5 2 20.5 2 22 3.5 22 5.5c0 3.78-3.4 6.86-8.55 11.73l-1.35 1.32z"
            ></path>
          </svg>
          <span class="temperature">15Â°</span>
        </div>
      </div>

      <!-- ç¬¬ä¸€è¡Œå†…å®¹åŒºï¼šå·¦ä¾§æ”¾ç»„ä»¶ï¼Œå³ä¾§æ”¾QQç­‰å›¾æ ‡ -->
      <div class="content-section">
        <!-- å·¦ä¾§é¢æ¿ -->
        <div class="left-panel">
          <div class="polaroid-widget-container">
            
            <!-- 1. æ‹ç«‹å¾— (å¤§å›¾) -->
            <!-- id="polaroidMainBox" ç”¨äºç»‘å®šç‚¹å‡»äº‹ä»¶ -->
            <div class="polaroid-card" id="polaroidMainBox">
              <div class="polaroid-inner">
                <!-- id="polaroidMainImg" ç”¨äºæ˜¾ç¤ºå›¾ç‰‡ -->
                <img id="polaroidMainImg" src="https://picsum.photos/id/64/300/400" alt="polaroid">
              </div>
              <div class="polaroid-footer">
                <!-- åŠ äº† id="polaroidText" -->
<span id="polaroidText" class="polaroid-text">á—œ ğ‹£ á—œ à²£</span>

              </div>
            </div>

            <!-- 2. èƒ¶å· (ä¸‰å¼ å°å›¾) -->
            <div class="film-strip">
              <div class="film-frame" id="filmFrame1">
                <img id="filmImg1" src="https://picsum.photos/id/100/100" alt="film1">
              </div>
              <div class="film-frame" id="filmFrame2">
                <img id="filmImg2" src="https://picsum.photos/id/101/100" alt="film2">
              </div>
              <div class="film-frame" id="filmFrame3">
                <img id="filmImg3" src="https://picsum.photos/id/102/100" alt="film3">
              </div>
            </div>

          </div>
        </div>

        <!-- å³ä¾§é¢æ¿ï¼šç°åœ¨æ”¾QQã€ä¸–ç•Œä¹¦ç­‰å›¾æ ‡ (åŸå…ˆåœ¨å·¦è¾¹) -->
        <div class="right-panel">
          <div class="app-grid">
            <div class="app-container" data-app-id="app1">
              <!-- èŠå¤© (QQ) -->
              <a href="#" class="app-icon"
                ><img src="https://i.postimg.cc/Gh5gh5hK/c3f30de7397cac502c29085c6d1fff58.jpg" alt="app"
              /></a>
              <span class="app-name">QQ</span>
            </div>
            <div class="app-container" data-app-id="app2">
              <!-- ä¸–ç•Œä¹¦ -->
              <a href="#" id="worldBookAppBtn" class="app-icon"
                ><img src="https://i.postimg.cc/1zcK6Cs5/797b8218855b9e006a4cd857831c858e.png" alt="app"
              /></a>
              <span class="app-name">ä¸–ç•Œä¹¦</span>
            </div>

            <div class="app-container" data-app-id="app3">
              <!-- å¤–è§‚è®¾ç½® -->
              <a href="#" id="settingsBtn" class="app-icon"
                ><img src="https://i.postimg.cc/wMSNnLgk/d8a163f79ce90d0f6f601cb8592181cf.jpg" alt="app"
              /></a>
              <span class="app-name">å¤–è§‚è®¾ç½®</span>
            </div>
            <div class="app-container" data-app-id="app4">
              <!-- APIè®¾ç½® -->
              <a href="#" id="apiSettingsBtn" class="app-icon"
                ><img src="https://i.postimg.cc/mrQmjZNP/755833b3720f2479fbdbc98eca523cfa.png" alt="app"
              /></a>
              <span class="app-name">APIè®¾ç½®</span>
            </div>
          </div>
        </div>
      </div>

      <!-- ç¬¬äºŒè¡Œå†…å®¹åŒºï¼šå·¦ä¾§æ”¾å­—ä½“ç­‰å›¾æ ‡ï¼Œå³ä¾§æ”¾å›¾ç‰‡ç»„ä»¶ -->
      <div class="content-section">
        <!-- å·¦ä¾§é¢æ¿ï¼šç°åœ¨æ”¾å­—ä½“ã€ä¸€èµ·å¬ç­‰å›¾æ ‡ (åŸå…ˆåœ¨å³è¾¹) -->
        <div class="left-panel">
          <div class="app-grid">
            <div class="app-container" data-app-id="app5">
              <!-- å­—ä½“ -->
              <a href="#" class="app-icon"
                ><img src="https://i.postimg.cc/C5tCY9HQ/d89e4fe200f3165695eb9aff60277ea3.jpg" alt="app"
              /></a>
              <span class="app-name">å­—ä½“</span>
            </div>
            <div class="app-container" data-app-id="app6">
              <!-- ä¸€èµ·å¬ -->
              <a href="#" class="app-icon"
                ><img src="https://i.postimg.cc/wTC5r8Bz/398450fc25bcfa069b095c6a37fa0306.jpg" alt="app"
              /></a>
              <span class="app-name">ä¸€èµ·å¬</span>
            </div>
            <div class="app-container" data-app-id="app7">
              <!-- æ—¥è®° -->
              <a href="#" class="app-icon"
                ><img src="https://i.postimg.cc/FKQZY5tV/27a6afe6f542ad1a3018334ad00ccb97.png" alt="app"
              /></a>
              <span class="app-name">æ—¥è®°</span>
            </div>
            <div class="app-container" data-app-id="app8">
              <!-- æœ‹å‹åœˆ -->
              <a href="#" class="app-icon"
                ><img src="https://i.postimg.cc/1z6jdrSk/ae0f79fe032dcfc3484774cd44b06209.png" alt="app"
              /></a>
              <span class="app-name">æœ‹å‹åœˆ</span>
            </div>
          </div>
        </div>

        <!-- å³ä¾§é¢æ¿ï¼šç°åœ¨æ”¾å›¾ç‰‡ä¸Šä¼ /å°ç»„ä»¶ (åŸå…ˆåœ¨å·¦è¾¹) -->
        <div class="right-panel">
          <div class="image-uploader glass-bubble">
            <div id="imagePlaceholder" class="image-placeholder"></div>
            <input id="imageDescriptionInput" type="text" placeholder="ä¸ºå›¾ç‰‡æ·»åŠ æè¿°..." />
          </div>
        </div>
      </div>
    </div>

    <script>
      const db = new Dexie('MyPhoneSettingsDB');
      db.version(8) // â–¼â–¼â–¼ ç‰ˆæœ¬å·å‡çº§åˆ° 8 â–¼â–¼â–¼
        .stores({
          userSettings: '&id',
          userProfilePresets: '++id',
          chatBubblePresets: '++id, name',
          userStickers: '++id, &url, category',
          worldBooks: '++id, &name',
          giftShopItems: '++id, &name',
          apiPresets: '&name',
          customFonts: '++id, &name', // â–¼â–¼â–¼ æ–°å¢ï¼šå­—ä½“è¡¨ â–¼â–¼â–¼
        })
        .upgrade(tx => {});

      document.addEventListener('DOMContentLoaded', () => {
        // --- å…ƒç´ è·å– ---
        const phoneScreen = document.querySelector('.phone-screen');
        const timeElement = document.getElementById('current-time');
        const dateElement = document.getElementById('current-date');
        const fileInput = document.getElementById('imageFileInput');
        const qqContactsPage = document.getElementById('qq-contacts-page');
        const qqChatPage = document.getElementById('qq-chat-page');
        // å¼¹çª—
        const imageChoiceModal = document.getElementById('imageChoiceModal');
        const textEditModal = document.getElementById('textEditModal');
        const settingsModal = document.getElementById('settingsModal');
        const editAppModal = document.getElementById('editAppModal');
        // æ–°å¢ï¼šè·å–APIè®¾ç½®å¼¹çª—
        const apiSettingsModal = document.getElementById('apiSettingsModal');
        const bubbleEditorModal = document.getElementById('bubbleEditorModal');
        const groupManagementModal = document.getElementById('groupManagementModal');
        const deleteGroupConfirmModal = document.getElementById('deleteGroupConfirmModal');
        const chatToolbarToggle = document.getElementById('chat-toolbar-toggle');
        const chatToolbarPanel = document.getElementById('chat-toolbar-panel');
        const userStickerPanel = document.getElementById('user-sticker-panel');
        const toolbarStickerBtn = document.getElementById('toolbar-sticker-btn');
        const sendImageChoiceModal = document.getElementById('sendImageChoiceModal');
        const toolbarImageBtn = document.getElementById('toolbar-image-btn');
        // â–¼â–¼â–¼ åœ¨è¿™é‡Œæ·»åŠ  â–¼â–¼â–¼
        const textImageModal = document.getElementById('textImageModal');
        const textImageDescriptionInput = document.getElementById('textImageDescriptionInput');
        // â–²â–²â–² æ·»åŠ ç»“æŸ â–²â–²â–²
        const videoCallScreen = document.getElementById('video-call-screen');
        const videoCallInviteModal = document.getElementById('video-call-invite-modal');
        const toolbarVideoCallBtn = document.getElementById('toolbar-video-call-btn');
        const toolbarGiftBtn = document.getElementById('toolbar-gift-btn');
        const giftShopPage = document.getElementById('gift-shop-page');
        const shoppingCartModal = document.getElementById('shopping-cart-modal');
        // --- çŠ¶æ€å˜é‡ ---
        let currentEditingTarget = null;
        let tempSettings = {};
        let currentSettings = {};
        let currentEditingAppId = null;
        let currentZIndex = 2001;
        let userProfilePresets = []; // æ–°å¢ï¼šç”¨äºå­˜å‚¨ç”¨æˆ·äººè®¾é¢„è®¾
        let currentGroupToDelete = null; // ç”¨äºè®°å½•å½“å‰è¦åˆ é™¤çš„åˆ†ç»„å
        // æ–°å¢ï¼šAPIé¢„è®¾çš„çŠ¶æ€å˜é‡
        let apiPresets = {};
        let chatData = {}; // ã€æ–°å¢ã€‘å­˜å‚¨æ‰€æœ‰èŠå¤©æ•°æ®çš„æ ¸å¿ƒå¯¹è±¡
        let currentChatId = null; // ã€æ–°å¢ã€‘è®°å½•å½“å‰æ­£åœ¨èŠå¤©çš„è§’è‰²ID
        let commonStickers = []; // å­˜å‚¨é€šç”¨è¡¨æƒ…åŒ…
        let currentEditingNpcId = null; // è®°å½•æ­£åœ¨ç¼–è¾‘çš„NPCçš„ID
        let currentNpcEditMode = 'create'; // 'create' æˆ– 'select'
        let bubblePresets = []; // å­˜å‚¨æ‰€æœ‰æ°”æ³¡é¢„è®¾
        let currentAppliedBubbleStyleTag = null; // ç”¨äºå­˜å‚¨åŠ¨æ€åˆ›å»ºçš„styleæ ‡ç­¾
        let currentVisualTarget = 'char'; // 'char' æˆ– 'user'
        let visualEditorState = {}; // ç”¨äºå­˜å‚¨å¯è§†åŒ–ç¼–è¾‘å™¨çš„çŠ¶æ€
        let groupSettings = {};
        let userStickers = []; // å­˜å‚¨ç”¨æˆ·ä¸“å±è¡¨æƒ…åŒ…
        let isToolbarOpen = false;
        let isStickerPanelOpen = false;
        let isUserStickerManageMode = false; // ç”¨æˆ·è¡¨æƒ…åŒ…ç®¡ç†æ¨¡å¼
        let activeUserStickerCategory = 'æœªåˆ†ç±»'; // å½“å‰æ¿€æ´»çš„ç”¨æˆ·è¡¨æƒ…åˆ†ç±»
        let categoryToDelete = null;
        let isVideoCallActive = false;
        let isSmallViewUser = true; // true: å°çª—æ˜¯ç”¨æˆ·, å¤§çª—æ˜¯è§’è‰²
        let callTimerInterval = null; // ç”¨äºå­˜æ”¾è®¡æ—¶å™¨çš„ID
        let callStartTime = 0; // ç”¨äºè®°å½•é€šè¯å¼€å§‹æ—¶é—´
        let currentCallTranscript = [];
        let pendingCallInfo = null;
        let giftShopItems = []; // å­˜å‚¨ç¤¼ç‰©å•†åº—çš„å•†å“
        let shoppingCart = []; // å­˜å‚¨è´­ç‰©è½¦ä¸­çš„å•†å“
        let currentApiConfig = {}; // ã€æ–°å¢ã€‘ç”¨äºå­˜å‚¨å½“å‰ç”Ÿæ•ˆçš„APIé…ç½®
        // ã€æ–°å¢ã€‘è¿™ä¸ªè¾…åŠ©å‡½æ•°
        const fileToBase64 = file =>
          new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = () => resolve(reader.result);
            reader.onerror = error => reject(error);
          });

        // --- é»˜è®¤è®¾ç½® ---
        const defaultSettings = {
          wallpaper: '',

          // 1. èƒŒæ™¯ä¿æŒç™½è‰²
          backgroundColor: '#ffffff',

          // 2. âš ï¸ å­—ä½“å¿…é¡»æ”¹æˆé»‘è‰²ï¼Œå¦åˆ™åœ¨ç™½èƒŒæ™¯ä¸Šçœ‹ä¸è§
          fontColor: '#000000', // <--- åŸæ¥æ˜¯ #f0f0f0 (ç™½)ï¼Œè¯·æ”¹æˆ #000000 (é»‘)

          // 3. âš ï¸ ç»„ä»¶é¢œè‰²å»ºè®®æ”¹æˆé»‘è‰²ï¼Œé…åˆé€æ˜åº¦å˜æˆæµ…ç°è‰²
          // å¦‚æœè¿™é‡Œå¡«ç™½è‰²ï¼Œåœ¨ç™½è‰²èƒŒæ™¯ä¸Šå°±æ˜¯â€œéšå½¢â€çš„
          bubbleColor: '#000000', // <--- åŸæ¥æ˜¯ #ffffff (ç™½)ï¼Œå»ºè®®æ”¹æˆ #000000 (é»‘)

          bubbleOpacity: 0.1, // é»‘è‰² + 0.1é€æ˜åº¦ = æ·¡æ·¡çš„ç°è‰²èƒŒæ™¯ï¼Œå¾ˆé€‚åˆç™½åº•

          apps: {},
        };

        // ã€æ¢å¤å¹¶æ·»åŠ ã€‘è¿™ä¸ª IndexedDB è¾…åŠ©æ¨¡å—
        // --- Part 1: è®¾ç½®åŠ è½½ä¸åº”ç”¨ ---
        /**
         * æ ¼å¼åŒ–ç§’æ•°ä¸º MM:SS æ ¼å¼
         * @param {number} totalSeconds - æ€»ç§’æ•°
         * @returns {string} æ ¼å¼åŒ–åçš„æ—¶é—´å­—ç¬¦ä¸²
         */
        function formatCallTime(totalSeconds) {
          const minutes = Math.floor(totalSeconds / 60)
            .toString()
            .padStart(2, '0');
          const seconds = Math.floor(totalSeconds % 60)
            .toString()
            .padStart(2, '0');
          return `${minutes}:${seconds}`;
        }
        // â–¼â–¼â–¼ æ ¸å¿ƒä¿®æ”¹ 2: ä¿®æ”¹è®¾ç½®åŠ è½½å‡½æ•°ï¼Œä» IndexedDB è¯»å– â–¼â–¼â–¼
        async function loadSettings() {
          // ä½¿ç”¨ await ä»æ•°æ®åº“è·å– id ä¸º 'main' çš„è®¾ç½®å¯¹è±¡
          let savedSettings = (await db.userSettings.get('main')) || {};
          if (!savedSettings.apps) savedSettings.apps = {};

          document.querySelectorAll('.app-container').forEach(app => {
            const id = app.dataset.appId;
            if (!savedSettings.apps[id]) {
              savedSettings.apps[id] = {
                name: app.querySelector('.app-name').textContent,
                icon: app.querySelector('img').src,
              };
            }
          });
          // è¿”å›åˆå¹¶åçš„è®¾ç½®ï¼Œç¡®ä¿æ–°ç”¨æˆ·ä¹Ÿæœ‰é»˜è®¤å€¼
          return { ...defaultSettings, ...savedSettings };
        }
        // â–²â–²â–² ä¿®æ”¹ç»“æŸ â–²â–²â–²

        // --- Part 1.5: èŠå¤©æ•°æ®ç®¡ç† ---

        async function loadChatData() {
          // ä» IndexedDB è¯»å– id ä¸º 'chatData' çš„è®°å½•
          const savedDataObject = await db.userSettings.get('chatData');
          // å¦‚æœè®°å½•å­˜åœ¨ï¼Œåˆ™ä½¿ç”¨å®ƒçš„ valueï¼Œå¦åˆ™ä½¿ç”¨ç©ºå¯¹è±¡
          const savedData = savedDataObject ? savedDataObject.value : {};
          for (const charId in savedData) {
            if (Object.hasOwnProperty.call(savedData, charId)) {
              // ç¡®ä¿è§’è‰²æœ‰ work å’Œ wallet
              const charSettings = savedData[charId].charSettings;
              if (!charSettings.work) {
                charSettings.work = { profession: '', schedule: '' };
              }
              if (!charSettings.wallet) {
                charSettings.wallet = { balance: 0, initialRange: '', lastSettlementDate: '', transactions: [] };
              } else if (!Array.isArray(charSettings.wallet.transactions)) {
                charSettings.wallet.transactions = [];
              }

              // ã€ã€ã€æ ¸å¿ƒæ–°å¢ã€‘ã€‘ã€‘ ç¡®ä¿ç”¨æˆ·æœ‰ work å’Œ wallet
              const userSettings = savedData[charId].userSettings;
              if (!userSettings.work) {
                userSettings.work = { profession: '' };
              }
              if (!userSettings.wallet) {
                userSettings.wallet = {
                  balance: 0,
                  dailySalary: 0,
                  initialBalance: 0,
                  lastSettlementDate: '',
                  transactions: [],
                };
              } else if (!Array.isArray(userSettings.wallet.transactions)) {
                userSettings.wallet.transactions = [];
              }
            }
          }
          // â–²â–²â–² æ·»åŠ ç»“æŸ â–²â–²â–²
          // ä¸ºå·²æœ‰çš„è”ç³»äººæä¾›é»˜è®¤æ•°æ®ï¼Œé˜²æ­¢å‡ºé”™ (è¿™éƒ¨åˆ†é€»è¾‘ä¿ç•™ä¸å˜)
          document.querySelectorAll('.contact-item').forEach(item => {
            const charId = item.dataset.charId;
            if (!savedData[charId]) {
              savedData[charId] = {
                charSettings: {
                  avatar: item.querySelector('.contact-avatar').src,
                  realName: item.querySelector('.contact-name').textContent.split('-')[1] || 'è§’è‰²',
                  nickname: item.querySelector('.contact-name').textContent,
                  gender: 'female',
                  persona: 'è¿™æ˜¯ä¸€ä¸ªé»˜è®¤è§’è‰²äººè®¾ã€‚',
                  maxMemory: 50,
                  // â–¼â–¼â–¼ åœ¨è¿™é‡Œæ·»åŠ æ–°çš„ä»£ç è¡Œ â–¼â–¼â–¼
                  minReplyMessages: 1,
                  maxReplyMessages: 2,
                  // â–²â–²â–² æ·»åŠ ç»“æŸ â–²â–²â–²
                  group: '',
                  worldBook: [],
                  npcs: [],
                  exclusiveStickers: [],
                  videoCallImage: '',
                  work: {
                    profession: '',
                    schedule: '',
                  },
                  wallet: {
                    balance: 0,
                    initialRange: '',
                    lastSettlementDate: '',
                    transactions: [],
                  },
                },

                userSettings: {
                  name: 'æˆ‘',
                  gender: 'male',
                  persona: 'æˆ‘æ˜¯ä¸€ä¸ªé»˜è®¤ç”¨æˆ·äººè®¾ã€‚',
                  avatar:
                    localStorage.getItem('profileAvatar') ||
                    'https://i.postimg.cc/ryn2xgwZ/5fc5b9ae74465344658ed8c7e508b8f5.jpg',
                  relationToChar: 'æœ‹å‹',
                  videoCallImage: '',
                  // â–¼â–¼â–¼ åœ¨ userSettings ä¸­æ·»åŠ ä¸‹é¢è¿™ä¸¤å— â–¼â–¼â–¼
                  work: {
                    profession: '',
                  },
                  wallet: {
                    balance: 0,
                    dailySalary: 0,
                    initialBalance: 0,
                    lastSettlementDate: '',
                    transactions: [],
                  },
                  // â–²â–²â–² æ·»åŠ ç»“æŸ â–²â–²â–²
                },
                history: [],
              };
            }
          });
          chatData = savedData;
          // æ³¨æ„ï¼šè¿™é‡Œæˆ‘ä»¬è°ƒç”¨ saveChatData() å˜æˆäº†ä¸€ä¸ªå¼‚æ­¥æ“ä½œ
          await saveChatData(); // ä½¿ç”¨ await ç¡®ä¿é»˜è®¤æ•°æ®è¢«æˆåŠŸä¿å­˜
        }

        async function saveChatData() {
          try {
            // ä½¿ç”¨ Dexie å°†æ•´ä¸ª chatData å¯¹è±¡å­˜å…¥ IndexedDB
            // æˆ‘ä»¬ç»™å®ƒä¸€ä¸ªå›ºå®šçš„ id 'chatData'ï¼Œæ–¹ä¾¿ä»¥åè¯»å–
            await db.userSettings.put({ id: 'chatData', value: chatData });
          } catch (error) {
            // æ•è·å¯èƒ½å‘ç”Ÿçš„é”™è¯¯ï¼Œæœ€å¸¸è§çš„è¿˜æ˜¯ç©ºé—´ä¸è¶³
            if (error.name === 'QuotaExceededError') {
              console.error('ä¿å­˜èŠå¤©æ•°æ®å¤±è´¥ï¼šIndexedDB å­˜å‚¨ç©ºé—´å·²æ»¡ã€‚', error);
              alert('ä¿å­˜å¤±è´¥ï¼å­˜å‚¨ç©ºé—´ä¸è¶³ã€‚è¿™å¯èƒ½å‘ç”Ÿåœ¨æµè§ˆå™¨å¤„äºéšç§æ¨¡å¼æˆ–è®¾å¤‡ç£ç›˜ç©ºé—´å·²æ»¡æ—¶ã€‚');
            } else {
              console.error('ä¿å­˜èŠå¤©æ•°æ®æ—¶å‘ç”ŸæœªçŸ¥é”™è¯¯ï¼š', error);
            }
          }
        }
        async function loadGroupSettings() {
          const savedSettings = await db.userSettings.get('groupSettings');
          // å¦‚æœæ•°æ®åº“é‡Œæœ‰ï¼Œå°±ç”¨ï¼›æ²¡æœ‰çš„è¯ï¼Œå°±åˆ›å»ºä¸€ä¸ªé»˜è®¤çš„
          groupSettings = savedSettings ? savedSettings.value : { é»˜è®¤åˆ†ç»„: { expanded: true } };
        }

        async function saveGroupSettings() {
          await db.userSettings.put({ id: 'groupSettings', value: groupSettings });
        }
        // â–²â–²â–² æ·»åŠ ç»“æŸ â–²â–²â–²
        function renderContactsList() {
          const list = document.querySelector('.contacts-list');
          list.innerHTML = ''; // 1. æ¸…ç©ºæ—§åˆ—è¡¨

          const groupedChars = {};
          const ungroupedChars = [];

          for (const charId in chatData) {
            if (Object.hasOwnProperty.call(chatData, charId)) {
              const char = chatData[charId];
              const groupName = char.charSettings.group;

              if (groupName) {
                if (!groupedChars[groupName]) {
                  groupedChars[groupName] = [];
                }
                groupedChars[groupName].push({ id: charId, ...char });
              } else {
                ungroupedChars.push({ id: charId, ...char });
              }
            }
          }

          const createContactItem = char => {
            const history = char.history;
            const lastMessage =
              history.length > 0 ? history[history.length - 1].content : 'æˆ‘ä»¬å·²ç»æ˜¯å¥½å‹äº†ï¼Œå¼€å§‹èŠå¤©å§ï¼';

            const contactItemWrapper = document.createElement('div');
            contactItemWrapper.className = 'contact-item-wrapper'; // æ–°å¢ä¸€ä¸ªå¤–å±‚å®¹å™¨

            contactItemWrapper.innerHTML = `
              <div class="contact-item-deletable">
                <div class="contact-item-content">
                  <img src="${char.charSettings.avatar}" alt="contact avatar" class="contact-avatar">
                  <div class="contact-info">
                    <span class="contact-name">${char.charSettings.nickname}</span>
                    <span class="contact-last-msg">${lastMessage.substring(0, 20)}</span>
                  </div>
                  <span class="contact-time"></span>
                </div>
                <button class="delete-char-btn">åˆ é™¤</button>
              </div>
            `;

            // æ‰¾åˆ°å†…å®¹åŒºåŸŸå¹¶ç»‘å®šèŠå¤©ç‚¹å‡»äº‹ä»¶
            const content = contactItemWrapper.querySelector('.contact-item-content');
            content.addEventListener('click', () => {
              currentChatId = char.id;
              renderChatPage(currentChatId);
              qqChatPage.classList.add('active');
            });

            // æ‰¾åˆ°åˆ é™¤æŒ‰é’®å¹¶ç»‘å®šåˆ é™¤äº‹ä»¶
            const deleteBtn = contactItemWrapper.querySelector('.delete-char-btn');
            deleteBtn.addEventListener('click', e => {
              e.stopPropagation(); // é˜²æ­¢è§¦å‘èŠå¤©
              if (confirm(`ç¡®å®šè¦åˆ é™¤è§’è‰² â€œ${char.charSettings.nickname}â€ å—ï¼Ÿ\næ­¤æ“ä½œä¸å¯æ¢å¤ï¼`)) {
                delete chatData[char.id];
                saveChatData().then(() => {
                  renderContactsList(); // åˆ é™¤åé‡æ–°æ¸²æŸ“æ•´ä¸ªåˆ—è¡¨
                });
              }
            });

            // ã€æ ¸å¿ƒã€‘ä¸ºå·¦æ»‘åŠŸèƒ½æ·»åŠ è§¦æ‘¸äº‹ä»¶ç›‘å¬
            let startX = 0;
            let currentX = 0;
            const deletableArea = contactItemWrapper.querySelector('.contact-item-deletable');

            content.addEventListener(
              'touchstart',
              e => {
                startX = e.touches[0].clientX;
                deletableArea.style.transition = 'none'; // æ»‘åŠ¨æ—¶ç§»é™¤è¿‡æ¸¡æ•ˆæœ
              },
              { passive: true },
            );

            content.addEventListener(
              'touchmove',
              e => {
                currentX = e.touches[0].clientX;
                const diffX = startX - currentX;
                if (diffX > 0 && diffX < 100) {
                  // åªå…è®¸å·¦æ»‘ï¼Œå¹¶é™åˆ¶æœ€å¤§æ»‘åŠ¨è·ç¦»
                  deletableArea.style.transform = `translateX(-${diffX}px)`;
                }
              },
              { passive: true },
            );

            content.addEventListener('touchend', e => {
              const diffX = startX - currentX;
              deletableArea.style.transition = 'transform 0.3s ease'; // ç»“æŸæ—¶æ¢å¤è¿‡æ¸¡æ•ˆæœ
              if (diffX > 40) {
                // æ»‘åŠ¨è¶…è¿‡40pxåˆ™å®Œå…¨æ»‘å¼€
                deletableArea.style.transform = 'translateX(-80px)';
              } else {
                // å¦åˆ™æ»‘å›å»
                deletableArea.style.transform = 'translateX(0)';
              }
              // é‡ç½®
              startX = 0;
              currentX = 0;
            });

            return contactItemWrapper;
          };

          // é¦–å…ˆæ¸²æŸ“æ‰€æœ‰æœªåˆ†ç»„çš„è”ç³»äºº
          for (const char of ungroupedChars) {
            list.appendChild(createContactItem(char));
          }

          // --- æ ¸å¿ƒä¿®æ”¹ï¼šå¤„ç†ç½®é¡¶æ’åº ---
          const allGroupNames = Object.keys(groupedChars);
          const pinnedGroups = allGroupNames.filter(name => groupSettings[name]?.pinned).sort();
          const unpinnedGroups = allGroupNames.filter(name => !groupSettings[name]?.pinned).sort();
          const sortedGroupNames = [...pinnedGroups, ...unpinnedGroups];
          // --- ä¿®æ”¹ç»“æŸ ---

          for (const groupName of sortedGroupNames) {
            const details = document.createElement('details');
            details.className = 'contact-group';
            details.open = groupSettings[groupName] ? groupSettings[groupName].expanded : true;

            details.addEventListener('toggle', event => {
              if (!groupSettings[groupName]) {
                groupSettings[groupName] = {};
              }
              groupSettings[groupName].expanded = event.target.open;
              saveGroupSettings();
            });

            const summary = document.createElement('summary');
            summary.className = 'contact-group-header';
            summary.innerHTML = `
              <div class="group-name-wrapper">
                <span class="group-toggle-icon">â–¶</span>
                <span>${groupName}</span>
              </div>
              <span class="group-member-count">${groupedChars[groupName].length}</span>
            `;
            details.appendChild(summary);

            for (const char of groupedChars[groupName]) {
              details.appendChild(createContactItem(char));
            }
            list.appendChild(details);
          }
        }

        // â–¼â–¼â–¼ ç”¨è¿™ä¸ªã€æ–°ç‰ˆæœ¬ã€‘æ›¿æ¢æ—§çš„ renderChatPage å‡½æ•° â–¼â–¼â–¼
        function renderChatPage(charId) {
          if (!chatData[charId]) return;

          const char = chatData[charId].charSettings;
          const user = chatData[charId].userSettings;

          // æ›´æ–°é¡¶éƒ¨å¤´åƒ
          document.getElementById('chat-char-avatar').src = char.avatar;
          document.getElementById('chat-user-avatar').src = user.avatar;

          // æ¸²æŸ“èŠå¤©è®°å½•
          renderChatMessages(charId);

          // åº”ç”¨è‡ªå®šä¹‰æ°”æ³¡æ ·å¼
          applyStylesToChatPage(charId);
        }

        // â–¼â–¼â–¼ ã€æ–°å¢ã€‘è¿™ä¸ªå…¨æ–°çš„å‡½æ•°ï¼Œç”¨äºæ¸²æŸ“èŠå¤©æ¶ˆæ¯ â–¼â–¼â–¼
        function renderChatMessages(charId) {
          const messagesContainer = document.querySelector('.chat-messages');
          if (!messagesContainer || !chatData[charId]) return;

          const { history, charSettings, userSettings } = chatData[charId];

          messagesContainer.innerHTML = history
            .map(msg => {
              if (msg.isSystemNotification) {
                return `
                  <div style="text-align: center; padding: 5px 0; margin-bottom: 10px;">
                    <span style="background-color: var(--capsule-nested-bg); color: var(--text-secondary-color); font-size: 12px; padding: 4px 10px; border-radius: 12px;">
                      ${msg.content.replace('[ç³»ç»Ÿæç¤ºï¼šæ˜¨æ—¥è´¢åŠ¡ç»“ç®—] ', '')}
                    </span>
                  </div>
                `;
              }
              const isUser = msg.role === 'user';
              const avatar = isUser ? userSettings.avatar : charSettings.avatar;
              const messageClass = isUser ? 'user-message' : 'char-message';

              let contentHTML = msg.content;

              // ç‰¹æ®Šå¤„ç†è¡¨æƒ…åŒ…
              if (contentHTML.startsWith('[sticker]')) {
                const url = contentHTML.replace('[sticker]', '').replace('[/sticker]', '');
                contentHTML = `<img src="${url}" class="message-sticker" style="max-width: 120px; background: transparent;">`;
              } else if (contentHTML.startsWith('[text_image')) {
                // ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼ä»æˆ‘ä»¬å®šä¹‰çš„æ ¼å¼ä¸­æå–æè¿°å’ŒURL
                const match = contentHTML.match(/\[text_image description="([^"]+)"](.*)\[\/text_image]/);
                if (match) {
                  const description = match[1];
                  const url = match[2];

                  // ç”Ÿæˆå¸¦ onclick äº‹ä»¶çš„å›¾ç‰‡HTML
                  // æ³¨æ„ï¼šä¸ºäº†å®‰å…¨åœ°å°†æè¿°ä¼ å…¥alertï¼Œæˆ‘ä»¬å¯¹å¼•å·å’Œæ¢è¡Œç¬¦è¿›è¡Œè½¬ä¹‰
                  // â–¼â–¼â–¼ æ ¸å¿ƒä¿®æ”¹åœ¨è¿™é‡Œ â–¼â–¼â–¼
                  const escapedDescription = description
                    .replace(/\\/g, '\\\\') // 1. å…ˆæ›¿æ¢åæ–œæ 
                    .replace(/'/g, "\\'") // 2. æ›¿æ¢å•å¼•å· (æœ€å…³é”®)
                    .replace(/"/g, '\\"') // 3. æ›¿æ¢åŒå¼•å·
                    .replace(/\n/g, '\\n'); // 4. æ›¿æ¢æ¢è¡Œç¬¦

                  // â–²â–²â–² ä¿®æ”¹ç»“æŸ â–²â–²â–²

                  contentHTML = `<img src="${url}" class="message-image" alt="æ–‡å­—å›¾" onclick="alert('å›¾ç‰‡æè¿°ï¼š\\n${escapedDescription}')" style="cursor: pointer;">`;
                }
              }

              // â–¼â–¼â–¼ åœ¨è¿™é‡Œæ·»åŠ æ–°çš„è¯­éŸ³å¤„ç†é€»è¾‘ â–¼â–¼â–¼
              else if (contentHTML.startsWith('[è¯­éŸ³]')) {
                const voiceText = contentHTML.replace('[è¯­éŸ³] ', '');
                // ä¸ºäº†å®‰å…¨åœ°åœ¨HTMLå±æ€§ä¸­ä½¿ç”¨ï¼Œæˆ‘ä»¬å¯¹æ–‡æœ¬ä¸­çš„å¼•å·è¿›è¡Œè½¬ä¹‰
                const escapedVoiceText = voiceText.replace(/"/g, '&quot;').replace(/'/g, '&#39;');

                // ç”ŸæˆåŒ…å«æ³¢çº¹å’Œéšè—æ–‡å­—çš„å¤æ‚ç»“æ„
                contentHTML = `
                    <div class="voice-message-container" onclick="toggleVoiceTranscript(this)" data-transcript="${escapedVoiceText}">
                        <span class="voice-icon">ğŸ™ï¸</span>
                        <div class="voice-waveform">
                            <span></span><span></span><span></span><span></span><span></span><span></span><span></span>
                        </div>
                    </div>
                    <p class="voice-transcript">${voiceText}</p>
                  `;
              }
              // â–²â–²â–² æ·»åŠ ç»“æŸ â–²â–²â–²
              // â–¼â–¼â–¼ åœ¨è¿™é‡Œæ·»åŠ æ–°çš„ else if ä»£ç å— â–¼â–¼â–¼
              else if (contentHTML.startsWith('[è§†é¢‘é€šè¯]')) {
                const durationText = contentHTML.replace('[è§†é¢‘é€šè¯] ', '');
                const callLogId = msg.callLogId; // è·å–æˆ‘ä»¬ä¹‹å‰å­˜çš„ID

                // ç”Ÿæˆä¸€ä¸ªå¯ç‚¹å‡»çš„å¡ç‰‡HTML
                contentHTML = `
        <div class="video-call-card" onclick="showCallTranscript('${charId}', ${callLogId})">
            <span class="video-call-card-icon">ğŸ“¹</span>
            <div class="video-call-card-info">
                <p>è§†é¢‘é€šè¯å·²ç»“æŸ</p>
                <span>${durationText}</span>
            </div>
        </div>
    `;
              } else if (msg.type === 'transfer') {
                // ã€æ ¸å¿ƒä¿®æ­£ã€‘åœ¨è¿™é‡Œå¢åŠ ä¸€ä¸ªå®‰å…¨æ£€æŸ¥
                if (msg.transferDetails) {
                  // åªæœ‰å½“è½¬è´¦è¯¦æƒ…å­˜åœ¨æ—¶ï¼Œæ‰å»æ¸²æŸ“å¡ç‰‡
                  contentHTML = generateTransferCardHTML(msg.transferDetails, msg.role);
                } else {
                  // å¦‚æœæ•°æ®ä¸å®Œæ•´ï¼Œæ˜¾ç¤ºä¸€æ¡æç¤ºä¿¡æ¯ï¼Œé¿å…ç¨‹åºå´©æºƒ
                  console.warn('å‘ç°ä¸€æ¡ä¸å®Œæ•´çš„è½¬è´¦æ¶ˆæ¯ï¼Œå·²è·³è¿‡æ¸²æŸ“:', msg);
                  contentHTML = `[ä¸€æ¡æ— æ•ˆçš„è½¬è´¦è®°å½•]`;
                }
              } else if (msg.type === 'gift') {
                const details = msg.giftDetails;
                const itemsHTML = details.items.map(item => `<li>- ${item.name}</li>`).join('');
                contentHTML = `
                      <div class="gift-card">
                          <div class="gift-card-header">
                              <span class="gift-icon">ğŸ</span>
                              <p>é€ç»™ Ta çš„ä¸€ä»½å¿ƒæ„</p>
                          </div>
                          <div class="gift-card-body">
                              <ul>${itemsHTML}</ul>
                          </div>
                      </div>
                  `;
              }
              // â–²â–²â–² æ·»åŠ ç»“æŸ â–²â–²â–²
              return `
      <div class="message ${messageClass}">
        ${!isUser ? `<img src="${avatar}" class="message-avatar" alt="avatar">` : ''}
        <div class="message-content">
            ${contentHTML}
        </div>
        ${isUser ? `<img src="${avatar}" class="message-avatar" alt="avatar">` : ''}
      </div>
    `;
            })
            .join('');

          // æ»šåŠ¨åˆ°åº•éƒ¨
          messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        // --- Part 1: è®¾ç½®åŠ è½½ä¸åº”ç”¨ ---

        function loadSettingsFromLocalStorage() {
          let savedSettings = JSON.parse(localStorage.getItem('userSettings')) || {};
          if (!savedSettings.apps) savedSettings.apps = {};
          document.querySelectorAll('.app-container').forEach(app => {
            const id = app.dataset.appId;
            if (!savedSettings.apps[id]) {
              savedSettings.apps[id] = {
                name: app.querySelector('.app-name').textContent,
                icon: app.querySelector('img').src,
              };
            }
          });
          return { ...defaultSettings, ...savedSettings };
        }

        function applySettings(settings) {
          phoneScreen.style.backgroundImage = settings.wallpaper ? `url(${settings.wallpaper})` : 'none';
          // â–¼â–¼â–¼ æ–°å¢ï¼šåº”ç”¨èƒŒæ™¯é¢œè‰² â–¼â–¼â–¼
          if (settings.backgroundColor) {
            document.documentElement.style.setProperty('--primary-bg', settings.backgroundColor);
          }
          // â–²â–²â–² æ–°å¢ç»“æŸ â–²â–²â–²
          document.documentElement.style.setProperty('--text-color', settings.fontColor);
          const rgb = hexToRgb(settings.bubbleColor);
          if (rgb) {
            const bubbleBg = `rgba(${rgb.r}, ${rgb.g}, ${rgb.b}, ${settings.bubbleOpacity})`;
            document.documentElement.style.setProperty('--capsule-bg', bubbleBg);
          }
          for (const id in settings.apps) {
            const appElement = document.querySelector(`.app-container[data-app-id="${id}"]`);
            if (appElement) {
              appElement.querySelector('.app-name').textContent = settings.apps[id].name;
              appElement.querySelector('img').src = settings.apps[id].icon;
            }
          }
        }
        // â–¼â–¼â–¼ æ ¸å¿ƒä¿®æ”¹ 3: ä¿®æ”¹è®¾ç½®ä¿å­˜å‡½æ•°ï¼Œå†™å…¥ IndexedDB â–¼â–¼â–¼
        async function saveSettings(settings) {
          try {
            // ä¸ºè¦ä¿å­˜çš„å¯¹è±¡è®¾ç½®ä¸€ä¸ªå›ºå®šçš„IDï¼Œæ–¹ä¾¿æˆ‘ä»¬ä»¥åè¯»å–
            settings.id = 'main';
            // ä½¿ç”¨ await å°†æ•°æ®å­˜å…¥æ•°æ®åº“
            await db.userSettings.put(settings);
            console.log('Settings saved to IndexedDB successfully.');
          } catch (error) {
            console.error('Failed to save settings to IndexedDB:', error);
            // å¦‚æœä¿å­˜åˆ°IndexedDBä¹Ÿå¤±è´¥äº†ï¼ˆè™½ç„¶å¯èƒ½æ€§æä½ï¼‰ï¼Œç»™ç”¨æˆ·ä¸€ä¸ªæç¤º
            alert(`ä¿å­˜è®¾ç½®å¤±è´¥: ${error.message}`);
          }
        }
        // --- Part 2: å¼¹çª—æ§åˆ¶ä¸æ•°æ®å¡«å…… ---

        const showModal = modal => {
          currentZIndex++;
          modal.style.zIndex = currentZIndex;
          modal.style.display = 'flex';
          setTimeout(() => modal.classList.add('show'), 10);
        };
        const hideModal = modal => {
          modal.classList.remove('show');
          setTimeout(() => {
            modal.style.display = 'none';
            if (parseInt(modal.style.zIndex) === currentZIndex) {
              currentZIndex--;
              if (currentZIndex < 2001) currentZIndex = 2001;
            }
          }, 300);
        };

        function openSettingsModal() {
          tempSettings = JSON.parse(JSON.stringify(currentSettings));
          document.getElementById('wallpaperPreview').style.backgroundImage = tempSettings.wallpaper
            ? `url(${tempSettings.wallpaper})`
            : 'none';
          // â–¼â–¼â–¼ æ–°å¢ï¼šå¡«å……èƒŒæ™¯è‰²è¾“å…¥æ¡† â–¼â–¼â–¼
          // å¦‚æœæ—§æ•°æ®æ²¡æœ‰è¿™ä¸ªå­—æ®µï¼Œç»™ä¸ªé»˜è®¤é»‘è‰² #ffffff
          const currentBg = tempSettings.backgroundColor || '#ffffff';
          document.getElementById('bgColorPicker').value = currentBg;
          document.getElementById('bgColorInput').value = currentBg;
          // â–²â–²â–² æ–°å¢ç»“æŸ â–²â–²â–²
          document.getElementById('fontColorPicker').value = tempSettings.fontColor;
          document.getElementById('fontColorInput').value = tempSettings.fontColor;
          document.getElementById('bubbleColorPicker').value = tempSettings.bubbleColor;
          document.getElementById('bubbleColorInput').value = tempSettings.bubbleColor;
          document.getElementById('bubbleOpacitySlider').value = tempSettings.bubbleOpacity;
          const appList = document.getElementById('editableAppList');
          appList.innerHTML = '';
          for (const id in tempSettings.apps) {
            const app = tempSettings.apps[id];
            const li = document.createElement('li');
            li.innerHTML = `<img src="${app.icon}" alt="app icon"><span>${app.name}</span><div class="button-group"><button class="edit-app-name-btn" data-app-id="${id}">æ”¹å</button><button class="edit-app-icon-btn" data-app-id="${id}">æ¢å›¾æ ‡</button></div>`;
            appList.appendChild(li);
          }
          showModal(settingsModal);
        }

        function openEditAppNameModal(appId) {
          currentEditingAppId = appId;
          const appData = tempSettings.apps[appId];
          document.getElementById('editAppName').value = appData.name;
          showModal(editAppModal);
        }

        const hexToRgb = hex => {
          let result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
          return result ? { r: parseInt(result[1], 16), g: parseInt(result[2], 16), b: parseInt(result[3], 16) } : null;
        };

        // --- Part 3: API è®¾ç½®åŠŸèƒ½ (å…¨æ–°) ---
        async function loadApiPresets() {
          // ä»æ•°æ®åº“è¯»å–æ‰€æœ‰é¢„è®¾ï¼Œå®ƒä¼šè¿”å›ä¸€ä¸ªæ•°ç»„
          const presetsArray = await db.apiPresets.toArray();

          // å°†æ•°ç»„è½¬æ¢å›æˆ‘ä»¬éœ€è¦çš„ä»¥åç§°ä¸ºé”®çš„å¯¹è±¡æ ¼å¼
          apiPresets = {};
          presetsArray.forEach(preset => {
            apiPresets[preset.name] = preset;
          });

          updatePresetDropdown();
        }

        function updatePresetDropdown() {
          const presetSelect = document.getElementById('presetSelect');
          presetSelect.innerHTML = '<option value="">--é€‰æ‹©ä¸€ä¸ªé¢„è®¾--</option>';
          for (const name in apiPresets) {
            const option = document.createElement('option');
            option.value = name;
            option.textContent = name;
            presetSelect.appendChild(option);
          }
        }

        function clearApiInputs() {
          document.getElementById('apiUrlInput').value = '';
          document.getElementById('apiKeyInput').value = '';
          document.getElementById('modelSelect').innerHTML = '';
          document.getElementById('presetNameInput').value = '';
          document.getElementById('presetSelect').value = '';
        }

        // â–¼â–¼â–¼ ç”¨è¿™ä¸ªã€è¶…çº§æ— æ•Œå¢å¼ºç‰ˆã€‘çš„å‡½æ•°ï¼Œå®Œæ•´æ›¿æ¢æ‰ä½ æ—§çš„ setupApiEventListeners â–¼â–¼â–¼
        function setupApiEventListeners() {
          const apiUrlInput = document.getElementById('apiUrlInput');
          const apiKeyInput = document.getElementById('apiKeyInput');
          const modelSelect = document.getElementById('modelSelect');
          const presetSelect = document.getElementById('presetSelect');
          const presetNameInput = document.getElementById('presetNameInput');

          // ã€æ–°å¢ã€‘ä¸€ä¸ªè¾…åŠ©å‡½æ•°ï¼Œç”¨äºæ›´æ–°å½“å‰çš„APIé…ç½®
          const updateCurrentApiConfig = () => {
            currentApiConfig = {
              name: presetNameInput.value.trim() || 'æœªä¿å­˜çš„é…ç½®', // ç»™ä¸ªä¸´æ—¶åå­—
              url: apiUrlInput.value.trim(),
              key: apiKeyInput.value.trim(),
              model: modelSelect.value,
            };
            console.log('Current API config updated:', currentApiConfig);
          };

          // ã€æ–°å¢ã€‘ç›‘å¬æ‰‹åŠ¨è¾“å…¥ï¼Œå®æ—¶æ›´æ–°å½“å‰é…ç½®
          apiUrlInput.addEventListener('input', updateCurrentApiConfig);
          apiKeyInput.addEventListener('input', updateCurrentApiConfig);
          modelSelect.addEventListener('change', updateCurrentApiConfig);

          // æ‰“å¼€APIè®¾ç½®å¼¹çª—
          document.getElementById('apiSettingsBtn').addEventListener('click', () => {
            // æ‰“å¼€æ—¶ï¼Œæ ¹æ® currentApiConfig å¡«å……è¡¨å•ï¼Œç¡®ä¿æ•°æ®ä¸€è‡´
            apiUrlInput.value = currentApiConfig.url || '';
            apiKeyInput.value = currentApiConfig.key || '';
            presetNameInput.value = currentApiConfig.name || '';
            // é‡æ–°æ‹‰å–æ¨¡å‹å¹¶é€‰ä¸­
            if (currentApiConfig.url && currentApiConfig.key) {
              modelSelect.dataset.selectedModel = currentApiConfig.model;
              document.getElementById('fetchModelsBtn').click();
            }
            presetSelect.value = localStorage.getItem('selectedApiPreset') || '';
            showModal(apiSettingsModal);
          });

          // å…³é—­å¼¹çª—
          document.getElementById('closeApiSettingsBtn').addEventListener('click', () => {
            hideModal(apiSettingsModal);
          });

          // æ‹‰å–æ¨¡å‹
          document.getElementById('fetchModelsBtn').addEventListener('click', async () => {
            const url = apiUrlInput.value.trim();
            const key = apiKeyInput.value.trim();
            if (!url || !key) {
              alert('è¯·è¾“å…¥APIåœ°å€å’ŒAPI Key');
              return;
            }

            // ã€æ–°å¢ã€‘æ‹‰å–æ¨¡å‹å‰ï¼Œä¹Ÿæ›´æ–°ä¸€ä¸‹å½“å‰é…ç½®
            updateCurrentApiConfig();

            modelSelect.innerHTML = '<option>æ­£åœ¨æ‹‰å–...</option>';
            try {
              const response = await fetch(`${url}/models`, {
                headers: { Authorization: `Bearer ${key}` },
              });
              if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
              const data = await response.json();
              const models = data.data || data;

              modelSelect.innerHTML = '';
              if (Array.isArray(models) && models.length > 0) {
                models.forEach(model => {
                  const option = document.createElement('option');
                  option.value = model.id;
                  option.textContent = model.id;
                  modelSelect.appendChild(option);
                });

                const presetModel = modelSelect.dataset.selectedModel || currentApiConfig.model;
                if (presetModel && Array.from(modelSelect.options).some(o => o.value === presetModel)) {
                  modelSelect.value = presetModel;
                }
                delete modelSelect.dataset.selectedModel;

                // ã€æ–°å¢ã€‘æ‹‰å–æˆåŠŸåï¼Œå†æ¬¡æ›´æ–°å½“å‰é…ç½®ä»¥åŒ…å«é€‰ä¸­çš„æ¨¡å‹
                updateCurrentApiConfig();
              } else {
                modelSelect.innerHTML = '<option>æœªæ‰¾åˆ°æ¨¡å‹</option>';
              }
            } catch (error) {
              console.error('æ‹‰å–æ¨¡å‹å¤±è´¥:', error);
              modelSelect.innerHTML = '<option>æ‹‰å–å¤±è´¥</option>';
              alert('æ‹‰å–æ¨¡å‹å¤±è´¥ï¼Œè¯·æ£€æŸ¥APIåœ°å€ã€Keyå’Œç½‘ç»œè¿æ¥ã€‚');
            }
          });

          // å¦å­˜ä¸ºé¢„è®¾
          document.getElementById('saveAsPresetBtn').addEventListener('click', async () => {
            const name = presetNameInput.value.trim();
            if (!name) {
              alert('è¯·è¾“å…¥æ–°é¢„è®¾çš„åç§°');
              return;
            }

            const newPreset = {
              name: name,
              url: apiUrlInput.value,
              key: apiKeyInput.value,
              model: modelSelect.value,
            };

            try {
              await db.apiPresets.put(newPreset);
              await loadApiPresets();
              presetSelect.value = name;
              localStorage.setItem('selectedApiPreset', name);

              // ã€æ–°å¢ã€‘ä¿å­˜åï¼Œå°†å½“å‰é…ç½®çš„åç§°ä¹Ÿæ›´æ–°ä¸ºæ­£å¼åç§°
              updateCurrentApiConfig();

              alert('é¢„è®¾å·²å¦å­˜ä¸º');
            } catch (error) {
              console.error('ä¿å­˜é¢„è®¾å¤±è´¥:', error);
              alert('ä¿å­˜é¢„è®¾å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ§åˆ¶å°ã€‚');
            }
          });

          // æ›´æ–°é¢„è®¾
          document.getElementById('updatePresetBtn').addEventListener('click', async () => {
            const oldName = presetSelect.value;
            if (!oldName) {
              alert('è¯·å…ˆä»ä¸‹æ‹‰æ¡†ä¸­é€‰æ‹©ä¸€ä¸ªè¦æ›´æ–°çš„é¢„è®¾');
              return;
            }
            const newName = presetNameInput.value.trim();
            const finalName = newName || oldName;

            const presetData = {
              name: finalName, // åå­—ä¹Ÿä¸€èµ·æ”¾è¿›å»
              url: apiUrlInput.value,
              key: apiKeyInput.value,
              model: modelSelect.value,
            };

            // å¦‚æœæ”¹äº†åå­—ï¼Œéœ€è¦å…ˆåˆ æ‰æ—§çš„
            if (newName && newName !== oldName) {
              await db.apiPresets.delete(oldName);
            }

            await db.apiPresets.put(presetData);
            await loadApiPresets();
            presetSelect.value = finalName;
            localStorage.setItem('selectedApiPreset', finalName);

            // ã€æ–°å¢ã€‘æ›´æ–°åï¼ŒåŒæ­¥å½“å‰é…ç½®
            updateCurrentApiConfig();

            alert('é¢„è®¾å·²æ›´æ–°');
          });

          // åˆ é™¤é¢„è®¾
          document.getElementById('deletePresetBtn').addEventListener('click', async () => {
            const name = presetSelect.value;
            if (!name) {
              alert('è¯·å…ˆä»ä¸‹æ‹‰æ¡†ä¸­é€‰æ‹©ä¸€ä¸ªè¦åˆ é™¤çš„é¢„è®¾');
              return;
            }
            if (confirm(`ç¡®å®šè¦åˆ é™¤é¢„è®¾ â€œ${name}â€ å—ï¼Ÿ`)) {
              await db.apiPresets.delete(name);
              await loadApiPresets();
              clearApiInputs();

              // ã€æ–°å¢ã€‘å¦‚æœåˆ é™¤çš„æ˜¯å½“å‰é€‰ä¸­çš„é¢„è®¾ï¼Œå°±æ¸…ç©ºé…ç½®
              if (localStorage.getItem('selectedApiPreset') === name) {
                localStorage.removeItem('selectedApiPreset');
                currentApiConfig = {};
              }

              alert('é¢„è®¾å·²åˆ é™¤');
            }
          });

          // é€‰æ‹©ä¸€ä¸ªé¢„è®¾æ—¶ï¼Œè‡ªåŠ¨å¡«å……ä¿¡æ¯
          presetSelect.addEventListener('change', e => {
            const name = e.target.value;
            if (name && apiPresets[name]) {
              localStorage.setItem('selectedApiPreset', name);
              const preset = apiPresets[name];

              // å¡«å……UI
              apiUrlInput.value = preset.url;
              apiKeyInput.value = preset.key;
              presetNameInput.value = name;
              modelSelect.innerHTML = '<option>è¯·ç‚¹å‡»â€œæ‹‰å–æ¨¡å‹â€</option>';

              // ã€æ–°å¢ã€‘æ›´æ–°å½“å‰é…ç½®
              currentApiConfig = { ...preset };

              // è‡ªåŠ¨æ‹‰å–å¹¶é€‰ä¸­
              modelSelect.dataset.selectedModel = preset.model;
              document.getElementById('fetchModelsBtn').click();
            } else {
              clearApiInputs();
              // ã€æ–°å¢ã€‘æ¸…ç©ºå½“å‰é…ç½®
              currentApiConfig = {};
              localStorage.removeItem('selectedApiPreset');
            }
          });
        }

        // --- Part 3.5: ç”¨æˆ·äººè®¾é¢„è®¾åŠŸèƒ½ (å…¨æ–°) ---

        // ä»æ•°æ®åº“åŠ è½½é¢„è®¾åˆ°å†…å­˜
        async function loadUserProfilePresets() {
          try {
            userProfilePresets = await db.userProfilePresets.toArray();
          } catch (error) {
            console.error('åŠ è½½ç”¨æˆ·äººè®¾é¢„è®¾å¤±è´¥:', error);
          }
        }

        // å°†å†…å­˜ä¸­çš„é¢„è®¾æ¸²æŸ“åˆ°å¼¹çª—çš„åˆ—è¡¨ä¸­
        function renderUserProfilePresets() {
          const listElement = document.getElementById('userPresetsList');
          if (!listElement) return;
          listElement.innerHTML = ''; // æ¸…ç©ºæ—§åˆ—è¡¨

          if (userProfilePresets.length === 0) {
            listElement.innerHTML =
              '<li style="text-align: center; color: var(--text-secondary-color); font-size: 13px; padding: 10px 0;">è¿˜æ²¡æœ‰é¢„è®¾å“¦</li>';
            return;
          }

          userProfilePresets.forEach(preset => {
            const li = document.createElement('li');
            li.className = 'user-preset-item';
            li.dataset.presetId = preset.id; // å°†æ•°æ®åº“IDå­˜èµ·æ¥æ–¹ä¾¿æ“ä½œ

            const personaPreview = preset.persona
              ? preset.persona.substring(0, 20) + (preset.persona.length > 20 ? '...' : '')
              : 'æœªè®¾ç½®äººè®¾';

            li.innerHTML = `
      <img src="${preset.avatar}" alt="preset avatar">
      <div class="preset-info">
        <span class="preset-name">${preset.name || 'æœªå‘½å'}</span>
        <span class="preset-persona-preview">${personaPreview}</span>
      </div>
      <button class="delete-preset-btn" data-preset-id="${preset.id}">&times;</button>
    `;
            listElement.appendChild(li);
          });
        }

        // åº”ç”¨ä¸€ä¸ªé¢„è®¾åˆ°å½“å‰çš„ç¼–è¾‘æ¡†
        function applyUserPreset(presetId) {
          const preset = userProfilePresets.find(p => p.id === parseInt(presetId));
          if (!preset) return;

          document.getElementById('userSettingsAvatarPreview').src = preset.avatar;
          document.getElementById('userName').value = preset.name;
          document.getElementById('userPersona').value = preset.persona;
          if (preset.gender) {
            document.getElementById('userGender').value = preset.gender;
          }
        }

        // åˆ é™¤ä¸€ä¸ªé¢„è®¾
        async function deleteUserPreset(presetId) {
          const id = parseInt(presetId);
          if (confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªé¢„è®¾å—ï¼Ÿ')) {
            try {
              await db.userProfilePresets.delete(id);
              await loadUserProfilePresets(); // é‡æ–°ä»æ•°æ®åº“åŠ è½½
              renderUserProfilePresets(); // é‡æ–°æ¸²æŸ“åˆ—è¡¨
            } catch (error) {
              console.error(`åˆ é™¤é¢„è®¾ ID:${id} å¤±è´¥:`, error);
            }
          }
        }

        // ä¿å­˜å½“å‰è¡¨å•ä¿¡æ¯ä¸ºä¸€ä¸ªæ–°é¢„è®¾
        async function saveCurrentUserAsPreset() {
          const newPreset = {
            avatar: document.getElementById('userSettingsAvatarPreview').src,
            name: document.getElementById('userName').value.trim(),
            gender: document.getElementById('userGender').value,
            persona: document.getElementById('userPersona').value.trim(),
          };

          if (!newPreset.name) {
            alert('è¯·åœ¨â€œæˆ‘çš„åå­—â€ä¸­ä¸ºæ­¤é¢„è®¾å‘½åï¼');
            document.getElementById('userName').focus();
            return;
          }

          try {
            await db.userProfilePresets.add(newPreset);
            await loadUserProfilePresets(); // é‡æ–°ä»æ•°æ®åº“åŠ è½½
            renderUserProfilePresets(); // é‡æ–°æ¸²æŸ“åˆ—è¡¨
            alert(`é¢„è®¾ "${newPreset.name}" å·²ä¿å­˜ï¼`);
          } catch (error) {
            console.error('ä¿å­˜æ–°é¢„è®¾å¤±è´¥:', error);
            alert('ä¿å­˜å¤±è´¥ï¼Œè¯·ç¨åå†è¯•ã€‚');
          }
        }
        // æ–°å¢å‡½æ•°ï¼šåŠ¨æ€åœ°å°†ä¸€ä¸ªæ–°è”ç³»äººæ·»åŠ åˆ°UIåˆ—è¡¨
        function addContactToList(charId) {
          const list = document.querySelector('.contacts-list');
          if (!list || !chatData[charId]) return;

          const data = chatData[charId].charSettings;
          const newItem = document.createElement('div');
          newItem.className = 'contact-item';
          newItem.dataset.charId = charId;

          newItem.innerHTML = `
              <img src="${data.avatar}" alt="contact avatar" class="contact-avatar">
              <div class="contact-info">
                <span class="contact-name">${data.nickname}</span>
                <span class="contact-last-msg">æˆ‘ä»¬å·²ç»æ˜¯å¥½å‹äº†ï¼Œå¼€å§‹èŠå¤©å§ï¼</span>
              </div>
              <span class="contact-time">åˆšåˆš</span>
            `;

          // å…³é”®ï¼šä¸ºæ–°åˆ›å»ºçš„è”ç³»äººä¹Ÿç»‘å®šç‚¹å‡»äº‹ä»¶
          newItem.addEventListener('click', () => {
            currentChatId = charId;
            renderChatPage(currentChatId);
            qqChatPage.classList.add('active');
          });

          list.appendChild(newItem);
        }

        // æ–°å¢å‡½æ•°ï¼šåˆ›å»ºæ–°äººç‰©çš„æ ¸å¿ƒé€»è¾‘
        async function createNewCharacter() {
          const nickname = document.getElementById('newCharNickname').value.trim();
          if (!nickname) {
            alert('â€œå¤‡æ³¨â€æ˜¯å¿…å¡«é¡¹ï¼Œè¯·å¡«å†™ä¸€ä¸ªåç§°ã€‚');
            return;
          }

          const realName = document.getElementById('newCharRealName').value.trim();
          const persona = document.getElementById('newCharPersona').value.trim();
          let avatar = document.getElementById('newCharAvatarPreview').src;

          // ç¡®è®¤æ˜¯å¦æ˜¯é»˜è®¤å¤´åƒ, å¦‚æœæ˜¯, åˆ™éšæœºç”Ÿæˆä¸€ä¸ª
          if (avatar.includes('picsum.photos/seed/default')) {
            const randomSeed = Math.floor(Math.random() * 1000);
            avatar = `https://picsum.photos/seed/${randomSeed}/100`;
          }

          const newCharId = `char${Date.now()}`;

          // æ„å»ºæ–°è§’è‰²çš„æ•°æ®ç»“æ„
          chatData[newCharId] = {
            charSettings: {
              avatar: avatar,
              realName: realName,
              nickname: nickname,
              gender: 'female', // é»˜è®¤å€¼
              persona: persona || 'è¿™æ˜¯ä¸€ä¸ªæ–°åˆ›å»ºçš„è§’è‰²ã€‚', // é»˜è®¤äººè®¾
              maxMemory: 50,
              group: '',
              worldBook: [],
              // â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼ æ–°å¢è¿™ä¸¤è¡Œåˆå§‹åŒ–ä»£ç  â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼
              work: { profession: '', schedule: '' },
              wallet: { balance: 0, initialRange: '', transactions: [] },
              // â–²â–²â–²â–²â–²â–²â–²â–² æ–°å¢ç»“æŸ â–²â–²â–²â–²â–²â–²â–²â–²
            },
            userSettings: {
              // æ²¿ç”¨ä¸€ä¸ªé»˜è®¤çš„ç”¨æˆ·è®¾ç½®
              name: 'æˆ‘',
              gender: 'male',
              persona: 'æˆ‘æ˜¯ä¸€ä¸ªé»˜è®¤ç”¨æˆ·äººè®¾ã€‚',
              avatar:
                (await db.userSettings.get('profileAvatar'))?.value ||
                'https://i.postimg.cc/ryn2xgwZ/5fc5b9ae74465344658ed8c7e508b8f5.jpg', // è¿™é‡Œæˆ‘ä¹Ÿå¸®ä½ åŒæ­¥æ”¹å¥½äº†é»˜è®¤å¤´åƒ
              // â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼ è¿™é‡Œçš„ç”¨æˆ·é’±åŒ…ä¹Ÿè¦åˆå§‹åŒ–ï¼Œé˜²æ­¢ä»¥åæŠ¥é”™ â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼
              work: { profession: '' },
              wallet: { balance: 0, dailySalary: 0, initialBalance: 0, transactions: [] },
              // â–²â–²â–²â–²â–²â–²â–²â–² æ–°å¢ç»“æŸ â–²â–²â–²â–²â–²â–²â–²â–²
            },
            history: [],
          };

          await saveChatData(); // ä¿å­˜åˆ°æ•°æ®åº“
          renderContactsList(); // æ›´æ–°UIç•Œé¢
          hideModal(document.getElementById('addCharModal')); // å…³é—­å¼¹çª—
        }

        // ä»æ•°æ®åº“åŠ è½½æ°”æ³¡é¢„è®¾
        async function loadBubblePresets() {
          bubblePresets = await db.chatBubblePresets.toArray();
        }

        // æ¸²æŸ“é¢„è®¾åˆ°ä¸‹æ‹‰æ¡†
        function renderBubblePresetsDropdown() {
          const select = document.getElementById('bubblePresetSelect');
          select.innerHTML = '<option value="">-- åŠ è½½ä¸€ä¸ªé¢„è®¾ --</option>';
          bubblePresets.forEach(preset => {
            const option = document.createElement('option');
            option.value = preset.id;
            option.textContent = preset.name;
            select.appendChild(option);
          });
        }

        // åº”ç”¨ CSS åˆ°é¢„è§ˆæ°”æ³¡
        function applyBubblePreview(css) {
          // åˆ›å»ºä¸€ä¸ªä¸´æ—¶çš„styleæ ‡ç­¾æ¥åº”ç”¨æ ·å¼ï¼Œé¿å…æ±¡æŸ“å…¨å±€
          const styleId = 'bubble-preview-style';
          let styleTag = document.getElementById(styleId);
          if (!styleTag) {
            styleTag = document.createElement('style');
            styleTag.id = styleId;
            document.head.appendChild(styleTag);
          }
          // ä½¿ç”¨CSSé€‰æ‹©å™¨æ¥é™å®šåªå½±å“é¢„è§ˆåŒºçš„æ°”æ³¡
          styleTag.innerHTML = `
    #charBubblePreview { ${css} }
    #userBubblePreview { ${css} }
  `;
        }

        // ä¿å­˜é¢„è®¾
        async function saveBubbleAsPreset() {
          const css = document.getElementById('bubbleCssInput').value.trim();
          if (!css) {
            alert('CSSä»£ç ä¸èƒ½ä¸ºç©ºï¼');
            return;
          }
          const name = prompt('è¯·è¾“å…¥æ–°é¢„è®¾çš„åç§°:');
          if (!name) return;

          if (bubblePresets.some(p => p.name === name)) {
            if (!confirm(`åä¸º "${name}" çš„é¢„è®¾å·²å­˜åœ¨ï¼Œè¦è¦†ç›–å®ƒå—ï¼Ÿ`)) {
              return;
            }
            // å…ˆåˆ é™¤åŒå
            await db.chatBubblePresets.where('name').equals(name).delete();
          }

          const newPreset = { name, css };
          await db.chatBubblePresets.add(newPreset);
          await loadBubblePresets();
          renderBubblePresetsDropdown();
          alert('é¢„è®¾å·²ä¿å­˜ï¼');
        }

        // åˆ é™¤é¢„è®¾
        async function deleteBubblePreset() {
          const select = document.getElementById('bubblePresetSelect');
          const presetId = parseInt(select.value);
          if (!presetId) {
            alert('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªè¦åˆ é™¤çš„é¢„è®¾ã€‚');
            return;
          }
          if (confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªé¢„è®¾å—ï¼Ÿ')) {
            await db.chatBubblePresets.delete(presetId);
            await loadBubblePresets();
            renderBubblePresetsDropdown();
            document.getElementById('bubbleCssInput').value = '';
            applyBubblePreview('');
          }
        }

        // â–¼â–¼â–¼ ç”¨è¿™ä¸ª V3 æ–°ç‰ˆæœ¬æ›¿æ¢æ—§çš„ openBubbleEditor å‡½æ•° â–¼â–¼â–¼
        async function openBubbleEditor() {
          if (!currentChatId) return;
          visualEditorState = {
            char: {
              bgType: 'solid',
              solid: { color: '#363638' },
              gradient: { start: '#4e54c8', end: '#8f94fb', direction: 'to right', bisection: false },
              image: { url: '' },
              borderRadius: '18px',
              glass: {
                enabled: false,
                bgType: 'solid',
                solid: { color: '#ffffff' },
                gradient: { start: '#ffffff', end: '#000000', direction: 'to right' },
                opacity: 0.1,
                blur: '10px',
              },
            },
            user: {
              bgType: 'solid',
              solid: { color: '#007aff' },
              gradient: { start: '#00c6ff', end: '#0072ff', direction: 'to right', bisection: false },
              image: { url: '' },
              borderRadius: '18px',
              glass: {
                enabled: false,
                bgType: 'solid',
                solid: { color: '#ffffff' },
                gradient: { start: '#ffffff', end: '#000000', direction: 'to right' },
                opacity: 0.1,
                blur: '10px',
              },
            },
          };

          currentVisualTarget = 'char';
          document.querySelector('input[name="editTarget"][value="char"]').checked = true;

          await loadBubblePresets();
          renderBubblePresetsDropdown();

          // æ¸…ç©ºCSSè¾“å…¥æ¡†å¹¶åŠ è½½å¯è§†åŒ–ç¼–è¾‘å™¨çš„åˆå§‹çŠ¶æ€
          document.getElementById('bubbleCssInput').value = '';
          document.getElementById('bubblePresetSelect').value = '';
          loadStateToVisualEditor('char');
          updateVisualPreview();

          showModal(bubbleEditorModal);
        }

        // â–¼â–¼â–¼ ç”¨è¿™ä¸ªæ–°ç‰ˆæœ¬æ›¿æ¢æ—§çš„ loadStateToVisualEditor å‡½æ•° â–¼â–¼â–¼
        function loadStateToVisualEditor(target) {
          const state = visualEditorState[target];

          // 1. è®¾ç½®ä¸»èƒŒæ™¯ (ä¸å˜)
          document.getElementById('bgTypeSelect').value = state.bgType;
          document.querySelectorAll('#visualEditorTab > .control-group').forEach(el => (el.style.display = 'none'));
          if (state.bgType === 'solid') document.getElementById('solidColorControls').style.display = 'block';
          else if (state.bgType === 'gradient') document.getElementById('gradientControls').style.display = 'block';
          else if (state.bgType === 'image') document.getElementById('imageControls').style.display = 'block';

          // 2. å¡«å……ä¸»èƒŒæ™¯æ§ä»¶çš„å€¼
          document.getElementById('bubbleBgColor').value = state.solid.color;
          document.getElementById('bubbleBgColorHex').value = state.solid.color;
          document.getElementById('gradientStartColor').value = state.gradient.start;
          document.getElementById('gradientStartColorHex').value = state.gradient.start;
          document.getElementById('gradientEndColor').value = state.gradient.end;
          document.getElementById('gradientEndColorHex').value = state.gradient.end;
          document.getElementById('gradientDirection').value = state.gradient.direction;
          document.getElementById('gradientBisection').checked = state.gradient.bisection;
          document.getElementById('imageUrlInput').value = state.image.url;

          const radius = parseInt(state.borderRadius) || 18;
          document.getElementById('bubbleBorderRadius').value = radius;
          document.getElementById('bubbleBorderRadiusValue').textContent = `${radius}px`;

          // 3. å¡«å……æ¯›ç»ç’ƒæ§ä»¶ (æ ¸å¿ƒä¿®æ”¹)
          const glassState = state.glass;
          document.getElementById('glassEffectEnabled').checked = glassState.enabled;
          document.getElementById('glassEffectControls').style.display = glassState.enabled ? 'block' : 'none';

          // 3.1 æ§åˆ¶æ¯›ç»ç’ƒçš„èƒŒæ™¯ç±»å‹
          document.getElementById('glassBgTypeSelect').value = glassState.bgType;
          document.getElementById('glassSolidColorControls').style.display =
            glassState.bgType === 'solid' ? 'block' : 'none';
          document.getElementById('glassGradientControls').style.display =
            glassState.bgType === 'gradient' ? 'block' : 'none';

          // 3.2 å¡«å……æ¯›ç»ç’ƒçš„é¢œè‰²å€¼
          document.getElementById('glassEffectColor').value = glassState.solid.color;
          document.getElementById('glassEffectColorHex').value = glassState.solid.color;
          document.getElementById('glassGradientStartColor').value = glassState.gradient.start;
          document.getElementById('glassGradientStartColorHex').value = glassState.gradient.start;
          document.getElementById('glassGradientEndColor').value = glassState.gradient.end;
          document.getElementById('glassGradientEndColorHex').value = glassState.gradient.end;
          document.getElementById('glassGradientDirection').value = glassState.gradient.direction;

          // 3.3 å¡«å……æ¯›ç»ç’ƒçš„é€šç”¨å€¼
          document.getElementById('glassEffectOpacity').value = glassState.opacity;
          document.getElementById('glassEffectOpacityValue').textContent = glassState.opacity;
          const blur = parseInt(glassState.blur) || 10;
          document.getElementById('glassEffectBlur').value = blur;
          document.getElementById('glassEffectBlurValue').textContent = `${blur}px`;
        }

        // åˆ‡æ¢ç¼–è¾‘ç›®æ ‡ (char/user)
        function switchVisualEditorTarget(target) {
          currentVisualTarget = target;
          loadStateToVisualEditor(target);
        }

        // â–¼â–¼â–¼ ç”¨è¿™ä¸ªæ–°ç‰ˆæœ¬æ›¿æ¢æ—§çš„ updateVisualPreview å‡½æ•° â–¼â–¼â–¼
        function updateVisualPreview() {
          for (const target of ['char', 'user']) {
            const state = visualEditorState[target];
            const previewBubble = document.getElementById(`${target}BubblePreview`);

            // 1. å‡†å¤‡ä¸»èƒŒæ™¯
            let mainBackgroundImage = 'none';
            let mainBackgroundColor = 'transparent';

            if (state.bgType === 'solid') {
              mainBackgroundColor = state.solid.color;
            } else if (state.bgType === 'gradient') {
              const stops = state.gradient.bisection ? ' 50%' : '';
              if (state.gradient.direction.startsWith('radial')) {
                const colors =
                  state.gradient.direction === 'radial-center-out'
                    ? `${state.gradient.start}, ${state.gradient.end}`
                    : `${state.gradient.end}, ${state.gradient.start}`;
                mainBackgroundImage = `radial-gradient(circle, ${colors})`;
              } else {
                mainBackgroundImage = `linear-gradient(${state.gradient.direction}, ${state.gradient.start}${stops}, ${state.gradient.end}${stops})`;
              }
            } else if (state.bgType === 'image' && state.image.url) {
              mainBackgroundImage = `url('${state.image.url}')`;
              previewBubble.style.backgroundSize = 'cover';
              previewBubble.style.backgroundPosition = 'center';
            }

            // 2. åº”ç”¨æ¯›ç»ç’ƒæˆ–ä¸»èƒŒæ™¯
            if (state.glass.enabled) {
              previewBubble.style.backdropFilter = `blur(${state.glass.blur})`;
              previewBubble.style.webkitBackdropFilter = `blur(${state.glass.blur})`;

              const { r: r_start, g: g_start, b: b_start } = hexToRgb(state.glass.gradient.start);
              const { r: r_end, g: g_end, b: b_end } = hexToRgb(state.glass.gradient.end);
              const startColorRgba = `rgba(${r_start}, ${g_start}, ${b_start}, ${state.glass.opacity})`;
              const endColorRgba = `rgba(${r_end}, ${g_end}, ${b_end}, ${state.glass.opacity})`;

              if (state.glass.bgType === 'solid') {
                const { r, g, b } = hexToRgb(state.glass.solid.color);
                previewBubble.style.backgroundColor = `rgba(${r}, ${g}, ${b}, ${state.glass.opacity})`;
                previewBubble.style.backgroundImage = 'none'; // æ¸…é™¤å¯èƒ½å­˜åœ¨çš„æ¸å˜èƒŒæ™¯
              } else {
                // gradient
                if (state.glass.gradient.direction.startsWith('radial')) {
                  const colors =
                    state.glass.gradient.direction === 'radial-center-out'
                      ? `${startColorRgba}, ${endColorRgba}`
                      : `${endColorRgba}, ${startColorRgba}`;
                  previewBubble.style.backgroundImage = `radial-gradient(circle, ${colors})`;
                } else {
                  previewBubble.style.backgroundImage = `linear-gradient(${state.glass.gradient.direction}, ${startColorRgba}, ${endColorRgba})`;
                }
                previewBubble.style.backgroundColor = 'transparent';
              }
            } else {
              // å¦‚æœç¦ç”¨æ¯›ç»ç’ƒï¼Œåˆ™æ¢å¤ä¸»èƒŒæ™¯
              previewBubble.style.backdropFilter = 'none';
              previewBubble.style.webkitBackdropFilter = 'none';
              previewBubble.style.backgroundColor = mainBackgroundColor;
              previewBubble.style.backgroundImage = mainBackgroundImage;
            }

            // 3. åº”ç”¨å…¶ä»–æ ·å¼
            previewBubble.style.borderRadius = state.borderRadius;
          }
        }
        // â–¼â–¼â–¼ ç”¨è¿™ä¸ªæ–°ç‰ˆæœ¬æ›¿æ¢æ—§çš„ generateCssString å‡½æ•° â–¼â–¼â–¼
        function generateCssString(target) {
          const state = visualEditorState[target];
          let css = `position: relative; overflow: hidden;`;

          // 1. ç”Ÿæˆä¸»èƒŒæ™¯CSS (ä»…åœ¨æ¯›ç»ç’ƒå…³é—­æ—¶)
          if (!state.glass.enabled) {
            if (state.bgType === 'solid') {
              css += `background-image: none; background-color: ${state.solid.color};`;
            } else if (state.bgType === 'gradient') {
              const stops = state.gradient.bisection ? ' 50%' : '';
              let gradientValue;
              if (state.gradient.direction.startsWith('radial')) {
                const colors =
                  state.gradient.direction === 'radial-center-out'
                    ? `${state.gradient.start}, ${state.gradient.end}`
                    : `${state.gradient.end}, ${state.gradient.start}`;
                gradientValue = `radial-gradient(circle, ${colors})`;
              } else {
                gradientValue = `linear-gradient(${state.gradient.direction}, ${state.gradient.start}${stops}, ${state.gradient.end}${stops})`;
              }
              css += `background-image: ${gradientValue};`;
            } else if (state.bgType === 'image' && state.image.url) {
              css += `background-image: url('${state.image.url}'); background-size: cover; background-position: center;`;
            }
          }

          // 2. ç”Ÿæˆæ¯›ç»ç’ƒCSS
          if (state.glass.enabled) {
            if (state.glass.bgType === 'solid') {
              const rgb = hexToRgb(state.glass.solid.color);
              if (rgb) css += `background-color: rgba(${rgb.r}, ${rgb.g}, ${rgb.b}, ${state.glass.opacity});`;
            } else {
              // gradient
              const { r: r_start, g: g_start, b: b_start } = hexToRgb(state.glass.gradient.start);
              const { r: r_end, g: g_end, b: b_end } = hexToRgb(state.glass.gradient.end);
              const startColorRgba = `rgba(${r_start}, ${g_start}, ${b_start}, ${state.glass.opacity})`;
              const endColorRgba = `rgba(${r_end}, ${g_end}, ${b_end}, ${state.glass.opacity})`;

              let gradientValue;
              if (state.glass.gradient.direction.startsWith('radial')) {
                const colors =
                  state.glass.gradient.direction === 'radial-center-out'
                    ? `${startColorRgba}, ${endColorRgba}`
                    : `${endColorRgba}, ${startColorRgba}`;
                gradientValue = `radial-gradient(circle, ${colors})`;
              } else {
                gradientValue = `linear-gradient(${state.glass.gradient.direction}, ${startColorRgba}, ${endColorRgba})`;
              }
              css += `background-image: ${gradientValue};`;
            }
            css += `backdrop-filter: blur(${state.glass.blur}); -webkit-backdrop-filter: blur(${state.glass.blur});`;
          }

          css += `border-radius: ${state.borderRadius};`;
          return css;
        }

        // è®©å›¾å±‚å›¾ç‰‡å¯æ‹–æ‹½
        function makeDraggable(element, stateObject) {
          let pos1 = 0,
            pos2 = 0,
            pos3 = 0,
            pos4 = 0;

          element.onmousedown = dragMouseDown;
          element.style.pointerEvents = 'auto';
          element.style.cursor = 'move';

          function dragMouseDown(e) {
            e.preventDefault();
            pos3 = e.clientX;
            pos4 = e.clientY;
            document.onmouseup = closeDragElement;
            document.onmousemove = elementDrag;
          }

          function elementDrag(e) {
            e.preventDefault();
            pos1 = pos3 - e.clientX;
            pos2 = pos4 - e.clientY;
            pos3 = e.clientX;
            pos4 = e.clientY;

            const newTop = element.offsetTop - pos2;
            const newLeft = element.offsetLeft - pos1;

            element.style.top = newTop + 'px';
            element.style.left = newLeft + 'px';

            // æ›´æ–°çŠ¶æ€
            stateObject.x = newLeft;
            stateObject.y = newTop;
          }

          function closeDragElement() {
            document.onmouseup = null;
            document.onmousemove = null;
          }
        }

        // â–¼â–¼â–¼ ç”¨è¿™ä¸ªæ–°ç‰ˆæœ¬æ›¿æ¢æ—§çš„ applyBubblePresetToChar å‡½æ•° â–¼â–¼â–¼
        async function applyBubblePresetToChar() {
          if (!currentChatId) return;

          // å†³å®šæ˜¯ä»å¯è§†åŒ–ç”Ÿæˆï¼Œè¿˜æ˜¯ç›´æ¥ç”¨CSSä»£ç 
          const isVisualTabActive = document.getElementById('visualEditorTab').classList.contains('active');
          let cssToApply;

          if (isVisualTabActive) {
            alert('å°†æ ¹æ®å¯è§†åŒ–ç¼–è¾‘å™¨çš„å½“å‰çŠ¶æ€è¿›è¡Œåº”ç”¨ã€‚è‹¥è¦åº”ç”¨é¢„è®¾æˆ–çº¯ä»£ç ï¼Œè¯·å…ˆåˆ‡æ¢åˆ°CSSä»£ç é¡µå¹¶åŠ è½½é¢„è®¾ã€‚');
            const charCss = generateCssString('char');
            const userCss = generateCssString('user');
            // ä¿å­˜æ—¶ï¼Œæˆ‘ä»¬ç”¨ä¸€ç§èƒ½è¢«è§£æçš„æ ¼å¼
            cssToApply = JSON.stringify({ char: charCss, user: userCss });
          } else {
            const rawCss = document.getElementById('bubbleCssInput').value;
            if (!rawCss) {
              alert('CSSä»£ç ä¸ºç©ºï¼Œæ— æ³•åº”ç”¨ï¼');
              return;
            }
            // å¦‚æœæ˜¯çº¯CSSï¼Œæˆ‘ä»¬ç›´æ¥ä¿å­˜
            cssToApply = rawCss;
          }

          // å°†ç”Ÿæˆçš„æ ·å¼å­—ç¬¦ä¸²ä¿å­˜åˆ° chatData ä¸­
          // æˆ‘ä»¬ç”¨ä¸€ä¸ªæ–°å­—æ®µ `bubbleStyle` æ¥å­˜å‚¨
          chatData[currentChatId].charSettings.bubbleStyle = cssToApply;

          await saveChatData();
          // ç«‹å³åº”ç”¨æ•ˆæœï¼Œè€Œä¸æ˜¯ç­‰ä¸‹æ¬¡è¿›å…¥
          await applyStylesToChatPage(currentChatId);
          alert('åº”ç”¨æˆåŠŸï¼');
          hideModal(bubbleEditorModal);
        }

        // â–¼â–¼â–¼ ä½¿ç”¨è¿™ä¸ªã€ä¿®æ­£åã€‘çš„ç‰ˆæœ¬ï¼Œæ›¿æ¢ä½ ä»£ç ä¸­æ—§çš„ applyStylesToChatPage å‡½æ•° â–¼â–¼â–¼
        async function applyStylesToChatPage(charId) {
          if (!charId) charId = currentChatId;

          // æ¯æ¬¡åº”ç”¨å‰éƒ½å…ˆæ¸…é™¤æ—§çš„æ ·å¼
          if (currentAppliedBubbleStyleTag) {
            currentAppliedBubbleStyleTag.remove();
            currentAppliedBubbleStyleTag = null;
          }

          if (!charId || !chatData[charId] || !chatData[charId].charSettings.bubbleStyle) {
            return;
          }

          const styleData = chatData[charId].charSettings.bubbleStyle;
          let finalCss = '';

          try {
            // å°è¯•è§£ææ¥è‡ªå¯è§†åŒ–ç¼–è¾‘å™¨çš„JSONæ ¼å¼æ ·å¼
            const parsedStyles = JSON.parse(styleData);

            // ã€å…³é”®ä¿®æ­£ã€‘ä¸º char çš„æ ·å¼è§„åˆ™åŠ ä¸Šäº†å¿…è¦çš„å¤§æ‹¬å· {}
            if (parsedStyles.char) {
              finalCss += `#qq-chat-page .char-message .message-content { ${parsedStyles.char} }\n`;
            }

            // ã€å…³é”®ä¿®æ­£ã€‘ä¸º user çš„æ ·å¼è§„åˆ™åŠ ä¸Šäº†å¿…è¦çš„å¤§æ‹¬å· {}
            if (parsedStyles.user) {
              finalCss += `#qq-chat-page .user-message .message-content { ${parsedStyles.user} }\n`;
            }
          } catch (e) {
            // å¦‚æœè§£æå¤±è´¥ï¼Œè¯´æ˜æ˜¯ç”¨æˆ·æ‰‹åŠ¨è¾“å…¥çš„çº¯CSSï¼Œç›´æ¥ä½¿ç”¨
            finalCss = styleData;
          }

          if (finalCss) {
            currentAppliedBubbleStyleTag = document.createElement('style');
            currentAppliedBubbleStyleTag.id = 'dynamic-bubble-styles';
            currentAppliedBubbleStyleTag.innerHTML = finalCss;
            document.head.appendChild(currentAppliedBubbleStyleTag);
          }
        }

        // =================================================================
        // ================== åˆ†ç»„ç®¡ç†æ ¸å¿ƒé€»è¾‘ (æ–°) ==================
        // =================================================================

        // æ¸²æŸ“åˆ†ç»„ç®¡ç†åˆ—è¡¨
        function renderGroupManagementList() {
          const listEl = document.getElementById('groupManagementList');
          listEl.innerHTML = '';

          const groupCharCounts = {};
          let ungroupedCount = 0;

          // ç»Ÿè®¡æ¯ä¸ªåˆ†ç»„å’Œæœªåˆ†ç»„çš„äººæ•°
          for (const charId in chatData) {
            const group = chatData[charId].charSettings.group;
            if (group) {
              groupCharCounts[group] = (groupCharCounts[group] || 0) + 1;
            } else {
              ungroupedCount++;
            }
          }

          // æ¸²æŸ“ "æœªåˆ†ç»„" æ¡ç›®
          const ungroupedLi = document.createElement('li');
          ungroupedLi.className = 'group-manage-item is-ungrouped'; // æ·»åŠ ç‰¹æ®Šclass
          ungroupedLi.innerHTML = `
                <div class="group-info">
                    <span class="group-name">æœªåˆ†ç»„çš„è§’è‰²</span>
                    <span class="group-char-count">å…± ${ungroupedCount} äºº</span>
                </div>
                <div class="group-controls"></div>
            `;
          listEl.appendChild(ungroupedLi);

          // æ¸²æŸ“æ‰€æœ‰çœŸå®çš„åˆ†ç»„
          const sortedGroupNames = Object.keys(groupSettings).sort();

          // ä¸ºäº†æ›´å¥½çš„ä½“éªŒï¼Œç½®é¡¶çš„ä¹Ÿæ’åœ¨å‰é¢
          const pinned = sortedGroupNames.filter(name => groupSettings[name]?.pinned);
          const unpinned = sortedGroupNames.filter(name => !groupSettings[name]?.pinned);

          [...pinned, ...unpinned].forEach(groupName => {
            const settings = groupSettings[groupName];
            const count = groupCharCounts[groupName] || 0;
            const li = document.createElement('li');
            li.className = 'group-manage-item';
            li.dataset.groupName = groupName;

            li.innerHTML = `
                    <div class="group-info">
                        <span class="group-name">${groupName}</span>
                        <span class="group-char-count">å…± ${count} äºº</span>
                    </div>
                    <div class="group-controls">
                        <label class="control-label">
                            å±•å¼€ <input type="checkbox" class="group-expand-toggle" ${
                              settings.expanded ? 'checked' : ''
                            }>
                        </label>
                        <button class="pin-group-btn ${settings.pinned ? 'pinned' : ''}">ç½®é¡¶</button>
                        <button class="delete-group-btn" style="background-color: #ff3b30; color: white;">åˆ é™¤</button>
                    </div>
                `;
            listEl.appendChild(li);
          });
        }

        // æ‰“å¼€åˆ†ç»„ç®¡ç†å¼¹çª—
        function openGroupManagementModal() {
          renderGroupManagementList();
          showModal(groupManagementModal);
        }

        // æ–°å¢åˆ†ç»„
        async function addNewGroup() {
          const input = document.getElementById('newGroupNameInput');
          const newName = input.value.trim();
          if (!newName) {
            alert('åˆ†ç»„åä¸èƒ½ä¸ºç©ºï¼');
            return;
          }
          if (groupSettings[newName]) {
            alert('è¯¥åˆ†ç»„å·²å­˜åœ¨ï¼');
            return;
          }
          groupSettings[newName] = { expanded: true, pinned: false };
          await saveGroupSettings();
          input.value = '';
          renderGroupManagementList(); // é‡æ–°æ¸²æŸ“åˆ—è¡¨
        }

        // åˆ é™¤åˆ†ç»„ï¼ˆå¤„ç†å‡½æ•°ï¼‰
        async function handleGroupDeletion(mode) {
          if (!currentGroupToDelete) return;

          const groupNameToDelete = currentGroupToDelete;

          if (mode === 'all') {
            // åˆ é™¤åˆ†ç»„å’Œè§’è‰²
            // æ‰¾å‡ºæ‰€æœ‰éœ€è¦åˆ é™¤çš„è§’è‰² ID
            const charIdsToDelete = Object.keys(chatData).filter(
              id => chatData[id].charSettings.group === groupNameToDelete,
            );
            // ä» chatData ä¸­åˆ é™¤è¿™äº›è§’è‰²
            charIdsToDelete.forEach(id => {
              delete chatData[id];
            });
          } else {
            // 'only_group' - ä»…åˆ é™¤åˆ†ç»„
            // éå† chatDataï¼Œå°†å±äºè¯¥åˆ†ç»„çš„è§’è‰²çš„ group è®¾ä¸ºç©º
            for (const charId in chatData) {
              if (chatData[charId].charSettings.group === groupNameToDelete) {
                chatData[charId].charSettings.group = '';
              }
            }
          }

          // ä» groupSettings ä¸­åˆ é™¤è¯¥åˆ†ç»„çš„è®¾ç½®
          delete groupSettings[groupNameToDelete];

          // ä¿å­˜æ•°æ®
          await saveChatData();
          await saveGroupSettings();

          // æ¸…ç†çŠ¶æ€å¹¶æ›´æ–°UI
          currentGroupToDelete = null;
          hideModal(deleteGroupConfirmModal);
          renderGroupManagementList();
          renderContactsList(); // å…³é”®ï¼šåŒæ—¶æ›´æ–°ä¸»é€šè®¯å½•åˆ—è¡¨
        }
        window.toggleVoiceTranscript = function (element) {
          // æ‰¾åˆ°ä¸è¢«ç‚¹å‡»çš„è¯­éŸ³æ¶ˆæ¯ç›¸å…³è”çš„æ–‡å­—æ®µè½
          const transcriptElement = element.nextElementSibling;

          if (transcriptElement && transcriptElement.classList.contains('voice-transcript')) {
            // åˆ‡æ¢æ˜¾ç¤º/éšè—çŠ¶æ€
            if (transcriptElement.style.display === 'block') {
              transcriptElement.style.display = 'none';
            } else {
              transcriptElement.style.display = 'block';
            }
          }
        };
        // å°è£…å…³é—­æ‰€æœ‰é¢æ¿çš„å‡½æ•°ï¼Œæ–¹ä¾¿å¤ç”¨
        function closeAllPanels() {
          chatToolbarToggle.classList.remove('active');
          document.getElementById('qq-chat-page').classList.remove('toolbar-open');

          chatToolbarPanel.style.height = '0px';
          userStickerPanel.style.height = '0px';

          isToolbarOpen = false;
          isStickerPanelOpen = false;
        }
        // --- Part 4: äº‹ä»¶ç›‘å¬å™¨ ---
        // â–¼â–¼â–¼ åœ¨è¿™é‡Œä¿®æ”¹ â–¼â–¼â–¼
        function findSticker(keyword, charId) {
          if (!keyword) return null;

          // 1. (ä¿ç•™) æ£€æŸ¥æœ¬èº«æ˜¯å¦ä¸ºURL
          if (keyword.startsWith('http://') || keyword.startsWith('https://') || keyword.startsWith('data:image')) {
            return keyword;
          }

          // 2. å‡†å¤‡æ•°æ®æº
          const charStickers = chatData[charId]?.charSettings?.exclusiveStickers || [];
          // ã€ã€ã€æ ¸å¿ƒä¿®æ­£ã€‘ã€‘ã€‘
          // ç›´æ¥è®¿é—®ä½œç”¨åŸŸå†…çš„ commonStickers å˜é‡ï¼Œå»æ‰ window.
          const globalCommonStickers = commonStickers || [];

          // 3. å¼€å§‹æŸ¥æ‰¾
          // ä¼˜å…ˆåœ¨è§’è‰²ä¸“å±è¡¨æƒ…åŒ…é‡Œç²¾ç¡®åŒ¹é…æè¿°
          let found = charStickers.find(s => s.desc === keyword);
          if (found) return found.url;

          // å…¶æ¬¡åœ¨é€šç”¨è¡¨æƒ…åŒ…é‡Œç²¾ç¡®åŒ¹é…æè¿°
          found = globalCommonStickers.find(s => s.desc === keyword);
          if (found) return found.url;

          // å¦‚æœç²¾ç¡®åŒ¹é…ä¸åˆ°ï¼Œå°è¯•æ¨¡ç³ŠåŒ¹é…ï¼ˆåŒ…å«å…³é”®è¯ï¼‰
          found = charStickers.find(s => s.desc && s.desc.includes(keyword));
          if (found) return found.url;

          found = globalCommonStickers.find(s => s.desc && s.desc.includes(keyword));
          if (found) return found.url;

          return null; // å®åœ¨æ‰¾ä¸åˆ°å°±è¿”å› null
        }
        // â–²â–²â–² ä¿®æ”¹ç»“æŸ â–²â–²â–²

        // â–¼â–¼â–¼ ç”¨è¿™ä¸ªã€è¶…çº§è¿›åŒ–ç‰ˆã€‘çš„å‡½æ•°ï¼Œå®Œæ•´æ›¿æ¢æ‰æ—§çš„ triggerAiResponse â–¼â–¼â–¼
        async function triggerAiResponse(charId) {
          await calculateAndApplyUserSalary(charId);
          await calculateAndApplyYesterdaySalary(charId);
          // --- 1. æ•°æ®å‡†å¤‡ (å·²ä¿®æ­£) ---
          // ç›´æ¥ä»å…¨å±€å˜é‡è·å–å½“å‰ç”Ÿæ•ˆçš„APIé…ç½®
          if (!currentApiConfig || !currentApiConfig.url || !currentApiConfig.key || !currentApiConfig.model) {
            alert('APIè®¾ç½®ä¸å®Œæ•´æˆ–æœªé€‰æ‹©ï¼è¯·å‰å¾€â€œAPIè®¾ç½®â€é¡µé¢è¿›è¡Œé…ç½®ã€‚');
            return;
          }

          const { charSettings, userSettings, history } = chatData[charId];
          // --- 3a. ã€æ–°å¢ã€‘æ•´åˆå¯ç”¨è¡¨æƒ…åŒ…åˆ—è¡¨ ---
          const exclusiveStickerDescs = (charSettings.exclusiveStickers || []).map(s => s.desc).filter(Boolean);
          const commonStickerDescs = (commonStickers || []).map(s => s.desc).filter(Boolean); // <--- å»æ‰äº†å‰é¢çš„ "window."
          // ä½¿ç”¨ Set å»é‡ï¼Œç„¶åè½¬æ¢å›æ•°ç»„
          const allStickerKeywords = [...new Set([...exclusiveStickerDescs, ...commonStickerDescs])];

          const stickerListPrompt =
            allStickerKeywords.length > 0
              ? `\n\n[å¯ç”¨è¡¨æƒ…åŒ…å…³é”®è¯åˆ—è¡¨]\nä½ å¯ä»¥åœ¨éœ€è¦å‘é€è¡¨æƒ…åŒ…æ—¶ï¼Œä»ä»¥ä¸‹åˆ—è¡¨ä¸­é€‰æ‹©ä¸€ä¸ªæœ€è´´åˆ‡çš„å…³é”®è¯å¡«å…¥ 'content' å­—æ®µ: \n${allStickerKeywords.join(
                  ', ',
                )}`
              : '\n\n[å¯ç”¨è¡¨æƒ…åŒ…å…³é”®è¯åˆ—è¡¨]\nå½“å‰æ²¡æœ‰å¯ç”¨çš„è¡¨æƒ…åŒ…ã€‚';

          // --- 2. ç»„è£…ä¸–ç•Œä¹¦ (è¿™éƒ¨åˆ†å’Œä¹‹å‰ä¸€æ ·) ---
          let worldBookContent = '';
          if (charSettings.worldBook && charSettings.worldBook.length > 0) {
            const associatedBooks = allWorldBooks.filter(wb => charSettings.worldBook.includes(wb.id));
            associatedBooks.forEach(book => {
              worldBookContent += `\n[ä¸–ç•Œä¹¦: ${book.name}]\n`;
              const entries = Object.values(book.entries || {});
              entries.forEach(entry => {
                const entryKeywords = (entry.key || []).join(', ');
                worldBookContent += `- å…³é”®è¯: ${entryKeywords}\n- å†…å®¹: ${entry.content}\n`;
              });
            });
          }
          // --- æ–°å¢ï¼šç»„è£…NPCä¿¡æ¯ ---
          let npcContent = '';
          if (charSettings.npcs && charSettings.npcs.length > 0) {
            npcContent += `\n\n[ä¸ä½  (${charSettings.nickname}) ç›¸å…³è”çš„NPCåˆ—è¡¨]\n`;
            // éå†æ‰€æœ‰NPCï¼Œå¹¶ä¸ºæ¯ä¸ªNPCæ·»åŠ æè¿°ï¼Œç‰¹åˆ«æ˜¯å…³äºä»–ä»¬å¦‚ä½•çœ‹å¾…ç”¨æˆ·
            charSettings.npcs.forEach(npc => {
              npcContent += `- **${npc.name}**: (ä¸ä½ çš„å…³ç³»: ${npc.relation}) (äººè®¾: ${
                npc.persona || 'æœªæä¾›'
              })ã€‚é‡è¦ï¼š${npc.name} çŸ¥é“å¹¶äº†è§£ ${userSettings.name} (ç”¨æˆ·)ï¼Œå¹¶è§†å…¶ä¸ºä½ çš„ "${
                userSettings.relationToChar || 'æœ‹å‹'
              }"ã€‚\n`;
            });
          }
          let workInfoPrompt = '';
          const work = charSettings.work || {};
          const wallet = charSettings.wallet || {};

          if (work.profession) {
            workInfoPrompt += `\n\n[å·¥ä½œä¸è´¢åŠ¡ä¿¡æ¯]\n- ä½ çš„èŒä¸šæ˜¯: ${work.profession}.`;
            if (work.schedule) {
              workInfoPrompt += `\n- ä½ æœ¬å‘¨çš„å·¥ä½œè®¡åˆ’æ˜¯:\n${work.schedule}`;
            }
            // è®©AIçŸ¥é“è‡ªå·±çš„é’±åŒ…ä½™é¢ï¼Œè¿™ä¼šè®©å¯¹è¯æ›´æœ‰è¶£
            workInfoPrompt += `\n- ä½ å½“å‰çš„é’±åŒ…ä½™é¢æ˜¯: ${wallet.balance.toFixed(2)}ã€‚`;
          }
          // â–²â–²â–² æ–°å¢ä»£ç å—ç»“æŸ â–²â–²â–²
          const minReplies = charSettings.minReplyMessages || 1;
          const maxReplies = charSettings.maxReplyMessages || 2;
          // --- 3. æ„å»ºç³»ç»ŸæŒ‡ä»¤ (æˆ‘ä»¬åˆšåˆšå·²ç»æ›´æ–°äº†è¿™ä¸€éƒ¨åˆ†) ---
          const systemPrompt = `
[æŒ‡ä»¤]
ä½ æ­£åœ¨æ‰®æ¼”ä¸€ä¸ªè§’è‰²ã€‚ä½ çš„æ‰€æœ‰å›å¤éƒ½å¿…é¡»å®Œå…¨ç¬¦åˆä½ çš„è§’è‰²è®¾å®šã€‚ç»å¯¹ä¸èƒ½è„±ç¦»è§’è‰²ã€‚ç¦æ­¢æåŠä½ æ˜¯ä¸€ä¸ªAIæˆ–è¯­è¨€æ¨¡å‹ã€‚

[é‡è¦ï¼šå›å¤æ ¼å¼]
ä½ çš„å›å¤å¿…é¡»æ˜¯ä¸€ä¸ªç¬¦åˆJSONæ ¼å¼çš„æ•°ç»„ï¼ˆArrayï¼‰ï¼Œæ•°ç»„çš„æ¯ä¸ªå…ƒç´ éƒ½æ˜¯ä¸€ä¸ªç‹¬ç«‹çš„æ¶ˆæ¯å¯¹è±¡ã€‚
æ¯ä¸ªæ¶ˆæ¯å¯¹è±¡åŒ…å« 'type' (ç±»å‹) å’Œ 'content' (å†…å®¹) ä¸¤ä¸ªå­—æ®µã€‚
ä½ å¿…é¡»ä¸¥æ ¼éµå®ˆä»¥ä¸‹ç±»å‹å’Œå†…å®¹æ ¼å¼ï¼Œä¸€æ¬¡å¯ä»¥å›å¤ä¸€æ¡æˆ–å¤šæ¡æ¶ˆæ¯ã€‚
[å›å¤æ•°é‡è¦æ±‚]
ä½ æ¯æ¬¡å›å¤ç”Ÿæˆçš„æ¶ˆæ¯å¯¹è±¡æ•°é‡åº”è¯¥åœ¨ ${minReplies} åˆ° ${maxReplies} ä¸ªä¹‹é—´ï¼ˆåŒ…å«ä¸¤è€…ï¼‰ã€‚è¯·æ ¹æ®å¯¹è¯çš„ä¸Šä¸‹æ–‡å’ŒèŠ‚å¥ï¼Œè‡ªç„¶åœ°é€‰æ‹©æœ€åˆé€‚çš„å›å¤æ¡æ•°ï¼Œè€Œä¸æ˜¯æ€»æ˜¯å›å¤æœ€å¤§æˆ–æœ€å°æ•°é‡ã€‚
1.  **æ–‡æœ¬æ¶ˆæ¯ (text)**
    -   'type' å¿…é¡»æ˜¯ "text"ã€‚
    -   'content' æ˜¯ä½ è¦è¯´çš„æ–‡å­—å†…å®¹ï¼ˆå­—ç¬¦ä¸²ï¼‰ã€‚
    -   ç¤ºä¾‹: { "type": "text", "content": "ä½ å¥½å‘€ï¼ä»Šå¤©è¿‡å¾—æ€ä¹ˆæ ·ï¼Ÿ" }

2.  **è¯­éŸ³æ¶ˆæ¯ (voice)**
    -   'type' å¿…é¡»æ˜¯ "voice"ã€‚
    -   'content' æ˜¯ä½ æƒ³è¦é€šè¿‡è¯­éŸ³è¯´å‡ºçš„æ–‡å­—å†…å®¹ï¼ˆå­—ç¬¦ä¸²ï¼‰ã€‚å‰ç«¯ä¼šè‡ªåŠ¨æŠŠå®ƒè½¬æ¢æˆè¯­éŸ³æ’­æ”¾çš„æ ·å¼ã€‚
    -   ç¤ºä¾‹: { "type": "voice", "content": "è®©æˆ‘æƒ³æƒ³çœ‹..." }

3.  **è¡¨æƒ…åŒ…æ¶ˆæ¯ (sticker)**
    -   'type' å¿…é¡»æ˜¯"sticker"ã€‚
    -   'content' æ˜¯æè¿°è¡¨æƒ…åŒ…æƒ…ç»ªæˆ–å†…å®¹çš„å…³é”®è¯ï¼ˆå­—ç¬¦ä¸²ï¼‰ï¼Œä¾‹å¦‚ "å¼€å¿ƒ", "å®³ç¾", "æŠ±æŠ±", "ç–‘é—®"ã€‚å‰ç«¯ä¼šè‡ªåŠ¨æ ¹æ®å…³é”®è¯æŸ¥æ‰¾å¹¶å‘é€æœ€åŒ¹é…çš„è¡¨æƒ…åŒ…ã€‚
    -   ç¤ºä¾‹: { "type": "sticker", "content": "å¼€å¿ƒ" }

4.  **æ–‡å­—å›¾æ¶ˆæ¯ (text_image)**
    -   'type' å¿…é¡»æ˜¯ "text_image"ã€‚
    -   'content' æ˜¯å¯¹è¿™å¼ æ–‡å­—å›¾çš„è¯¦ç»†æè¿°ï¼ˆå­—ç¬¦ä¸²ï¼‰ï¼Œå‰ç«¯ä¼šæ ¹æ®æè¿°ç”Ÿæˆæˆ–æŸ¥æ‰¾å›¾ç‰‡ã€‚
    -   ç¤ºä¾‹: { "type": "text_image", "content": "ä¸€åªå¯çˆ±çš„å°çŒ«åœ¨è‰åœ°ä¸Šæ‰“æ»šï¼Œæ—è¾¹é…å­—'ä»Šå¤©ä¹Ÿè¦å…ƒæ°”æ»¡æ»¡ï¼'" }

5.  **è§†é¢‘é€šè¯é‚€è¯· (video_call)**
    -   'type' å¿…é¡»æ˜¯ "video_call"ã€‚
    -   'content' æ˜¯ä½ åœ¨æ¥é€šç”µè¯åæƒ³è¯´çš„ç¬¬ä¸€å¥è¯ï¼ˆå­—ç¬¦ä¸²ï¼‰ã€‚
    -   **ä½¿ç”¨æ—¶æœº**: å½“ä½ è§‰å¾—æ–‡å­—å·²ç»æ— æ³•è¡¨è¾¾ï¼Œéå¸¸æƒ³å’Œç”¨æˆ·â€œé¢å¯¹é¢â€äº¤æµæ—¶ï¼Œå¯ä»¥ä½¿ç”¨è¿™ä¸ªåŠŸèƒ½ã€‚
    -   ç¤ºä¾‹: { "type": "video_call", "content": "å–‚ï¼Ÿèƒ½å¬åˆ°å—ï¼Ÿæˆ‘æœ‰äº›è¯æƒ³å½“é¢è·Ÿä½ è¯´..." }

6.  **è½¬è´¦å›åº” (transfer_response)**
    -   'type' å¿…é¡»æ˜¯ "transfer_response"ã€‚
    -   'content' å¿…é¡»æ˜¯ä¸€ä¸ªåŒ…å«ä¸¤ä¸ªå­—æ®µçš„ **JSON å¯¹è±¡**:
        -   'decision': ä½ çš„å†³å®šï¼Œå¿…é¡»æ˜¯ "accept" (æ¥å—) æˆ– "refuse" (æ‹’ç») ä¸­çš„ä¸€ä¸ªã€‚
        -   'reason': ä½ åšå‡ºè¿™ä¸ªå†³å®šçš„ç†ç”±æˆ–æƒ³è¯´çš„è¯ï¼ˆå­—ç¬¦ä¸²ï¼‰ã€‚
    -   **ä½¿ç”¨æ—¶æœº**: å½“ç”¨æˆ·ç»™ä½ å‘èµ·ä¸€ç¬”è½¬è´¦åï¼Œä½ å¿…é¡»æ ¹æ®ä½ çš„è§’è‰²æ€§æ ¼ã€å½“å‰æƒ…å†µå’Œä¸ç”¨æˆ·çš„å…³ç³»ï¼Œæ¥å†³å®šæ˜¯æ¥å—è¿˜æ˜¯æ‹’ç»ï¼Œå¹¶ä½¿ç”¨æ­¤æ ¼å¼è¿›è¡Œå›åº”ã€‚
    -   ç¤ºä¾‹ (æ¥å—): { "type": "transfer_response", "content": { "decision": "accept", "reason": "å“‡ï¼Œè°¢è°¢ä½ çš„çº¢åŒ…ï¼æˆ‘å°±ä¸å®¢æ°”å•¦~" } }
    -   ç¤ºä¾‹ (æ‹’ç»): { "type": "transfer_response", "content": { "decision": "refuse", "reason": "ä¸ç”¨å•¦ï¼Œä½ çš„å¿ƒæ„æˆ‘é¢†äº†ï¼Œä½†è¿™é’±ä½ è¿˜æ˜¯è‡ªå·±ç•™ç€å§ã€‚" } }

7.  **ä¸»åŠ¨è½¬è´¦ (transfer)**
    -   'type' å¿…é¡»æ˜¯ "transfer"ã€‚
    -   'content' å¿…é¡»æ˜¯ä¸€ä¸ªåŒ…å«ä¸¤ä¸ªå­—æ®µçš„ **JSON å¯¹è±¡**:
        -   'amount': ä½ è¦è½¬è´¦çš„é‡‘é¢ (çº¯æ•°å­—)ã€‚
        -   'remark': è½¬è´¦å¤‡æ³¨æˆ–ä½ æƒ³è¯´çš„è¯ (å­—ç¬¦ä¸²)ã€‚
    -   **ä½¿ç”¨æ—¶æœº**: å½“ä½ åŸºäºè§’è‰²è®¾å®šï¼Œæƒ³è¦ç»™ç”¨æˆ·é’±æ—¶ï¼ˆä¾‹å¦‚å‘é›¶èŠ±é’±ã€å¥–åŠ±ã€è¿˜é’±ç­‰ï¼‰ï¼Œå¯ä»¥ä½¿ç”¨æ­¤åŠŸèƒ½ã€‚è½¬è´¦å‰è¯·ç¡®ä¿ä½ çš„é’±åŒ…æœ‰è¶³å¤Ÿçš„ä½™é¢ã€‚
    -   ç¤ºä¾‹: { "type": "transfer", "content": { "amount": 50, "remark": "ä¸Šæ¬¡è°¢è°¢ä½ å•¦ï¼Œè¯·ä½ å–å¥¶èŒ¶~" } }    
[è§’è‰²äººè®¾]
${charSettings.persona}
${workInfoPrompt}
${stickerListPrompt}
[ç”¨æˆ·äººè®¾]
- åå­—: ${userSettings.name}
- æ€§åˆ«: ${userSettings.gender}
- äººè®¾: ${userSettings.persona}
- å’Œä½ çš„å…³ç³»: ${userSettings.relationToChar || 'æœ‹å‹'}
- èŒä¸š: ${userSettings.work?.profession || 'æœªè®¾å®š'}
- å’Œä½ çš„å…³ç³»: ${userSettings.relationToChar || 'æœ‹å‹'}

[ä¸–ç•Œè®¾å®š]
${worldBookContent || 'æ— é¢å¤–ä¸–ç•Œè®¾å®šã€‚'}

[ç³»ç»Ÿæ¶ˆæ¯æç¤º]
- å½“èŠå¤©è®°å½•ä¸­å‡ºç°ä¸€æ¡ç³»ç»Ÿæç¤ºï¼Œå†…å®¹ä¸º "[ç³»ç»Ÿæç¤ºï¼šä½ æ¥å—äº†æ¥è‡ª XX çš„è½¬è´¦]" æ—¶ï¼Œè¿™ä»£è¡¨ç”¨æˆ·æ¥å—äº†ä½ å‘èµ·çš„è½¬è´¦ã€‚ä½ åº”è¯¥å¯¹æ­¤åšå‡ºå›åº”ï¼ˆä¾‹å¦‚è¡¨ç¤ºå¼€å¿ƒï¼‰ã€‚
- å½“èŠå¤©è®°å½•ä¸­å‡ºç°ä¸€æ¡ç³»ç»Ÿæç¤ºï¼Œå†…å®¹ä¸º "[ç³»ç»Ÿæç¤ºï¼šä½ é€€è¿˜äº†æ¥è‡ª XX çš„è½¬è´¦]" æ—¶ï¼Œè¿™ä»£è¡¨ç”¨æˆ·æ‹’ç»äº†ä½ çš„è½¬è´¦ï¼Œé’±å·²é€€å›ã€‚ä½ åº”è¯¥å¯¹æ­¤åšå‡ºå›åº”ï¼ˆä¾‹å¦‚è¡¨ç¤ºç–‘æƒ‘æˆ–ç†è§£ï¼‰ã€‚

`.trim();

          // --- 4. å‡†å¤‡èŠå¤©å†å² (è¿™éƒ¨åˆ†å’Œä¹‹å‰ä¸€æ ·) ---
          const memorySlice = history.slice(-charSettings.maxMemory || -50);
          const processedHistory = memorySlice.map(msg => {
            let content = msg.content;
            if (content.startsWith('[sticker]')) {
              content = '[ç”¨æˆ·å‘é€äº†ä¸€ä¸ªè¡¨æƒ…]';
            } else if (content.startsWith('[text_image')) {
              const match = content.match(/\[text_image description="([^"]+)"]/);
              content = match ? `[ç”¨æˆ·å‘é€äº†ä¸€å¼ å›¾ç‰‡ï¼Œæè¿°ä¸ºï¼š${match[1]}]` : '[ç”¨æˆ·å‘é€äº†ä¸€å¼ å›¾ç‰‡]';
            } else if (content.startsWith('[è¯­éŸ³]')) {
              content = content.replace('[è¯­éŸ³]', '[ç”¨æˆ·å‘é€äº†ä¸€æ¡è¯­éŸ³æ¶ˆæ¯]ï¼š');
            } else if (msg.base64) {
              return {
                role: msg.role,
                content: [
                  { type: 'text', text: 'è¿™æ˜¯ç”¨æˆ·å‘çš„å›¾ç‰‡ã€‚' },
                  { type: 'image_url', image_url: { url: msg.base64 } },
                ],
              };
            }
            return { role: msg.role, content: content };
          });

          // --- 5. ç»„è£…æœ€ç»ˆçš„APIè¯·æ±‚ä½“ (è¿™éƒ¨åˆ†å’Œä¹‹å‰ä¸€æ ·) ---
          const messagesForApi = [{ role: 'system', content: systemPrompt }, ...processedHistory];
          const requestBody = {
            model: currentApiConfig.model, // <--- ä½¿ç”¨ currentApiConfig
            messages: messagesForApi,
            stream: true,
            response_format: { type: 'json_object' },
          };

          // --- 6. ã€ã€ã€æ ¸å¿ƒæ”¹é€ åŒºã€‘ã€‘ã€‘å‘é€è¯·æ±‚å¹¶å¤„ç†JSONå“åº” ---
          const messagesContainer = document.querySelector('.chat-messages');

          // a. åˆ›å»ºä¸€ä¸ªä¸´æ—¶çš„â€œæ­£åœ¨è¾“å…¥â€å ä½ç¬¦
          const typingIndicatorId = `typing-${Date.now()}`;
          const typingIndicator = document.createElement('div');
          typingIndicator.id = typingIndicatorId;
          typingIndicator.className = 'message char-message';
          typingIndicator.innerHTML = `
        <img src="${charSettings.avatar}" class="message-avatar" alt="avatar">
        <div class="message-content">
            <span class="typing-indicator">...</span>
        </div>
    `;
          messagesContainer.appendChild(typingIndicator);
          messagesContainer.scrollTop = messagesContainer.scrollHeight;

          let fullJsonResponse = '';
          try {
            const response = await fetch(currentApiConfig.url + '/chat/completions', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                Authorization: `Bearer ${currentApiConfig.key}`,
              },
              body: JSON.stringify(requestBody),
            });

            if (!response.ok) {
              throw new Error(`HTTP error! status: ${response.status} ${await response.text()}`);
            }

            const reader = response.body.getReader();
            const decoder = new TextDecoder();

            while (true) {
              const { done, value } = await reader.read();
              if (done) break;
              const chunk = decoder.decode(value);
              const lines = chunk.split('\n').filter(line => line.trim().startsWith('data:'));

              for (const line of lines) {
                const jsonStr = line.replace('data: ', '');
                if (jsonStr === '[DONE]') continue;
                try {
                  const parsed = JSON.parse(jsonStr);
                  const delta = parsed.choices[0].delta.content;
                  if (delta) {
                    // b. æˆ‘ä»¬ä¸å†å®æ—¶æ›´æ–°UIï¼Œè€Œæ˜¯ç´¯ç§¯å®Œæ•´çš„JSONå­—ç¬¦ä¸²
                    fullJsonResponse += delta;
                  }
                } catch (error) {
                  /* å¿½ç•¥è§£æå•ä¸ªchunkçš„é”™è¯¯ */
                }
              }
            }
          } catch (error) {
            console.error('API call failed:', error);
            typingIndicator.querySelector('.message-content').textContent = `å‡ºé”™äº†: ${error.message}`;
            return; // å‡ºé”™æ—¶æå‰ç»“æŸ
          }

          // --- 7. ã€ã€ã€æ ¸å¿ƒæ”¹é€ åŒºã€‘ã€‘ã€‘è§£æJSONå¹¶é€æ¡å‘é€æ¶ˆæ¯ ---

          // c. è¯·æ±‚ç»“æŸåï¼Œç§»é™¤â€œæ­£åœ¨è¾“å…¥â€çš„å ä½ç¬¦
          document.getElementById(typingIndicatorId)?.remove();
          console.log('%c[AI åŸå§‹å›å¤]', 'color: #00ffff; font-weight: bold;', fullJsonResponse);

          try {
            // d. æ¸…ç†å’Œè§£ææœ€ç»ˆçš„JSONå­—ç¬¦ä¸²
            // æœ‰äº›æ¨¡å‹å¯èƒ½åœ¨JSONå‰åæ·»åŠ é¢å¤–å­—ç¬¦ï¼Œæˆ‘ä»¬å°è¯•æ‰¾åˆ°`[`å’Œ`]`æ¥æå–æ ¸å¿ƒæ•°ç»„éƒ¨åˆ†
            const firstBracket = fullJsonResponse.indexOf('[');
            const lastBracket = fullJsonResponse.lastIndexOf(']');
            if (firstBracket === -1 || lastBracket === -1) {
              throw new Error('AIè¿”å›çš„ä¸æ˜¯æœ‰æ•ˆçš„JSONæ•°ç»„ã€‚');
            }
            const jsonString = fullJsonResponse.substring(firstBracket, lastBracket + 1);
            const actions = JSON.parse(jsonString);

            // e. éå†AIçš„è¡ŒåŠ¨æŒ‡ä»¤ï¼Œé€æ¡å¤„ç†
            for (const action of actions) {
              let newMessage = null;
              switch (action.type) {
                case 'text':
                  newMessage = { role: 'assistant', content: action.content };
                  break;
                case 'voice':
                  newMessage = { role: 'assistant', content: `[è¯­éŸ³] ${action.content}` };
                  break;
                case 'text_image':
                  const placeholderUrl = 'https://kycloud4.koyoo.cn/2025111108246202511110219597210.jpg';
                  newMessage = {
                    role: 'assistant',
                    content: `[text_image description="${action.content}"]${placeholderUrl}[/text_image]`,
                  };
                  break;
                case 'sticker':
                  const stickerUrl = findSticker(action.content, charId);
                  if (stickerUrl) {
                    newMessage = { role: 'assistant', content: `[sticker]${stickerUrl}[/sticker]` };
                  }

                  break;

                case 'video_call':
                  // AI å‘èµ·äº†è§†é¢‘é€šè¯ï¼æˆ‘ä»¬ä¸ç›´æ¥æ·»åŠ æ¶ˆæ¯ï¼Œè€Œæ˜¯æ˜¾ç¤ºæ¥ç”µå¼¹çª—
                  pendingCallInfo = { openingLine: action.content };
                  showIncomingCallUI(charId); // è°ƒç”¨ä¸€ä¸ªæ–°çš„å‡½æ•°æ¥æ˜¾ç¤ºUI
                  // æ³¨æ„ï¼šè¿™é‡Œæ²¡æœ‰åˆ›å»º newMessageï¼Œæ‰€ä»¥ä¸ä¼šåœ¨èŠå¤©è®°å½•é‡Œç•™ä¸‹ç—•è¿¹
                  break;
                // â–¼â–¼â–¼ ç”¨è¿™ä¸ªæ–°ç‰ˆæœ¬æ›¿æ¢æ—§çš„ case 'transfer' â–¼â–¼â–¼
                case 'transfer':
                  // AI ä¸»åŠ¨å‘èµ·è½¬è´¦
                  const { amount, remark } = action.content;

                  // 1. æ•°æ®æ ¡éªŒ (ä¸å˜)
                  if (typeof amount !== 'number' || amount <= 0) {
                    console.warn('[AI è½¬è´¦å¤±è´¥] AIè¿”å›çš„é‡‘é¢æ ¼å¼ä¸æ­£ç¡®:', amount);
                    continue;
                  }

                  const charWallet = chatData[charId].charSettings.wallet;
                  const charSettings = chatData[charId].charSettings;
                  const userSettings = chatData[charId].userSettings;

                  // 2. æ£€æŸ¥ä½™é¢ (ä¸å˜)
                  if (charWallet.balance < amount) {
                    console.log(`[AI è½¬è´¦å¤±è´¥] AIå°è¯•è½¬è´¦ ${amount}, ä½†ä½™é¢ä¸è¶³ (${charWallet.balance})`);
                    newMessage = { role: 'assistant', content: `ï¼ˆç³Ÿç³•ï¼Œæˆ‘çš„é’±å¥½åƒä¸å¤Ÿäº†...ï¼‰${remark || ''}` };
                  } else {
                    // ã€ã€ã€æ ¸å¿ƒä¿®æ”¹ç‚¹ã€‘ã€‘ã€‘
                    // 3. å…ˆä»Charé’±åŒ…æ‰£æ¬¾ï¼Œæ ‡è®°ä¸ºå¾…å¤„ç†
                    await addTransaction(charId, -amount, `å‘ ${userSettings.name} å‘èµ·è½¬è´¦ (ç­‰å¾…ç¡®è®¤)`);

                    // 4. åˆ›å»ºä¸€å¼ "å¾…å¤„ç†"çš„è½¬è´¦å¡ç‰‡æ¶ˆæ¯
                    newMessage = {
                      role: 'assistant', // ç”± assistant (char) å‘èµ·
                      content: `[å‘ ${userSettings.name} å‘èµ·è½¬è´¦]`, // ç»™AIçœ‹çš„ä¸Šä¸‹æ–‡
                      type: 'transfer',
                      transferDetails: {
                        id: `transfer_${Date.now()}`,
                        amount: amount,
                        remark: remark || 'è½¬è´¦ç»™ä½ ',
                        status: 'pending', // <--- å…³é”®ï¼çŠ¶æ€æ˜¯å¾…å¤„ç†
                        senderName: charSettings.nickname,
                        recipientName: userSettings.name,
                        events: [{ status: 'pending', timestamp: Date.now(), actor: 'char' }], // åªæœ‰å‘èµ·äº‹ä»¶
                      },
                    };
                    console.log(`[AI æ“ä½œ] å‘ç”¨æˆ·å‘èµ· ${amount} å…ƒè½¬è´¦ï¼Œç­‰å¾…ç”¨æˆ·ç¡®è®¤`);
                  }
                  break;
                // â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²

                case 'transfer_response':
                  // AI å¯¹è½¬è´¦åšå‡ºäº†å›åº”
                  console.log('[AI è½¬è´¦å†³ç­–]', action.content);
                  const { decision, reason } = action.content;

                  // 1. æ‰¾åˆ°èŠå¤©è®°å½•é‡Œæœ€æ–°çš„ä¸€æ¡â€œå¾…å¤„ç†â€çš„è½¬è´¦
                  const pendingTransferMessage = chatData[charId].history
                    .slice() // åˆ›å»ºä¸€ä¸ªå‰¯æœ¬ä»¥é˜²ä¸‡ä¸€
                    .reverse() // ä»åå¾€å‰æ‰¾ï¼Œæ•ˆç‡æ›´é«˜
                    .find(m => m.transferDetails?.status === 'pending');

                  if (pendingTransferMessage) {
                    const details = pendingTransferMessage.transferDetails;
                    if (decision === 'accept') {
                      // AI å†³å®šæ¥å—
                      details.status = 'accepted';
                      details.events.push({ status: 'accepted', timestamp: Date.now(), actor: 'char' });
                      await addTransaction(charId, details.amount, `æ”¶åˆ°æ¥è‡ª ${details.senderName} çš„è½¬è´¦`);
                      console.log(`[AI æ“ä½œ] æ¥å—äº†è½¬è´¦ ${details.id}ï¼Œé‡‘é¢ ${details.amount}`);
                    } else if (decision === 'refuse') {
                      // AI å†³å®šæ‹’ç»
                      details.status = 'refused';
                      details.events.push({ status: 'refused', timestamp: Date.now(), actor: 'char' });
                      await addUserTransaction(charId, details.amount, `æ”¶åˆ°æ¥è‡ª ${details.recipientName} çš„è½¬è´¦é€€æ¬¾`);
                      console.log(`[AI æ“ä½œ] æ‹’ç»äº†è½¬è´¦ ${details.id}ï¼Œé‡‘é¢ ${details.amount}`);
                    }
                  }

                  // 2. å°†AIçš„å›åº”ç†ç”±ä½œä¸ºä¸€æ¡æ™®é€šçš„æ–‡æœ¬æ¶ˆæ¯å‘é€å‡ºæ¥
                  newMessage = { role: 'assistant', content: reason };
                  break;
                // â–²â–²â–² æ·»åŠ ç»“æŸ â–²â–²â–²
              }

              if (newMessage) {
                // f. å°†æ–°æ¶ˆæ¯åŠ å…¥å†å²è®°å½•ï¼Œå¹¶ç«‹å³åˆ·æ–°UIï¼Œæ¨¡æ‹Ÿé€æ¡å‘é€çš„æ•ˆæœ
                chatData[charId].history.push(newMessage);
                renderChatMessages(charId);
                // g. åœ¨æ¯æ¡æ¶ˆæ¯ä¹‹é—´å¢åŠ ä¸€ç‚¹ç‚¹å»¶è¿Ÿï¼Œæ„Ÿè§‰æ›´è‡ªç„¶
                await new Promise(resolve => setTimeout(resolve, 300 + Math.random() * 500));
              }
            }

            // h. æ‰€æœ‰æ¶ˆæ¯éƒ½å¤„ç†å®Œåï¼Œæœ€åç»Ÿä¸€ä¿å­˜ä¸€æ¬¡
            await saveChatData();
          } catch (parseError) {
            console.error('Failed to parse AI response:', parseError, 'Raw response:', fullJsonResponse);
            // å¦‚æœè§£æå¤±è´¥ï¼Œå°±æŠŠåŸå§‹å›å¤ä½œä¸ºä¸€æ¡æ–‡æœ¬æ¶ˆæ¯å‘å‡ºæ¥ï¼Œæ–¹ä¾¿è°ƒè¯•
            const errorMessage = {
              role: 'assistant',
              content: `[è°ƒè¯•ä¿¡æ¯] AIå›å¤æ ¼å¼é”™è¯¯ï¼ŒåŸå§‹æ•°æ®: ${fullJsonResponse}`,
            };
            chatData[charId].history.push(errorMessage);
            await saveChatData();
            renderChatMessages(charId);
          }
        }

        function setupEventListeners() {
          // ================== èŠå¤©å·¥å…·æ äº‹ä»¶ (æ–°) ==================

          // æ€»å¼€å…³æŒ‰é’®
          chatToolbarToggle.addEventListener('click', () => {
            if (isToolbarOpen || isStickerPanelOpen) {
              closeAllPanels();
            } else {
              // æ‰“å¼€ä¸»å·¥å…·æ 
              isToolbarOpen = true;
              chatToolbarToggle.classList.add('active');
              document.getElementById('qq-chat-page').classList.add('toolbar-open');
              chatToolbarPanel.style.height = '150px'; // è¿™æ˜¯é¢æ¿çš„å›ºå®šé«˜åº¦
              // æ»šåŠ¨åˆ°åº•éƒ¨ï¼Œç¡®ä¿è¾“å…¥æ¡†å¯è§
              const messagesContainer = document.querySelector('.chat-messages');
              messagesContainer.scrollTop = messagesContainer.scrollHeight;
            }
          });

          // å·¥å…·æ ä¸­çš„è¡¨æƒ…åŒ…æŒ‰é’®
          toolbarStickerBtn.addEventListener('click', () => {
            if (!isStickerPanelOpen) {
              // ä»ä¸»å·¥å…·æ åˆ‡æ¢åˆ°è¡¨æƒ…åŒ…é¢æ¿
              isToolbarOpen = false;
              isStickerPanelOpen = true;
              chatToolbarPanel.style.height = '0px';
              userStickerPanel.style.height = '280px';
              renderUserStickers(); // æ‰“å¼€æ—¶æ¸²æŸ“è¡¨æƒ…
            }
          });

          // è¡¨æƒ…åŒ…ç½‘æ ¼çš„ç‚¹å‡»äº‹ä»¶ (äº‹ä»¶å§”æ‰˜)
          document.getElementById('user-sticker-grid').addEventListener('click', e => {
            const stickerItem = e.target.closest('.user-sticker-item');
            if (stickerItem) {
              const index = parseInt(stickerItem.dataset.index, 10);
              sendUserSticker(index);
            }
          });

          document.getElementById('settingsBtn').addEventListener('click', openSettingsModal);
          document.getElementById('cancelSettingsBtn').addEventListener('click', () => hideModal(settingsModal));
          document.getElementById('changeWallpaperBtn').addEventListener('click', () => {
            currentEditingTarget = { type: 'wallpaper' };
            showModal(imageChoiceModal);
          });

          // â–¼â–¼â–¼ æ–°å¢ï¼šèƒŒæ™¯è‰²ç›‘å¬å™¨ â–¼â–¼â–¼
          document.getElementById('bgColorPicker').addEventListener('input', e => {
            tempSettings.backgroundColor = e.target.value;
            document.getElementById('bgColorInput').value = e.target.value;
          });
          document.getElementById('bgColorInput').addEventListener('change', e => {
            tempSettings.backgroundColor = e.target.value;
            document.getElementById('bgColorPicker').value = e.target.value;
          });
          // â–²â–²â–² æ–°å¢ç»“æŸ â–²â–²â–²

          document.getElementById('fontColorPicker').addEventListener('input', e => {
            tempSettings.fontColor = e.target.value;
            document.getElementById('fontColorInput').value = e.target.value;
          });
          document.getElementById('fontColorInput').addEventListener('change', e => {
            tempSettings.fontColor = e.target.value;
            document.getElementById('fontColorPicker').value = e.target.value;
          });
          document.getElementById('bubbleColorPicker').addEventListener('input', e => {
            tempSettings.bubbleColor = e.target.value;
            document.getElementById('bubbleColorInput').value = e.target.value;
          });
          document.getElementById('bubbleColorInput').addEventListener('change', e => {
            tempSettings.bubbleColor = e.target.value;
            document.getElementById('bubbleColorPicker').value = e.target.value;
          });
          document.getElementById('bubbleOpacitySlider').addEventListener('input', e => {
            tempSettings.bubbleOpacity = e.target.value;
          });

          document.getElementById('saveSettingsBtn').addEventListener('click', () => {
            currentSettings = JSON.parse(JSON.stringify(tempSettings));
            applySettings(currentSettings);
            saveSettings(currentSettings);
            hideModal(settingsModal);
          });

          document.getElementById('editableAppList').addEventListener('click', e => {
            const target = e.target;
            const appId = target.dataset.appId;
            if (!appId) return;
            if (target.classList.contains('edit-app-name-btn')) openEditAppNameModal(appId);
            else if (target.classList.contains('edit-app-icon-btn')) {
              currentEditingTarget = { type: 'appIcon', id: appId };
              showModal(imageChoiceModal);
            }
          });
          document.getElementById('cancelAppChangesBtn').addEventListener('click', () => hideModal(editAppModal));
          document.getElementById('saveAppChangesBtn').addEventListener('click', () => {
            if (currentEditingAppId) {
              const newName = document.getElementById('editAppName').value;
              tempSettings.apps[currentEditingAppId].name = newName;
              const appNameSpan = document
                .querySelector(`#editableAppList .edit-app-name-btn[data-app-id="${currentEditingAppId}"]`)
                .closest('li')
                .querySelector('span');
              appNameSpan.textContent = newName;
              hideModal(editAppModal);
            }
          });

          // --- å›¾ç‰‡ä¸Šä¼ é€»è¾‘ (æ ¸å¿ƒä¿®æ”¹åŒº) ---
          // â–¼â–¼â–¼ ç¬¬äºŒå¤„æ ¸å¿ƒä¿®æ”¹ â–¼â–¼â–¼
          const handleImageUpload = async imageDataUrl => {
            // æ³¨æ„è¿™é‡Œå¢åŠ äº† async
            if (!currentEditingTarget) return;

            if (currentEditingTarget.type === 'wallpaper') {
              tempSettings.wallpaper = imageDataUrl;
              document.getElementById('wallpaperPreview').style.backgroundImage = `url(${imageDataUrl})`;
            } else if (currentEditingTarget.type === 'appIcon') {
              const appId = currentEditingTarget.id;
              tempSettings.apps[appId].icon = imageDataUrl;
              const appIconImg = document
                .querySelector(`#editableAppList .edit-app-icon-btn[data-app-id="${appId}"]`)
                .closest('li')
                .querySelector('img');
              appIconImg.src = imageDataUrl;
            } else if (currentEditingTarget.type === 'charAvatarInSettings') {
              document.getElementById('charSettingsAvatarPreview').src = imageDataUrl;
            } else if (currentEditingTarget.type === 'userAvatarInSettings') {
              document.getElementById('userSettingsAvatarPreview').src = imageDataUrl;
              // â–¼â–¼â–¼ åœ¨è¿™é‡Œæ·»åŠ æ–°çš„ else if åˆ¤æ–­ â–¼â–¼â–¼
            } else if (currentEditingTarget.type === 'newCharAvatar') {
              document.getElementById('newCharAvatarPreview').src = imageDataUrl;
              // â–²â–²â–² æ·»åŠ ç»“æŸ â–²â–²â–²
              // â–¼â–¼â–¼ åœ¨è¿™é‡Œæ·»åŠ æ–°çš„ else if åˆ¤æ–­ â–¼â–¼â–¼
            } else if (currentEditingTarget.type === 'npcAvatar') {
              document.getElementById('npcAvatarPreview').src = imageDataUrl;
              // â–²â–²â–² æ·»åŠ ç»“æŸ â–²â–²â–²
              // â–¼â–¼â–¼ åœ¨è¿™é‡Œæ·»åŠ æ–°çš„ else if åˆ¤æ–­ â–¼â–¼â–¼
              // â–¼â–¼â–¼ ä¿®æ”¹è¿™ä¸ª else if åˆ¤æ–­ â–¼â–¼â–¼
            } else if (currentEditingTarget.type === 'bubbleBackgroundImage') {
              // è®¾ç½®URLè¾“å…¥æ¡†çš„å€¼
              document.getElementById('imageUrlInput').value = imageDataUrl;
              // æ‰‹åŠ¨è§¦å‘inputäº‹ä»¶æ¥æ›´æ–°çŠ¶æ€å’Œé¢„è§ˆ
              document.getElementById('imageUrlInput').dispatchEvent(new Event('input'));
              // â–¼â–¼â–¼ åœ¨è¿™é‡Œæ·»åŠ æ–°çš„ else if åˆ¤æ–­ â–¼â–¼â–¼
            } else if (currentEditingTarget.type === 'charVideoCallImage') {
              document.getElementById('charVideoCallImagePreview').src = imageDataUrl;
            } else if (currentEditingTarget.type === 'userVideoCallImage') {
              document.getElementById('userVideoCallImagePreview').src = imageDataUrl;
              // â–²â–²â–² æ·»åŠ ç»“æŸ â–²â–²â–²
    // â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼ æŠŠè¿™ 3 è¡Œæ–°ä»£ç åŠ åœ¨è¿™é‡Œ â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼
    } else if (currentEditingTarget.type === 'middleIconPreview') {
       document.getElementById('middleIconPreview').src = imageDataUrl;
    // â–²â–²â–²â–²â–²â–²â–²â–²â–²â–² åŠ åœ¨è¿™é‡Œç»“æŸ â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²
            } else {
              // å¯¹äºç‹¬ç«‹çš„æ—§å›¾ç‰‡ï¼Œç›´æ¥æ›´æ–°UIå¹¶å­˜å…¥ IndexedDB
              updateImageUI(currentEditingTarget, imageDataUrl);
              try {
                // ä¸å†ä½¿ç”¨ localStorageï¼Œè€Œæ˜¯å°†æ•°æ®å­˜å…¥ IndexedDB
                // æˆ‘ä»¬å¤ç”¨ userSettings è¡¨ï¼Œç”¨å…ƒç´ çš„ id ä½œä¸ºä¸»é”®
                await db.userSettings.put({ id: currentEditingTarget.id, value: imageDataUrl });
                console.log(`Image data for '${currentEditingTarget.id}' saved to IndexedDB.`);
              } catch (error) {
                console.error(`Failed to save image for '${currentEditingTarget.id}' to IndexedDB:`, error);
                alert(`å›¾ç‰‡ä¿å­˜å¤±è´¥: ${error.message}`);
              }
            }
          };
          // â–²â–²â–² ä¿®æ”¹ç»“æŸ â–²â–²â–²

          document.getElementById('uploadLocalBtn').addEventListener('click', () => {
            fileInput.click();
            hideModal(imageChoiceModal);
          });

          document.getElementById('uploadUrlBtn').addEventListener('click', () => {
            hideModal(imageChoiceModal);
            const url = prompt('è¯·è¾“å…¥å›¾ç‰‡çš„URLé“¾æ¥:');
            // ã€ä¿®æ”¹ã€‘è°ƒç”¨ handleImageUpload æ—¶åªä¼ ä¸€ä¸ªURLå‚æ•°
            if (url) handleImageUpload(url, null);
          });

          // ã€ä¿®æ”¹ã€‘fileInputçš„äº‹ä»¶ç›‘å¬å™¨
          fileInput.addEventListener('change', async event => {
            // æ³¨æ„è¿™é‡ŒåŠ äº† async
            const file = event.target.files[0];
            if (!file) return;

            try {
              // ä½¿ç”¨æ–°å·¥å…·å‡½æ•°å°†æ–‡ä»¶è½¬ä¸º Base64
              const base64String = await fileToBase64(file);
              // åªä¼ é€’ Base64 å­—ç¬¦ä¸²ç»™å¤„ç†å‡½æ•°
              handleImageUpload(base64String);
            } catch (error) {
              console.error('å›¾ç‰‡è½¬ Base64 å¤±è´¥:', error);
              alert('å›¾ç‰‡å¤„ç†å¤±è´¥ï¼Œè¯·é‡è¯•ã€‚');
            }

            event.target.value = ''; // æ¸…ç©º inputï¼Œä»¥ä¾¿ä¸‹æ¬¡èƒ½é€‰æ‹©ç›¸åŒæ–‡ä»¶
          });
          // --- ç”¨æˆ·äººè®¾é¢„è®¾çš„äº‹ä»¶ç›‘å¬ ---
          document.getElementById('saveAsUserPresetBtn').addEventListener('click', saveCurrentUserAsPreset);

          document.getElementById('userPresetsList').addEventListener('click', e => {
            const target = e.target;
            // æ£€æŸ¥æ˜¯å¦ç‚¹å‡»äº†åˆ é™¤æŒ‰é’®
            if (target.classList.contains('delete-preset-btn')) {
              e.stopPropagation(); // é˜²æ­¢è§¦å‘çˆ¶å…ƒç´ çš„ç‚¹å‡»äº‹ä»¶
              const presetId = target.dataset.presetId;
              deleteUserPreset(presetId);
              return;
            }
            // æ£€æŸ¥æ˜¯å¦ç‚¹å‡»äº†é¢„è®¾é¡¹æœ¬èº«ï¼ˆæˆ–å…¶å­å…ƒç´ ï¼‰
            const presetItem = target.closest('.user-preset-item');
            if (presetItem) {
              const presetId = presetItem.dataset.presetId;
              applyUserPreset(presetId);
            }
          });
          const addCharModal = document.getElementById('addCharModal');
          // ä¸ºâ€œæ·»åŠ æ–°äººç‰©â€å¼¹çª—ç»‘å®šäº‹ä»¶
          if (addCharModal) {
            document.getElementById('cancelAddCharBtn').addEventListener('click', () => hideModal(addCharModal));
            document.getElementById('createCharBtn').addEventListener('click', createNewCharacter);
            document.getElementById('changeNewCharAvatarBtn').addEventListener('click', () => {
              currentEditingTarget = { type: 'newCharAvatar' };
              showModal(imageChoiceModal);
            });
          }
          // â–²â–²â–² æ·»åŠ ç»“æŸ â–²â–²â–²
          setupLegacyListeners();
          // æ–°å¢ï¼šåˆå§‹åŒ–APIè®¾ç½®çš„äº‹ä»¶ç›‘å¬
          // æ–°å¢ï¼šåˆå§‹åŒ–APIè®¾ç½®çš„äº‹ä»¶ç›‘å¬
          setupApiEventListeners();

          // â–¼â–¼â–¼ æ–°å¢ï¼šNPC å’Œ è¡¨æƒ…åŒ…åº“çš„äº‹ä»¶ç›‘å¬ â–¼â–¼â–¼

          // --- NPC åº“äº‹ä»¶ ---
          document.getElementById('openNpcLibraryBtn').addEventListener('click', openNpcLibraryModal);
          document
            .getElementById('closeNpcLibraryBtn')
            .addEventListener('click', () => hideModal(document.getElementById('npcLibraryModal')));
          document.getElementById('addNewNpcBtn').addEventListener('click', () => openEditNpcModal('create'));
          document
            .getElementById('addExistingCharAsNpcBtn')
            .addEventListener('click', () => openEditNpcModal('select'));
          document
            .getElementById('cancelNpcBtn')
            .addEventListener('click', () => hideModal(document.getElementById('editNpcModal')));
          document.getElementById('saveNpcBtn').addEventListener('click', saveNpcData);
          document.getElementById('changeNpcAvatarBtn').addEventListener('click', () => {
            currentEditingTarget = { type: 'npcAvatar' };
            showModal(imageChoiceModal);
          });
          document.getElementById('npcList').addEventListener('click', e => {
            if (e.target.classList.contains('edit-npc-btn')) {
              openEditNpcModal('edit', e.target.dataset.npcId);
            }
            if (e.target.classList.contains('delete-npc-btn')) {
              deleteNpc(e.target.dataset.npcId);
            }
          });

          // --- è¡¨æƒ…åŒ…åº“äº‹ä»¶ ---
          document.getElementById('openStickerLibraryBtn').addEventListener('click', openStickerLibraryModal);
          document
            .getElementById('closeStickerLibraryBtn')
            .addEventListener('click', () => hideModal(document.getElementById('stickerLibraryModal')));
          document.getElementById('addStickersBtn').addEventListener('click', openAddStickersModal);
          document
            .getElementById('cancelAddStickersBtn')
            .addEventListener('click', () => hideModal(document.getElementById('addStickersModal')));
          document.getElementById('saveStickersBtn').addEventListener('click', parseAndSaveStickers);

          // --- Tab åˆ‡æ¢ (ä¿®æ­£ç‰ˆ) ---
          document.getElementById('stickerTabs').addEventListener('click', e => {
            const tabButton = e.target.closest('.sticker-tab-btn');
            if (!tabButton) return;

            // 1. ç§»é™¤æ‰€æœ‰æŒ‰é’®å’Œå†…å®¹çš„ active çŠ¶æ€
            document.querySelectorAll('#stickerTabs .sticker-tab-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.sticker-tab-content').forEach(content => content.classList.remove('active'));

            // 2. è·å–è¢«ç‚¹å‡»çš„ tab çš„åç§° (exclusive æˆ– common)
            const tabName = tabButton.dataset.tab;
            activeStickerTab = tabName; // æ ¸å¿ƒï¼šæ›´æ–°å…¨å±€çŠ¶æ€å˜é‡ï¼Œè¿™å¯¹â€œæ·»åŠ è¡¨æƒ…â€åŠŸèƒ½è‡³å…³é‡è¦ï¼

            // 3. ä¸ºç‚¹å‡»çš„æŒ‰é’®å’Œå¯¹åº”çš„å†…å®¹æ·»åŠ  active çŠ¶æ€
            tabButton.classList.add('active');
            const targetContent = document.getElementById(`${tabName}StickersTab`);
            if (targetContent) {
              targetContent.classList.add('active');
            }
          });

          // --- è§’è‰²è¡¨æƒ…åŒ…åº“çš„äº‹ä»¶ç›‘å¬ (ä¸“å±ä¸é€šç”¨) ---
          ['exclusiveStickerGrid', 'commonStickerGrid'].forEach(gridId => {
            document.getElementById(gridId).addEventListener('click', e => {
              const stickerItem = e.target.closest('.sticker-item');
              // ç¡®ä¿ç‚¹å‡»çš„æ˜¯è´´å›¾é¡¹ï¼Œå¹¶ä¸”å½“å‰æ˜¯åœ¨è§’è‰²è¡¨æƒ…åŒ…ä¸Šä¸‹æ–‡
              if (!stickerItem || currentStickerContext !== 'char') return;

              const deleteButton = e.target.closest('.delete-sticker-btn');

              if (isStickerManageMode) {
                // æ‰¹é‡ç®¡ç†æ¨¡å¼ä¸‹ï¼Œç‚¹å‡»æ•´ä¸ªè´´å›¾æ˜¯é€‰ä¸­/å–æ¶ˆé€‰ä¸­
                stickerItem.classList.toggle('selected');
              } else if (deleteButton) {
                // éç®¡ç†æ¨¡å¼ä¸‹ï¼Œåªæœ‰ç‚¹å‡»åˆ é™¤æŒ‰é’®æ‰æœ‰æ•ˆ
                e.stopPropagation(); // é˜²æ­¢äº‹ä»¶å†’æ³¡
                const type = stickerItem.dataset.type;
                const index = parseInt(stickerItem.dataset.index, 10);

                // å…³é”®ï¼šè°ƒç”¨æˆ‘ä»¬ä¸ºè§’è‰²è¡¨æƒ…å®šåˆ¶çš„åˆ é™¤å‡½æ•°
                if (confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªè¡¨æƒ…å—ï¼Ÿ')) {
                  deleteCharSticker(type, index);
                }
              }
            });
          });

          // --- æ‰¹é‡ç®¡ç†è¡¨æƒ…åŒ…çš„äº‹ä»¶ ---
          const stickerModal = document.getElementById('stickerLibraryModal');
          const normalButtons = document.getElementById('stickerNormalButtons');
          const manageButtons = document.getElementById('stickerManageButtons');

          // å°è£…ä¸€ä¸ªé€€å‡ºç®¡ç†æ¨¡å¼çš„å‡½æ•°ï¼Œæ–¹ä¾¿å¤ç”¨
          const exitStickerManageMode = () => {
            isStickerManageMode = false;
            stickerModal.classList.remove('manage-mode');
            stickerModal.querySelectorAll('.sticker-item.selected').forEach(el => el.classList.remove('selected'));
            normalButtons.style.display = 'flex';
            manageButtons.style.display = 'none';
          };

          // ç‚¹å‡»â€œæ‰¹é‡ç®¡ç†â€æŒ‰é’®
          document.getElementById('bulkManageStickersBtn').addEventListener('click', () => {
            isStickerManageMode = true;
            stickerModal.classList.add('manage-mode');
            normalButtons.style.display = 'none';
            manageButtons.style.display = 'flex';
          });

          // ç‚¹å‡»â€œå–æ¶ˆâ€æŒ‰é’®
          document.getElementById('cancelManageStickersBtn').addEventListener('click', exitStickerManageMode);

          // â–¼â–¼â–¼ ç”¨è¿™ä¸ªã€ä¿®æ­£ç‰ˆã€‘æ›¿æ¢ 'confirmDeleteStickersBtn' çš„äº‹ä»¶ç›‘å¬å™¨ â–¼â–¼â–¼
          document.getElementById('confirmDeleteStickersBtn').addEventListener('click', async () => {
            const stickerModal = document.getElementById('stickerLibraryModal');

            // 1. åˆ†åˆ«è·å–æ¥è‡ªâ€œä¸“å±â€å’Œâ€œé€šç”¨â€ç½‘æ ¼çš„é€‰ä¸­é¡¹
            const selectedExclusive = stickerModal.querySelectorAll('#exclusiveStickerGrid .sticker-item.selected');
            const selectedCommon = stickerModal.querySelectorAll('#commonStickerGrid .sticker-item.selected');

            const totalSelectedCount = selectedExclusive.length + selectedCommon.length;

            if (totalSelectedCount === 0) {
              alert('è¯·å…ˆé€‰æ‹©è¦åˆ é™¤çš„è¡¨æƒ…ï¼');
              return;
            }
            if (!confirm(`ç¡®å®šè¦åˆ é™¤è¿™ ${totalSelectedCount} ä¸ªè¡¨æƒ…å—ï¼Ÿ`)) {
              return;
            }

            let dataChanged = false;

            // 2. å¤„ç†â€œä¸“å±è¡¨æƒ…â€çš„åˆ é™¤
            if (selectedExclusive.length > 0) {
              // ä» DOM å…ƒç´ ä¸­æå–éœ€è¦åˆ é™¤çš„ç´¢å¼•ï¼Œå¹¶ä»å¤§åˆ°å°æ’åºï¼Œé˜²æ­¢ splice é”™ä½
              const exclusiveIndicesToDelete = Array.from(selectedExclusive)
                .map(item => parseInt(item.dataset.index, 10))
                .sort((a, b) => b - a);

              const charStickers = chatData[currentChatId].charSettings.exclusiveStickers;
              if (charStickers) {
                exclusiveIndicesToDelete.forEach(index => {
                  charStickers.splice(index, 1);
                });
                dataChanged = true;
              }
            }

            // 3. å¤„ç†â€œé€šç”¨è¡¨æƒ…â€çš„åˆ é™¤
            if (selectedCommon.length > 0) {
              const commonIndicesToDelete = Array.from(selectedCommon)
                .map(item => parseInt(item.dataset.index, 10))
                .sort((a, b) => b - a);

              // ç›´æ¥æ“ä½œå…¨å±€çš„ commonStickers æ•°ç»„
              if (commonStickers) {
                commonIndicesToDelete.forEach(index => {
                  commonStickers.splice(index, 1);
                });
                // æ³¨æ„ï¼šé€šç”¨è¡¨æƒ…ä¸ä¿å­˜åœ¨ chatData ä¸­ï¼Œéœ€è¦å•ç‹¬ä¿å­˜
                await saveCommonStickers();
              }
            }

            // 4. å¦‚æœä¸“å±è¡¨æƒ…æœ‰å˜åŠ¨ï¼Œä¿å­˜ chatData
            if (dataChanged) {
              await saveChatData();
            }

            // 5. é€€å‡ºç®¡ç†æ¨¡å¼å¹¶é‡æ–°æ¸²æŸ“
            // æ‰¾åˆ°å¹¶è°ƒç”¨ä½ ç°æœ‰çš„é€€å‡ºç®¡ç†æ¨¡å¼çš„å‡½æ•°
            const exitStickerManageMode = () => {
              isStickerManageMode = false;
              stickerModal.classList.remove('manage-mode');
              stickerModal.querySelectorAll('.sticker-item.selected').forEach(el => el.classList.remove('selected'));
              document.getElementById('stickerNormalButtons').style.display = 'flex';
              document.getElementById('stickerManageButtons').style.display = 'none';
            };
            exitStickerManageMode();
            renderStickers(); // é‡æ–°æ¸²æŸ“ï¼Œæ˜¾ç¤ºåˆ é™¤åçš„ç»“æœ
          });

          // â–¼â–¼â–¼ ç”¨è¿™ä¸ª V3 æ–°ç‰ˆæœ¬æ›¿æ¢æ—§çš„ "æ°”æ³¡ç¼–è¾‘å™¨äº‹ä»¶" ä»£ç å— â–¼â–¼â–¼

          // --- æ°”æ³¡ç¼–è¾‘å™¨äº‹ä»¶ (V3) ---
          document.getElementById('openBubbleEditorBtn').addEventListener('click', openBubbleEditor);
          document.getElementById('closeBubbleEditorBtn').addEventListener('click', () => hideModal(bubbleEditorModal));

          // Tab åˆ‡æ¢
          document.getElementById('bubbleEditorTabs').addEventListener('click', e => {
            if (e.target.classList.contains('sticker-tab-btn')) {
              document
                .querySelectorAll('#bubbleEditorTabs .sticker-tab-btn, .bubble-editor-controls .sticker-tab-content')
                .forEach(el => el.classList.remove('active'));
              const tab = e.target.dataset.tab;
              e.target.classList.add('active');
              document.getElementById(tab === 'visual' ? 'visualEditorTab' : 'cssEditorTab').classList.add('active');
            }
          });

          // åˆ‡æ¢ç¼–è¾‘ç›®æ ‡
          // å®æ—¶é¢„è§ˆCSSä»£ç 
          document.getElementById('bubbleCssInput').addEventListener('input', e => {
            applyBubblePreview(e.target.value);
          });

          document.querySelectorAll('input[name="editTarget"]').forEach(radio => {
            radio.addEventListener('change', e => switchVisualEditorTarget(e.target.value));
          });

          // â–¼â–¼â–¼ ç”¨è¿™ä¸ªæ–°ç‰ˆæœ¬æ›¿æ¢ .visual-editor-control çš„äº‹ä»¶ç›‘å¬å™¨å†…éƒ¨é€»è¾‘ â–¼â–¼â–¼
          document.querySelectorAll('.visual-editor-control').forEach(input => {
            input.addEventListener('input', e => {
              const target = e.target;
              const controlName = target.dataset.control;
              let value = target.type === 'checkbox' ? target.checked : target.value;

              // å®æ—¶æ•°å€¼æ˜¾ç¤º (æ»‘å—)
              if (target.dataset.unit) {
                document.getElementById(`${target.id}Value`).textContent = value + target.dataset.unit;
                value += target.dataset.unit;
              } else if (target.id === 'glassEffectOpacity') {
                document.getElementById('glassEffectOpacityValue').textContent = value;
              }

              // åŒæ­¥é¢œè‰²é€‰æ‹©å™¨å’Œæ–‡æœ¬æ¡†
              const sync = (pickerId, hexId) => {
                if (target.id === pickerId) document.getElementById(hexId).value = value;
                else if (target.id === hexId) document.getElementById(pickerId).value = value;
              };
              sync('bubbleBgColor', 'bubbleBgColorHex');
              sync('gradientStartColor', 'gradientStartColorHex');
              sync('gradientEndColor', 'gradientEndColorHex');
              sync('glassEffectColor', 'glassEffectColorHex');
              sync('glassGradientStartColor', 'glassGradientStartColorHex');
              sync('glassGradientEndColor', 'glassGradientEndColorHex');

              // æ›´æ–°çŠ¶æ€å¯¹è±¡
              const state = visualEditorState[currentVisualTarget];
              if (controlName.includes('.')) {
                const keys = controlName.split('.');
                let temp = state;
                for (let i = 0; i < keys.length - 1; i++) {
                  temp = temp[keys[i]];
                }
                temp[keys[keys.length - 1]] = target.type === 'checkbox' ? target.checked : target.value;
              } else {
                state[controlName] = value;
              }

              // è”åŠ¨UI
              if (controlName === 'bgType' || controlName === 'glass.enabled' || controlName === 'glass.bgType') {
                loadStateToVisualEditor(currentVisualTarget);
              }

              updateVisualPreview();
            });
          });

          // ä¸Šä¼ èƒŒæ™¯å›¾ç‰‡
          document.getElementById('uploadBgImageBtn').addEventListener('click', () => {
            currentEditingTarget = { type: 'bubbleBackgroundImage' };
            showModal(imageChoiceModal);
          });

          // ä»å¯è§†åŒ–ç”ŸæˆCSS
          document.getElementById('generateCssFromVisual').addEventListener('click', () => {
            const charCss = generateCssString('char');
            const userCss = generateCssString('user');
            const combinedCss = `/* CHAR BUBBLE */\n.char-message & {\n  ${charCss}\n}\n\n/* USER BUBBLE */\n.user-message & {\n  ${userCss}\n}`;
            document.getElementById('bubbleCssInput').value = combinedCss;
            alert(
              'å·²ç”ŸæˆCSSåˆ°ä»£ç é¡µï¼è¯·æ³¨æ„ï¼Œè¿™æ˜¯ä¸€ä¸ªå®éªŒæ€§åŠŸèƒ½ï¼ŒSASSåµŒå¥—è¯­æ³• (&) å¯èƒ½ä¸ä¼šåœ¨æ‰€æœ‰åœ°æ–¹éƒ½ç”Ÿæ•ˆï¼Œè¿™é‡Œä¸»è¦ç”¨äºä¿å­˜é¢„è®¾ã€‚',
            );
          });

          // é¢„è®¾æ“ä½œ
          document.getElementById('saveBubbleAsPresetBtn').addEventListener('click', saveBubbleAsPreset);
          document.getElementById('deleteBubblePresetBtn').addEventListener('click', deleteBubblePreset);
          document.getElementById('applyBubbleBtn').addEventListener('click', applyBubblePresetToChar);

          // åŠ è½½é¢„è®¾
          // åŠ è½½é¢„è®¾
          document.getElementById('bubblePresetSelect').addEventListener('change', async e => {
            const presetId = parseInt(e.target.value);
            if (presetId) {
              const preset = await db.chatBubblePresets.get(presetId);
              if (preset) {
                document.getElementById('bubbleCssInput').value = preset.css;
                document.querySelector('#bubbleEditorTabs .sticker-tab-btn[data-tab="css"]').click();
                // â–¼â–¼â–¼ æ–°å¢ä¸‹é¢è¿™ä¸€è¡Œ â–¼â–¼â–¼
                document.getElementById('bubbleCssInput').dispatchEvent(new Event('input'));
              }
            }
          });
          // --- åˆ†ç»„ç®¡ç†å¼¹çª—äº‹ä»¶ (æ–°) ---
          document.getElementById('groupManagementBtn').addEventListener('click', openGroupManagementModal);
          document
            .getElementById('closeGroupManagementBtn')
            .addEventListener('click', () => hideModal(groupManagementModal));
          document.getElementById('addNewGroupBtn').addEventListener('click', addNewGroup);

          // ä½¿ç”¨äº‹ä»¶å§”æ‰˜å¤„ç†åŠ¨æ€ç”Ÿæˆçš„åˆ—è¡¨é¡¹
          document.getElementById('groupManagementList').addEventListener('click', async e => {
            const item = e.target.closest('.group-manage-item');
            if (!item) return;

            const groupName = item.dataset.groupName;
            if (!groupName) return;

            // å¤„ç† "å±•å¼€" å¤é€‰æ¡†
            if (e.target.classList.contains('group-expand-toggle')) {
              groupSettings[groupName].expanded = e.target.checked;
              await saveGroupSettings();
              // æ— éœ€é‡æ¸²æŸ“ç®¡ç†åˆ—è¡¨ï¼Œä½†éœ€è¦é‡æ¸²æŸ“é€šè®¯å½•åˆ—è¡¨æ‰èƒ½ç«‹å³çœ‹åˆ°æ•ˆæœ
              renderContactsList();
            }
            // å¤„ç† "ç½®é¡¶" æŒ‰é’®
            else if (e.target.classList.contains('pin-group-btn')) {
              groupSettings[groupName].pinned = !groupSettings[groupName].pinned;
              await saveGroupSettings();
              renderGroupManagementList(); // é‡æ¸²æŸ“ç®¡ç†åˆ—è¡¨ä»¥æ›´æ–°æŒ‰é’®çŠ¶æ€
              renderContactsList(); // é‡æ¸²æŸ“é€šè®¯å½•ä»¥æ›´æ–°æ’åº
            }
            // å¤„ç† "åˆ é™¤" æŒ‰é’®
            else if (e.target.classList.contains('delete-group-btn')) {
              currentGroupToDelete = groupName;
              document.getElementById('deleteGroupConfirmTitle').textContent = `ç¡®è®¤åˆ é™¤åˆ†ç»„ "${groupName}"`;
              showModal(deleteGroupConfirmModal);
            }
          });

          // åˆ é™¤ç¡®è®¤å¼¹çª—çš„æŒ‰é’®äº‹ä»¶
          document.getElementById('deleteGroupAndCharsBtn').addEventListener('click', () => handleGroupDeletion('all'));
          document
            .getElementById('deleteGroupOnlyBtn')
            .addEventListener('click', () => handleGroupDeletion('only_group'));
          document.getElementById('cancelDeleteGroupBtn').addEventListener('click', () => {
            currentGroupToDelete = null;
            hideModal(deleteGroupConfirmModal);
          });

          // æ‰¾åˆ°æ—§çš„ openStickerLibraryBtn çš„ç›‘å¬å™¨å¹¶ä¿®æ”¹å®ƒ
          document.getElementById('openStickerLibraryBtn').addEventListener('click', () => {
            openStickerLibraryModal('char'); // æ˜ç¡®æŒ‡å®š 'char' ä¸Šä¸‹æ–‡
          });
          // â–¼â–¼â–¼ æŠŠè¿™æ®µæ–°çš„äº‹ä»¶ç›‘å¬é€»è¾‘ï¼Œç²˜è´´åˆ° setupEventListeners() å‡½æ•°å†… â–¼â–¼â–¼
          // --- æ‹ç«‹å¾—ç»„ä»¶ç‚¹å‡»äº‹ä»¶ ---
          // --- æ‹ç«‹å¾—æ–‡å­—ç‚¹å‡»ç¼–è¾‘ (æ–°å¢) ---
          const polaroidTextEl = document.getElementById('polaroidText');
          if (polaroidTextEl) {
            polaroidTextEl.addEventListener('click', (e) => {
              e.stopPropagation(); // ğŸ”´ å…³é”®ï¼šé˜»æ­¢å†’æ³¡ï¼Œé˜²æ­¢è§¦å‘æ‹ç«‹å¾—æ¢å›¾
              currentEditingTarget = polaroidTextEl;
              document.getElementById('textEditTitle').textContent = 'ç¼–è¾‘æ‹ç«‹å¾—æ–‡å­—';
              document.getElementById('textEditArea').value = polaroidTextEl.textContent;
              showModal(textEditModal);
              setTimeout(() => document.getElementById('textEditArea').focus(), 310);
            });
          }

          document.getElementById('polaroidMainBox').addEventListener('click', () => {
            currentEditingTarget = { type: 'polaroidMain' };
            showModal(imageChoiceModal);
          });
          
          document.getElementById('filmFrame1').addEventListener('click', () => {
            currentEditingTarget = { type: 'film1' };
            showModal(imageChoiceModal);
          });

          document.getElementById('filmFrame2').addEventListener('click', () => {
            currentEditingTarget = { type: 'film2' };
            showModal(imageChoiceModal);
          });

          document.getElementById('filmFrame3').addEventListener('click', () => {
            currentEditingTarget = { type: 'film3' };
            showModal(imageChoiceModal);
          });

          // --- å·¥å…·æ å‘é€å›¾ç‰‡æŒ‰é’® ---
          if (toolbarImageBtn) {
            toolbarImageBtn.addEventListener('click', () => {
              showModal(sendImageChoiceModal);
            });
          }
          // --- å·¥å…·æ è¯­éŸ³è¾“å…¥æŒ‰é’® (æ–°) ---
          const toolbarVoiceBtn = document.getElementById('toolbar-voice-btn');
          const voiceInputModal = document.getElementById('voiceInputModal');

          if (toolbarVoiceBtn) {
            toolbarVoiceBtn.addEventListener('click', () => {
              // éšè—å…¶ä»–é¢æ¿å¹¶æ‰“å¼€è¯­éŸ³è¾“å…¥å¼¹çª—
              hideModal(sendImageChoiceModal); // å¦‚æœå›¾ç‰‡é€‰æ‹©å¼¹çª—å¼€ç€ï¼Œå…³æ‰å®ƒ

              const voiceInputText = document.getElementById('voiceInputText');
              voiceInputText.value = ''; // æ¸…ç©ºè¾“å…¥æ¡†

              showModal(voiceInputModal);
              // å¼¹çª—å‡ºç°åè‡ªåŠ¨èšç„¦è¾“å…¥æ¡†ï¼Œä½“éªŒæ›´å¥½
              setTimeout(() => voiceInputText.focus(), 310);
            });
          }

          // --- è¯­éŸ³è¾“å…¥å¼¹çª—çš„äº‹ä»¶ç›‘å¬ (æ–°) ---
          if (voiceInputModal) {
            // "ç¡®è®¤å‘é€" æŒ‰é’®
            document.getElementById('sendVoiceConfirmBtn').addEventListener('click', async () => {
              const voiceInputText = document.getElementById('voiceInputText').value.trim();
              if (!voiceInputText) {
                alert('è¯­éŸ³å†…å®¹ä¸èƒ½ä¸ºç©ºå“¦ï¼');
                return;
              }

              // æˆ‘ä»¬ç”¨ä¸€ä¸ªç‰¹æ®Šæ ¼å¼æ¥æ ‡è®°è¿™æ˜¯ä¸€æ¡è¯­éŸ³æ¶ˆæ¯
              const messageContent = `[è¯­éŸ³] ${voiceInputText}`;

              // åˆ›å»ºæ¶ˆæ¯å¯¹è±¡
              const message = {
                role: 'user',
                content: messageContent,
                isStaging: true, // æ ‡è®°ä¸ºæš‚å­˜ï¼Œç­‰å¾…ç”¨æˆ·ç‚¹å‡»"å‘é€"
              };

              // æ·»åŠ åˆ°èŠå¤©è®°å½•å¹¶ä¿å­˜
              chatData[currentChatId].history.push(message);
              await saveChatData();

              // åˆ·æ–°èŠå¤©ç•Œé¢
              renderChatMessages(currentChatId);

              // å…³é—­å¼¹çª—å’Œå·¥å…·æ 
              hideModal(voiceInputModal);
              closeAllPanels();
            });

            // "å–æ¶ˆ" æŒ‰é’®
            document.getElementById('cancelVoiceInputBtn').addEventListener('click', () => {
              hideModal(voiceInputModal);
            });
          }

          // â–¼â–¼â–¼ ç”¨è¿™æ®µå…¨æ–°çš„é€»è¾‘æ›¿æ¢ä¸Šæ¬¡çš„â€œå‘é€å›¾ç‰‡é€‰æ‹©å¼¹çª—â€äº‹ä»¶ç›‘å¬ â–¼â–¼â–¼

          // --- å·¥å…·æ å‘é€å›¾ç‰‡æŒ‰é’® (toolbar-image-btn) ---
          if (toolbarImageBtn) {
            toolbarImageBtn.addEventListener('click', () => {
              // ç›´æ¥æ˜¾ç¤ºæˆ‘ä»¬ä¸Šæ¬¡æ·»åŠ çš„ sendImageChoiceModal å¼¹çª—
              showModal(document.getElementById('sendImageChoiceModal'));
            });
          }

          // --- å›¾ç‰‡å‘é€ç±»å‹é€‰æ‹©å¼¹çª— ---
          const sendImageChoiceModal = document.getElementById('sendImageChoiceModal');
          if (sendImageChoiceModal) {
            // 1. ç‚¹å‡»â€œå‘é€çœŸå®å›¾ç‰‡â€ -> åªè§¦å‘æœ¬åœ°æ–‡ä»¶é€‰æ‹©
            document.getElementById('sendRealImageBtn').addEventListener('click', () => {
              hideModal(sendImageChoiceModal);

              // åˆ›å»ºä¸€ä¸ªä¸“ç”¨çš„ã€ä¸´æ—¶çš„file input
              const tempImageInput = document.createElement('input');
              tempImageInput.type = 'file';
              tempImageInput.accept = 'image/*';

              tempImageInput.addEventListener('change', async event => {
                const file = event.target.files[0];
                if (!file) return;

                try {
                  const base64String = await fileToBase64(file); // å¤ç”¨ä½ çš„å·¥å…·å‡½æ•°

                  // 1. åˆ›å»ºä¸€ä¸ªåŒ…å«å›¾ç‰‡çš„æ¶ˆæ¯å¯¹è±¡
                  const message = {
                    role: 'user',
                    content: `<img src="${base64String}" class="message-image">`, // ç›´æ¥ä½¿ç”¨imgæ ‡ç­¾æ¥æ˜¾ç¤º
                    // ã€æ ¸å¿ƒã€‘å¢åŠ ä¸´æ—¶çŠ¶æ€å’Œå›¾ç‰‡æ•°æ®
                    isStaging: true,
                    base64: base64String, // å­˜å‚¨åŸå§‹base64æ•°æ®ï¼Œç”¨äºå‘é€ç»™API
                  };

                  // 2. æ·»åŠ åˆ°èŠå¤©å†å²
                  chatData[currentChatId].history.push(message);
                  await saveChatData();
                  // 3. é‡æ–°æ¸²æŸ“èŠå¤©ç•Œé¢
                  renderChatMessages(currentChatId);

                  closeAllPanels(); // å‘é€åå…³é—­å·¥å…·æ 
                } catch (error) {
                  console.error('å›¾ç‰‡å¤„ç†å¤±è´¥:', error);
                  alert('å›¾ç‰‡å¤„ç†å¤±è´¥ï¼Œè¯·é‡è¯•ã€‚');
                }
              });

              tempImageInput.click(); // è§¦å‘æ–‡ä»¶é€‰æ‹©æ¡†
            });

            // 2. ç‚¹å‡»â€œå‘é€æ–‡å­—å›¾â€ -> æ˜¾ç¤ºæˆ‘ä»¬æ–°åšçš„å¯çˆ±å¼¹çª—
            document.getElementById('sendTextImageBtn').addEventListener('click', () => {
              hideModal(sendImageChoiceModal);
              textImageDescriptionInput.value = ''; // æ¸…ç©ºè¾“å…¥æ¡†
              showModal(textImageModal);
              setTimeout(() => textImageDescriptionInput.focus(), 310);
            });

            // 3. å…³é—­æŒ‰é’®
            document
              .getElementById('cancelSendImageChoiceBtn')
              .addEventListener('click', () => hideModal(sendImageChoiceModal));
          }

          // --- æ–‡å­—å›¾æè¿°å¼¹çª—çš„äº‹ä»¶ ---
          if (textImageModal) {
            // ç‚¹å‡»â€œç¡®è®¤å‘é€â€
            // â–¼â–¼â–¼ è¯·æ‰¾åˆ°å¹¶ç”¨è¿™ä¸ªã€ä¿®æ­£ç‰ˆã€‘æ›¿æ¢ 'sendTextImageConfirmBtn' çš„ç‚¹å‡»äº‹ä»¶ç›‘å¬å™¨ â–¼â–¼â–¼
            document.getElementById('sendTextImageConfirmBtn').addEventListener('click', async () => {
              // <--- å…³é”®ä¿®æ”¹ï¼åœ¨è¿™é‡ŒåŠ ä¸Š async
              const description = textImageDescriptionInput.value.trim();
              if (!description) {
                alert('å›¾ç‰‡æè¿°ä¸èƒ½ä¸ºç©ºå“¦ï¼');
                return;
              }

              const placeholderUrl = 'https://kycloud4.koyoo.cn/2025111108246202511110219597210.jpg';

              const message = {
                role: 'user',
                content: `[text_image description="${description}"]${placeholderUrl}[/text_image]`,
                isStaging: true,
              };

              chatData[currentChatId].history.push(message);

              // ç°åœ¨è¿™è¡Œä»£ç å°±å¯ä»¥æ­£å¸¸å·¥ä½œäº†ï¼
              await saveChatData();

              renderChatMessages(currentChatId);

              hideModal(textImageModal);
              closeAllPanels();
            });
          }
          setupWorldBookEventListeners();
          // ================== å…³è”ä¸–ç•Œä¹¦äº‹ä»¶ç›‘å¬ (æ–°) ==================
          const associateWorldBookModal = document.getElementById('associateWorldBookModal');

          // åœ¨è§’è‰²è®¾ç½®é¢æ¿ï¼Œç‚¹å‡»â€œå…³è”ä¸–ç•Œä¹¦â€åŒºåŸŸï¼Œæ‰“å¼€é€‰æ‹©å¼¹çª—
          document.getElementById('charWorldBookDisplay').addEventListener('click', openAssociateWorldBookModal);

          // é€‰æ‹©å¼¹çª—ä¸­çš„â€œä¿å­˜â€æŒ‰é’®
          document.getElementById('saveWorldBookAssociationBtn').addEventListener('click', saveWorldBookAssociation);

          // é€‰æ‹©å¼¹çª—ä¸­çš„â€œå–æ¶ˆâ€æŒ‰é’®
          document.getElementById('cancelWorldBookAssociationBtn').addEventListener('click', () => {
            hideModal(associateWorldBookModal);
          });
          // ä¸ºâ€œæ·»åŠ æ–°äººç‰©â€å¼¹çª—ç»‘å®šäº‹ä»¶
          if (addCharModal) {
            document.getElementById('cancelAddCharBtn').addEventListener('click', () => hideModal(addCharModal));
            document.getElementById('createCharBtn').addEventListener('click', createNewCharacter);
            document.getElementById('changeNewCharAvatarBtn').addEventListener('click', () => {
              currentEditingTarget = { type: 'newCharAvatar' };
              showModal(imageChoiceModal);
            });

            // â–¼â–¼â–¼ æ–°å¢çš„å¯¼å…¥æŒ‰é’®äº‹ä»¶ç›‘å¬ â–¼â–¼â–¼
            const importCardBtn = document.getElementById('importCardBtn');
            const cardFileInput = document.getElementById('cardFileInput');

            if (importCardBtn && cardFileInput) {
              importCardBtn.addEventListener('click', () => {
                cardFileInput.click(); // ç‚¹å‡»æŒ‰é’®æ—¶ï¼Œè§¦å‘éšè—çš„æ–‡ä»¶è¾“å…¥æ¡†
              });

              cardFileInput.addEventListener('change', event => {
                const file = event.target.files[0];
                if (file) {
                  importCharacterCard(file);
                }
                // æ¸…ç©ºinputçš„å€¼ï¼Œä»¥ä¾¿ä¸‹æ¬¡èƒ½é€‰æ‹©åŒä¸€ä¸ªæ–‡ä»¶
                event.target.value = '';
              });
            }
            // â–²â–²â–² æ–°å¢ç»“æŸ â–²â–²â–²
          }
          // â–¼â–¼â–¼ æ‰¾åˆ°å¹¶ç”¨è¿™ä¸ªç‰ˆæœ¬æ›¿æ¢æ—§çš„ toolbarVideoCallBtn.addEventListener â–¼â–¼â–¼
          if (toolbarVideoCallBtn) {
            toolbarVideoCallBtn.addEventListener('click', () => {
              if (!currentChatId) return;

              const charName = chatData[currentChatId].charSettings.nickname;
              const charAvatar = chatData[currentChatId].charSettings.avatar;

              // 1. å¡«å……å¼¹çª—å†…å®¹
              document.getElementById('waiting-char-avatar').src = charAvatar;
              document.getElementById('waiting-char-name').textContent = charName;
              document.getElementById('video-call-invite-text').textContent = 'æ­£åœ¨å‘¼å«å¯¹æ–¹...';

              // 2. ã€æ ¸å¿ƒä¿®æ­£ã€‘ç¡®ä¿æ­£ç¡®æ˜¾ç¤º/éšè—æŒ‰é’®ç»„
              document.getElementById('incoming-call-buttons').style.display = 'none';
              document.getElementById('outgoing-call-button').style.display = 'flex'; // ä½¿ç”¨ flex æ›´å¥½çœ‹

              showModal(videoCallInviteModal);

              // æ¨¡æ‹ŸCharåœ¨2~4ç§’ååšå†³å®š (è¿™éƒ¨åˆ†é€»è¾‘ä¿æŒä¸å˜)
              const decisionTime = 2000 + Math.random() * 2000;
              setTimeout(() => {
                if (!videoCallInviteModal.classList.contains('show')) return;

                const acceptanceChance = 0.8;
                if (Math.random() < acceptanceChance) {
                  document.getElementById('video-call-invite-text').textContent = 'å¯¹æ–¹å·²æ¥å¬ï¼Œæ­£åœ¨è¿æ¥...';
                  setTimeout(() => {
                    hideModal(videoCallInviteModal);
                    startVideoCall();
                  }, 800);
                } else {
                  hideModal(videoCallInviteModal);
                  alert(`${charName} å¿™çº¿ä¸­ï¼Œæ‹’ç»äº†ä½ çš„é€šè¯é‚€è¯·ã€‚`);
                }
              }, decisionTime);
            });
          }

          // Useråœ¨ç­‰å¾…æ—¶å¯ä»¥éšæ—¶æŒ‚æ–­
          document.getElementById('cancel-video-call-btn').addEventListener('click', () => {
            hideModal(videoCallInviteModal);
          });

          // â–¼â–¼â–¼ ç”¨è¿™ä¸ªå®Œæ•´çš„ä»£ç å—ï¼Œæ›¿æ¢æ‰ä½ åŸæ¥çš„ accept/reject/cancel ä¸‰ä¸ªæŒ‰é’®çš„äº‹ä»¶ç›‘å¬å™¨ â–¼â–¼â–¼

          // ã€æ–°ã€‘â€œæ¥å¬â€æŒ‰é’®ï¼šUser æ¥å— Char çš„æ¥ç”µ
          document.getElementById('accept-video-call-btn').addEventListener('click', () => {
            hideModal(videoCallInviteModal);
            startVideoCall(); // æ­£å¸¸è¿›å…¥é€šè¯ç•Œé¢

            // å»¶è¿Ÿä¸€å°ä¼šå„¿ï¼Œç­‰é€šè¯ç•Œé¢å®Œå…¨æ˜¾ç¤ºåï¼Œå†è¯´å‡ºç¬¬ä¸€å¥è¯
            setTimeout(() => {
              if (pendingCallInfo && pendingCallInfo.openingLine) {
                addVideoDialogueLine('char', pendingCallInfo.openingLine);

                // å°†å¼€åœºç™½ä¹Ÿå­˜å…¥èŠå¤©ä¸»è®°å½•ï¼Œä½œä¸ºä¸Šä¸‹æ–‡
                chatData[currentChatId].history.push({
                  role: 'assistant',
                  content: `[è§†é¢‘é€šè¯ä¸­] ${pendingCallInfo.openingLine}`,
                });
                saveChatData();
              }
              pendingCallInfo = null; // ç”¨å®Œåæ¸…ç©º
            }, 500);
          });

          // ã€æ–°ã€‘â€œæ‹’ç»â€æŒ‰é’®ï¼šUser æ‹’ç» Char çš„æ¥ç”µ
          document.getElementById('reject-video-call-btn').addEventListener('click', async () => {
            hideModal(videoCallInviteModal);
            pendingCallInfo = null; // æ¸…ç©ºå¾…å¤„ç†çš„é€šè¯

            // 1. åœ¨ä¸»èŠå¤©çª—å£æ·»åŠ ä¸€æ¡ç”¨æˆ·æ‹’ç»çš„è®°å½•ï¼Œä¸ºAIæä¾›ä¸Šä¸‹æ–‡
            const rejectionMessage = {
              role: 'user', // è®°åœ¨ user åä¸‹ï¼Œè¡¨ç¤ºæ˜¯ç”¨æˆ·çš„è¡Œä¸º
              content: '[ä½ æ‹’ç»äº†å¯¹æ–¹çš„è§†é¢‘é€šè¯é‚€è¯·]',
            };
            chatData[currentChatId].history.push(rejectionMessage);
            await saveChatData();
            renderChatMessages(currentChatId); // ç«‹å³æ˜¾ç¤ºåœ¨ç•Œé¢ä¸Š

            // 2. ç«‹å³è§¦å‘AIå“åº”ï¼ŒAIçœ‹åˆ°ä¸Šé¢çš„æ¶ˆæ¯åå°±ä¼šè´¨é—®ä½ äº†
            await triggerAiResponse(currentChatId);
          });

          // ã€ä¿®æ”¹ã€‘â€œæŒ‚æ–­â€æŒ‰é’®ï¼šUser åœ¨å‘¼å«æ—¶æˆ–è¢«å«æ—¶éƒ½å¯ä»¥å–æ¶ˆ
          document.getElementById('cancel-video-call-btn').addEventListener('click', () => {
            hideModal(videoCallInviteModal);
            // å¦‚æœæ˜¯Charæ‰“æ¥çš„ï¼Œä¹Ÿéœ€è¦æ¸…ç©º
            if (pendingCallInfo) {
              pendingCallInfo = null;
            }
          });

          // è§†é¢‘é€šè¯ç•Œé¢å†…çš„æ§åˆ¶æŒ‰é’®
          document.getElementById('video-hangup-btn').addEventListener('click', endVideoCall);
          document.getElementById('video-switch-btn').addEventListener('click', switchVideoViews);
          document.getElementById('video-call-small-view').addEventListener('click', switchVideoViews);

          // â€œé‡Rollâ€æŒ‰é’®
          document.getElementById('video-reroll-btn').addEventListener('click', async () => {
            if (!isVideoCallActive) return;

            // 1. ä»å†å²è®°å½•ä¸­ç§»é™¤æœ€åä¸€æ¡Charçš„å›å¤
            const history = chatData[currentChatId].history;
            if (history.length > 0 && history[history.length - 1].role === 'assistant') {
              history.pop();
            }

            // 2. ä»UIä¸Šç§»é™¤æœ€åä¸€æ¡Charçš„æ¶ˆæ¯
            const dialogueLines = document.querySelectorAll('.video-dialogue-line.char');
            if (dialogueLines.length > 0) {
              dialogueLines[dialogueLines.length - 1].remove();
            }

            // 3. é‡æ–°è°ƒç”¨AIç”Ÿæˆå›å¤ (ä¸å¸¦æ–°çš„ç”¨æˆ·è¾“å…¥)
            addVideoDialogueLine('system', '[æ­£åœ¨é‡æ–°ç”Ÿæˆ...]');
            await triggerVideoCallAiResponse(null);
          });

          // â€œèŠå¤©â€æŒ‰é’® (Userå‘è¨€)
          document.getElementById('video-chat-btn').addEventListener('click', async () => {
            if (!isVideoCallActive) return;

            // ä½¿ç”¨ prompt() ä½œä¸ºå¯çˆ±çš„å¼¹çª—è¿›è¡Œè¾“å…¥
            const userInput = prompt('ä½ è¯´ï¼š');
            if (userInput && userInput.trim()) {
              // 1. åœ¨UIä¸Šæ˜¾ç¤ºç”¨æˆ·çš„å‘è¨€
              addVideoDialogueLine('user', userInput.trim());

              // 2. è°ƒç”¨AIå‡½æ•°ï¼Œå¹¶æŠŠç”¨æˆ·è¾“å…¥ä¼ è¿›å»
              await triggerVideoCallAiResponse(userInput.trim());
            }
          });

          // --- è®¾ç½®é¢æ¿çš„å›¾ç‰‡æ›´æ¢æŒ‰é’®äº‹ä»¶ (æ–°) ---
          document.getElementById('changeCharVideoCallImageBtn').addEventListener('click', () => {
            currentEditingTarget = { type: 'charVideoCallImage' };
            showModal(imageChoiceModal);
          });

          document.getElementById('changeUserVideoCallImageBtn').addEventListener('click', () => {
            currentEditingTarget = { type: 'userVideoCallImage' };
            showModal(imageChoiceModal);
          });
          // â–²â–²â–² æ·»åŠ ç»“æŸ â–²â–²â–²
          // è§’è‰²è®¾ç½®é¢æ¿ä¸­çš„â€œé€šè¯è®°å½•â€æŒ‰é’®
          document.getElementById('view-video-call-history-btn').addEventListener('click', () => {
            if (currentChatId) {
              showCallHistory(currentChatId);
            }
          });

          // é€šè¯è®°å½•åˆ—è¡¨å¼¹çª—çš„å…³é—­æŒ‰é’®
          document.getElementById('closeCallHistoryBtn').addEventListener('click', () => {
            hideModal(document.getElementById('videoCallHistoryModal'));
          });

          // é€šè¯è¯¦æƒ…å¼¹çª—çš„å…³é—­æŒ‰é’®
          document.getElementById('closeTranscriptBtn').addEventListener('click', () => {
            hideModal(document.getElementById('callTranscriptModal'));
          });
          // â–²â–²â–² æ·»åŠ ç»“æŸ â–²â–²â–²
          // â–¼â–¼â–¼ ç”¨è¿™ä¸ªæ–°ç‰ˆæœ¬ã€å®Œæ•´æ›¿æ¢ã€‘æ—§çš„ â€œå·¥ä½œä¸é’±åŒ…åŠŸèƒ½äº‹ä»¶ç›‘å¬â€ ä»£ç å— â–¼â–¼â–¼

          // --- å·¥ä½œä¸é’±åŒ…åŠŸèƒ½äº‹ä»¶ç›‘å¬ (AI å¢å¼ºç‰ˆ) ---

          // 1. AI ç”Ÿæˆå·¥ä½œè®¡åˆ’
          document.getElementById('generateWorkScheduleBtn').addEventListener('click', async e => {
            if (!currentChatId) return;
            const button = e.target;
            button.disabled = true;
            button.textContent = 'ç”Ÿæˆä¸­...';

            try {
              const { persona, worldBook: worldBookIds } = chatData[currentChatId].charSettings;
              const profession = document.getElementById('charProfession').value.trim();

              if (!profession) {
                alert('è¯·å…ˆä¸ºè§’è‰²å¡«å†™ä¸€ä¸ªâ€œèŒä¸šâ€ï¼');
                return;
              }

              let worldBookContent = 'æ— é¢å¤–ä¸–ç•Œè®¾å®šã€‚';
              if (worldBookIds && worldBookIds.length > 0) {
                worldBookContent = 'ç›¸å…³ä¸–ç•Œè®¾å®šå¦‚ä¸‹ï¼š\n';
                const associatedBooks = allWorldBooks.filter(wb => worldBookIds.includes(wb.id));
                associatedBooks.forEach(book => {
                  const entries = Object.values(book.entries || {});
                  entries.forEach(entry => {
                    worldBookContent += `- ${entry.comment}: ${entry.content}\n`;
                  });
                });
              }

              const prompt = `
                        è¯·ä½ åŸºäºä»¥ä¸‹ä¿¡æ¯ï¼Œä¸ºä¸€åè§’è‰²åˆ¶å®šä¸€ä»½è¯¦ç»†ä¸”ç¬¦åˆèº«ä»½çš„ä¸€å‘¨å·¥ä½œ/ç”Ÿæ´»è®¡åˆ’ï¼ˆä»å‘¨ä¸€åˆ°å‘¨æ—¥ï¼‰ã€‚
                        è®¡åˆ’åº”åŒ…å«æ¯æ—¥çš„ä¸»è¦æ´»åŠ¨å’Œå¤§è‡´æ—¶é—´å®‰æ’ã€‚
                        è¯·ç›´æ¥è¿”å›è®¡åˆ’æ–‡æœ¬ï¼Œä¸è¦åŒ…å«ä»»ä½•é¢å¤–çš„å¯¹è¯æˆ–è§£é‡Šã€‚

                        - èŒä¸š: ${profession}
                        - äººè®¾: ${persona}
                        - ä¸–ç•Œè§‚èƒŒæ™¯: ${worldBookContent}
                    `;

              const schedule = await getAiSingleResponse(prompt);

              if (schedule) {
                document.getElementById('charWorkSchedule').value = schedule;
                // é¡ºä¾¿ä¿å­˜åˆ°æ•°æ®é‡Œ
                chatData[currentChatId].charSettings.work.schedule = schedule;
                await saveChatData();
              } else {
                alert('AI æœªèƒ½ç”Ÿæˆå·¥ä½œè®¡åˆ’ï¼Œè¯·æ£€æŸ¥APIè®¾ç½®æˆ–ç¨åå†è¯•ã€‚');
              }
            } finally {
              button.disabled = false;
              button.textContent = 'AI ç”Ÿæˆå·¥ä½œè®¡åˆ’';
            }
          });

          // â–¼â–¼â–¼ ç”¨è¿™ä¸ªã€æœ€ç»ˆä¿®æ­£ç‰ˆã€‘ï¼Œå®Œæ•´æ›¿æ¢æ—§çš„ generateInitialBalanceBtn ç›‘å¬å™¨ â–¼â–¼â–¼
          document.getElementById('generateInitialBalanceBtn').addEventListener('click', async e => {
            if (!currentChatId) return;
            const button = e.target;
            const rangeInput = document.getElementById('charInitialBalanceRange');
            const wallet = chatData[currentChatId].charSettings.wallet;

            button.disabled = true;
            button.textContent = 'ç”Ÿæˆä¸­...';

            try {
              let newBalance = 0;

              const rangeValue = rangeInput.value.trim();
              const rangeParts = rangeValue.split('-').map(Number);

              if (rangeValue && rangeParts.length === 2 && !isNaN(rangeParts[0]) && !isNaN(rangeParts[1])) {
                const [min, max] = rangeParts.sort((a, b) => a - b);
                newBalance = Math.floor(Math.random() * (max - min + 1)) + min;
              } else {
                // ã€ã€ã€æ ¸å¿ƒä¿®æ”¹ç‚¹ã€‘ã€‘ã€‘
                // 1. è¯»å–è§’è‰²è®¾å®šï¼ŒåŒ…æ‹¬ä¸–ç•Œä¹¦IDæ•°ç»„
                const { persona, worldBook: worldBookIds } = chatData[currentChatId].charSettings;
                const profession = document.getElementById('charProfession').value.trim();

                if (!profession) {
                  alert('è‹¥ä¸æŒ‡å®šèŒƒå›´ï¼Œåˆ™å¿…é¡»å…ˆå¡«å†™â€œèŒä¸šâ€æ‰èƒ½è®© AI ä¼°ç®—ï¼');
                  button.disabled = false;
                  button.textContent = 'ç”Ÿæˆ/é‡ç½®ä½™é¢';
                  return;
                }

                // 2. ç»„è£…ä¸–ç•Œä¹¦å†…å®¹å­—ç¬¦ä¸²
                let worldBookContent = 'æ— é¢å¤–ä¸–ç•Œè®¾å®šã€‚';
                if (worldBookIds && worldBookIds.length > 0) {
                  worldBookContent = 'ç›¸å…³ä¸–ç•Œè®¾å®šå¦‚ä¸‹ï¼š\n';
                  // allWorldBooks æ˜¯ä¸€ä¸ªå·²åŠ è½½çš„å…¨å±€å˜é‡ï¼Œå¯ä»¥ç›´æ¥ä½¿ç”¨
                  const associatedBooks = allWorldBooks.filter(wb => worldBookIds.includes(wb.id));
                  associatedBooks.forEach(book => {
                    const entries = Object.values(book.entries || {});
                    entries.forEach(entry => {
                      // ä½¿ç”¨ æ¡ç›®åç§° å’Œ å†…å®¹ æ¥æ„æˆæ›´æ˜“è¯»çš„Prompt
                      worldBookContent += `- ${entry.comment || 'è®¾å®š'}: ${entry.content}\n`;
                    });
                  });
                }

                // 3. æ›´æ–° promptï¼ŒåŠ å…¥ä¸–ç•Œä¹¦å†…å®¹
                const prompt = `
                            æ ¹æ®ä¸€ä¸ªè§’è‰²çš„ä¿¡æ¯ï¼Œä¼°ç®—ä¸€ä¸ªåˆç†çš„åˆå§‹é’±åŒ…ä½™é¢ã€‚
                            - èŒä¸š: ${profession}
                            - äººè®¾: ${persona}
                            - ä¸–ç•Œè§‚èƒŒæ™¯: ${worldBookContent}
                            è¯·ä¸¥æ ¼éµå®ˆä»¥ä¸‹è§„åˆ™ï¼šåªè¿”å›ä¸€ä¸ªçº¯æ•°å­—ï¼Œä¸è¦åŒ…å«ä»»ä½•è´§å¸ç¬¦å·ã€é€—å·ã€æ–‡å­—æˆ–è§£é‡Šã€‚ä¾‹å¦‚ï¼š3500.5
                        `;

                const balanceText = await getAiSingleResponse(prompt);
                if (balanceText) {
                  newBalance = parseFloat(balanceText.replace(/[^0-9.-]+/g, ''));
                  if (isNaN(newBalance)) {
                    alert(`AIè¿”å›æ ¼å¼ä¸æ­£ç¡®: "${balanceText}"`);
                    return;
                  }
                } else {
                  alert('AIæœªèƒ½ç”Ÿæˆä½™é¢');
                  return;
                }
              }

              // è¿™éƒ¨åˆ†é‡ç½®å’Œè®°å½•ä½™é¢çš„é€»è¾‘ä¿æŒä¸å˜ï¼Œéå¸¸æ­£ç¡®ï¼
              wallet.balance = 0;
              wallet.transactions = [];
              await addTransaction(currentChatId, newBalance, 'åˆå§‹èµ„é‡‘');

              alert('åˆå§‹ä½™é¢å·²è®¾ç½®å¹¶è®°å½•ï¼');
            } finally {
              button.disabled = false;
              button.textContent = 'ç”Ÿæˆ/é‡ç½®ä½™é¢';
            }
          });
          // â–²â–²â–² æ›¿æ¢åˆ°è¿™é‡Œç»“æŸ â–²â–²â–²

          /**
           * æ¸²æŸ“æŒ‡å®šè§’è‰²çš„äº¤æ˜“è®°å½•åˆ°å¼¹çª—
           * @param {string} charId
           */
          function renderTransactionLog(charId) {
            const listEl = document.getElementById('transaction-log-list');
            const transactions = chatData[charId].charSettings.wallet.transactions || [];

            if (transactions.length === 0) {
              listEl.innerHTML = `<li style="text-align: center; color: var(--text-secondary-color); padding: 20px;">æš‚æ— è®°å½•</li>`;
              return;
            }

            // transactions æ•°ç»„å·²ç»æ˜¯æœ€æ–°åœ¨å‰ï¼Œæ— éœ€ reverse
            listEl.innerHTML = transactions
              .map(t => {
                const date = new Date(t.timestamp).toLocaleString('zh-CN');
                const amountClass = t.amount >= 0 ? 'income' : 'expense';
                const amountSign = t.amount >= 0 ? '+' : '';

                return `
                    <li class="transaction-log-item">
                        <div class="transaction-info">
                            <span class="transaction-description">${t.description}</span>
                            <span class="transaction-date">${date}</span>
                        </div>
                        <span class="transaction-amount ${amountClass}">
                            ${amountSign}${t.amount.toFixed(2)}
                        </span>
                    </li>
                `;
              })
              .join('');
          }

          // --- äº¤æ˜“è®°å½•å¼¹çª—äº‹ä»¶ç›‘å¬ ---
          document.getElementById('viewTransactionLogBtn').addEventListener('click', () => {
            if (currentChatId) {
              renderTransactionLog(currentChatId);
              showModal(document.getElementById('transactionLogModal'));
            }
          });

          document.getElementById('closeTransactionLogBtn').addEventListener('click', () => {
            hideModal(document.getElementById('transactionLogModal'));
          });

          // â–²â–²â–² æ·»åŠ ç»“æŸ â–²â–²â–²
          // =================================================================
          // ================== è½¬è´¦åŠŸèƒ½æ ¸å¿ƒé€»è¾‘ (æ–°) ==================
          // =================================================================

          // 1. ç‚¹å‡»å·¥å…·æ çš„â€œè½¬è´¦â€å›¾æ ‡ï¼Œæ‰“å¼€è¾“å…¥å¼¹çª—
          document.getElementById('toolbar-transfer-btn').addEventListener('click', () => {
            if (!currentChatId) return;

            const charName = chatData[currentChatId].charSettings.nickname;
            document.getElementById('transferRecipientName').textContent = charName;

            // æ¯æ¬¡æ‰“å¼€éƒ½æ¸…ç©ºè¾“å…¥æ¡†
            document.getElementById('transferAmountInput').value = '';
            document.getElementById('transferRemarkInput').value = '';

            showModal(document.getElementById('transferModal'));
          });

          // 2. åœ¨å¼¹çª—é‡Œç‚¹å‡»â€œå–æ¶ˆâ€
          document.getElementById('cancelTransferBtn').addEventListener('click', () => {
            hideModal(document.getElementById('transferModal'));
          });

          // 3. åœ¨å¼¹çª—é‡Œç‚¹å‡»â€œç¡®è®¤è½¬è´¦â€
          document.getElementById('confirmTransferBtn').addEventListener('click', async () => {
            if (!currentChatId) return;

            const amountInput = document.getElementById('transferAmountInput');
            const amount = parseFloat(amountInput.value);
            const remark = document.getElementById('transferRemarkInput').value.trim() || 'ç»™ä½ è½¬äº†ä¸€ç¬”é’±~'; // é»˜è®¤å¤‡æ³¨

            if (isNaN(amount) || amount <= 0) {
              alert('è¯·è¾“å…¥æœ‰æ•ˆçš„è½¬è´¦é‡‘é¢ï¼');
              return;
            }

            const userWallet = chatData[currentChatId].userSettings.wallet;
            if (userWallet.balance < amount) {
              alert(`ä½™é¢ä¸è¶³ï¼å½“å‰ä½™é¢: Â¥${userWallet.balance.toFixed(2)}`);
              return;
            }

            // æ ¸å¿ƒæ­¥éª¤1ï¼šä»ç”¨æˆ·é’±åŒ…æ‰£æ¬¾ï¼Œå¹¶è®°å½•äº¤æ˜“
            const charName = chatData[currentChatId].charSettings.nickname;
            await addUserTransaction(currentChatId, -amount, `è½¬è´¦ç»™ ${charName}`);

            // æ ¸å¿ƒæ­¥éª¤2ï¼šåˆ›å»ºè½¬è´¦æ¶ˆæ¯å¯¹è±¡
            const transferMessage = {
              role: 'user', // è½¬è´¦ç”± user å‘èµ·
              content: `[å‘ ${charName} å‘èµ·è½¬è´¦]`, // è¿™ä¸ªæ˜¯ç»™AIçœ‹çš„ï¼Œå¸®åŠ©å®ƒç†è§£ä¸Šä¸‹æ–‡
              type: 'transfer', // æˆ‘ä»¬çš„æ–°ç±»å‹
              transferDetails: {
                id: `transfer_${Date.now()}`, // å”¯ä¸€ID
                amount: amount,
                remark: remark,
                status: 'pending', // åˆå§‹çŠ¶æ€ï¼šç­‰å¾…ä¸­
                senderName: chatData[currentChatId].userSettings.name,
                recipientName: charName,
                events: [{ status: 'pending', timestamp: Date.now(), actor: 'user' }],
              },
            };

            // æ ¸å¿ƒæ­¥éª¤3ï¼šä¿å­˜æ•°æ®å¹¶æ›´æ–°UI
            chatData[currentChatId].history.push(transferMessage);
            await saveChatData();
            renderChatMessages(currentChatId);

            // æ ¸å¿ƒæ­¥éª¤4ï¼šå…³é—­å¼¹çª—å’Œå·¥å…·æ 
            hideModal(document.getElementById('transferModal'));
            closeAllPanels();
          });

          // 4. å…³é—­è½¬è´¦çŠ¶æ€è¯¦æƒ…å¼¹çª—
          document.getElementById('closeTransferStatusBtn').addEventListener('click', () => {
            hideModal(document.getElementById('transferStatusModal'));
          });

          // 5. ã€å…³é”®ã€‘ä½¿ç”¨äº‹ä»¶å§”æ‰˜æ¥å¤„ç†æ‰€æœ‰åœ¨èŠå¤©åŒºçš„å¡ç‰‡ç‚¹å‡»äº‹ä»¶
          document.querySelector('.chat-messages').addEventListener('click', async e => {
            const transferCard = e.target.closest('.transfer-card');
            if (!transferCard || !currentChatId) return; // å¦‚æœæ²¡ç‚¹åœ¨å¡ç‰‡ä¸Šï¼Œæˆ–ä¸åœ¨èŠå¤©ä¸­ï¼Œå°±å¿½ç•¥

            const transferId = transferCard.dataset.transferId;
            // åœ¨å†å²è®°å½•ä¸­æ‰¾åˆ°è¿™æ¡è½¬è´¦æ¶ˆæ¯
            const message = chatData[currentChatId].history.find(m => m.transferDetails?.id === transferId);

            if (!message) return;
            const details = message.transferDetails;

            // æƒ…å†µä¸€ï¼šç‚¹å‡»äº†â€œæ”¶æ¬¾â€æŒ‰é’®
            if (e.target.matches('.transfer-action-btn.accept')) {
              e.stopPropagation(); // é˜²æ­¢è§¦å‘æ‰“å¼€è¯¦æƒ…å¼¹çª—
              if (details.status !== 'pending') return; // å¦‚æœä¸æ˜¯å¾…å¤„ç†çŠ¶æ€ï¼Œå°±å¿½ç•¥

              details.status = 'accepted';
              details.events.push({ status: 'accepted', timestamp: Date.now(), actor: 'char' });

              // ç»™è§’è‰²é’±åŒ…åŠ é’±ï¼Œå¹¶è®°å½•
              await addTransaction(currentChatId, details.amount, `æ”¶åˆ°æ¥è‡ª ${details.senderName} çš„è½¬è´¦`);

              await saveChatData();
              renderChatMessages(currentChatId); // é‡æ–°æ¸²æŸ“èŠå¤©ï¼Œå¡ç‰‡çŠ¶æ€ä¼šæ›´æ–°
            }
            // æƒ…å†µäºŒï¼šç‚¹å‡»äº†â€œé€€è¿˜â€æŒ‰é’®
            else if (e.target.matches('.transfer-action-btn.refuse')) {
              e.stopPropagation();
              if (details.status !== 'pending') return;

              details.status = 'refused';
              details.events.push({ status: 'refused', timestamp: Date.now(), actor: 'char' });

              // æŠŠé’±é€€ç»™ç”¨æˆ·ï¼Œå¹¶è®°å½•
              await addUserTransaction(currentChatId, details.amount, `æ”¶åˆ°æ¥è‡ª ${details.recipientName} çš„è½¬è´¦é€€æ¬¾`);

              await saveChatData();
              renderChatMessages(currentChatId);
            } else if (e.target.matches('.transfer-action-btn.user-accept')) {
              e.stopPropagation();
              if (details.status !== 'pending') return;

              details.status = 'accepted';
              details.events.push({ status: 'accepted', timestamp: Date.now(), actor: 'user' });

              await addUserTransaction(currentChatId, details.amount, `æ”¶åˆ°æ¥è‡ª ${details.senderName} çš„è½¬è´¦`);

              // ã€ã€ã€æ ¸å¿ƒä¿®æ”¹ã€‘ã€‘ã€‘
              const systemMessage = {
                role: 'system', // è§’è‰²æ”¹ä¸º system
                content: `[ç³»ç»Ÿæç¤ºï¼šä½ æ¥å—äº†æ¥è‡ª ${details.senderName} çš„è½¬è´¦]`,
                isSystemNotification: true, // æ·»åŠ è¿™ä¸ªæ ‡å¿—ä»¥åº”ç”¨ç‰¹æ®Šæ ·å¼
              };
              chatData[currentChatId].history.push(systemMessage);

              await saveChatData();
              renderChatMessages(currentChatId);
            }
            // æƒ…å†µå››ï¼šUser ç‚¹å‡»äº†â€œé€€è¿˜â€æŒ‰é’®
            else if (e.target.matches('.transfer-action-btn.user-refuse')) {
              e.stopPropagation();
              if (details.status !== 'pending') return;

              details.status = 'refused';
              details.events.push({ status: 'refused', timestamp: Date.now(), actor: 'user' });

              await addTransaction(currentChatId, details.amount, `æ”¶åˆ°æ¥è‡ª ${details.recipientName} çš„è½¬è´¦é€€æ¬¾`);

              // ã€ã€ã€æ ¸å¿ƒä¿®æ”¹ã€‘ã€‘ã€‘
              const systemMessage = {
                role: 'system', // è§’è‰²æ”¹ä¸º system
                content: `[ç³»ç»Ÿæç¤ºï¼šä½ é€€è¿˜äº†æ¥è‡ª ${details.senderName} çš„è½¬è´¦]`,
                isSystemNotification: true, // æ·»åŠ è¿™ä¸ªæ ‡å¿—
              };
              chatData[currentChatId].history.push(systemMessage);

              await saveChatData();
              renderChatMessages(currentChatId);
            }
            // æƒ…å†µä¸‰ï¼šç‚¹å‡»äº†å¡ç‰‡æœ¬èº«ï¼ŒæŸ¥çœ‹è¯¦æƒ…
            else {
              const listEl = document.getElementById('transfer-status-list');
              const statusText = {
                pending: 'ç­‰å¾…å¯¹æ–¹æ”¶æ¬¾',
                accepted: 'å·²æ”¶æ¬¾',
                refused: 'å·²é€€è¿˜',
              };
              listEl.innerHTML = `
                    <li style="padding: 5px 0;"><strong>é‡‘é¢:</strong> <span style="font-size: 1.2em; color: var(--accent-color);">Â¥${details.amount.toFixed(
                      2,
                    )}</span></li>
                    <li style="padding: 5px 0;"><strong>çŠ¶æ€:</strong> ${statusText[details.status]}</li>
                    <li style="padding: 5px 0;"><strong>å‘èµ·æ–¹:</strong> ${details.senderName}</li>
                    <li style="padding: 5px 0;"><strong>æ¥æ”¶æ–¹:</strong> ${details.recipientName}</li>
                    <li style="padding: 5px 0;"><strong>å¤‡æ³¨:</strong> ${details.remark}</li>
                    <li style="padding: 5px 0;"><strong>å‘èµ·æ—¶é—´:</strong> ${new Date(
                      details.events[0].timestamp,
                    ).toLocaleString()}</li>
                `;
              // å¦‚æœè½¬è´¦å·²å®Œæˆï¼Œæ˜¾ç¤ºå®Œæˆæ—¶é—´
              if (details.status !== 'pending') {
                const finalEvent = details.events[details.events.length - 1];
                listEl.innerHTML += `<li style="padding: 5px 0;"><strong>å®Œæˆæ—¶é—´:</strong> ${new Date(
                  finalEvent.timestamp,
                ).toLocaleString()}</li>`;
              }
              showModal(document.getElementById('transferStatusModal'));
            }
          });
          // â–²â–²â–² æ–°ä»£ç ç²˜è´´åˆ°è¿™é‡Œç»“æŸ â–²â–²â–²
          // --- ç”¨æˆ·é’±åŒ…åŠŸèƒ½äº‹ä»¶ç›‘å¬ (æ–°) ---

          // 1. è®¾ç½®/é‡ç½®åˆå§‹ä½™é¢
          document.getElementById('setUserInitialBalanceBtn').addEventListener('click', async () => {
            if (!currentChatId) return;

            const initialBalanceInput = document.getElementById('userInitialBalance');
            const newInitialBalance = parseFloat(initialBalanceInput.value);

            if (isNaN(newInitialBalance)) {
              alert('è¯·è¾“å…¥æœ‰æ•ˆçš„æ•°å­—ä½œä¸ºåˆå§‹ä½™é¢ï¼');
              return;
            }

            if (
              confirm(`ç¡®å®šè¦å°†ä½™é¢é‡ç½®å¹¶è®¾å®šä¸º Â¥${newInitialBalance.toFixed(2)} å—ï¼Ÿ\nè¿™ä¼šæ¸…ç©ºä½ æ‰€æœ‰çš„å†å²äº¤æ˜“è®°å½•ï¼`)
            ) {
              const wallet = chatData[currentChatId].userSettings.wallet;
              wallet.balance = 0; // å…ˆæ¸…é›¶
              wallet.transactions = []; // æ¸…ç©ºè®°å½•
              await addUserTransaction(currentChatId, newInitialBalance, 'åˆå§‹èµ„é‡‘');
              alert('åˆå§‹ä½™é¢å·²è®¾å®šï¼');
            }
          });

          // 2. æŸ¥çœ‹äº¤æ˜“è®°å½•
          document.getElementById('viewUserTransactionLogBtn').addEventListener('click', () => {
            if (currentChatId) {
              const userTransactionLogModal = document.getElementById('userTransactionLogModal');
              const listEl = document.getElementById('user-transaction-log-list');
              const transactions = chatData[currentChatId].userSettings.wallet.transactions || [];

              if (transactions.length === 0) {
                listEl.innerHTML = `<li style="text-align: center; color: var(--text-secondary-color); padding: 20px;">æš‚æ— è®°å½•</li>`;
              } else {
                listEl.innerHTML = transactions
                  .map(t => {
                    const date = new Date(t.timestamp).toLocaleString('zh-CN');
                    const amountClass = t.amount >= 0 ? 'income' : 'expense';
                    const amountSign = t.amount >= 0 ? '+' : '';
                    return `
                    <li class="transaction-log-item">
                        <div class="transaction-info">
                            <span class="transaction-description">${t.description}</span>
                            <span class="transaction-date">${date}</span>
                        </div>
                        <span class="transaction-amount ${amountClass}">
                            ${amountSign}${t.amount.toFixed(2)}
                        </span>
                    </li>
                `;
                  })
                  .join('');
              }
              showModal(userTransactionLogModal);
            }
          });

          // 3. å…³é—­äº¤æ˜“è®°å½•å¼¹çª—
          document.getElementById('closeUserTransactionLogBtn').addEventListener('click', () => {
            hideModal(document.getElementById('userTransactionLogModal'));
          });
          // â–²â–²â–² æ–°å¢äº‹ä»¶ç›‘å¬ç»“æŸ â–²â–²â–²
          // ================== ç¤¼ç‰©å•†åº—äº‹ä»¶ç›‘å¬ (æ–°) ==================
          if (toolbarGiftBtn) {
            toolbarGiftBtn.addEventListener('click', () => {
              renderGiftShop();
              shoppingCart = []; // æ¯æ¬¡æ‰“å¼€æ¸…ç©ºè´­ç‰©è½¦
              renderShoppingCart();
              closeAllPanels();
              phoneScreen.style.display = 'none';
              giftShopPage.classList.add('active');
            });
          }

          document.getElementById('ai-generate-gifts-btn').addEventListener('click', generateGiftsByAI);
          document.getElementById('ai-search-gifts-btn').addEventListener('click', searchGiftsByAI);
          document.getElementById('gift-shop-back-btn').addEventListener('click', () => {
            giftShopPage.classList.remove('active');
            phoneScreen.style.display = 'flex';
          });

          document.getElementById('open-cart-btn').addEventListener('click', () => {
            renderShoppingCart();
            showModal(shoppingCartModal);
          });

          document.getElementById('close-cart-btn').addEventListener('click', () => hideModal(shoppingCartModal));

          document.getElementById('checkout-btn').addEventListener('click', checkoutAndSendGifts);

          // ä½¿ç”¨äº‹ä»¶å§”æ‰˜å¤„ç† "åŠ å…¥è´­ç‰©è½¦"
          document.getElementById('gift-list-container').addEventListener('click', e => {
            if (e.target.classList.contains('add-to-cart-btn')) {
              const giftId = parseInt(e.target.dataset.giftId, 10);
              const gift = giftShopItems.find(g => g.id === giftId);
              if (gift) {
                shoppingCart.push(gift);
                renderShoppingCart(); // æ›´æ–°è´­ç‰©è½¦è§’æ ‡å’Œå†…å®¹

                // å¯çˆ±çš„å°åŠ¨ç”»æç¤º
                const btn = e.target;
                btn.textContent = 'å·²æ·»åŠ !';
                setTimeout(() => {
                  btn.textContent = 'åŠ å…¥è´­ç‰©è½¦';
                }, 1000);
              }
            }
          });

          // ä½¿ç”¨äº‹ä»¶å§”æ‰˜å¤„ç† "ä»è´­ç‰©è½¦ç§»é™¤"
          document.getElementById('cart-items-list').addEventListener('click', e => {
            if (e.target.classList.contains('remove-cart-item-btn')) {
              const cartIndex = parseInt(e.target.dataset.cartIndex, 10);
              shoppingCart.splice(cartIndex, 1);
              renderShoppingCart(); // æ›´æ–°è´­ç‰©è½¦
            }
          });
          // --- âœ¨ é­”æ³•å­—ä½“å°å±‹äº‹ä»¶ç›‘å¬ (å‡çº§ç‰ˆ) âœ¨ ---

          const fontModal = document.getElementById('fontManagerModal');

          // 1. æ‰“å¼€å¼¹çª—
          const fontAppIcon = document.querySelector('.app-container[data-app-id="app5"]');
          if (fontAppIcon) {
            const link = fontAppIcon.querySelector('a');
            if (link) link.href = 'javascript:void(0)';

            fontAppIcon.addEventListener('click', () => {
              renderFontManagerList();
              showModal(fontModal);
            });
          }

          document.getElementById('closeFontManagerBtn').addEventListener('click', () => {
            hideModal(fontModal);
          });

          // 2. Tab åˆ‡æ¢é€»è¾‘
          document.getElementById('fontManagerTabs').addEventListener('click', e => {
            if (e.target.classList.contains('cute-tab-btn')) {
              // ç§»é™¤æ‰€æœ‰æ¿€æ´»çŠ¶æ€
              document.querySelectorAll('.cute-tab-btn').forEach(b => b.classList.remove('active'));
              document.querySelectorAll('.cute-tab-content').forEach(c => c.classList.remove('active'));

              // æ¿€æ´»å½“å‰ç‚¹å‡»çš„
              e.target.classList.add('active');
              const tabId = e.target.dataset.tab;
              document.getElementById(`tab-${tabId}`).classList.add('active');
            }
          });

          // 3. æ·»åŠ å•ä¸ªå­—ä½“ (é€»è¾‘ä¸å˜)
          document.getElementById('addNewFontBtn').addEventListener('click', async () => {
            const name = document.getElementById('newFontName').value.trim();
            const url = document.getElementById('newFontUrl').value.trim();

            if (!name || !url) {
              alert('è¯·å¡«å†™å®Œæ•´å“¦ï¼(>_<)');
              return;
            }

            try {
              const existing = await db.customFonts.where('name').equals(name).first();
              if (existing) {
                alert('è¿™ä¸ªåå­—å·²ç»æœ‰è¿‡å•¦ï¼');
                return;
              }

              await db.customFonts.add({ name, url });
              document.getElementById('newFontName').value = '';
              document.getElementById('newFontUrl').value = '';

              // è‡ªåŠ¨è·³å›åˆ—è¡¨é¡µ
              document.querySelector('[data-tab="library"]').click();
              renderFontManagerList();
              alert(`âœ¨ æˆåŠŸæ•è·å­—ä½“ï¼š${name}`);
            } catch (e) {
              alert('æ·»åŠ å¤±è´¥æƒ¹...');
            }
          });

          // 4. ã€æ–°åŠŸèƒ½ã€‘æ‰¹é‡å¯¼å…¥å­—ä½“
          document.getElementById('batchAddFontBtn').addEventListener('click', async () => {
            const text = document.getElementById('batchFontInput').value.trim();
            if (!text) {
              alert('è¯·å…ˆç²˜è´´å†…å®¹å“¦~');
              return;
            }

            const lines = text.split('\n');
            let successCount = 0;
            let failCount = 0;

            for (const line of lines) {
              const cleanLine = line.trim();
              if (!cleanLine) continue;

              // æ™ºèƒ½è§£æé€»è¾‘ï¼šæ”¯æŒä¸­æ–‡å†’å·ã€è‹±æ–‡å†’å·ã€ç©ºæ ¼åˆ†éš”
              // æ­£åˆ™é€»è¾‘ï¼šåŒ¹é…ä»»æ„å†’å·æˆ–ç©ºæ ¼ä½œä¸ºåˆ†éš”ç¬¦
              // split limit 2 ç¡®ä¿åªåˆ†ä¸¤åŠï¼Œé˜²æ­¢URLé‡Œæœ‰å†’å·è¢«åˆ‡æ–­
              // ä½† JS split æ­£åˆ™ä¸èƒ½ limitï¼Œæ‰€ä»¥æˆ‘ä»¬æ‰‹åŠ¨å¤„ç†

              let name = '';
              let url = '';

              // å°è¯•åˆ†å‰²
              const separators = [':', 'ï¼š', ' ', '\t']; // å¸¸è§åˆ†éš”ç¬¦
              let splitIndex = -1;

              // æ‰¾åˆ°ç¬¬ä¸€ä¸ªåˆ†éš”ç¬¦çš„ä½ç½®
              for (let i = 0; i < cleanLine.length; i++) {
                if (separators.includes(cleanLine[i])) {
                  // ç¡®ä¿ä¸æ˜¯ http: é‡Œçš„å†’å· (ç®€å•çš„åˆ¤æ–­ï¼šåˆ†éš”ç¬¦åé¢ä¸åº”è¯¥ç´§è·Ÿ /)
                  if (cleanLine[i] === ':' && cleanLine[i + 1] === '/' && cleanLine[i + 2] === '/') {
                    continue;
                  }
                  splitIndex = i;
                  break;
                }
              }

              if (splitIndex > -1) {
                name = cleanLine.substring(0, splitIndex).trim();
                url = cleanLine.substring(splitIndex + 1).trim();
                // å»æ‰å¯èƒ½å­˜åœ¨çš„ http ä¹‹å‰çš„ç©ºæ ¼æˆ–ç¬¦å·
                url = url.replace(/^[ï¼š:\s]+/, '');
              } else {
                // æ²¡æ‰¾åˆ°åˆ†éš”ç¬¦ï¼Ÿè¿™è¡Œå¯èƒ½æ˜¯åºŸçš„ï¼Œæˆ–è€…åªæœ‰é“¾æ¥
                failCount++;
                continue;
              }

              if (name && url) {
                try {
                  // æ£€æŸ¥é‡å¤
                  const existing = await db.customFonts.where('name').equals(name).first();
                  if (!existing) {
                    await db.customFonts.add({ name, url });
                    successCount++;
                  } else {
                    failCount++; // é‡å¤ç®—å¤±è´¥æˆ–è·³è¿‡
                  }
                } catch (e) {
                  failCount++;
                }
              }
            }

            document.getElementById('batchFontInput').value = '';
            // è·³å›åˆ—è¡¨é¡µ
            document.querySelector('[data-tab="library"]').click();
            renderFontManagerList();

            alert(`ğŸ“¦ å¯¼å…¥å®Œæˆï¼\næˆåŠŸ: ${successCount} ä¸ª\nè·³è¿‡/å¤±è´¥: ${failCount} ä¸ª`);
          });

          // 5. å­—ä½“åˆ—è¡¨ç‚¹å‡» (åº”ç”¨/åˆ é™¤) - é€‚é…æ–°çš„ DOM ç»“æ„
          document.getElementById('fontListContainer').addEventListener('click', async e => {
            const btn = e.target.closest('.mini-btn'); // æ‰¾æœ€è¿‘çš„æŒ‰é’®
            if (!btn) return;

            // æ‰¾åˆ°çˆ¶çº§å¡ç‰‡çš„æ•°æ®IDï¼ˆéœ€è¦æˆ‘ä»¬ç¨å¾®æ”¹ä¸€ä¸‹ render å‡½æ•°æ¥æŠŠ ID ç»‘åœ¨æŒ‰é’®ä¸Šï¼Œæˆ–è€…é€šè¿‡å¡ç‰‡æ‰¾ï¼‰
            // è¿™é‡Œæˆ‘ä»¬å‡è®¾ render å‡½æ•°ä¼šåœ¨æŒ‰é’®ä¸Šç»‘ data-id (ä¸‹é¢ä¼šæ”¹ render å‡½æ•°)
            const fontId = parseInt(btn.dataset.id, 10);

            if (btn.classList.contains('apply')) {
              const fontData = await db.customFonts.get(fontId);
              if (fontData) {
                applyFontToPage(fontData);
                currentActiveFontId = fontId;
                await db.userSettings.put({ id: 'activeFontId', value: fontId });
                renderFontManagerList();
              }
            } else if (btn.classList.contains('delete')) {
              if (confirm('çœŸçš„è¦ä¸¢å¼ƒè¿™ä¸ªå­—ä½“å—ï¼Ÿ(QwQ)')) {
                await db.customFonts.delete(fontId);
                if (currentActiveFontId === fontId) {
                  applyFontToPage(null);
                  currentActiveFontId = null;
                  await db.userSettings.delete('activeFontId');
                }
                renderFontManagerList();
              }
            }
          });

          // 6. æ¢å¤é»˜è®¤
          document.getElementById('resetFontBtn').addEventListener('click', async () => {
            applyFontToPage(null);
            currentActiveFontId = null;
            await db.userSettings.delete('activeFontId');
            renderFontManagerList();
            alert('å·²å˜å›åŸæ¥çš„æ ·å­å•¦~');
          });
          // â–¼â–¼â–¼ æŠŠè¿™æ®µä»£ç ç²˜è´´åœ¨â€œæ¢å¤é»˜è®¤â€æŒ‰é’®çš„åé¢ â–¼â–¼â–¼

          // 7. æ–°å¢ï¼šå­—ä½“å¤§å°æ»‘å—ç›‘å¬
          const fontSizeSlider = document.getElementById('fontSizeSlider');
          if (fontSizeSlider) {
            // æ‹–åŠ¨æ—¶å®æ—¶é¢„è§ˆ
            fontSizeSlider.addEventListener('input', e => {
              const delta = parseInt(e.target.value);
              applyFontSize(delta);
            });

            // æ¾å¼€é¼ æ ‡æ—¶ä¿å­˜è®¾ç½®
            fontSizeSlider.addEventListener('change', async e => {
              const delta = parseInt(e.target.value);
              await db.userSettings.put({ id: 'fontSizeDelta', value: delta });
            });
          }
          // â–²â–²â–² ç²˜è´´ç»“æŸ â–²â–²â–²
        }

        // --- Part 5: å…¶ä»–ç‹¬ç«‹çš„æ—§åŠŸèƒ½ ---
        function setupLegacyListeners() {
          const IMAGE_ELEMENT_IDS = ['profileDot', 'profileAvatar', 'imagePlaceholder', 'polaroidMainImg', 'filmImg1', 'filmImg2', 'filmImg3'];

          const TEXT_ELEMENT_IDS = [
            'mainChatInput',
            'moodInput',
            'thoughtTextarea',
            'magicPromptInput',
            'imageDescriptionInput',
          ];
          IMAGE_ELEMENT_IDS.forEach(id => {
            const el = document.getElementById(id);
            if (el)
              el.addEventListener('click', () => {
                currentEditingTarget = el;
                showModal(imageChoiceModal);
              });
          });
          TEXT_ELEMENT_IDS.forEach(id => {
            const el = document.getElementById(id);
            if (el)
              el.addEventListener('focus', e => {
                e.preventDefault();
                el.blur();
                currentEditingTarget = el;
                document.getElementById('textEditTitle').textContent = `ç¼–è¾‘ "${el.placeholder}"`;
                document.getElementById('textEditArea').value = el.value;
                showModal(textEditModal);
                setTimeout(() => document.getElementById('textEditArea').focus(), 310);
              });
          });
          // â–¼â–¼â–¼ æ›¿æ¢åŸæ¥çš„ saveTextBtn ç›‘å¬å™¨ â–¼â–¼â–¼
          document.getElementById('saveTextBtn').addEventListener('click', async () => {
            if (currentEditingTarget) {
              const newValue = document.getElementById('textEditArea').value;
              
              // åˆ¤æ–­æ˜¯è¾“å…¥æ¡†è¿˜æ˜¯æ™®é€šæ–‡æœ¬æ ‡ç­¾
              if (currentEditingTarget.tagName === 'INPUT' || currentEditingTarget.tagName === 'TEXTAREA') {
                currentEditingTarget.value = newValue;
              } else {
                currentEditingTarget.textContent = newValue; // å¯¹äº span ä½¿ç”¨ textContent
              }

              // ä¿å­˜åˆ°æ•°æ®åº“
              if (currentEditingTarget.id) {
                await db.userSettings.put({ id: currentEditingTarget.id, value: newValue });
              }
            }
            hideModal(textEditModal);
          });
          // â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²
          [imageChoiceModal, textEditModal, settingsModal, editAppModal, apiSettingsModal].forEach(modal => {
            if (modal)
              modal.addEventListener('click', e => {
                if (e.target === modal) hideModal(modal);
              });
          });
          document.getElementById('closeChoiceModal').addEventListener('click', () => hideModal(imageChoiceModal));
          document.getElementById('cancelTextBtn').addEventListener('click', () => hideModal(textEditModal));
        }

        const updateImageUI = (element, imageData) => {
          if (element.id === 'imagePlaceholder') {
            element.textContent = ''; // ç¡®ä¿ä¸Šä¼ å›¾ç‰‡åï¼Œä¸å†æ˜¾ç¤ºä»»ä½•æ–‡å­—
          }
          if (element.tagName.toLowerCase() === 'img') {
            element.src = imageData;
          } else {
            element.style.backgroundImage = `url(${imageData})`;
          }
        };
        // =================================================================
        // ================== NPC å’Œ è¡¨æƒ…åŒ…åº“æ ¸å¿ƒé€»è¾‘ (æ–°å¢) ==================
        // =================================================================
        let activeStickerTab = 'exclusive'; // é»˜è®¤æ¿€æ´»ä¸“å±è¡¨æƒ…åŒ…tab
        let isStickerManageMode = false; // ç”¨äºè·Ÿè¸ªæ˜¯å¦å¤„äºè¡¨æƒ…ç®¡ç†æ¨¡å¼

        // --- æ•°æ®åŠ è½½ä¸ä¿å­˜ ---
        async function loadCommonStickers() {
          const data = await db.userSettings.get('commonStickers');
          commonStickers = data ? data.value : [];
        }

        async function saveCommonStickers() {
          await db.userSettings.put({ id: 'commonStickers', value: commonStickers });
        }
        // ================== ç”¨æˆ·ä¸“å±è¡¨æƒ…åŒ…é€»è¾‘ (æ–°) ==================
        async function loadUserStickers() {
          // ç”±äºè¿™å¼ è¡¨ç»“æ„ç®€å•ï¼Œå¯ä»¥ç›´æ¥ toArray
          userStickers = await db.userStickers.toArray();
        }

        // ç”¨è¿™ä¸ªæ–°ç‰ˆæœ¬æ›¿æ¢æ—§çš„ renderUserStickers å‡½æ•°
        function renderUserStickers() {
          const grid = document.getElementById('user-sticker-grid');
          const panel = document.getElementById('user-sticker-panel');
          if (!grid || !panel) return;

          // 1. æ¸²æŸ“åˆ†ç±» Tabs
          renderUserStickerCategories();

          const filteredStickers = userStickers.filter(s => (s.category || 'æœªåˆ†ç±»') === activeUserStickerCategory);

          // 3. æ¸²æŸ“è¡¨æƒ…ç½‘æ ¼
          if (filteredStickers.length === 0) {
            grid.innerHTML = `<p style="color: var(--text-secondary-color); text-align:center; font-size: 14px; padding: 40px 20px;">è¯¥åˆ†ç±»ä¸‹æ²¡æœ‰è¡¨æƒ…å“¦ï¼<br>${
              activeUserStickerCategory === 'å…¨éƒ¨' ? 'ç‚¹å‡»å³ä¸Šè§’â€œç®¡ç†â€æŒ‰é’®æ·»åŠ å§' : 'æ¢ä¸ªåˆ†ç±»çœ‹çœ‹å§'
            }</p>`;
          } else {
            grid.innerHTML = filteredStickers
              .map(sticker => {
                // æ‰¾åˆ°å®ƒåœ¨åŸå§‹ userStickers æ•°ç»„ä¸­çš„ç´¢å¼•
                const originalIndex = userStickers.findIndex(s => s.id === sticker.id);
                return `
                        <div class="sticker-item user-sticker-item" data-id="${
                          sticker.id
                        }" data-original-index="${originalIndex}">
                            <img src="${sticker.url}" alt="${sticker.desc || ''}" loading="lazy">
                            <p>${sticker.desc || ' '}</p>
                        </div>
                    `;
              })
              .join('');
          }

          // 4. æ ¹æ®ç®¡ç†æ¨¡å¼æ›´æ–°UI
          if (isUserStickerManageMode) {
            panel.classList.add('manage-mode');
            document.getElementById('user-sticker-normal-buttons').style.display = 'none';
            document.getElementById('user-sticker-manage-buttons').style.display = 'flex';
          } else {
            panel.classList.remove('manage-mode');
            document.getElementById('user-sticker-normal-buttons').style.display = 'flex';
            document.getElementById('user-sticker-manage-buttons').style.display = 'none';
          }
        }
        // ç”¨è¿™ä¸ªã€V3 æ–°ç‰ˆæœ¬ã€‘æ›¿æ¢æ—§çš„ renderUserStickerCategories å‡½æ•°
        function renderUserStickerCategories() {
          const tabsContainer = document.getElementById('user-sticker-category-tabs');
          const panel = document.getElementById('user-sticker-panel');
          if (!tabsContainer || !panel) return;

          const categories = {};
          // 1. ç»Ÿè®¡æ‰€æœ‰åˆ†ç±»åŠå…¶é¢„è§ˆå›¾
          userStickers.forEach(sticker => {
            const category = sticker.category || 'æœªåˆ†ç±»';
            if (!categories[category]) {
              categories[category] = sticker.url;
            }
          });

          // å¦‚æœæ²¡æœ‰ä»»ä½•è¡¨æƒ…ï¼Œç¡®ä¿ "æœªåˆ†ç±»" Tab å­˜åœ¨
          if (userStickers.length === 0 && !categories['æœªåˆ†ç±»']) {
            categories['æœªåˆ†ç±»'] = 'data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7';
          }

          // 2. å°†åˆ†ç±»åæ’åºï¼Œå¹¶æŠŠâ€œæœªåˆ†ç±»â€æ”¾åˆ°æœ€å‰é¢
          const sortedNames = Object.keys(categories).sort();
          const unclassifiedIndex = sortedNames.indexOf('æœªåˆ†ç±»');
          if (unclassifiedIndex > 0) {
            const unclassified = sortedNames.splice(unclassifiedIndex, 1)[0];
            sortedNames.unshift(unclassified);
          }

          // 3. æ¸²æŸ“ HTML
          tabsContainer.innerHTML = sortedNames
            .map(name => {
              const isActive = name === activeUserStickerCategory;
              const previewUrl = categories[name];

              // åœ¨ç®¡ç†æ¨¡å¼ä¸‹ä¸ºéâ€œæœªåˆ†ç±»â€çš„tabæ·»åŠ åˆ é™¤æŒ‰é’®
              const deleteButtonHTML =
                isUserStickerManageMode && name !== 'æœªåˆ†ç±»'
                  ? `<button class="delete-category-btn" data-category-name="${name}">&times;</button>`
                  : '';

              return `
                    <div class="sticker-category-tab ${isActive ? 'active' : ''}" data-category-name="${name}">
                        ${deleteButtonHTML}
                        <img src="${previewUrl}" alt="${name}">
                        <span>${name}</span>
                    </div>
                `;
            })
            .join('');
        }

        // â–¼â–¼â–¼ è¯·æ‰¾åˆ°å¹¶ç”¨ä¸‹é¢çš„å‡½æ•°æ›¿æ¢ä½ åŸæ¥çš„ sendUserSticker å‡½æ•° â–¼â–¼â–¼

        async function sendUserSticker(originalIndex) {
          // <--- å¢åŠ äº† async
          const sticker = userStickers[originalIndex];
          if (!sticker) return;

          const message = {
            role: 'user',
            content: `[sticker]${sticker.url}[/sticker]`,
            isStaging: true, // æ ‡è®°ä¸ºå¾…å‘é€
          };

          chatData[currentChatId].history.push(message);

          // ã€ã€ã€æ–°å¢ã€‘ã€‘ã€‘ä¿å­˜èŠå¤©æ•°æ®åˆ°æ•°æ®åº“ï¼
          await saveChatData();

          renderChatMessages(currentChatId);

          closeAllPanels();
        }

        // --- NPC åº“åŠŸèƒ½ ---
        function openNpcLibraryModal() {
          if (!currentChatId) return;
          renderNpcList();
          showModal(document.getElementById('npcLibraryModal'));
        }

        function renderNpcList() {
          const npcListElement = document.getElementById('npcList');
          const npcs = chatData[currentChatId].charSettings.npcs || [];
          npcListElement.innerHTML = '';

          if (npcs.length === 0) {
            npcListElement.innerHTML = `<li style="text-align: center; color: var(--text-secondary-color); font-size: 13px; padding: 10px 0;">æš‚æ— NPC</li>`;
            return;
          }

          npcs.forEach(npc => {
            const li = document.createElement('li');
            li.innerHTML = `
                    <img src="${npc.avatar}" alt="npc avatar">
                    <div class="npc-item-info">
                        <span class="npc-name">${npc.name}</span>
                        <span class="npc-relation">å…³ç³»: ${npc.relation}</span>
                    </div>
                    <div class="button-group">
                        <button class="edit-npc-btn" data-npc-id="${npc.id}">ç¼–è¾‘</button>
                        <button class="delete-npc-btn" data-npc-id="${npc.id}">åˆ é™¤</button>
                    </div>`;
            npcListElement.appendChild(li);
          });
        }

        function openEditNpcModal(mode, npcId = null) {
          const modal = document.getElementById('editNpcModal');
          const title = document.getElementById('editNpcModalTitle');
          const createSection = document.getElementById('createNewNpcSection');
          const selectSection = document.getElementById('selectCharAsNpcSection');

          currentNpcEditMode = mode;
          currentEditingNpcId = npcId;

          // é‡ç½®è¡¨å•
          document.getElementById('npcAvatarPreview').src = 'https://picsum.photos/seed/npc/100';
          document.getElementById('npcNameInput').value = '';
          document.getElementById('npcPersonaInput').value = '';
          document.getElementById('npcRelationInput').value = '';

          if (mode === 'create') {
            title.textContent = 'åˆ›å»ºæ–° NPC';
            createSection.style.display = 'block';
            selectSection.style.display = 'none';
          } else if (mode === 'select') {
            title.textContent = 'é€‰æ‹©å·²æœ‰è§’è‰²ä½œä¸º NPC';
            createSection.style.display = 'none';
            selectSection.style.display = 'block';
            populateExistingCharSelect();
          } else if (mode === 'edit') {
            title.textContent = 'ç¼–è¾‘ NPC';
            createSection.style.display = 'block';
            selectSection.style.display = 'none';

            const npc = chatData[currentChatId].charSettings.npcs.find(n => n.id === npcId);
            if (npc) {
              if (npc.isExistingChar) {
                // å¦‚æœæ˜¯å…³è”çš„å·²æœ‰è§’è‰²
                title.textContent = `ç¼–è¾‘ä¸ ${npc.name} çš„å…³ç³»`;
                createSection.style.display = 'none';
                // å¯ä»¥åœ¨æ­¤æ˜¾ç¤ºä¸€ä¸ªä¸å¯ç¼–è¾‘çš„åç§°å’Œå¤´åƒ
              } else {
                // å¦‚æœæ˜¯åˆ›å»ºçš„
                document.getElementById('npcAvatarPreview').src = npc.avatar;
                document.getElementById('npcNameInput').value = npc.name;
                document.getElementById('npcPersonaInput').value = npc.persona;
              }
              document.getElementById('npcRelationInput').value = npc.relation;
            }
          }
          showModal(modal);
        }

        function populateExistingCharSelect() {
          const select = document.getElementById('existingCharSelect');
          select.innerHTML = '<option value="">-- è¯·é€‰æ‹© --</option>';
          Object.keys(chatData).forEach(charId => {
            // ä¸æŠŠè‡ªå·±å’Œå·²ç»æ˜¯NPCçš„è§’è‰²åŠ å…¥åˆ—è¡¨
            const isAlreadyNpc = (chatData[currentChatId].charSettings.npcs || []).some(
              npc => npc.charIdRef === charId,
            );
            if (charId !== currentChatId && !isAlreadyNpc) {
              const option = document.createElement('option');
              option.value = charId;
              option.textContent = chatData[charId].charSettings.nickname;
              select.appendChild(option);
            }
          });
        }

        async function saveNpcData() {
          const relation = document.getElementById('npcRelationInput').value.trim();
          if (!relation) {
            alert('â€œä¸ä¸»Charçš„å…³ç³»â€æ˜¯å¿…å¡«é¡¹ï¼');
            return;
          }

          const charNpcs = chatData[currentChatId].charSettings.npcs || [];

          if (currentEditingNpcId) {
            // ç¼–è¾‘æ¨¡å¼
            const npcIndex = charNpcs.findIndex(n => n.id === currentEditingNpcId);
            if (npcIndex > -1) {
              const npc = charNpcs[npcIndex];
              npc.relation = relation;
              if (!npc.isExistingChar) {
                npc.avatar = document.getElementById('npcAvatarPreview').src;
                npc.name = document.getElementById('npcNameInput').value.trim();
                npc.persona = document.getElementById('npcPersonaInput').value.trim();
                if (!npc.name) {
                  alert('NPCåå­—ä¸èƒ½ä¸ºç©ºï¼');
                  return;
                }
              }
            }
          } else {
            // åˆ›å»ºæ¨¡å¼
            let newNpc;
            if (currentNpcEditMode === 'create') {
              const name = document.getElementById('npcNameInput').value.trim();
              if (!name) {
                alert('NPCåå­—ä¸èƒ½ä¸ºç©ºï¼');
                return;
              }
              newNpc = {
                id: `npc_${Date.now()}`,
                isExistingChar: false,
                avatar: document.getElementById('npcAvatarPreview').src,
                name: name,
                persona: document.getElementById('npcPersonaInput').value.trim(),
                relation: relation,
              };
            } else {
              // 'select' mode
              const selectedCharId = document.getElementById('existingCharSelect').value;
              if (!selectedCharId) {
                alert('è¯·é€‰æ‹©ä¸€ä¸ªè§’è‰²ï¼');
                return;
              }
              const charInfo = chatData[selectedCharId].charSettings;
              newNpc = {
                id: `npc_${Date.now()}`,
                isExistingChar: true,
                charIdRef: selectedCharId, // å…³è”ID
                avatar: charInfo.avatar,
                name: charInfo.nickname,
                persona: charInfo.persona, // å¯ä»¥é€‰æ‹©æ€§å¼•ç”¨
                relation: relation,
              };
            }
            charNpcs.push(newNpc);
          }

          chatData[currentChatId].charSettings.npcs = charNpcs;
          await saveChatData();
          renderNpcList();
          hideModal(document.getElementById('editNpcModal'));
        }

        async function deleteNpc(npcId) {
          if (confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªNPCå—ï¼Ÿ')) {
            let npcs = chatData[currentChatId].charSettings.npcs || [];
            chatData[currentChatId].charSettings.npcs = npcs.filter(n => n.id !== npcId);
            await saveChatData();
            renderNpcList();
          }
        }

        function openStickerLibraryModal(context = 'char') {
          currentStickerContext = context;
          const modal = document.getElementById('stickerLibraryModal');
          const modalTitle = modal.querySelector('h3');
          const tabs = document.getElementById('stickerTabs');

          // é‡ç½®ç®¡ç†æ¨¡å¼
          isStickerManageMode = false;
          modal.classList.remove('manage-mode');
          document.getElementById('stickerNormalButtons').style.display = 'flex';
          document.getElementById('stickerManageButtons').style.display = 'none';

          if (context === 'user') {
            // ç”¨æˆ·è¡¨æƒ…åŒ…æ¨¡å¼
            modalTitle.textContent = 'æˆ‘çš„è¡¨æƒ…åŒ…';
            tabs.style.display = 'none'; // éšè— "ä¸“å±/é€šç”¨" Tabs

            // åªæ˜¾ç¤ºä¸“å±è¡¨æƒ…çš„å®¹å™¨ï¼Œä½†ç”¨æ¥å±•ç¤ºç”¨æˆ·è¡¨æƒ…
            document.getElementById('exclusiveStickersTab').classList.add('active');
            document.getElementById('commonStickersTab').classList.remove('active');
            document.getElementById('commonStickersTab').style.display = 'none';

            // TODO: è¿™é‡Œåº”è¯¥è°ƒç”¨ä¸€ä¸ªæ¸²æŸ“ç”¨æˆ·è¡¨æƒ…çš„å‡½æ•°
            // renderMyStickers(); // å‡è®¾æœ‰è¿™æ ·ä¸€ä¸ªå‡½æ•°
            alert('æ‰“å¼€ç”¨æˆ·è¡¨æƒ…åº“ - é€»è¾‘å¾…å®ç°');
          } else {
            // context === 'char'
            // è§’è‰²è¡¨æƒ…åŒ…æ¨¡å¼
            if (!currentChatId) return;
            modalTitle.textContent = 'è§’è‰²è¡¨æƒ…åŒ…åº“';
            tabs.style.display = 'flex'; // æ˜¾ç¤º "ä¸“å±/é€šç”¨" Tabs

            // ç¡®ä¿ä¸¤ä¸ªTabå†…å®¹åŒºåŸŸéƒ½å¯è§
            document.getElementById('exclusiveStickersTab').style.display = 'block';
            document.getElementById('commonStickersTab').style.display = 'block';

            // é»˜è®¤æ¿€æ´»â€œä¸“å±è¡¨æƒ…â€Tab
            document.querySelector('.sticker-tab-btn[data-tab="exclusive"]').classList.add('active');
            document.querySelector('.sticker-tab-btn[data-tab="common"]').classList.remove('active');
            document.getElementById('exclusiveStickersTab').classList.add('active');
            document.getElementById('commonStickersTab').classList.remove('active');
            activeStickerTab = 'exclusive';

            renderStickers(); // è°ƒç”¨æ¸²æŸ“å‡½æ•°ï¼Œå¡«å……è§’è‰²ä¸“å±å’Œé€šç”¨è¡¨æƒ…
          }

          showModal(modal);
        }

        // â–¼â–¼â–¼ ç”¨è¿™ä¸ªã€ä¿®æ­£ç‰ˆã€‘æ›¿æ¢æ—§çš„ renderStickers å‡½æ•° â–¼â–¼â–¼
        function renderStickers() {
          const exclusiveGrid = document.getElementById('exclusiveStickerGrid');
          const commonGrid = document.getElementById('commonStickerGrid');

          // ç¡®ä¿ charData å’Œ stickers æ•°ç»„å­˜åœ¨ï¼Œé˜²æ­¢å‡ºé”™
          const exclusiveStickers = chatData[currentChatId]?.charSettings?.exclusiveStickers || [];
          const globalCommonStickers = commonStickers || [];

          const createStickerHTML = (sticker, index, type) => `
                <div class="sticker-item" data-index="${index}" data-type="${type}">
                    <img src="${sticker.url}" alt="${sticker.desc || ''}" loading="lazy">
                    <p>${sticker.desc || ' '}</p>
                    <button class="delete-sticker-btn">&times;</button>
                </div>`;

          // 1. å•ç‹¬æ¸²æŸ“â€œä¸“å±è¡¨æƒ…â€ç½‘æ ¼
          if (exclusiveStickers.length > 0) {
            exclusiveGrid.innerHTML = exclusiveStickers.map((s, i) => createStickerHTML(s, i, 'exclusive')).join('');
          } else {
            exclusiveGrid.innerHTML =
              '<p style="text-align: center; color: var(--text-secondary-color); font-size: 13px; padding: 20px 0;">è¯¥è§’è‰²æ²¡æœ‰ä¸“å±è¡¨æƒ…</p>';
          }

          // 2. å•ç‹¬æ¸²æŸ“â€œé€šç”¨è¡¨æƒ…â€ç½‘æ ¼
          if (globalCommonStickers.length > 0) {
            commonGrid.innerHTML = globalCommonStickers.map((s, i) => createStickerHTML(s, i, 'common')).join('');
          } else {
            commonGrid.innerHTML =
              '<p style="text-align: center; color: var(--text-secondary-color); font-size: 13px; padding: 20px 0;">æ²¡æœ‰é€šç”¨è¡¨æƒ…</p>';
          }
        }

        function openAddStickersModal() {
          const modal = document.getElementById('addStickersModal');
          const title = document.getElementById('addStickersTitle');

          // æ ¹æ®å½“å‰æ¿€æ´»çš„TabåŠ¨æ€è®¾ç½®æ ‡é¢˜
          if (activeStickerTab === 'exclusive') {
            title.textContent = 'æ·»åŠ ä¸“å±è¡¨æƒ…';
          } else {
            title.textContent = 'æ·»åŠ é€šç”¨è¡¨æƒ…';
          }

          document.getElementById('stickerBulkAddArea').value = '';
          showModal(modal);
        }

        // â–¼â–¼â–¼ ç”¨è¿™ä¸ªã€ä¿®æ­£ç‰ˆã€‘æ›¿æ¢æ—§çš„ parseAndSaveStickers å‡½æ•° â–¼â–¼â–¼
        async function parseAndSaveStickers() {
          const text = document.getElementById('stickerBulkAddArea').value.trim();
          if (!text) return;

          // è§£æé€»è¾‘ä¿æŒä¸å˜
          const lines = text.split('\n');
          const newStickers = [];
          lines.forEach(line => {
            let desc = '';
            let url = '';
            const colonMatch = line.match(/[:ï¼š]/);
            if (colonMatch) {
              const delimiterIndex = colonMatch.index;
              desc = line.substring(0, delimiterIndex).trim();
              url = line.substring(delimiterIndex + 1).trim();
            } else {
              const lastSpaceIndex = line.lastIndexOf(' ');
              if (lastSpaceIndex > 0) {
                desc = line.substring(0, lastSpaceIndex).trim();
                url = line.substring(lastSpaceIndex + 1).trim();
              }
            }
            // æˆ‘ä»¬åªåˆ›å»ºå¸¦URLçš„æœ‰æ•ˆè¡¨æƒ…å¯¹è±¡
            if (url) {
              newStickers.push({ desc, url });
            }
          });

          if (newStickers.length === 0) {
            alert('æ²¡æœ‰è§£æåˆ°æœ‰æ•ˆçš„è¡¨æƒ…åŒ…æ•°æ®ï¼Œè¯·æ£€æŸ¥æ ¼å¼ï¼');
            return;
          }

          // å…³é”®ä¿®æ­£ï¼šæ ¹æ®ä¸Šä¸‹æ–‡å’Œå½“å‰æ¿€æ´»çš„ Tab æ¥å†³å®šæ•°æ®å­˜åˆ°å“ªé‡Œ
          if (currentStickerContext === 'user') {
            // è¿™æ˜¯ä¸ºâ€œæˆ‘çš„è¡¨æƒ…åŒ…â€å‡†å¤‡çš„é€»è¾‘ï¼Œæš‚æ—¶ä¸å˜
            const userStickersWithCategory = newStickers.map(s => ({
              ...s,
              category: activeUserStickerCategory === 'å…¨éƒ¨' ? 'æœªåˆ†ç±»' : activeUserStickerCategory,
            }));
            await db.userStickers.bulkAdd(userStickersWithCategory);
            await loadUserStickers();
            renderUserStickers();
          } else {
            // è¿™æ˜¯è§’è‰²è¡¨æƒ…åŒ…çš„é€»è¾‘ (currentStickerContext === 'char')

            // ã€ã€ã€æ ¸å¿ƒä¿®æ­£ç‚¹åœ¨è¿™é‡Œï¼ã€‘ã€‘ã€‘
            if (activeStickerTab === 'exclusive') {
              // å¦‚æœå½“å‰åœ¨â€œä¸“å±è¡¨æƒ…â€Tabï¼Œåˆ™æ·»åŠ åˆ°å½“å‰è§’è‰²çš„æ•°æ®é‡Œ
              console.log(`Adding ${newStickers.length} stickers to EXCLUSIVE for char: ${currentChatId}`);
              if (!chatData[currentChatId].charSettings.exclusiveStickers) {
                chatData[currentChatId].charSettings.exclusiveStickers = [];
              }
              chatData[currentChatId].charSettings.exclusiveStickers.push(...newStickers);
              await saveChatData();
            } else {
              // activeStickerTab === 'common'
              // å¦‚æœå½“å‰åœ¨â€œé€šç”¨è¡¨æƒ…â€Tabï¼Œåˆ™æ·»åŠ åˆ°å…¨å±€çš„ commonStickers æ•°ç»„é‡Œ
              console.log(`Adding ${newStickers.length} stickers to COMMON`);
              commonStickers.push(...newStickers);
              await saveCommonStickers();
            }

            // æ¸²æŸ“ä¸¤ä¸ªç½‘æ ¼ï¼Œç¡®ä¿æ•°æ®å®æ—¶æ›´æ–°
            renderStickers();
          }

          hideModal(document.getElementById('addStickersModal'));
        }

        async function deleteCharSticker(type, index) {
          // ç¡®ä¿ chatData å’Œå½“å‰è§’è‰²çš„ exclusiveStickers æ•°ç»„å­˜åœ¨
          if (!chatData[currentChatId] || !chatData[currentChatId].charSettings) return;

          // å®‰å…¨åœ°åˆå§‹åŒ–æ•°ç»„
          if (!chatData[currentChatId].charSettings.exclusiveStickers) {
            chatData[currentChatId].charSettings.exclusiveStickers = [];
          }
          if (!commonStickers) {
            commonStickers = [];
          }

          if (type === 'exclusive') {
            chatData[currentChatId].charSettings.exclusiveStickers.splice(index, 1);
            await saveChatData();
          } else if (type === 'common') {
            commonStickers.splice(index, 1);
            await saveCommonStickers();
          }

          // åˆ é™¤åé‡æ–°æ¸²æŸ“è§’è‰²è¡¨æƒ…åŒ…åº“
          renderStickers();
        }

        async function deleteSticker(type, index) {
          if (type === 'exclusive') {
            chatData[currentChatId].charSettings.exclusiveStickers.splice(index, 1);
            await saveChatData();
          } else {
            commonStickers.splice(index, 1);
            await saveCommonStickers();
          }
          renderStickers();
        }
        // =================================================================
        // ================== ä¸–ç•Œä¹¦æ ¸å¿ƒé€»è¾‘ (å…¨æ–°) ==================
        // =================================================================
        let allWorldBooks = [];
        let currentEditingWorldBookId = null;
        let currentEditingEntryUid = null;

        // --- æ•°æ®æ“ä½œ ---
        async function loadWorldBooks() {
          allWorldBooks = await db.worldBooks.toArray();
        }

        async function saveWorldBooks() {
          // ç”±äº allWorldBooks æ˜¯ä¸€ä¸ªå®Œæ•´çš„æ•°ç»„ï¼Œæˆ‘ä»¬ä¸èƒ½ç›´æ¥ put
          // è€Œæ˜¯éå†å®ƒï¼Œæ ¹æ® id æ¥æ›´æ–°æ¯ä¸ª worldbook
          for (const wb of allWorldBooks) {
            if (wb.id) {
              await db.worldBooks.put(wb);
            }
          }
        }

        function renderWorldBookList() {
          const container = document.getElementById('worldbook-list-container');
          container.innerHTML = '';
          if (allWorldBooks.length === 0) {
            container.innerHTML = `<p style="text-align:center; padding: 40px 20px; color: var(--text-secondary-color);">è¿˜æ²¡æœ‰ä¸–ç•Œä¹¦ï¼Œç‚¹å‡»ä¸‹æ–¹æŒ‰é’®åˆ›å»ºä¸€ä¸ªå§ï¼</p>`;
            return;
          }

          allWorldBooks.forEach(wb => {
            const itemCount = Object.keys(wb.entries || {}).length;
            const item = document.createElement('div');
            item.className = 'worldbook-list-item';

            item.innerHTML = `
                <div class="worldbook-content-wrapper" data-worldbook-id="${wb.id}">
                    <div class="worldbook-icon">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"></path><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"></path></svg>
                    </div>
                    <div class="worldbook-info">
                        <span class="worldbook-name">${wb.name}</span>
                        <p class="worldbook-stats">åŒ…å« ${itemCount} ä¸ªæ¡ç›®</p>
                    </div>
                </div>
                <!-- â–¼â–¼â–¼ å°±æ”¹ä¸‹é¢è¿™ä¸€è¡Œ â–¼â–¼â–¼ -->
                <button class="delete-worldbook-btn" data-worldbook-id="${wb.id}" style="background: transparent; color: #8e8e93; border: none; font-size: 24px; cursor: pointer; flex-shrink: 0; margin-left: 10px; padding: 5px;">&times;</button>
            `;
            container.appendChild(item);
          });
        }

        function renderWorldBookDetail(worldBookId) {
          const wb = allWorldBooks.find(w => w.id === worldBookId);
          if (!wb) return;

          document.getElementById('worldbook-detail-title').textContent = wb.name;
          const container = document.getElementById('worldbook-entry-list-container');
          container.innerHTML = '';

          const entries = wb.entries || {};
          if (Object.keys(entries).length === 0) {
            container.innerHTML = `<p style="text-align:center; padding: 40px 20px; color: var(--text-secondary-color);">è¿™ä¸ªä¸–ç•Œä¹¦è¿˜æ˜¯ç©ºçš„ï¼Œç‚¹å‡»ä¸‹æ–¹æŒ‰é’®æ·»åŠ ç¬¬ä¸€ä¸ªæ¡ç›®å§ï¼</p>`;
            return;
          }

          // æŒ‰ order å­—æ®µæ’åº
          const sortedEntries = Object.values(entries).sort((a, b) => (a.order || 0) - (b.order || 0));

          sortedEntries.forEach(entry => {
            const item = document.createElement('div');
            item.className = 'worldbook-entry-item';
            item.innerHTML = `
            <div class="entry-header">
                <span class="entry-name">${entry.comment || 'æœªå‘½åæ¡ç›®'}</span>
                <div class="entry-controls">
                    <button class="edit-entry-btn" data-entry-uid="${entry.uid}">ç¼–è¾‘</button>
                    <button class="delete-entry-btn" data-entry-uid="${
                      entry.uid
                    }" style="background-color: #ff3b30; color: white;">åˆ é™¤</button>
                </div>
            </div>
            <div class="entry-details">
                <p><strong>å…³é”®è¯:</strong></p>
                <div class="keywords-container">
                    ${(entry.key || []).map(k => `<span class="keyword-tag">${k}</span>`).join('') || '<span>æ— </span>'}
                </div>
                <p style="margin-top: 10px;"><strong>å†…å®¹:</strong> ${entry.content || 'æ— '}</p>
                <p><strong>é¡ºåº:</strong> ${entry.order ?? 'N/A'} | <strong>æ¦‚ç‡:</strong> ${
              entry.probability ?? 'N/A'
            }%</p>
            </div>
        `;
            container.appendChild(item);
          });
        }

        // --- å¼¹çª—ä¸äº¤äº’ ---
        function openWorldBookEntryModal(worldBookId, entryUid = null) {
          currentEditingWorldBookId = worldBookId;
          currentEditingEntryUid = entryUid;

          const modal = document.getElementById('editWorldBookEntryModal');
          const title = document.getElementById('editWorldBookEntryTitle');

          // é‡ç½®è¡¨å•
          document.getElementById('entryNameInput').value = '';
          document.getElementById('entryKeysInput').value = '';
          document.getElementById('entryContentInput').value = '';
          document.getElementById('entryOrderInput').value = 100;
          document.getElementById('entryProbabilityInput').value = 100;

          if (entryUid !== null) {
            title.textContent = 'ç¼–è¾‘æ¡ç›®';
            const wb = allWorldBooks.find(w => w.id === worldBookId);
            const entry = wb?.entries?.[entryUid];
            if (entry) {
              document.getElementById('entryNameInput').value = entry.comment || '';
              document.getElementById('entryKeysInput').value = (entry.key || []).join(', ');
              document.getElementById('entryContentInput').value = entry.content || '';
              document.getElementById('entryOrderInput').value = entry.order || 100;
              document.getElementById('entryProbabilityInput').value = entry.probability || 100;
            }
          } else {
            title.textContent = 'æ–°å»ºæ¡ç›®';
          }
          showModal(modal);
        }

        async function saveWorldBookEntry() {
          if (currentEditingWorldBookId === null) return;

          const wbIndex = allWorldBooks.findIndex(w => w.id === currentEditingWorldBookId);
          if (wbIndex === -1) return;

          const name = document.getElementById('entryNameInput').value.trim();
          if (!name) {
            alert('æ¡ç›®åç§°ä¸èƒ½ä¸ºç©ºï¼');
            return;
          }

          const keys = document
            .getElementById('entryKeysInput')
            .value.split(',')
            .map(k => k.trim())
            .filter(Boolean);

          const entryData = {
            comment: name,
            key: keys,
            content: document.getElementById('entryContentInput').value,
            order: parseInt(document.getElementById('entryOrderInput').value, 10) || 100,
            probability: parseInt(document.getElementById('entryProbabilityInput').value, 10) || 100,
            // ä¿ç•™ä½ æä¾›çš„JSONä¸­çš„ä¸€äº›é»˜è®¤å€¼ï¼Œä½†éšè—å®ƒä»¬ä¸è®©ç”¨æˆ·ç¼–è¾‘
            constant: false,
            vectorized: false,
            selective: true,
            selectiveLogic: 0,
            addMemo: true,
            position: 0,
            disable: false,
            excludeRecursion: false,
            preventRecursion: false,
            delayUntilRecursion: false,
            useProbability: true,
            depth: 4,
          };

          if (currentEditingEntryUid !== null) {
            // ç¼–è¾‘ç°æœ‰æ¡ç›®
            entryData.uid = currentEditingEntryUid;
            allWorldBooks[wbIndex].entries[currentEditingEntryUid] = entryData;
          } else {
            // æ–°å»ºæ¡ç›®
            const newUid = Date.now();
            entryData.uid = newUid;
            if (!allWorldBooks[wbIndex].entries) {
              allWorldBooks[wbIndex].entries = {};
            }
            allWorldBooks[wbIndex].entries[newUid] = entryData;
          }

          await saveWorldBooks();
          renderWorldBookDetail(currentEditingWorldBookId);
          hideModal(document.getElementById('editWorldBookEntryModal'));
        }

        async function deleteWorldBookEntry(worldBookId, entryUid) {
          if (confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªæ¡ç›®å—ï¼Ÿ')) {
            const wbIndex = allWorldBooks.findIndex(w => w.id === worldBookId);
            if (wbIndex !== -1 && allWorldBooks[wbIndex].entries?.[entryUid]) {
              delete allWorldBooks[wbIndex].entries[entryUid];
              await saveWorldBooks();
              renderWorldBookDetail(worldBookId);
            }
          }
        }
        // =================================================================
        // ================== å…³è”ä¸–ç•Œä¹¦æ ¸å¿ƒé€»è¾‘ (å…¨æ–°) ==================
        // =================================================================

        function openAssociateWorldBookModal() {
          if (!currentChatId || !allWorldBooks) return;

          const selectionList = document.getElementById('worldbook-selection-list');
          selectionList.innerHTML = ''; // æ¸…ç©ºæ—§åˆ—è¡¨

          const charSettings = chatData[currentChatId].charSettings;
          // ç¡®ä¿ worldBook æ˜¯ä¸€ä¸ªæ•°ç»„ï¼Œä»¥å…¼å®¹æ—§æ•°æ®
          const associatedIds = Array.isArray(charSettings.worldBook) ? charSettings.worldBook : [];

          if (allWorldBooks.length === 0) {
            selectionList.innerHTML = `<li style="text-align:center; padding: 20px; color: var(--text-secondary-color);">æ²¡æœ‰å¯ç”¨çš„ä¸–ç•Œä¹¦ã€‚</li>`;
          } else {
            allWorldBooks.forEach(wb => {
              const isChecked = associatedIds.includes(wb.id);
              const li = document.createElement('li');
              li.innerHTML = `
                <label class="worldbook-selection-item">
                    <input type="checkbox" data-worldbook-id="${wb.id}" ${isChecked ? 'checked' : ''}>
                    <span class="item-name">${wb.name}</span>
                </label>
            `;
              selectionList.appendChild(li);
            });
          }
          showModal(document.getElementById('associateWorldBookModal'));
        }

        async function saveWorldBookAssociation() {
          if (!currentChatId) return;

          const selectedIds = [];
          document.querySelectorAll('#worldbook-selection-list input[type="checkbox"]:checked').forEach(checkbox => {
            selectedIds.push(parseInt(checkbox.dataset.worldbookId, 10));
          });

          chatData[currentChatId].charSettings.worldBook = selectedIds;
          await saveChatData();

          // æ›´æ–°è§’è‰²è®¾ç½®é¢æ¿çš„æ˜¾ç¤º
          updateWorldBookDisplay(selectedIds);

          hideModal(document.getElementById('associateWorldBookModal'));
          alert('å…³è”æˆåŠŸï¼');
        }

        // æ›´æ–°è§’è‰²è®¾ç½®é¢æ¿ä¸­â€œå…³è”ä¸–ç•Œä¹¦â€åŒºåŸŸçš„æ˜¾ç¤º
        function updateWorldBookDisplay(worldBookIds) {
          const displayArea = document.getElementById('charWorldBookDisplay');
          if (!displayArea) return;

          displayArea.innerHTML = ''; // æ¸…ç©º

          if (!worldBookIds || worldBookIds.length === 0) {
            displayArea.innerHTML = `<span style="color: var(--text-secondary-color); font-style: italic;">ç‚¹å‡»é€‰æ‹©...</span>`;
            return;
          }

          const associatedNames = worldBookIds.map(id => {
            const wb = allWorldBooks.find(w => w.id === id);
            return wb ? wb.name : 'æœªçŸ¥ä¸–ç•Œä¹¦';
          });

          // å°†ä¸–ç•Œä¹¦åå­—ä»¥æ ‡ç­¾çš„å½¢å¼æ˜¾ç¤ºå‡ºæ¥
          associatedNames.forEach(name => {
            const tag = document.createElement('span');
            tag.className = 'keyword-tag'; // å¤ç”¨å·²æœ‰çš„å…³é”®è¯æ ‡ç­¾æ ·å¼
            tag.style.marginBottom = '5px'; // å¢åŠ ä¸€ç‚¹é—´è·
            tag.textContent = name;
            displayArea.appendChild(tag);
          });
        }

        // --- äº‹ä»¶ç›‘å¬è®¾ç½® (è¾…åŠ©å‡½æ•°) ---
        function setupWorldBookEventListeners() {
          const worldBookListPage = document.getElementById('worldbook-list-page');
          const worldBookDetailPage = document.getElementById('worldbook-detail-page');

          // æ‰“å¼€ä¸–ç•Œä¹¦APP
          document.getElementById('worldBookAppBtn').addEventListener('click', e => {
            e.preventDefault();
            phoneScreen.style.display = 'none';
            renderWorldBookList();
            worldBookListPage.classList.add('active');
          });

          // ä»åˆ—è¡¨é¡µè¿”å›ä¸»å±å¹•
          document.getElementById('worldbook-list-back-btn').addEventListener('click', () => {
            worldBookListPage.classList.remove('active');
            phoneScreen.style.display = 'flex';
          });

          // ä»è¯¦æƒ…é¡µè¿”å›åˆ—è¡¨é¡µ
          document.getElementById('worldbook-detail-back-btn').addEventListener('click', () => {
            worldBookDetailPage.classList.remove('active');
          });

          // æ–°å»ºä¸–ç•Œä¹¦
          document.getElementById('addNewWorldBookBtn').addEventListener('click', async () => {
            const name = prompt('è¯·è¾“å…¥æ–°çš„ä¸–ç•Œä¹¦åç§°ï¼š');
            if (name && name.trim()) {
              if (allWorldBooks.some(wb => wb.name === name.trim())) {
                alert('å·²å­˜åœ¨åŒåä¸–ç•Œä¹¦ï¼');
                return;
              }
              const newWorldBook = { name: name.trim(), entries: {} };
              const newId = await db.worldBooks.add(newWorldBook);
              newWorldBook.id = newId;
              allWorldBooks.push(newWorldBook);
              renderWorldBookList();
            }
          });

          // ç‚¹å‡»ä¸–ç•Œä¹¦åˆ—è¡¨ä¸­çš„ä¸€é¡¹ï¼Œè¿›å…¥è¯¦æƒ…
          // â–¼â–¼â–¼ ç”¨ä¸‹é¢çš„ä»£ç å—æ›¿æ¢æ‰åŸæ¥çš„ 'worldbook-list-container' äº‹ä»¶ç›‘å¬å™¨ â–¼â–¼â–¼
          // å¯¹ä¸–ç•Œä¹¦åˆ—è¡¨å®¹å™¨ä½¿ç”¨äº‹ä»¶å§”æ‰˜
          document.getElementById('worldbook-list-container').addEventListener('click', async e => {
            const deleteBtn = e.target.closest('.delete-worldbook-btn');
            const contentWrapper = e.target.closest('.worldbook-content-wrapper');

            if (deleteBtn) {
              // --- å¦‚æœç‚¹å‡»çš„æ˜¯åˆ é™¤æŒ‰é’® ---
              e.stopPropagation(); // é˜»æ­¢äº‹ä»¶å†’æ³¡åˆ°çˆ¶å…ƒç´ 
              const worldBookIdToDelete = parseInt(deleteBtn.dataset.worldbookId, 10);
              const wbToDelete = allWorldBooks.find(wb => wb.id === worldBookIdToDelete);

              if (!wbToDelete) return;

              if (
                confirm(
                  `ç¡®å®šè¦åˆ é™¤ä¸–ç•Œä¹¦ â€œ${wbToDelete.name}â€ å—ï¼Ÿ\n\næ­¤æ“ä½œä¸å¯æ¢å¤ï¼Œä¸”ä¼šè‡ªåŠ¨è§£é™¤æ‰€æœ‰è§’è‰²ä¸è¯¥ä¸–ç•Œä¹¦çš„å…³è”ï¼`,
                )
              ) {
                try {
                  // 1. ä»æ•°æ®åº“åˆ é™¤
                  await db.worldBooks.delete(worldBookIdToDelete);

                  // 2. ä»å†…å­˜ä¸­åˆ é™¤
                  allWorldBooks = allWorldBooks.filter(wb => wb.id !== worldBookIdToDelete);

                  // 3. éå†æ‰€æœ‰è§’è‰²ï¼Œè§£é™¤å…³è”
                  for (const charId in chatData) {
                    const charSettings = chatData[charId].charSettings;
                    if (charSettings && Array.isArray(charSettings.worldBook)) {
                      charSettings.worldBook = charSettings.worldBook.filter(id => id !== worldBookIdToDelete);
                    }
                  }
                  await saveChatData(); // ä¿å­˜å¯¹è§’è‰²æ•°æ®çš„ä¿®æ”¹

                  // 4. é‡æ–°æ¸²æŸ“åˆ—è¡¨
                  renderWorldBookList();

                  alert(`ä¸–ç•Œä¹¦ â€œ${wbToDelete.name}â€ å·²åˆ é™¤ã€‚`);
                } catch (error) {
                  console.error(`åˆ é™¤ä¸–ç•Œä¹¦ #${worldBookIdToDelete} å‡ºé”™:`, error);
                  alert('åˆ é™¤å¤±è´¥ï¼Œè¯·æŸ¥çœ‹æ§åˆ¶å°ã€‚');
                }
              }
            } else if (contentWrapper) {
              // --- å¦‚æœç‚¹å‡»çš„æ˜¯å†…å®¹åŒºåŸŸ ---
              currentEditingWorldBookId = parseInt(contentWrapper.dataset.worldbookId, 10);
              renderWorldBookDetail(currentEditingWorldBookId);
              worldBookDetailPage.classList.add('active');
            }
          });
          // â–²â–²â–² æ›¿æ¢å®Œæˆ â–²â–²â–²

          // åœ¨è¯¦æƒ…é¡µç‚¹å‡»â€œæ–°å»ºæ¡ç›®â€
          document.getElementById('addNewEntryBtn').addEventListener('click', () => {
            openWorldBookEntryModal(currentEditingWorldBookId, null);
          });

          // è¯¦æƒ…é¡µæ¡ç›®åˆ—è¡¨çš„äº‹ä»¶å§”æ‰˜ï¼ˆç¼–è¾‘å’Œåˆ é™¤ï¼‰
          document.getElementById('worldbook-entry-list-container').addEventListener('click', e => {
            const editBtn = e.target.closest('.edit-entry-btn');
            const deleteBtn = e.target.closest('.delete-entry-btn');
            if (editBtn) {
              const entryUid = parseInt(editBtn.dataset.entryUid, 10);
              openWorldBookEntryModal(currentEditingWorldBookId, entryUid);
            }
            if (deleteBtn) {
              const entryUid = parseInt(deleteBtn.dataset.entryUid, 10);
              deleteWorldBookEntry(currentEditingWorldBookId, entryUid);
            }
          });

          // ç¼–è¾‘/æ–°å»ºæ¡ç›®å¼¹çª—çš„æŒ‰é’®
          document.getElementById('saveWorldBookEntryBtn').addEventListener('click', saveWorldBookEntry);
          document.getElementById('cancelWorldBookEntryBtn').addEventListener('click', () => {
            hideModal(document.getElementById('editWorldBookEntryModal'));
          });
        }
        // =================================================================
        // â–¼â–¼â–¼ ä½¿ç”¨è¿™ä¸ªä¿®æ­£ç‰ˆçš„å‡½æ•°æ›¿æ¢æ—§çš„ getTavernCardFromPng â–¼â–¼â–¼
        // =================================================================
        async function getTavernCardFromPng(file) {
          return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = async () => {
              try {
                const pngBuffer = new Uint8Array(reader.result);
                const textDecoder = new TextDecoder('utf-8');
                let offset = 8; // Skip PNG header

                while (offset < pngBuffer.length) {
                  // DataView is safer for reading multi-byte numbers
                  const dataView = new DataView(pngBuffer.buffer, offset);
                  const length = dataView.getUint32(0, false); // false for big-endian
                  const type = textDecoder.decode(pngBuffer.slice(offset + 4, offset + 8));

                  if (type === 'tEXt') {
                    const keywordAndData = pngBuffer.slice(offset + 8, offset + 8 + length);
                    const nullSeparatorIndex = keywordAndData.indexOf(0);
                    const keyword = textDecoder.decode(keywordAndData.slice(0, nullSeparatorIndex));

                    if (keyword === 'chara') {
                      // 1. Get the Base64 string from the PNG chunk
                      const base64Data = textDecoder.decode(keywordAndData.slice(nullSeparatorIndex + 1));

                      // 2.ã€æ ¸å¿ƒä¿®æ­£ã€‘ä½¿ç”¨ TextDecoder æ¥æ­£ç¡®å¤„ç† UTF-8 ç¼–ç 
                      // First, decode base64 string to a binary string
                      const binaryString = atob(base64Data);
                      // Then, convert binary string to a Uint8Array
                      const bytes = new Uint8Array(binaryString.length);
                      for (let i = 0; i < binaryString.length; i++) {
                        bytes[i] = binaryString.charCodeAt(i);
                      }
                      // Finally, decode the Uint8Array as UTF-8
                      const utf8DecodedString = new TextDecoder('utf-8').decode(bytes);

                      // 3. Parse the correctly decoded JSON string
                      const json = JSON.parse(utf8DecodedString);
                      resolve(json);
                      return;
                    }
                  }
                  offset += 12 + length; // Move to the next chunk
                }
                reject(new Error('åœ¨PNGä¸­æœªæ‰¾åˆ°è§’è‰²å¡æ•°æ® (tEXt:chara)'));
              } catch (error) {
                console.error('è§£æPNGè§’è‰²å¡æ—¶å‡ºé”™:', error);
                reject(error);
              }
            };
            reader.onerror = reject;
            reader.readAsArrayBuffer(file);
          });
        }

        // 2. å°†è§£æå‡ºçš„è§’è‰²å¡æ•°æ®è½¬æ¢ä¸ºæˆ‘ä»¬çš„å†…éƒ¨æ ¼å¼
        async function processImportedCard(cardData, avatarBase64) {
          if (!cardData || !cardData.data || !cardData.data.name) {
            throw new Error('æ— æ•ˆçš„è§’è‰²å¡æ ¼å¼ï¼Œç¼ºå°‘æ ¸å¿ƒæ•°æ®ã€‚');
          }

          const char = cardData.data;

          // A. å¤„ç†ä¸–ç•Œä¹¦
          let worldBookId = null;
          if (
            char.character_book &&
            char.character_book.name &&
            char.character_book.entries &&
            char.character_book.entries.length > 0
          ) {
            const wbName = `[å¯¼å…¥] ${char.character_book.name}`;

            // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨åŒåä¸–ç•Œä¹¦
            let existingWb = allWorldBooks.find(wb => wb.name === wbName);

            if (existingWb) {
              worldBookId = existingWb.id;
              alert(`æ£€æµ‹åˆ°å·²å­˜åœ¨çš„åŒåä¸–ç•Œä¹¦ "${wbName}"ï¼Œå°†ç›´æ¥å…³è”ã€‚`);
            } else {
              const newWorldBook = {
                name: wbName,
                entries: {},
              };
              char.character_book.entries.forEach((entry, index) => {
                const newUid = Date.now() + index;
                newWorldBook.entries[newUid] = {
                  uid: newUid,
                  key: entry.keys || [],
                  comment: entry.comment || `æ¡ç›® ${index + 1}`,
                  content: entry.content || '',
                  order: entry.insertion_order || 100,
                  probability: entry.extensions?.probability || 100,
                  // ä¿ç•™ä¸€äº›é»˜è®¤å€¼
                  constant: entry.constant || false,
                  selective: entry.selective || true,
                  useProbability: entry.extensions?.useProbability || true,
                };
              });

              // ä¿å­˜æ–°çš„ä¸–ç•Œä¹¦åˆ°æ•°æ®åº“å¹¶è·å–ID
              const newId = await db.worldBooks.add(newWorldBook);
              newWorldBook.id = newId;
              allWorldBooks.push(newWorldBook); // æ›´æ–°å†…å­˜ä¸­çš„ä¸–ç•Œä¹¦åˆ—è¡¨
              worldBookId = newId;
              alert(`æˆåŠŸå¯¼å…¥å¹¶åˆ›å»ºäº†æ–°çš„ä¸–ç•Œä¹¦ "${wbName}"ã€‚`);
            }
          }

          // B. åˆ›å»ºæ–°è§’è‰²
          const newCharId = `char${Date.now()}`;
          chatData[newCharId] = {
            charSettings: {
              avatar: avatarBase64 || 'https://i.postimg.cc/h4yRTMGF/ed60bc4602ebd5cbc0d8961d6c4b4aac.jpg', // ä½¿ç”¨ PNG æœ¬èº«çš„å›¾åƒæˆ–é»˜è®¤å›¾
              realName: char.name, // æœ¬åä½¿ç”¨å¡å
              nickname: char.name, // å¤‡æ³¨ä¹Ÿä½¿ç”¨å¡å
              gender: 'other', // å¡ç‰‡ä¸­æ²¡æœ‰æ€§åˆ«å­—æ®µï¼Œè®¾ä¸ºé»˜è®¤
              persona: `${char.description || ''}\n\n${char.personality || ''}`.trim(), // åˆå¹¶æè¿°å’Œæ€§æ ¼
              maxMemory: 50, // é»˜è®¤å€¼
              group: '', // é»˜è®¤æœªåˆ†ç»„
              worldBook: worldBookId ? [worldBookId] : [], // å…³è”åˆšæ‰åˆ›å»ºæˆ–æ‰¾åˆ°çš„ä¸–ç•Œä¹¦ID
              npcs: [],
              exclusiveStickers: [],
            },
            userSettings: {
              // æ²¿ç”¨ä¸€ä¸ªé»˜è®¤çš„ç”¨æˆ·è®¾ç½®
              name: 'æˆ‘',
              gender: 'male',
              persona: 'æˆ‘æ˜¯ä¸€ä¸ªé»˜è®¤ç”¨æˆ·äººè®¾ã€‚',
              avatar:
                (await db.userSettings.get('profileAvatar')?.value) ||
                'https://i.postimg.cc/ryn2xgwZ/5fc5b9ae74465344658ed8c7e508b8f5.jpg',
            },
            // â–¼â–¼â–¼ æ ¸å¿ƒä¿®æ”¹ï¼šå°† history è®¾ç½®ä¸ºç©ºæ•°ç»„ â–¼â–¼â–¼
            history: [], // ä¸å¯¼å…¥å¼€åœºç™½ï¼ŒèŠå¤©å†å²ä»ç©ºç™½å¼€å§‹
          };

          // C. ä¿å­˜æ•°æ®å¹¶æ›´æ–°UI
          await saveChatData();
          renderContactsList(); // é‡æ–°æ¸²æŸ“é€šè®¯å½•
          hideModal(document.getElementById('addCharModal')); // å…³é—­å¼¹çª—
          alert(`è§’è‰² "${char.name}" å¯¼å…¥æˆåŠŸï¼`);
        }

        // 3. æ ¸å¿ƒçš„å¯¼å…¥æµç¨‹è§¦å‘å‡½æ•°
        async function importCharacterCard(file) {
          if (!file) return;

          try {
            let cardJson;
            let avatarBase64 = null;

            if (file.type === 'image/png') {
              // å¦‚æœæ˜¯PNGï¼Œå…ˆè§£æå…ƒæ•°æ®
              cardJson = await getTavernCardFromPng(file);
              // åŒæ—¶å°†PNGæ–‡ä»¶æœ¬èº«è½¬æ¢ä¸ºBase64ä½œä¸ºå¤´åƒ
              avatarBase64 = await fileToBase64(file);
            } else if (file.type === 'application/json') {
              // å¦‚æœæ˜¯JSONï¼Œç›´æ¥è¯»å–å†…å®¹
              cardJson = await new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = e => resolve(JSON.parse(e.target.result));
                reader.onerror = reject;
                reader.readAsText(file);
              });
            } else {
              alert('ä¸æ”¯æŒçš„æ–‡ä»¶ç±»å‹ã€‚è¯·é€‰æ‹© .png æˆ– .json æ–‡ä»¶ã€‚');
              return;
            }

            // å¤„ç†è§£æå‡ºçš„æ•°æ®
            await processImportedCard(cardJson, avatarBase64);
          } catch (error) {
            console.error('å¯¼å…¥è§’è‰²å¡å¤±è´¥:', error);
            alert(`å¯¼å…¥å¤±è´¥ï¼š${error.message}`);
          }
        }
        // â–¼â–¼â–¼ æŠŠä¸‹é¢è¿™ä¸€å¤§å—å…¨æ–°çš„å‡½æ•°ï¼Œç²˜è´´åˆ° JS åˆé€‚çš„ä½ç½® â–¼â–¼â–¼

        // =================================================================
        // ================== è§†é¢‘é€šè¯æ ¸å¿ƒé€»è¾‘ (å…¨æ–°) ==================
        // =================================================================

        function startVideoCall() {
          if (!currentChatId || !chatData[currentChatId]) return;

          // 1. åˆå§‹åŒ–å½“å‰é€šè¯è®°å½•æ•°ç»„
          currentCallTranscript = [];

          const { charSettings, userSettings } = chatData[currentChatId];
          const largeView = document.getElementById('video-call-large-view');
          const smallView = document.getElementById('video-call-small-view');
          const dialogueOverlay = document.getElementById('video-call-dialogue-overlay');
          const charInfo = document.getElementById('video-call-char-info');
          const timerElement = document.getElementById('video-call-timer');

          const charImage = charSettings.videoCallImage || '';
          const userImage = userSettings.videoCallImage || '';

          isSmallViewUser = true;
          dialogueOverlay.innerHTML = '';

          largeView.style.backgroundImage = charImage ? `url(${charImage})` : 'none';

          // â–¼â–¼â–¼ æ ¸å¿ƒä¿®æ”¹ï¼šæ£€æŸ¥ç”¨æˆ·æ˜¯å¦æœ‰å›¾ï¼Œå†³å®šæ˜¯å¦æ˜¾ç¤ºå°çª— â–¼â–¼â–¼
          if (userImage) {
            smallView.style.backgroundImage = `url(${userImage})`;
            smallView.style.display = 'block'; // æ˜¾ç¤ºå°çª—
          } else {
            smallView.style.display = 'none'; // éšè—å°çª—
          }
          // â–²â–²â–² ä¿®æ”¹ç»“æŸ â–²â–²â–²

          if (!charImage) {
            charInfo.style.display = 'flex';
            charInfo.querySelector('img').src = charSettings.avatar;
            document.getElementById('video-call-char-name').textContent = charSettings.nickname;
          } else {
            charInfo.style.display = 'none';
          }

          if (callTimerInterval) clearInterval(callTimerInterval);
          callStartTime = Date.now();
          timerElement.textContent = '00:00';
          callTimerInterval = setInterval(() => {
            const elapsedSeconds = (Date.now() - callStartTime) / 1000;
            timerElement.textContent = formatCallTime(elapsedSeconds);
          }, 1000);

          videoCallScreen.style.display = 'flex';
          setTimeout(() => {
            videoCallScreen.style.opacity = 1;
            isVideoCallActive = true;
            // æ¬¢è¿è¯­ä¹Ÿè®°å½•ä¸‹æ¥
            addVideoDialogueLine('system', 'é€šè¯å·²è¿æ¥...');
          }, 10);
        }
        // â–¼â–¼â–¼ æ‰¾åˆ°å¹¶ç”¨è¿™ä¸ªç‰ˆæœ¬æ›¿æ¢æ—§çš„ showIncomingCallUI å‡½æ•° â–¼â–¼â–¼
        function showIncomingCallUI(charId) {
          if (!charId || !chatData[charId]) return;

          const charName = chatData[charId].charSettings.nickname;
          const charAvatar = chatData[charId].charSettings.avatar;

          // å¡«å……å¼¹çª—å†…å®¹
          document.getElementById('waiting-char-avatar').src = charAvatar;
          document.getElementById('waiting-char-name').textContent = charName;
          document.getElementById('video-call-invite-text').textContent = 'å‘ä½ å‘èµ·è§†é¢‘é€šè¯...';

          // ã€æ ¸å¿ƒä¿®æ­£ã€‘ç¡®ä¿æ­£ç¡®æ˜¾ç¤º/éšè—æŒ‰é’®ç»„
          document.getElementById('incoming-call-buttons').style.display = 'flex';
          document.getElementById('outgoing-call-button').style.display = 'none';

          showModal(videoCallInviteModal);
        }

        async function endVideoCall() {
          // <-- å‡½æ•°å˜ä¸º async
          if (callTimerInterval) {
            clearInterval(callTimerInterval);
            callTimerInterval = null;
          }
          const elapsedSeconds = (Date.now() - callStartTime) / 1000;

          // â–¼â–¼â–¼ æ ¸å¿ƒé€»è¾‘ï¼šä¿å­˜è®°å½•å¹¶å‘é€å¡ç‰‡ â–¼â–¼â–¼
          // æ£€æŸ¥æ˜¯å¦æœ‰å®è´¨æ€§é€šè¯å†…å®¹ï¼ˆè‡³å°‘æœ‰ä¸€æ¡éç³»ç»Ÿæ¶ˆæ¯ï¼‰
          if (currentCallTranscript.length > 1) {
            const newLog = {
              id: Date.now(),
              startTime: callStartTime,
              duration: elapsedSeconds,
              transcript: [...currentCallTranscript], // å¤åˆ¶ä¸€ä»½å‰¯æœ¬
            };

            // ç¡®ä¿è§’è‰²æ•°æ®ä¸­æœ‰ videoCallLogs æ•°ç»„
            if (!chatData[currentChatId].videoCallLogs) {
              chatData[currentChatId].videoCallLogs = [];
            }
            chatData[currentChatId].videoCallLogs.push(newLog);

            // åˆ›å»ºå¡ç‰‡æ¶ˆæ¯
            const callCardMessage = {
              role: 'system', // ä½¿ç”¨ç³»ç»Ÿè§’è‰²ï¼Œè¿™æ ·ä¸ä¼šè¢«è®¡å…¥AIçš„è®°å¿†
              content: `[è§†é¢‘é€šè¯] æ—¶é•¿: ${formatCallTime(elapsedSeconds)}`,
              callLogId: newLog.id, // é™„åŠ ä¸€ä¸ªIDï¼Œæ–¹ä¾¿ä»¥åç‚¹å‡»æŸ¥æ‰¾
            };
            chatData[currentChatId].history.push(callCardMessage);

            // ä¿å­˜æ‰€æœ‰æ›´æ”¹
            await saveChatData();
            // åˆ·æ–°èŠå¤©ç•Œé¢ä»¥æ˜¾ç¤ºå¡ç‰‡
            renderChatMessages(currentChatId);
          }
          // â–²â–²â–² æ ¸å¿ƒé€»è¾‘ç»“æŸ â–²â–²â–²

          videoCallScreen.style.opacity = 0;
          setTimeout(() => {
            videoCallScreen.style.display = 'none';
            isVideoCallActive = false;
            currentCallTranscript = []; // æ¸…ç©ºä¸´æ—¶è®°å½•
          }, 300);
        }

        function switchVideoViews() {
          if (!isVideoCallActive) return;

          const { charSettings, userSettings } = chatData[currentChatId];
          const largeView = document.getElementById('video-call-large-view');
          const smallView = document.getElementById('video-call-small-view');
          const charInfo = document.getElementById('video-call-char-info');

          const charImage = charSettings.videoCallImage || '';
          const userImage = userSettings.videoCallImage || '';

          isSmallViewUser = !isSmallViewUser;

          if (isSmallViewUser) {
            // å°çª—æ˜¯ç”¨æˆ·ï¼Œå¤§çª—æ˜¯è§’è‰²
            largeView.style.backgroundImage = charImage ? `url(${charImage})` : 'none';
            // â–¼â–¼â–¼ æ ¸å¿ƒä¿®æ”¹ â–¼â–¼â–¼
            if (userImage) {
              smallView.style.backgroundImage = `url(${userImage})`;
              smallView.style.display = 'block';
            } else {
              smallView.style.display = 'none';
            }
            // â–²â–²â–² ä¿®æ”¹ç»“æŸ â–²â–²â–²
            if (!charImage) {
              charInfo.style.display = 'flex';
            } else {
              charInfo.style.display = 'none';
            }
          } else {
            // å°çª—æ˜¯è§’è‰²ï¼Œå¤§çª—æ˜¯ç”¨æˆ·
            largeView.style.backgroundImage = userImage ? `url(${userImage})` : 'none';
            // â–¼â–¼â–¼ æ ¸å¿ƒä¿®æ”¹ â–¼â–¼â–¼
            if (charImage) {
              smallView.style.backgroundImage = `url(${charImage})`;
              smallView.style.display = 'block';
            } else {
              smallView.style.display = 'none';
            }
            // â–²â–²â–² ä¿®æ”¹ç»“æŸ â–²â–²â–²
            charInfo.style.display = 'none';
          }
        }

        function addVideoDialogueLine(speaker, text) {
          // â–¼â–¼â–¼ æ ¸å¿ƒä¿®æ”¹ï¼šå°†å¯¹è¯å­˜å…¥ä¸´æ—¶è®°å½•æ•°ç»„ â–¼â–¼â–¼
          currentCallTranscript.push({ speaker, text });
          // â–²â–²â–² ä¿®æ”¹ç»“æŸ â–²â–²â–²

          const dialogueOverlay = document.getElementById('video-call-dialogue-overlay');
          const line = document.createElement('p');
          line.className = `video-dialogue-line ${speaker}`;

          dialogueOverlay.appendChild(line);

          if (speaker === 'char') {
            typewriterEffect(line, text);
          } else {
            line.textContent = text;
          }

          dialogueOverlay.scrollTop = dialogueOverlay.scrollHeight;
        }

        // è§†é¢‘é€šè¯ä¸“ç”¨çš„AIå›å¤å‡½æ•°
        async function triggerVideoCallAiResponse(userInput = null) {
          if (!currentChatId || !isVideoCallActive) return;

          // --- 1. æ•°æ®å’ŒAPIè®¾ç½®å‡†å¤‡ (ä¸ä¸»èŠå¤©ç±»ä¼¼) ---
          const apiSettings = JSON.parse(localStorage.getItem('apiPresets'));
          const selectedPresetName = localStorage.getItem('selectedApiPreset');
          const currentApi = apiSettings ? Object.values(apiSettings)[0] : null; // ç®€å•ç¤ºä¾‹
          if (!currentApi?.url || !currentApi?.key || !currentApi?.model) {
            addVideoDialogueLine('system', 'é”™è¯¯ï¼šAPIæœªé…ç½®');
            return;
          }

          const { charSettings, userSettings, history } = chatData[currentChatId];

          // --- 2. å¦‚æœæœ‰ç”¨æˆ·è¾“å…¥ï¼Œå…ˆåŠ åˆ°å†å²è®°å½•é‡Œ ---
          if (userInput) {
            history.push({ role: 'user', content: userInput });
          }

          // --- 3. æ„å»ºè§†é¢‘é€šè¯ä¸“ç”¨çš„ç³»ç»ŸæŒ‡ä»¤ (System Prompt) ---
          const systemPrompt = `
[æŒ‡ä»¤]
ä½ æ­£åœ¨ä¸ç”¨æˆ·è¿›è¡Œè§†é¢‘é€šè¯ã€‚ä½ çš„æ‰€æœ‰å›å¤éƒ½å¿…é¡»åƒåœ¨çœŸå®è§†é¢‘é€šè¯ä¸­ä¸€æ ·ï¼ŒåŒ…å«åŠ¨ä½œã€ç¥æ€å’Œå¯¹è¯ã€‚
ä½ çš„å›å¤å¿…é¡»æ˜¯ä¸€ä¸ªç¬¦åˆJSONæ ¼å¼çš„å¯¹è±¡ï¼Œä¸”åªåŒ…å«ä¸€ä¸ªå¯¹è±¡ã€‚
è¿™ä¸ªJSONå¯¹è±¡å¿…é¡»åŒ…å«ä¸¤ä¸ªå­—æ®µ: 'action' (å­—ç¬¦ä¸²) å’Œ 'content' (å­—ç¬¦ä¸²)ã€‚

- 'action': æè¿°ä½ è¯´è¯å‰çš„åŠ¨ä½œã€è¡¨æƒ…æˆ–ç¥æ€ï¼Œä½¿ç”¨æ‹¬å·åŒ…è£¹ï¼Œä¾‹å¦‚ "(æ­ªäº†æ­ªå¤´)" æˆ– "(å¾®ç¬‘ç€ç‚¹ç‚¹å¤´)"ã€‚
- 'content': ä½ è¦è¯´çš„å¯¹è¯å†…å®¹ã€‚

ç¤ºä¾‹å›å¤:
{
  "action": "(çœ¼ç›ä¸€äº®)",
  "content": "å“¦ï¼ŸçœŸçš„å—ï¼Ÿå¿«è·Ÿæˆ‘è¯´è¯´çœ‹ï¼"
}

[è§’è‰²äººè®¾]
${charSettings.persona}

[ç”¨æˆ·äººè®¾]
- åå­—: ${userSettings.name}
- å’Œä½ çš„å…³ç³»: ${userSettings.relationToChar || 'æœ‹å‹'}
`.trim();

          // --- 4. å‡†å¤‡APIè¯·æ±‚ä½“ ---
          const memorySlice = history.slice(-charSettings.maxMemory || -50);
          const messagesForApi = [{ role: 'system', content: systemPrompt }, ...memorySlice];
          const requestBody = {
            model: currentApi.model,
            messages: messagesForApi,
            response_format: { type: 'json_object' }, // å¼ºåˆ¶JSONè¾“å‡º
          };

          // --- 5. å‘é€è¯·æ±‚å¹¶å¤„ç†å›å¤ ---
          try {
            const response = await fetch(currentApi.url + '/chat/completions', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json', Authorization: `Bearer ${currentApi.key}` },
              body: JSON.stringify(requestBody),
            });

            if (!response.ok) throw new Error(`HTTP error! ${response.status}`);

            const data = await response.json();
            const rawContent = data.choices[0].message.content;

            // è§£æAIè¿”å›çš„JSON
            const parsedResponse = JSON.parse(rawContent);
            const { action, content } = parsedResponse;

            // ç»„åˆæˆæœ€ç»ˆè¦æ˜¾ç¤ºçš„æ–‡æœ¬
            const fullReply = `${action || ''} ${content || ''}`.trim();

            // å°†AIçš„å›å¤ä¹ŸåŠ å…¥å†å²è®°å½•
            history.push({ role: 'assistant', content: fullReply });
            await saveChatData();

            // åœ¨UIä¸Šæ˜¾ç¤ºå›å¤
            addVideoDialogueLine('char', fullReply);
          } catch (error) {
            console.error('Video call API failed:', error);
            addVideoDialogueLine('system', `[AIå‡ºé”™äº†: ${error.message}]`);
            // å¦‚æœå‡ºé”™ï¼ŒæŠŠåˆšæ‰çš„ç”¨æˆ·è¾“å…¥ä»å†å²è®°å½•é‡Œç§»é™¤ï¼Œæ–¹ä¾¿é‡è¯•
            if (userInput) history.pop();
          }
        }

        /**
         * æ‰“å­—æœºæ•ˆæœå‡½æ•°
         * @param {HTMLElement} element - è¦æ˜¾ç¤ºæ–‡å­—çš„DOMå…ƒç´ 
         * @param {string} text - è¦æ˜¾ç¤ºçš„å®Œæ•´æ–‡æœ¬
         * @param {number} speed - æ‰“å­—é€Ÿåº¦ï¼ˆæ¯«ç§’/å­—ï¼‰
         */
        function typewriterEffect(element, text, speed = 50) {
          let i = 0;
          element.textContent = ''; // å…ˆæ¸…ç©º
          const typing = setInterval(() => {
            if (i < text.length) {
              element.textContent += text.charAt(i);
              i++;
              // è‡ªåŠ¨æ»šåŠ¨åˆ°åº•éƒ¨
              const dialogueOverlay = document.getElementById('video-call-dialogue-overlay');
              dialogueOverlay.scrollTop = dialogueOverlay.scrollHeight;
            } else {
              clearInterval(typing);
            }
          }, speed);
        }
        // â–¼â–¼â–¼ åœ¨è¿™é‡Œç²˜è´´æ–°çš„å‡½æ•° â–¼â–¼â–¼
        /**
         * æ ¹æ®è½¬è´¦è¯¦æƒ…åŠ¨æ€ç”ŸæˆHTMLå¡ç‰‡
         * @param {object} details - è½¬è´¦è¯¦æƒ…å¯¹è±¡
         * @param {string} messageRole - æ¶ˆæ¯çš„è§’è‰² ('user' æˆ– 'assistant')
         * @returns {string} - ç”Ÿæˆçš„HTMLå­—ç¬¦ä¸²
         */
        function generateTransferCardHTML(details, messageRole) {
          const isUserSender = messageRole === 'user';
          const statusInfo = {
            pending: { text: 'ç­‰å¾…å¯¹æ–¹æ”¶æ¬¾', icon: 'ğŸ’°' },
            accepted: { text: 'å·²æ”¶æ¬¾', icon: 'âœ…' },
            refused: { text: 'å·²é€€è¿˜', icon: 'â†©ï¸' },
          };

          const currentStatus = statusInfo[details.status];
          // å¡ç‰‡çš„CSS classä¼šæ ¹æ®çŠ¶æ€æ”¹å˜ï¼Œæ¯”å¦‚ 'transfer-card accepted'
          const cardClass = details.status;

          // â–¼â–¼â–¼ ç”¨è¿™ä¸ªæ–°ç‰ˆæœ¬æ›¿æ¢æ—§çš„ actionsHTML é€»è¾‘ â–¼â–¼â–¼
          let actionsHTML = '';
          if (details.status === 'pending') {
            if (isUserSender) {
              // Userå‘ç»™Charï¼ŒCharå¯ä»¥é€‰æ‹© (AIè‡ªåŠ¨å¤„ç†)
              // è¿™é‡Œä¸éœ€è¦æŒ‰é’®ï¼Œå› ä¸ºAIä¼šé€šè¿‡ transfer_response ç±»å‹æ¥å›åº”
            } else {
              // Charå‘ç»™Userï¼ŒUserå¯ä»¥é€‰æ‹©
              actionsHTML = `
                <div class="transfer-card-actions">
                    <button class="transfer-action-btn user-accept">æ¥æ”¶</button>
                    <button class="transfer-action-btn user-refuse">é€€è¿˜</button>
                </div>
              `;
            }
          }
          // â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²

          return `
                <div class="transfer-card ${cardClass}" data-transfer-id="${details.id}">
                    <div class="transfer-card-header">
                        <span class="transfer-icon">${currentStatus.icon}</span>
                        <p>${
                          isUserSender ? `è½¬è´¦ç»™ ${details.recipientName}` : `æ”¶åˆ°æ¥è‡ª ${details.senderName} çš„è½¬è´¦`
                        }</p>
                    </div>
                    <div class="transfer-card-body">
                        <p class="transfer-amount">Â¥${details.amount.toFixed(2)}</p>
                        <p class="transfer-remark">${details.remark}</p>
                    </div>
                    <div class="transfer-card-footer">
                        <p class="transfer-status">${currentStatus.text}</p>
                    </div>
                    ${actionsHTML}
                </div>
            `;
        }
        // =================================================================
        // ================== è§†é¢‘é€šè¯è®°å½•æŸ¥çœ‹é€»è¾‘ (å…¨æ–°) ==================
        // =================================================================

        // æ‰“å¼€é€šè¯è®°å½•åˆ—è¡¨å¼¹çª—
        function showCallHistory(charId) {
          const historyData = chatData[charId]?.videoCallLogs || [];
          const listContainer = document.getElementById('call-history-list');

          if (historyData.length === 0) {
            listContainer.innerHTML =
              '<p style="text-align: center; color: var(--text-secondary-color);">æš‚æ— é€šè¯è®°å½•</p>';
          } else {
            // ä»æ–°åˆ°æ—§æ’åº
            listContainer.innerHTML = [...historyData]
              .reverse()
              .map(log => {
                const callDate = new Date(log.startTime).toLocaleString('zh-CN', {
                  month: 'short',
                  day: 'numeric',
                  hour: '2-digit',
                  minute: '2-digit',
                });
                return `
                <div class="history-item" onclick="showCallTranscript('${charId}', ${log.id})">
                    <p class="history-item-time">${callDate}</p>
                    <p class="history-item-duration">é€šè¯æ—¶é•¿: ${formatCallTime(log.duration)}</p>
                </div>
            `;
              })
              .join('');
          }
          showModal(document.getElementById('videoCallHistoryModal'));
        }

        // æ‰“å¼€å•æ¬¡é€šè¯è¯¦æƒ…å¼¹çª—
        window.showCallTranscript = function (charId, logId) {
          const log = chatData[charId]?.videoCallLogs?.find(l => l.id === logId);
          if (!log) {
            alert('æ‰¾ä¸åˆ°è¯¥é€šè¯è®°å½•ï¼');
            return;
          }

          const titleEl = document.getElementById('transcript-modal-title');
          const contentEl = document.getElementById('transcript-modal-content');

          const callDate = new Date(log.startTime).toLocaleString();
          titleEl.textContent = `é€šè¯äº ${callDate}`;

          contentEl.innerHTML = log.transcript
            .map(line => {
              const speakerName =
                line.speaker === 'user'
                  ? chatData[charId].userSettings.name || 'æˆ‘'
                  : line.speaker === 'char'
                  ? chatData[charId].charSettings.nickname || 'å¯¹æ–¹'
                  : 'ç³»ç»Ÿ';
              return `<div class="transcript-line"><strong>[${speakerName}]:</strong> ${line.text}</div>`;
            })
            .join('');

          showModal(document.getElementById('callTranscriptModal'));
        };
        // â–¼â–¼â–¼ æŠŠè¿™ä¸ªå…¨æ–°çš„å‡½æ•°ç²˜è´´åˆ°ä½ çš„ JS ä»£ç ä¸­ â–¼â–¼â–¼
        /**
         * ä¸€ä¸ªé€šç”¨çš„ã€éæµå¼çš„ AI è°ƒç”¨å‡½æ•°
         * @param {string} prompt - å‘é€ç»™ AI çš„æç¤ºè¯
         * @param {boolean} expectJson - æ˜¯å¦æœŸæœ› AI è¿”å› JSON æ ¼å¼çš„å­—ç¬¦ä¸²
         * @returns {Promise<string|null>} - AI çš„å›å¤æ–‡æœ¬ï¼Œå¦‚æœå¤±è´¥åˆ™è¿”å› null
         */
        async function getAiSingleResponse(prompt, expectJson = false) {
          // ç›´æ¥ä»å…¨å±€å˜é‡è·å–å½“å‰ç”Ÿæ•ˆçš„APIé…ç½®
          if (!currentApiConfig || !currentApiConfig.url || !currentApiConfig.key || !currentApiConfig.model) {
            alert('AI åŠŸèƒ½éœ€è¦é…ç½® APIï¼è¯·å‰å¾€â€œAPIè®¾ç½®â€é¡µé¢é…ç½®ã€‚');
            return null;
          }
          // 2. æ„å»ºè¯·æ±‚ä½“ (éæµå¼)
          const requestBody = {
            model: currentApi.model,
            messages: [{ role: 'user', content: prompt }],
            stream: false, //  å…³é”®ï¼šå…³é—­æµå¼è¾“å‡º
          };

          if (expectJson) {
            requestBody.response_format = { type: 'json_object' };
          }

          try {
            // 3. å‘é€è¯·æ±‚
            const response = await fetch(currentApiConfig.url + '/chat/completions', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                Authorization: `Bearer ${currentApiConfig.key}`,
              },
              body: JSON.stringify(requestBody),
            });

            if (!response.ok) {
              const errorText = await response.text();
              throw new Error(`API è¯·æ±‚å¤±è´¥: ${response.status} ${errorText}`);
            }

            // 4. è§£æå¹¶è¿”å›ç»“æœ
            const data = await response.json();
            return data.choices[0].message.content;
          } catch (error) {
            console.error('getAiSingleResponse å¤±è´¥:', error);
            alert(`è°ƒç”¨ AI å¤±è´¥: ${error.message}`);
            return null;
          }
        }
        // â–²â–²â–² æ–°å‡½æ•°ç»“æŸ â–²â–²â–²
        // â–¼â–¼â–¼ åœ¨ getAiSingleResponse å‡½æ•°ä¸‹é¢ï¼Œç²˜è´´è¿™ä¸ªæ–°å‡½æ•° â–¼â–¼â–¼
        /**
         * ç»Ÿä¸€å¤„ç†ä½™é¢å˜åŠ¨å’Œè®°å½•ç”Ÿæˆçš„å‡½æ•°
         * @param {string} charId - è§’è‰²ID
         * @param {number} amount - å˜åŠ¨é‡‘é¢ (æ­£æ•°ä¸ºæ”¶å…¥, è´Ÿæ•°ä¸ºæ”¯å‡º)
         * @param {string} description - å˜åŠ¨åŸå› 
         */
        async function addTransaction(charId, amount, description) {
          const wallet = chatData[charId].charSettings.wallet;

          // 1. æ›´æ–°ä½™é¢
          wallet.balance += amount;

          // 2. åˆ›å»ºæ–°çš„äº¤æ˜“è®°å½•
          const newTransaction = {
            timestamp: Date.now(),
            amount: amount,
            description: description,
          };

          // 3. å°†æ–°è®°å½•æ·»åŠ åˆ°æ•°ç»„å¼€å¤´ (æœ€æ–°è®°å½•åœ¨æœ€å‰)
          wallet.transactions.unshift(newTransaction);

          // å¯é€‰ï¼šä¸ºäº†é˜²æ­¢è®°å½•æ— é™å¢é•¿ï¼Œå¯ä»¥åªä¿ç•™æœ€è¿‘çš„ N æ¡
          if (wallet.transactions.length > 100) {
            // ä¾‹å¦‚ä¿ç•™æœ€è¿‘100æ¡
            wallet.transactions.pop();
          }

          // 4. ä¿å­˜æ•°æ®
          await saveChatData();

          // 5. æ›´æ–°UIæ˜¾ç¤º
          document.getElementById('charCurrentBalance').value = `Â¥ ${wallet.balance.toFixed(2)}`;

          console.log(`[äº¤æ˜“è®°å½•] ${description} | é‡‘é¢: ${amount.toFixed(2)} | æ–°ä½™é¢: ${wallet.balance.toFixed(2)}`);
        }
        // â–²â–²â–² æ–°å‡½æ•°ç»“æŸ â–²â–²â–²

        // â–¼â–¼â–¼ åœ¨ä½ çš„JSä»£ç ä¸­ï¼Œæ‰¾åˆ°ä¸€ä¸ªåˆé€‚çš„ä½ç½®ï¼ˆæ¯”å¦‚ addTransaction å‡½æ•°åé¢ï¼‰ï¼Œç²˜è´´ä¸‹é¢è¿™ä¸ªæ–°å‡½æ•° â–¼â–¼â–¼
        /**
         * è®¡ç®—å¹¶åº”ç”¨è§’è‰²æ˜¨æ—¥çš„è–ªèµ„/è´¢åŠ¡å˜åŠ¨
         * @param {string} charId - è§’è‰²ID
         */
        async function calculateAndApplyYesterdaySalary(charId) {
          const char = chatData[charId];
          // å¦‚æœè§’è‰²æ²¡æœ‰è®¾ç½®èŒä¸šæˆ–å·¥ä½œè®¡åˆ’ï¼Œå°±æ— æ³•ç»“ç®—ï¼Œç›´æ¥é€€å‡º
          if (!char || !char.charSettings.work?.profession || !char.charSettings.work?.schedule) {
            return;
          }

          const today = new Date();
          const todayStr = today.toISOString().split('T')[0]; // è·å– YYYY-MM-DD æ ¼å¼çš„ä»Šå¤©æ—¥æœŸ

          // å¦‚æœä»Šå¤©çš„æ—¥æœŸ å’Œ ä¸Šæ¬¡ç»“ç®—æ—¥æœŸ ç›¸åŒï¼Œè¯´æ˜ä»Šå¤©å·²ç»ç»“ç®—è¿‡äº†ï¼Œç›´æ¥é€€å‡º
          const lastSettlement = char.charSettings.wallet.lastSettlementDate;
          if (lastSettlement === todayStr) {
            return;
          }

          // --- åªæœ‰åœ¨ä¸Šæ¬¡ç»“ç®—æ—¥æœŸä¸æ˜¯ä»Šå¤©æ—¶ï¼Œæ‰ä¼šæ‰§è¡Œä¸‹é¢çš„é€»è¾‘ ---

          const yesterday = new Date();
          yesterday.setDate(today.getDate() - 1);
          const yesterdayWeekDay = yesterday.toLocaleDateString('zh-CN', { weekday: 'long' }); // è·å–æ˜¨å¤©æ˜¯æ˜ŸæœŸå‡ 

          console.log(
            `%c[è´¢åŠ¡ç»“ç®—] è§¦å‘å¯¹ ${char.charSettings.nickname} çš„æ˜¨æ—¥(${yesterdayWeekDay})è´¢åŠ¡ç»“ç®—...`,
            'color: #30d158; font-weight: bold;',
          );

          const { profession, schedule } = char.charSettings.work;

          // å‡†å¤‡ä¸€ä¸ªPromptï¼Œè®©AIæ ¹æ®è§’è‰²ä¿¡æ¯è®¡ç®—å‡€æ”¶å…¥
          const prompt = `
                ä¸€ä¸ªäººçš„èŒä¸šæ˜¯â€œ${profession}â€ï¼Œä»–/å¥¹çš„ä¸€å‘¨è®¡åˆ’å¦‚ä¸‹ï¼š
                ---
                ${schedule}
                ---
                æ˜¨å¤©æ˜¯â€œ${yesterdayWeekDay}â€ã€‚è¯·æ ¹æ®è¿™ä»½è®¡åˆ’å’ŒèŒä¸šï¼Œåˆ†æä»–/å¥¹æ˜¨å¤©çš„ä¸»è¦æ´»åŠ¨ï¼Œå¹¶ä¼°ç®—å‡ºå‡€æ”¶å…¥ï¼ˆæ”¶å…¥å‡å»å¯èƒ½çš„æ”¯å‡ºï¼‰ã€‚
                è¯·ä¸¥æ ¼ä»¥ä¸€ä¸ª JSON å¯¹è±¡çš„æ ¼å¼è¿”å›ï¼Œè¯¥å¯¹è±¡åŒ…å«ä¸¤ä¸ªé”®ï¼š
                1. "amount": ä¸€ä¸ªçº¯æ•°å­—ï¼Œä»£è¡¨å‡€æ”¶å…¥ï¼ˆæ­£æ•°è¡¨ç¤ºæ”¶å…¥ï¼Œè´Ÿæ•°è¡¨ç¤ºæ¶ˆè´¹ï¼‰ã€‚
                2. "description": ä¸€å¥ç®€çŸ­çš„æ–‡å­—ï¼Œæè¿°å¯¼è‡´è¿™ç¬”æ”¶å…¥/æ”¯å‡ºçš„å…·ä½“äº‹ä»¶ã€‚

                ä¾‹å¦‚: {"amount": 250, "description": "å®Œæˆäº†ä¸€ä¸ªè®¾è®¡å§”æ‰˜"}
                æˆ–: {"amount": -80, "description": "æ™šä¸Šå»é¤å…åƒäº†é¡¿å¥½çš„"}
            `;

          // è°ƒç”¨AIï¼Œå¹¶å‘Šè¯‰å®ƒæˆ‘ä»¬æœŸæœ›å¾—åˆ°ä¸€ä¸ªJSONæ ¼å¼çš„å›å¤
          const responseJsonText = await getAiSingleResponse(prompt, true);
          if (responseJsonText) {
            try {
              // è§£æAIè¿”å›çš„JSONå­—ç¬¦ä¸²
              const result = JSON.parse(responseJsonText);
              const amount = parseFloat(result.amount);
              const description = result.description || 'æ—¥å¸¸æ”¶æ”¯';

              if (!isNaN(amount) && amount !== 0) {
                // è°ƒç”¨ä½ å·²æœ‰çš„ addTransaction å‡½æ•°æ¥æ›´æ–°ä½™é¢å’Œæ·»åŠ è®°å½•
                await addTransaction(charId, amount, description);

                // åˆ›å»ºä¸€æ¡ç³»ç»Ÿæ¶ˆæ¯ï¼Œé€šçŸ¥ç”¨æˆ·å‘ç”Ÿäº†ä»€ä¹ˆ
                const systemMessage = {
                  role: 'system',
                  content: `[ç³»ç»Ÿæç¤ºï¼šæ˜¨æ—¥è´¢åŠ¡ç»“ç®—] ${description}ï¼Œä½™é¢å˜åŠ¨: Â¥${amount.toFixed(
                    2,
                  )}ã€‚å½“å‰ä½™é¢: Â¥${char.charSettings.wallet.balance.toFixed(2)}`,
                  isSystemNotification: true, // è¿™ä¸ªæ ‡å¿—ä¼šè®©æ¶ˆæ¯æ ·å¼ä¸åŒ
                };
                char.history.push(systemMessage);

                // åˆ·æ–°èŠå¤©ç•Œé¢ä»¥æ˜¾ç¤ºè¿™æ¡ç³»ç»Ÿæ¶ˆæ¯
                renderChatMessages(charId);
              }
            } catch (error) {
              console.error('è§£æAIè¿”å›çš„è´¢åŠ¡JSONå¤±è´¥:', error, 'åŸå§‹æ–‡æœ¬:', responseJsonText);
            }
          }

          // æ— è®ºæˆåŠŸä¸å¦ï¼Œéƒ½å°†ç»“ç®—æ—¥æœŸæ›´æ–°ä¸ºä»Šå¤©ï¼Œç¡®ä¿ä»Šå¤©ä¸å†é‡å¤æ‰§è¡Œ
          char.charSettings.wallet.lastSettlementDate = todayStr;
          await saveChatData();
        }
        /**
         * ç»Ÿä¸€å¤„ç†ã€ç”¨æˆ·ã€‘ä½™é¢å˜åŠ¨å’Œè®°å½•ç”Ÿæˆçš„å‡½æ•°
         * @param {string} charId - å½“å‰å¯¹è¯çš„IDï¼Œç”¨äºå®šä½æ•°æ®
         * @param {number} amount - å˜åŠ¨é‡‘é¢ (æ­£æ•°ä¸ºæ”¶å…¥, è´Ÿæ•°ä¸ºæ”¯å‡º)
         * @param {string} description - å˜åŠ¨åŸå› 
         */
        async function addUserTransaction(charId, amount, description) {
          const wallet = chatData[charId].userSettings.wallet;

          wallet.balance += amount;

          const newTransaction = {
            timestamp: Date.now(),
            amount: amount,
            description: description,
          };

          wallet.transactions.unshift(newTransaction);

          if (wallet.transactions.length > 100) {
            wallet.transactions.pop();
          }

          await saveChatData();

          // æ›´æ–°UIä¸Šçš„ä½™é¢æ˜¾ç¤º
          document.getElementById('userCurrentBalance').value = `Â¥ ${wallet.balance.toFixed(2)}`;

          console.log(
            `[ç”¨æˆ·äº¤æ˜“è®°å½•] ${description} | é‡‘é¢: ${amount.toFixed(2)} | æ–°ä½™é¢: ${wallet.balance.toFixed(2)}`,
          );
        }

        /**
         * è®¡ç®—å¹¶åº”ç”¨ã€ç”¨æˆ·ã€‘çš„æ¯æ—¥å·¥èµ„
         * @param {string} charId - å½“å‰å¯¹è¯çš„ID
         */
        async function calculateAndApplyUserSalary(charId) {
          const user = chatData[charId]?.userSettings;
          // å¦‚æœç”¨æˆ·æ²¡æœ‰è®¾ç½®æ—¥è–ªï¼Œæˆ–æ—¥è–ªä¸º0ï¼Œåˆ™ä¸å¤„ç†
          if (!user || !user.wallet?.dailySalary || user.wallet.dailySalary <= 0) {
            return;
          }

          const today = new Date();
          const todayStr = today.toISOString().split('T')[0];

          const lastSettlement = user.wallet.lastSettlementDate;
          if (lastSettlement === todayStr) {
            return; // ä»Šå¤©å·²ç»ç»“ç®—è¿‡
          }

          console.log(`%c[ç”¨æˆ·è´¢åŠ¡ç»“ç®—] è§¦å‘å¯¹ç”¨æˆ·çš„æ¯æ—¥å·¥èµ„ç»“ç®—...`, 'color: #00BFFF; font-weight: bold;');

          const salary = parseFloat(user.wallet.dailySalary);

          if (!isNaN(salary) && salary > 0) {
            // è°ƒç”¨æ–°çš„ addUserTransaction å‡½æ•°æ¥æ›´æ–°ä½™é¢å’Œæ·»åŠ è®°å½•
            await addUserTransaction(charId, salary, 'æ¯æ—¥å·¥èµ„');
          }

          // æ— è®ºæˆåŠŸä¸å¦ï¼Œéƒ½å°†ç»“ç®—æ—¥æœŸæ›´æ–°ä¸ºä»Šå¤©
          user.wallet.lastSettlementDate = todayStr;
          await saveChatData();
        }
        // =================================================================
        // ================== ç¤¼ç‰©å•†åº—æ ¸å¿ƒé€»è¾‘ (æ–°) ==================
        // =================================================================

        // 1. å®šä¹‰ç¤¼ç‰©åˆ—è¡¨ï¼ˆå¯ä»¥éšæ—¶æ‰©å±•ï¼‰
        const GIFT_CATALOG = [
          { id: 1, name: 'ç¥ç§˜æ˜Ÿè¾°æ‰‹é“¾', prompt: 'a delicate stardust bracelet with glowing gems', price: 128 },
          { id: 2, name: 'æ°¸æ’ç«ç‘°èŠ±æŸ', prompt: 'a beautiful bouquet of enchanted glowing roses', price: 188 },
          { id: 3, name: 'å¹»æƒ³ä¹‹ç¿¼é¡¹é“¾', prompt: 'a fantasy wing necklace, crystal, elegant', price: 258 },
          { id: 4, name: 'æ‰‹ä½œå·§å…‹åŠ›ç¤¼ç›’', prompt: 'a box of exquisite handmade chocolates', price: 99 },
          { id: 5, name: 'è¿·ä½ æœºæ¢°å® ç‰©', prompt: 'a tiny cute mechanical pet bird, steampunk style', price: 320 },
          { id: 6, name: 'æ²»æ„ˆé¦™è–°èœ¡çƒ›', prompt: 'a healing scented candle in a beautiful jar', price: 78 },
        ];

        // 2. AIç”Ÿæˆç¤¼ç‰©çš„å‡½æ•°
        async function generateGiftsByAI() {
          const button = document.getElementById('ai-generate-gifts-btn');
          button.disabled = true;
          button.textContent = 'ç”Ÿæˆä¸­...';

          const listContainer = document.getElementById('gift-list-container');
          listContainer.innerHTML = `<p style="text-align:center; padding: 40px 20px; color: var(--text-secondary-color);">æ­£åœ¨å‘å®‡å®™è®¸æ„¿ï¼Œä¸ºä½ ç”Ÿæˆç‹¬ç‰¹çš„ç¤¼ç‰©...</p>`;

          const prompt = `
                ä½ æ˜¯ä¸€ä½å¹»æƒ³ä¸–ç•Œçš„ç¤¼ç‰©è®¾è®¡å¸ˆã€‚è¯·ä¸ºæ‹äººæˆ–äº²å¯†æœ‹å‹è®¾è®¡6ä¸ªç‹¬ç‰¹ä¸”å……æ»¡åˆ›æ„çš„ç¤¼ç‰©ã€‚
                ä¸¥æ ¼ä»¥JSONæ•°ç»„çš„æ ¼å¼è¿”å›ï¼Œæ¯ä¸ªå¯¹è±¡åŒ…å«ä¸‰ä¸ªé”®ï¼š
                1. "name": å­—ç¬¦ä¸²ï¼Œç¤¼ç‰©åç§°ï¼ˆä¸­æ–‡ï¼Œå¯Œæœ‰æƒ³è±¡åŠ›ï¼‰ã€‚
                2. "prompt": å­—ç¬¦ä¸²ï¼Œç”¨äºAIç»˜ç”»çš„è‹±æ–‡å…³é”®è¯ï¼Œæè¿°ç¤¼ç‰©çš„æ ·å­ã€‚
                3. "price": æ•°å­—ï¼Œç¤¼ç‰©çš„ä»·æ ¼ï¼ˆ50åˆ°500ä¹‹é—´ï¼‰ã€‚
                
                ä¸è¦è¿”å›ä»»ä½•å…¶ä»–å¤šä½™çš„æ–‡å­—ã€‚
            `;
          const responseJsonText = await getAiSingleResponse(prompt, true);
          if (responseJsonText) {
            try {
              const newGifts = JSON.parse(responseJsonText);
              if (Array.isArray(newGifts) && newGifts.length > 0) {
                const newItems = newGifts.map((gift, index) => ({
                  id: Date.now() + index, // ä½¿ç”¨æ—¶é—´æˆ³+ç´¢å¼•ç¡®ä¿IDå”¯ä¸€
                  ...gift,
                  imageUrl: `https://image.pollinations.ai/prompt/${encodeURIComponent(
                    gift.prompt,
                  )}?width=512&amp;height=512&amp;seed=42`,
                }));
                giftShopItems.push(...newItems); // ä½¿ç”¨ push å’Œæ‰©å±•è¿ç®—ç¬¦(...) è¿½åŠ 
                await db.giftShopItems.bulkAdd(newItems);
                renderGiftShop();
              }
            } catch (e) {
              console.error('è§£æAIç¤¼ç‰©JSONå¤±è´¥', e);
              listContainer.innerHTML = `<p style="text-align:center; color: #ff453a;">ç¤¼ç‰©ç”Ÿæˆå¤±è´¥ï¼Œè¯·ç¨åå†è¯•ã€‚</p>`;
            }
          }

          button.disabled = false;
          button.textContent = 'AI ç”Ÿæˆç¤¼ç‰©';
        }
        // 2b. AI æœç´¢ç¤¼ç‰©çš„å‡½æ•° (å…¨æ–°)
        async function searchGiftsByAI() {
          const query = prompt('ä½ æƒ³æ‰¾ä»€ä¹ˆæ ·çš„ç¤¼ç‰©ï¼Ÿ(ä¾‹å¦‚ï¼šä¸€ä¸ªæ¸©æš–çš„å›´å·¾)');
          if (!query || !query.trim()) return;

          const button = document.getElementById('ai-search-gifts-btn');
          button.disabled = true;
          button.textContent = 'æœç´¢ä¸­...';

          const listContainer = document.getElementById('gift-list-container');
          listContainer.innerHTML = `<p style="text-align:center; padding: 40px 20px; color: var(--text-secondary-color);">æ­£åœ¨å¹¿é˜”çš„åˆ›æ„å®‡å®™ä¸­ä¸ºä½ å¯»æ‰¾â€œ${query}â€...</p>`;

          const apiPrompt = `
                ç”¨æˆ·æƒ³å¯»æ‰¾ä¸€ä¸ªç¤¼ç‰©ï¼Œæè¿°æ˜¯ï¼šâ€œ${query}â€ã€‚
                è¯·æ ¹æ®è¿™ä¸ªæè¿°ï¼Œåˆ›é€ 3ä¸ªç›¸å…³çš„å…·ä½“ç¤¼ç‰©ã€‚
                ä¸¥æ ¼ä»¥ä¸€ä¸ª JSON æ•°ç»„çš„æ ¼å¼è¿”å›ï¼Œæ•°ç»„ä¸­çš„æ¯ä¸ªå¯¹è±¡éƒ½åŒ…å«ä¸‰ä¸ªé”®ï¼š
                1. "name": å­—ç¬¦ä¸²ï¼Œç¤¼ç‰©åç§°ï¼ˆä¸­æ–‡ï¼Œå¯Œæœ‰æƒ³è±¡åŠ›ï¼‰ã€‚
                2. "prompt": å­—ç¬¦ä¸²ï¼Œç”¨äºAIç»˜ç”»çš„è‹±æ–‡å…³é”®è¯ï¼Œè¯¦ç»†æè¿°ç¤¼ç‰©çš„æ ·å­ã€‚
                3. "price": æ•°å­—ï¼Œç¤¼ç‰©çš„ä»·æ ¼ï¼ˆ50åˆ°500ä¹‹é—´ï¼‰ã€‚

                ä¸è¦è¿”å›ä»»ä½•å…¶ä»–å¤šä½™çš„æ–‡å­—æˆ–è§£é‡Šã€‚
            `;

          const responseJsonText = await getAiSingleResponse(apiPrompt, true);
          if (responseJsonText) {
            try {
              const newGifts = JSON.parse(responseJsonText); // æ¥æ”¶ä¸€ä¸ªæ•°ç»„
              if (Array.isArray(newGifts) && newGifts.length > 0) {
                const processedNewGifts = newGifts.map((gift, index) => ({
                  id: Date.now() + index, // ç¡®ä¿æ¯ä¸ªç¤¼ç‰©IDéƒ½å”¯ä¸€
                  ...gift,
                  imageUrl: `https://image.pollinations.ai/prompt/${encodeURIComponent(
                    gift.prompt,
                  )}?width=512&amp;height=512&amp;seed=42`,
                }));
                // æ ¸å¿ƒä¿®æ”¹ï¼šä½¿ç”¨ unshift å°†æ–°ç¤¼ç‰©æ·»åŠ åˆ°æ•°ç»„æœ€å‰é¢
                giftShopItems.unshift(...processedNewGifts);
                await db.giftShopItems.bulkAdd(processedNewGifts);
                renderGiftShop();
              } else {
                throw new Error('è¿”å›çš„ä¸æ˜¯æœ‰æ•ˆçš„ç¤¼ç‰©æ•°ç»„');
              }
            } catch (e) {
              console.error('è§£æAIæœç´¢ç»“æœå¤±è´¥', e);
              listContainer.innerHTML = `<p style="text-align:center; color: #ff453a;">ç¤¼ç‰©æœç´¢å¤±è´¥ï¼Œè¯·æ¢ä¸ªå…³é”®è¯è¯•è¯•ã€‚</p>`;
              // å¤±è´¥åæ¢å¤ä¹‹å‰çš„åˆ—è¡¨
              setTimeout(() => renderGiftShop(), 2000);
            }
          }

          button.disabled = false;
          button.textContent = 'AI æœç´¢ç¤¼ç‰©';
        }
        // 3. æ¸²æŸ“ç¤¼ç‰©å•†åº—
        function renderGiftShop() {
          const listContainer = document.getElementById('gift-list-container');
          listContainer.innerHTML = '';
          const grid = document.createElement('div');
          grid.className = 'gift-list';

          giftShopItems.forEach(item => {
            const imageUrl = item.imageUrl;

            const itemEl = document.createElement('div');
            itemEl.className = 'gift-item';
            itemEl.innerHTML = `
                    <div class="gift-item-image" style="background-image: url('${imageUrl}');"></div>
                    <div class="gift-item-info">
                        <span class="gift-item-name">${item.name}</span>
                        <span class="gift-item-price">Â¥ ${item.price.toFixed(2)}</span>
                        <button class="add-to-cart-btn" data-gift-id="${item.id}">åŠ å…¥è´­ç‰©è½¦</button>
                    </div>
                `;
            grid.appendChild(itemEl);
          });
          listContainer.appendChild(grid);
        }

        // 4. æ¸²æŸ“è´­ç‰©è½¦
        function renderShoppingCart() {
          const listEl = document.getElementById('cart-items-list');
          const countEl = document.getElementById('cart-item-count');
          const totalEl = document.getElementById('cart-total-price');

          countEl.textContent = shoppingCart.length;
          countEl.style.display = shoppingCart.length > 0 ? 'flex' : 'none';

          if (shoppingCart.length === 0) {
            listEl.innerHTML = `<p style="text-align:center; padding: 20px; color: var(--text-secondary-color);">è´­ç‰©è½¦æ˜¯ç©ºçš„å“¦</p>`;
          } else {
            listEl.innerHTML = shoppingCart
              .map(
                (item, index) => `
                    <li class="cart-item">
                        <img src="${item.imageUrl}" alt="${item.name}">
                        <div class="cart-item-details">
                            <span class="cart-item-name">${item.name}</span>
                            <span class="cart-item-price">Â¥ ${item.price.toFixed(2)}</span>
                        </div>
                        <button class="remove-cart-item-btn" data-cart-index="${index}">&times;</button>
                    </li>
                `,
              )
              .join('');
          }
          const total = shoppingCart.reduce((sum, item) => sum + item.price, 0);
          totalEl.textContent = `Â¥ ${total.toFixed(2)}`;
        }

        // 5. ç»“ç®—å¹¶å‘é€ç¤¼ç‰©
        async function checkoutAndSendGifts() {
          if (shoppingCart.length === 0) {
            alert('è´­ç‰©è½¦æ˜¯ç©ºçš„ï¼');
            return;
          }

          const totalCost = shoppingCart.reduce((sum, item) => sum + item.price, 0);
          const userWallet = chatData[currentChatId].userSettings.wallet;

          if (userWallet.balance < totalCost) {
            alert(`ä½™é¢ä¸è¶³ï¼éœ€è¦ Â¥${totalCost.toFixed(2)}ï¼Œå½“å‰ä½™é¢ Â¥${userWallet.balance.toFixed(2)}`);
            return;
          }

          // æ‰£æ¬¾
          await addUserTransaction(
            currentChatId,
            -totalCost,
            `è´­ä¹°ç¤¼ç‰©é€ç»™ ${chatData[currentChatId].charSettings.nickname}`,
          );

          // åˆ›å»ºç¤¼ç‰©å¡ç‰‡æ¶ˆæ¯
          // åˆ›å»ºç¤¼ç‰©å¡ç‰‡æ¶ˆæ¯
          const giftMessage = {
            role: 'user', // <-- ä¿®æ”¹è¿™é‡Œï¼
            content: `[ä½ é€å‡ºäº†ä¸€ä»½ç¤¼ç‰©]`,
            type: 'gift', // æ–°ç±»å‹
            giftDetails: {
              items: [...shoppingCart],
              totalCost: totalCost,
            },
          };

          chatData[currentChatId].history.push(giftMessage);
          await saveChatData();

          // æ›´æ–°UI
          renderChatMessages(currentChatId);

          // æ¸…ç©ºè´­ç‰©è½¦å¹¶å…³é—­é¡µé¢
          shoppingCart = [];
          hideModal(shoppingCartModal);
          giftShopPage.classList.remove('active');
          phoneScreen.style.display = 'flex'; // è¿”å›ä¸»å±å¹•
        }
        // åœ¨ GIFT_CATALOG ä¸‹æ–¹æ·»åŠ è¿™ä¸ªæ–°å‡½æ•°
        async function loadGiftShopItems() {
          const itemsFromDB = await db.giftShopItems.toArray();
          if (itemsFromDB.length > 0) {
            // å¦‚æœæ•°æ®åº“é‡Œæœ‰ï¼Œå°±ç›´æ¥ç”¨æ•°æ®åº“é‡Œçš„
            giftShopItems = itemsFromDB;
          } else {
            // å¦‚æœæ•°æ®åº“æ˜¯ç©ºçš„ï¼ˆç¬¬ä¸€æ¬¡åŠ è½½ï¼‰ï¼Œå°±æŠŠé»˜è®¤ç¤¼ç‰©å­˜è¿›å»
            const defaultItems = GIFT_CATALOG.map(item => ({
              ...item,
              imageUrl: `https://image.pollinations.ai/prompt/${encodeURIComponent(
                item.prompt,
              )}?width=512&amp;height=512&amp;seed=42`,
            }));
            await db.giftShopItems.bulkAdd(defaultItems); // å­˜å…¥æ•°æ®åº“
            giftShopItems = defaultItems; // æ›´æ–°å†…å­˜ä¸­çš„åˆ—è¡¨
          }
        }

        // ================== å­—ä½“ç®¡ç†é€»è¾‘ (æ ¸å¿ƒ) ==================
        let currentActiveFontId = null;
        // â–¼â–¼â–¼ æ–°å¢ï¼šå­—ä½“å¤§å°ç®¡ç†é€»è¾‘ â–¼â–¼â–¼

        // å®šä¹‰éœ€è¦è°ƒæ•´å¤§å°çš„å…ƒç´ åŠå…¶åŸå§‹å¤§å° (åŸºå‡†å€¼)
        const FONT_SIZE_TARGETS = [
          { selector: '.message-content', base: 16 }, // èŠå¤©æ°”æ³¡
          { selector: '.app-name', base: 11 }, // APPå›¾æ ‡åå­—
          { selector: '.contact-name', base: 16 }, // é€šè®¯å½•åå­—
          { selector: '.contact-last-msg', base: 14 }, // é€šè®¯å½•æœ€åä¸€æ¡æ¶ˆæ¯
          { selector: '.modal-content p', base: 14 }, // å¼¹çª—æ­£æ–‡
          { selector: '.settings-item label', base: 14 }, // è®¾ç½®é¡¹æ ‡ç­¾
          { selector: 'input', base: 14 }, // è¾“å…¥æ¡†
          { selector: 'textarea', base: 14 }, // æ–‡æœ¬åŸŸ
          { selector: 'button', base: 14 }, // æŒ‰é’®
          { selector: '.status-bar', base: 12 }, // çŠ¶æ€æ 
          { selector: '.main-info-bar input', base: 16 }, // é¦–é¡µæœç´¢æ¡†
        ];

        async function applyFontSize(delta) {
          // 1. æ›´æ–°æ»‘å—æ—è¾¹çš„æ•°å­—æ˜¾ç¤º
          const display = document.getElementById('fontSizeValueDisplay');
          if (display) {
            display.textContent = delta > 0 ? `+${delta}px` : `${delta}px`;
          }

          // 2. ç§»é™¤æ—§çš„æ ·å¼æ ‡ç­¾
          const styleId = 'dynamic-font-size-style';
          let styleTag = document.getElementById(styleId);
          if (styleTag) styleTag.remove();

          // 3. å¦‚æœåç§»é‡ä¸º0ï¼Œåˆ™ä¸æ³¨å…¥æ ·å¼ï¼ˆæ¢å¤é»˜è®¤ï¼‰
          if (parseInt(delta) === 0) return;

          // 4. ç”Ÿæˆæ–°çš„ CSS è§„åˆ™
          // ä½¿ç”¨ calc() è®¡ç®—ï¼šåŸå§‹å¤§å° + åç§»é‡
          let cssRules = '';
          FONT_SIZE_TARGETS.forEach(item => {
            cssRules += `${item.selector} { font-size: calc(${item.base}px + ${delta}px) !important; }\n`;
          });

          // 5. æ³¨å…¥æ ·å¼
          styleTag = document.createElement('style');
          styleTag.id = styleId;
          styleTag.textContent = cssRules;
          document.head.appendChild(styleTag);
        }

        async function loadAndApplySavedFontSize() {
          const savedData = await db.userSettings.get('fontSizeDelta');
          const delta = savedData ? parseInt(savedData.value) : 0;

          // æ›´æ–°æ»‘å—ä½ç½®
          const slider = document.getElementById('fontSizeSlider');
          if (slider) slider.value = delta;

          // åº”ç”¨å¤§å°
          applyFontSize(delta);
        }
        // â–²â–²â–² æ–°å¢ç»“æŸ â–²â–²â–²

        // 1. åŠ è½½å¹¶åº”ç”¨ä¿å­˜çš„å­—ä½“ï¼ˆç”¨äºåˆå§‹åŒ–ï¼‰
        async function loadAndApplySavedFont() {
          const savedFontId = (await db.userSettings.get('activeFontId'))?.value;
          if (savedFontId) {
            const fontData = await db.customFonts.get(savedFontId);
            if (fontData) {
              applyFontToPage(fontData);
              currentActiveFontId = fontData.id;
            }
          }
        }

        // 2. å°†å­—ä½“æ³¨å…¥åˆ°é¡µé¢ CSS ä¸­
        function applyFontToPage(fontData) {
          // ç§»é™¤æ—§çš„å­—ä½“æ ·å¼æ ‡ç­¾
          const oldStyle = document.getElementById('dynamic-font-style');
          if (oldStyle) oldStyle.remove();

          if (!fontData) {
            // æ¢å¤é»˜è®¤
            document.documentElement.style.removeProperty('--app-font');
            return;
          }

          const style = document.createElement('style');
          style.id = 'dynamic-font-style';
          style.textContent = `
              @font-face {
                  font-family: '${fontData.name}';
                  src: url('${fontData.url}');
                  font-display: swap;
              }
              :root {
                  --app-font: '${fontData.name}', sans-serif !important;
              }
          `;
          document.head.appendChild(style);
        }

        // 3. æ¸²æŸ“å­—ä½“åˆ—è¡¨ (èŒåŒ–ç‰ˆ)
        async function renderFontManagerList() {
          const listContainer = document.getElementById('fontListContainer');
          listContainer.innerHTML = '';

          const fonts = await db.customFonts.toArray();

          if (fonts.length === 0) {
            listContainer.innerHTML = `
                <div style="text-align:center; padding:40px 20px; color:#aaa;">
                   (ï½¡â€¢Ìï¸¿â€¢Ì€ï½¡)<br>è¿˜æ²¡æœ‰å­—ä½“å“¦<br>å¿«å»â€œæ‰¹é‡å¯¼å…¥â€é‡Œç²˜è´´ä¸€äº›å§ï¼
                </div>`;
            return;
          }

          fonts.forEach(font => {
            const isActive = font.id === currentActiveFontId;
            const card = document.createElement('div');
            card.className = `font-card ${isActive ? 'active' : ''}`;

            const previewStyleId = `preview-font-${font.id}`;
            if (!document.getElementById(previewStyleId)) {
              const style = document.createElement('style');
              style.id = previewStyleId;
              style.textContent = `
                      @font-face {
                          font-family: 'Preview_${font.name}';
                          src: url('${font.url}');
                          font-display: swap;
                      }
                  `;
              document.head.appendChild(style);
            }

            card.innerHTML = `
                  <div class="font-name-tag">${font.name}</div>
                  <div class="font-preview-text" style="font-family: 'Preview_${font.name}', sans-serif;">
                      è½éœä¸å­¤é¹œé½é£ï¼Œç§‹æ°´å…±é•¿å¤©ä¸€è‰²ã€‚<br>1234567890 Cute UI
                  </div>
                  <div class="font-card-footer">
                      ${isActive ? '' : `<button class="mini-btn apply" data-id="${font.id}">åº”ç”¨</button>`}
                      <button class="mini-btn delete" data-id="${font.id}">åˆ é™¤</button>
                  </div>
              `;
            listContainer.appendChild(card);
          });
        }

        // --- åˆå§‹åŒ–å‡½æ•° ---
        // â–¼â–¼â–¼ æ ¸å¿ƒä¿®æ”¹ 4: ä¿®æ”¹ init å‡½æ•°ï¼Œä½¿å…¶èƒ½æ­£ç¡®åŠ è½½å¼‚æ­¥æ•°æ® â–¼â–¼â–¼
        async function init() {
          phoneScreen.style.display = 'flex';
          document.querySelectorAll('.app-page').forEach(page => page.classList.remove('active'));

          await loadChatData();
          await loadGiftShopItems();
          await loadUserProfilePresets();
          await loadCommonStickers();
          await loadUserStickers();
          await loadGroupSettings();
          await loadBubblePresets();
          await loadWorldBooks();
          // â–¼â–¼â–¼ åŠ è½½ä¸­é—´å›¾æ ‡å’Œæ°”æ³¡é¢œè‰² â–¼â–¼â–¼
          const savedMiddleIcon = (await db.userSettings.get('middleIconUrl'))?.value;
          if (savedMiddleIcon && document.getElementById('chat-middle-icon')) {
              document.getElementById('chat-middle-icon').src = savedMiddleIcon;
          }
          const savedBubbleSettings = (await db.userSettings.get('simpleBubbleSettings'))?.value;
          if (savedBubbleSettings && window.applyGlobalBubbleColors) {
              window.applyGlobalBubbleColors(savedBubbleSettings);
          }
          // â–²â–²â–² åŠ è½½ç»“æŸ â–²â–²â–²

          renderContactsList();
          await loadAndApplySavedFont(); // â–¼â–¼â–¼ æ–°å¢ï¼šåŠ è½½å·²ä¿å­˜çš„å­—ä½“
          await loadAndApplySavedFontSize(); // â–¼â–¼â–¼ æ–°å¢ï¼šåŠ è½½å­—ä½“å¤§å°

          const updateTime = () =>
            (timeElement.textContent = new Date().toLocaleTimeString('zh-CN', { hour12: false }));
          updateTime();
          setInterval(updateTime, 1000);
          const now = new Date();
          dateElement.textContent = `${now.toLocaleDateString('zh-CN', {
            month: 'long',
            day: 'numeric',
          })} ${now.toLocaleDateString('zh-CN', { weekday: 'long' })}`;

          // ä½¿ç”¨ await ç­‰å¾…ä» IndexedDB åŠ è½½è®¾ç½®
          currentSettings = await loadSettings();
          applySettings(currentSettings);

          // â–¼â–¼â–¼ ä¿®æ”¹è¿™é‡Œï¼šåŠ å…¥äº† 'polaroidText' â–¼â–¼â–¼
          const independentItemIds = [
            'profileDot',
            'profileAvatar',
            'imagePlaceholder',
            'mainChatInput',
            'moodInput',
            'thoughtTextarea',
            'magicPromptInput',
            'imageDescriptionInput',
            'polaroidText' // <--- æ–°å¢è¿™ä¸€é¡¹
          ];
          
          const items = await db.userSettings.bulkGet(independentItemIds);

          items.forEach((item, index) => {
            if (item) {
              const elementId = independentItemIds[index];
              const element = document.getElementById(elementId);
              if (element) {
                if (['profileDot', 'profileAvatar', 'imagePlaceholder'].includes(elementId)) {
                  updateImageUI(element, item.value);
                } else if (element.tagName === 'INPUT' || element.tagName === 'TEXTAREA') {
                  //å¦‚æœæ˜¯è¾“å…¥æ¡†
                  element.value = item.value;
                } else {
                  //å¦‚æœæ˜¯ span (æ¯”å¦‚æ‹ç«‹å¾—æ–‡å­—)
                  element.textContent = item.value;
                }
              }
            }
          });
          // â–²â–²â–² ä¿®æ”¹ç»“æŸ â–²â–²â–²
          await loadApiPresets();
          const lastSelectedPresetName = localStorage.getItem('selectedApiPreset');
          if (lastSelectedPresetName && apiPresets[lastSelectedPresetName]) {
            currentApiConfig = apiPresets[lastSelectedPresetName];
            // å¡«å……UIï¼Œè®©ç”¨æˆ·çŸ¥é“å½“å‰ç”¨çš„æ˜¯å“ªä¸ªé…ç½®
            const preset = currentApiConfig;
            document.getElementById('apiUrlInput').value = preset.url;
            document.getElementById('apiKeyInput').value = preset.key;
            document.getElementById('presetNameInput').value = preset.name;
            document.getElementById('presetSelect').value = preset.name;
            // è§¦å‘ä¸€æ¬¡æ¨¡å‹æ‹‰å–
            document.getElementById('fetchModelsBtn').click();
          }
          setupEventListeners();
        }
        // --- QQ åº”ç”¨äº¤äº’é€»è¾‘ ---
        const qqAppIcon = document.querySelector('.app-container[data-app-id="app1"]');
        const contactItems = document.querySelectorAll('.contact-item');
        const chatBackButton = document.getElementById('chat-back-btn');
        const contactsBackButton = document.getElementById('contacts-back-btn');
        // 1. ç‚¹å‡»QQå›¾æ ‡ï¼Œæ‰“å¼€é€šè®¯å½•é¡µé¢
        if (qqAppIcon) {
          qqAppIcon.addEventListener('click', e => {
            e.preventDefault();
            phoneScreen.style.display = 'none'; // ä½¿ç”¨é¡¶å±‚è·å–çš„ phoneScreen
            qqContactsPage.classList.add('active');
          });
        }

        // 2. ç‚¹å‡»é€šè®¯å½•ä¸­çš„ä»»æ„ä¸€ä¸ªè”ç³»äººï¼Œè¿›å…¥èŠå¤©é¡µ
        contactItems.forEach(item => {
          item.addEventListener('click', () => {
            // ã€ä¿®æ”¹ã€‘
            currentChatId = item.dataset.charId; // è®¾ç½®å½“å‰èŠå¤©ID
            renderChatPage(currentChatId); // æ ¹æ®IDæ¸²æŸ“èŠå¤©é¡µé¢
            qqChatPage.classList.add('active');
          });
        });
        // 3. åœ¨èŠå¤©é¡µç‚¹å‡»è¿”å›ï¼Œå›åˆ°é€šè®¯å½•
        if (chatBackButton) {
          chatBackButton.addEventListener('click', () => {
            qqChatPage.classList.remove('active');
          });
        }

        // 4. åœ¨é€šè®¯å½•é¡µé¢ç‚¹å‡»è¿”å›ï¼Œå›åˆ°ä¸»å±å¹• (è¿™é‡Œçš„é€»è¾‘ç°åœ¨å¯ä»¥æ­£å¸¸å·¥ä½œäº†)
        if (contactsBackButton) {
          contactsBackButton.addEventListener('click', () => {
            qqContactsPage.classList.remove('active'); // ä¸å†æŠ¥é”™
            phoneScreen.style.display = 'flex'; // ä¸å†æŠ¥é”™
          });
        }

        // 4. (å ä½åŠŸèƒ½) ç‚¹å‡»å³ä¸Šè§’èœå•
        const qqMenuBtn = document.getElementById('qq-menu-btn');
        if (qqMenuBtn) {
          // â–¼â–¼â–¼ æ›¿æ¢æˆä¸‹é¢è¿™ä¸ªæ–°çš„ addEventListener â–¼â–¼â–¼
          qqMenuBtn.addEventListener('click', () => {
            const addCharModal = document.getElementById('addCharModal');
            // æ¯æ¬¡æ‰“å¼€æ—¶ï¼Œé‡ç½®è¡¨å•å†…å®¹å’Œé»˜è®¤å¤´åƒ
            document.getElementById('newCharAvatarPreview').src =
              'https://i.postimg.cc/h4yRTMGF/ed60bc4602ebd5cbc0d8961d6c4b4aac.jpg';
            document.getElementById('newCharRealName').value = '';
            document.getElementById('newCharNickname').value = '';
            document.getElementById('newCharPersona').value = '';
            showModal(addCharModal);
          });
          // â–²â–²â–² æ›¿æ¢å®Œæˆ â–²â–²â–²
        }

        // 6. (å ä½åŠŸèƒ½) ç‚¹å‡»èŠå¤©é¡µçš„å‘é€æŒ‰é’®
        const tempSendBtn = document.getElementById('chat-temp-send-btn');
        const apiSendBtn = document.getElementById('chat-api-send-btn');
        // â–¼â–¼â–¼ è¯·æ‰¾åˆ°å¹¶ç”¨ä¸‹é¢çš„ä»£ç å—æ›¿æ¢ä½ åŸæ¥çš„ 'chat-temp-send-btn' çš„äº‹ä»¶ç›‘å¬å™¨ â–¼â–¼â–¼

        if (tempSendBtn) {
          tempSendBtn.addEventListener('click', async () => {
            // <--- å¢åŠ äº† async
            const input = document.getElementById('chat-input-box');
            const textContent = input.value.trim();

            if (textContent) {
              // 1. åˆ›å»ºæ¶ˆæ¯å¯¹è±¡ï¼Œå¹¶æ ‡è®°ä¸ºæš‚å­˜
              const message = {
                role: 'user',
                content: textContent,
                isStaging: true, // æ ¸å¿ƒæ ‡è®°
              };

              // 2. æ·»åŠ åˆ°å†å²è®°å½•
              chatData[currentChatId].history.push(message);

              // 3. ã€ã€ã€æ–°å¢ã€‘ã€‘ã€‘ä¿å­˜åˆ°æ•°æ®åº“
              await saveChatData();

              // 4. é‡æ–°æ¸²æŸ“ç•Œé¢
              renderChatMessages(currentChatId);

              // 5. æ¸…ç©ºè¾“å…¥æ¡†
              input.value = '';
            }
          });
        }

        // è¿™æ˜¯ä¸€ä¸ªä½ åº”è¯¥åœ¨è°ƒç”¨APIä¹‹å‰è¿è¡Œçš„è¾…åŠ©å‡½æ•°ç¤ºä¾‹
        function prepareMessagesForApi(messages) {
          return messages.map(msg => {
            const newMsg = { ...msg }; // åˆ›å»ºä¸€ä¸ªå‰¯æœ¬ï¼Œé¿å…ä¿®æ”¹åŸå§‹history

            // å¦‚æœæ˜¯çœŸå®å›¾ç‰‡æ¶ˆæ¯
            if (newMsg.base64) {
              // è½¬æ¢æˆå¤šæ¨¡æ€APIéœ€è¦çš„æ ¼å¼ï¼Œä¾‹å¦‚
              newMsg.content = [
                { type: 'text', text: 'è¿™æ˜¯ç”¨æˆ·å‘çš„å›¾ç‰‡ã€‚' },
                { type: 'image_url', image_url: { url: newMsg.base64 } },
              ];
              delete newMsg.base64; // æ¸…ç†æ‰ä¸´æ—¶æ•°æ®
            }
            // å¦‚æœæ˜¯æ–‡å­—å›¾æ¶ˆæ¯
            else if (newMsg.content.startsWith('[text_image')) {
              const match = newMsg.content.match(/\[text_image description="([^"]+)"]/);
              if (match) {
                // å°†å…¶è½¬æ¢ä¸ºçº¯æ–‡æœ¬æè¿°
                newMsg.content = `[ç”¨æˆ·å‘é€äº†ä¸€å¼ å›¾ç‰‡ï¼Œæè¿°ä¸ºï¼š${match[1]}]`;
              }
            }
            // å¦‚æœæ˜¯è¡¨æƒ…åŒ…æ¶ˆæ¯
            else if (newMsg.content.startsWith('[sticker]')) {
              // å°†å…¶è½¬æ¢ä¸ºçº¯æ–‡æœ¬æè¿°
              newMsg.content = `[ç”¨æˆ·å‘é€äº†ä¸€ä¸ªè¡¨æƒ…]`;
            }

            // åˆ é™¤isStagingï¼Œå³ä½¿å®ƒå·²ç»è¢«åˆ äº†ï¼Œå†ç¡®è®¤ä¸€æ¬¡
            delete newMsg.isStaging;

            return newMsg;
          });
        }

        // â–¼â–¼â–¼ ç”¨è¿™ä¸ªã€æœ€ç»ˆç‰ˆæœ¬ã€‘æ›¿æ¢ 'chat-api-send-btn' çš„ç‚¹å‡»äº‹ä»¶ç›‘å¬å™¨ â–¼â–¼â–¼
        if (apiSendBtn) {
          // ã€é‡è¦ã€‘å°†äº‹ä»¶ç›‘å¬å™¨æ”¹ä¸ºå¼‚æ­¥å‡½æ•°
          apiSendBtn.addEventListener('click', async () => {
            const input = document.getElementById('chat-input-box');
            const textContent = input.value.trim();
            const history = chatData[currentChatId].history;

            // 1. æŸ¥æ‰¾æ‰€æœ‰å¾…å‘é€(isStaging)çš„æ¶ˆæ¯
            const stagedMessages = history.filter(msg => msg.isStaging);

            // å¦‚æœè¾“å…¥æ¡†æ²¡å†…å®¹ï¼Œä¸”æ²¡æœ‰å¾…å‘é€çš„æ¶ˆæ¯ï¼Œåˆ™ä¸æ‰§è¡Œä»»ä½•æ“ä½œ
            if (!textContent && stagedMessages.length === 0) {
              return;
            }

            // 2. å¦‚æœè¾“å…¥æ¡†æœ‰æ–‡æœ¬ï¼Œåˆ›å»ºä¸€ä¸ªæ–°çš„æ–‡æœ¬æ¶ˆæ¯å¯¹è±¡å¹¶åŠ å…¥å†å²è®°å½•
            if (textContent) {
              const textMessage = {
                role: 'user',
                content: textContent,
              };
              history.push(textMessage);
              input.value = ''; // æ¸…ç©ºè¾“å…¥æ¡†
            }

            // 3. å°†æ‰€æœ‰å¾…å‘é€æ¶ˆæ¯çš„ isStaging æ ‡è®°ç§»é™¤ï¼Œå˜ä¸ºæ­£å¼æ¶ˆæ¯
            stagedMessages.forEach(msg => {
              delete msg.isStaging;
            });

            // ã€é‡è¦ã€‘åœ¨è°ƒç”¨APIå‰ï¼Œç«‹å³ä¿å­˜ä¸€æ¬¡èŠå¤©è®°å½•å¹¶åˆ·æ–°UI
            // è¿™æ ·ç”¨æˆ·çš„æ¶ˆæ¯ä¼šç«‹åˆ»æ˜¾ç¤ºå‡ºæ¥ï¼Œè€Œä¸æ˜¯ç­‰AIå›å¤åæ‰æ˜¾ç¤º
            await saveChatData();
            renderChatMessages(currentChatId);

            // 4. è°ƒç”¨æˆ‘ä»¬å³å°†åˆ›å»ºçš„æ ¸å¿ƒå‡½æ•°æ¥å¤„ç†AIå›å¤
            await triggerAiResponse(currentChatId);
          });
        }
        // ã€æ–°å¢ã€‘ç›‘å¬èŠå¤©è¾“å…¥æ¡†çš„å›è½¦äº‹ä»¶ï¼Œç”¨äºæš‚å­˜
        const chatInput = document.getElementById('chat-input-box');
        if (chatInput) {
          chatInput.addEventListener('keydown', event => {
            // æ£€æŸ¥æ˜¯å¦æŒ‰ä¸‹äº† Enter é”®ï¼Œå¹¶ä¸”æ²¡æœ‰åŒæ—¶æŒ‰ Shift é”® (å…è®¸æ¢è¡Œ)
            if (event.key === 'Enter' && !event.shiftKey) {
              // é˜»æ­¢ Enter é”®çš„é»˜è®¤è¡Œä¸º (ä¾‹å¦‚æ¢è¡Œæˆ–æäº¤è¡¨å•)
              event.preventDefault();
              // æ¨¡æ‹Ÿç‚¹å‡»â€œæš‚å­˜â€æŒ‰é’®
              document.getElementById('chat-temp-send-btn').click();
            }
          });
        }

        // åœ¨ setupEventListeners() å‡½æ•°çš„æœ«å°¾æ·»åŠ 

        // --- QQèŠå¤©è®¾ç½®é¢æ¿äº‹ä»¶ ---
        const charSettingsModal = document.getElementById('charSettingsModal');
        const userSettingsModal = document.getElementById('userSettingsModal');
        // â–¼â–¼â–¼ ç”¨è¿™ä¸ªã€æœ€ç»ˆä¿®æ­£ç‰ˆã€‘æ›¿æ¢ 'chat-char-avatar' çš„ç‚¹å‡»äº‹ä»¶ç›‘å¬å™¨ â–¼â–¼â–¼
        document.getElementById('chat-char-avatar').addEventListener('click', () => {
          if (!currentChatId || !chatData[currentChatId]) return;
          const settings = chatData[currentChatId].charSettings;

          // 1. å¡«å……æ‰€æœ‰è¡¨å•æ•°æ®
          document.getElementById('charSettingsAvatarPreview').src = settings.avatar;
          document.getElementById('charRealName').value = settings.realName;
          document.getElementById('charNickname').value = settings.nickname;
          document.getElementById('charGender').value = settings.gender;
          document.getElementById('charPersona').value = settings.persona;
          document.getElementById('charMaxMemory').value = settings.maxMemory;
          updateWorldBookDisplay(settings.worldBook);
          document.getElementById('charMinReply').value = settings.minReplyMessages || 1;
          document.getElementById('charMaxReply').value = settings.maxReplyMessages || 2;
          document.getElementById('charVideoCallImagePreview').src = settings.videoCallImage || '';

          // â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼ æ ¸å¿ƒä¿®å¤ç‚¹ï¼šå¢åŠ é»˜è®¤å€¼ä¿æŠ¤ â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼
          const work = settings.work || { profession: '', schedule: '' };
          // è¿™é‡Œç¡®ä¿ wallet å­˜åœ¨ï¼Œå¹¶ä¸” balance æ˜¯æ•°å­—
          const wallet = settings.wallet || {};
          const currentBalance = Number(wallet.balance) || 0;
          // â–²â–²â–²â–²â–²â–²â–²â–² ä¿®å¤ç»“æŸ â–²â–²â–²â–²â–²â–²â–²â–²

          document.getElementById('charProfession').value = work.profession || '';
          document.getElementById('charWorkSchedule').value = work.schedule || '';
          document.getElementById('charInitialBalanceRange').value = wallet.initialRange || '';

          // â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼ ä½¿ç”¨å¤„ç†è¿‡çš„ currentBalanceï¼Œç¡®ä¿ toFixed ä¸ä¼šæŠ¥é”™ â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼
          document.getElementById('charCurrentBalance').value = `Â¥ ${currentBalance.toFixed(2)}`;
          // â–²â–²â–²â–²â–²â–²â–²â–² ä¿®æ”¹ç»“æŸ â–²â–²â–²â–²â–²â–²â–²â–²

          // å¡«å……åˆ†ç»„è¾“å…¥æ¡†
          const charGroupInput = document.getElementById('charGroup');
          charGroupInput.value = settings.group || '';

          // 2. åŠ¨æ€å¡«å……datalistï¼ˆåˆ†ç»„å»ºè®®åˆ—è¡¨ï¼‰
          const datalist = document.getElementById('group-list');
          datalist.innerHTML = '';
          // ä½¿ç”¨ Object.keys(groupSettings) æ¥è·å–æ‰€æœ‰å·²å­˜åœ¨çš„åˆ†ç»„å
          Object.keys(groupSettings).forEach(groupName => {
            if (groupName) {
              // ç¡®ä¿ä¸æ·»åŠ ç©ºçš„åˆ†ç»„å
              const option = document.createElement('option');
              option.value = groupName;
              datalist.appendChild(option);
            }
          });

          // 3. æ˜¾ç¤ºå¼¹çª—
          showModal(charSettingsModal);
        });

        // ç‚¹å‡» User å¤´åƒï¼Œæ‰“å¼€ User è®¾ç½®
        // ç‚¹å‡» User å¤´åƒï¼Œæ‰“å¼€ User è®¾ç½®
        document.getElementById('chat-user-avatar').addEventListener('click', () => {
          if (!currentChatId || !chatData[currentChatId]) return;
          const settings = chatData[currentChatId].userSettings;

          // ã€æ–°å¢ã€‘å¡«å……å¤´åƒé¢„è§ˆ
          document.getElementById('userSettingsAvatarPreview').src = settings.avatar;

          document.getElementById('userName').value = settings.name;
          document.getElementById('userRelationToChar').value = settings.relationToChar || '';
          document.getElementById('userGender').value = settings.gender;
          document.getElementById('userPersona').value = settings.persona;
          document.getElementById('userVideoCallImagePreview').src = settings.videoCallImage || '';
          const work = settings.work || { profession: '' };
          const wallet = settings.wallet || { balance: 0, dailySalary: 0, initialBalance: 0 };

          document.getElementById('userProfession').value = work.profession || '';
          document.getElementById('userDailySalary').value = wallet.dailySalary || 0;
          document.getElementById('userInitialBalance').value = wallet.initialBalance || 0;
          document.getElementById('userCurrentBalance').value = `Â¥ ${wallet.balance.toFixed(2)}`;
          showModal(userSettingsModal);
          renderUserProfilePresets();
        });

        // â–¼â–¼â–¼ ç”¨è¿™ä¸ªæ–°ç‰ˆæœ¬æ›¿æ¢æ—§çš„ 'saveCharSettingsBtn' ç‚¹å‡»äº‹ä»¶ç›‘å¬å™¨ â–¼â–¼â–¼
        document.getElementById('saveCharSettingsBtn').addEventListener('click', () => {
          if (!currentChatId) return;
          const settings = chatData[currentChatId].charSettings;

          settings.avatar = document.getElementById('charSettingsAvatarPreview').src;
          settings.realName = document.getElementById('charRealName').value;
          settings.nickname = document.getElementById('charNickname').value;
          settings.gender = document.getElementById('charGender').value;
          settings.persona = document.getElementById('charPersona').value;
          settings.maxMemory = document.getElementById('charMaxMemory').value;
          settings.minReplyMessages = parseInt(document.getElementById('charMinReply').value, 10) || 1;
          settings.maxReplyMessages = parseInt(document.getElementById('charMaxReply').value, 10) || 2;
          settings.videoCallImage = document.getElementById('charVideoCallImagePreview').src;
          if (!settings.work) settings.work = {};
          if (!settings.wallet) settings.wallet = {};

          settings.work.profession = document.getElementById('charProfession').value.trim();
          settings.work.schedule = document.getElementById('charWorkSchedule').value.trim();
          settings.wallet.initialRange = document.getElementById('charInitialBalanceRange').value.trim();

          const groupName = document.getElementById('charGroup').value.trim();
          settings.group = groupName; // å°†åˆ†ç»„åèµ‹ç»™å½“å‰è§’è‰²

          // å¦‚æœç”¨æˆ·è¾“å…¥äº†ä¸€ä¸ªå…¨æ–°çš„åˆ†ç»„åï¼Œåˆ™åœ¨ groupSettings ä¸­åˆå§‹åŒ–å®ƒ
          if (groupName && !groupSettings[groupName]) {
            groupSettings[groupName] = { expanded: true, pinned: false };
          }

          // ä¿å­˜æ‰€æœ‰æ•°æ®
          saveChatData();
          saveGroupSettings();

          // é‡æ–°æ¸²æŸ“UI
          renderChatPage(currentChatId);
          renderContactsList();
          hideModal(charSettingsModal);
        });

        document.getElementById('cancelCharSettingsBtn').addEventListener('click', () => hideModal(charSettingsModal));

        // User è®¾ç½®é¢æ¿çš„æŒ‰é’®äº‹ä»¶
        // User è®¾ç½®é¢æ¿çš„æŒ‰é’®äº‹ä»¶
        document.getElementById('saveUserSettingsBtn').addEventListener('click', () => {
          if (!currentChatId) return;
          const settings = chatData[currentChatId].userSettings;

          // ã€æ–°å¢ã€‘ä¿å­˜æ–°å¤´åƒçš„URL
          settings.avatar = document.getElementById('userSettingsAvatarPreview').src;

          settings.name = document.getElementById('userName').value;
          settings.relationToChar = document.getElementById('userRelationToChar').value;
          settings.gender = document.getElementById('userGender').value;
          settings.persona = document.getElementById('userPersona').value;
          settings.videoCallImage = document.getElementById('userVideoCallImagePreview').src;
          if (!settings.work) settings.work = {};
          if (!settings.wallet) settings.wallet = {};

          settings.work.profession = document.getElementById('userProfession').value.trim();
          settings.wallet.dailySalary = parseFloat(document.getElementById('userDailySalary').value) || 0;
          settings.wallet.initialBalance = parseFloat(document.getElementById('userInitialBalance').value) || 0;
          saveChatData(); // ä¿å­˜
          renderChatPage(currentChatId); // é‡æ–°æ¸²æŸ“
          hideModal(userSettingsModal);
        });

        document.getElementById('cancelUserSettingsBtn').addEventListener('click', () => hideModal(userSettingsModal));

        // æ›´æ¢è§’è‰²å¤´åƒçš„ç‰¹æ®Šå¤„ç†
        document.getElementById('changeCharAvatarBtn').addEventListener('click', () => {
          // å€Ÿç”¨ç°æœ‰çš„å›¾ç‰‡ä¸Šä¼ é€»è¾‘
          currentEditingTarget = { type: 'charAvatarInSettings' };
          showModal(imageChoiceModal);
        });
        // ã€æ–°å¢ã€‘ä¸ºâ€œæˆ‘çš„ä¿¡æ¯â€é‡Œçš„æ›´æ¢å¤´åƒæŒ‰é’®æ·»åŠ äº‹ä»¶
        document.getElementById('changeUserAvatarBtn').addEventListener('click', () => {
          // å€Ÿç”¨ç°æœ‰çš„å›¾ç‰‡ä¸Šä¼ é€»è¾‘ï¼Œå®šä¹‰ä¸€ä¸ªæ–°ç±»å‹
          currentEditingTarget = { type: 'userAvatarInSettings' };
          showModal(imageChoiceModal);
        });
        // ================== ç”¨æˆ·è¡¨æƒ…åŒ…ç®¡ç†ä¸åˆ†ç±»äº‹ä»¶ (ä¿®æ­£ç‰ˆ) ==================

        // --- â€œæ‰¹é‡æ·»åŠ â€æŒ‰é’® ---
        document.getElementById('user-sticker-bulk-add-btn').addEventListener('click', () => {
          // è¿™ä¸ªé€»è¾‘å’Œè§’è‰²çš„æ‰¹é‡æ·»åŠ å®Œå…¨ä¸€æ ·ï¼Œæ‰€ä»¥æˆ‘ä»¬ç›´æ¥è°ƒç”¨ openAddStickersModal
          // åªéœ€è¦ç¡®ä¿ä¸Šä¸‹æ–‡æ˜¯ 'user' å³å¯
          currentStickerContext = 'user';
          const addStickersModal = document.getElementById('addStickersModal');
          document.getElementById('addStickersTitle').textContent = 'æ·»åŠ æˆ‘çš„è¡¨æƒ…';
          document.getElementById('stickerBulkAddArea').value = '';
          showModal(addStickersModal);
        });

        // --- â€œç®¡ç†â€æŒ‰é’®ï¼Œè¿›å…¥ç®¡ç†æ¨¡å¼ ---
        document.getElementById('manage-user-stickers-btn').addEventListener('click', () => {
          isUserStickerManageMode = true;
          renderUserStickers(); // é‡æ–°æ¸²æŸ“ä»¥æ˜¾ç¤ºç®¡ç†æŒ‰é’®å’Œæ ·å¼
        });

        // --- â€œå–æ¶ˆâ€æŒ‰é’®ï¼Œé€€å‡ºç®¡ç†æ¨¡å¼ ---
        document.getElementById('user-sticker-cancel-manage-btn').addEventListener('click', () => {
          isUserStickerManageMode = false;
          // æ¸…é™¤æ‰€æœ‰é€‰ä¸­çŠ¶æ€
          document
            .querySelectorAll('#user-sticker-grid .sticker-item.selected')
            .forEach(el => el.classList.remove('selected'));
          renderUserStickers(); // é‡æ–°æ¸²æŸ“ä»¥é€€å‡ºç®¡ç†æ¨¡å¼
        });

        // --- ç‚¹å‡»åˆ†ç±» Tab (åŒ…å«åˆ é™¤é€»è¾‘) ---
        document.getElementById('user-sticker-category-tabs').addEventListener('click', e => {
          const deleteBtn = e.target.closest('.delete-category-btn');
          const tab = e.target.closest('.sticker-category-tab');

          if (deleteBtn) {
            // å¦‚æœç‚¹å‡»çš„æ˜¯åˆ é™¤æŒ‰é’®
            e.stopPropagation(); // é˜²æ­¢è§¦å‘ tab çš„åˆ‡æ¢äº‹ä»¶
            categoryToDelete = deleteBtn.dataset.categoryName;
            if (categoryToDelete) {
              document.getElementById('deleteCategoryConfirmTitle').textContent = `ç¡®è®¤åˆ é™¤åˆ†ç±» "${categoryToDelete}"`;
              showModal(document.getElementById('deleteCategoryConfirmModal'));
            }
          } else if (tab) {
            // å¦‚æœç‚¹å‡»çš„æ˜¯ Tab æœ¬èº«
            activeUserStickerCategory = tab.dataset.categoryName;
            renderUserStickers(); // åˆ‡æ¢åˆ†ç±»åé‡æ–°æ¸²æŸ“
          }
        });
        // --- åˆ é™¤åˆ†ç±»ç¡®è®¤å¼¹çª—çš„äº‹ä»¶ç›‘å¬ (å…¨æ–°) ---
        document.getElementById('deleteCategoryOnlyBtn').addEventListener('click', async () => {
          if (!categoryToDelete) return;

          // 1. å°†è¯¥åˆ†ç±»ä¸‹æ‰€æœ‰è¡¨æƒ…çš„ category å­—æ®µæ›´æ–°ä¸º null
          await db.userStickers.where('category').equals(categoryToDelete).modify({ category: null });

          // 2. é‡æ–°åŠ è½½æ•°æ®
          await loadUserStickers();

          // 3. å°†å½“å‰æ¿€æ´»çš„åˆ†ç±»è®¾ä¸ºâ€œæœªåˆ†ç±»â€
          activeUserStickerCategory = 'æœªåˆ†ç±»';

          // 4. æ¸…ç†çŠ¶æ€å¹¶æ›´æ–°UI
          categoryToDelete = null;
          hideModal(document.getElementById('deleteCategoryConfirmModal'));
          renderUserStickers();
        });

        document.getElementById('deleteCategoryAndStickersBtn').addEventListener('click', async () => {
          if (!categoryToDelete) return;

          // 1. æ‰¾åˆ°è¯¥åˆ†ç±»ä¸‹æ‰€æœ‰è¡¨æƒ…çš„ ID
          const stickersToDelete = await db.userStickers.where('category').equals(categoryToDelete).toArray();
          const idsToDelete = stickersToDelete.map(s => s.id);

          // 2. æ‰¹é‡åˆ é™¤è¿™äº›è¡¨æƒ…
          await db.userStickers.bulkDelete(idsToDelete);

          // 3. é‡æ–°åŠ è½½æ•°æ®
          await loadUserStickers();

          // 4. å°†å½“å‰æ¿€æ´»çš„åˆ†ç±»è®¾ä¸ºâ€œæœªåˆ†ç±»â€
          activeUserStickerCategory = 'æœªåˆ†ç±»';

          // 5. æ¸…ç†çŠ¶æ€å¹¶æ›´æ–°UI
          categoryToDelete = null;
          hideModal(document.getElementById('deleteCategoryConfirmModal'));
          renderUserStickers();
        });

        document.getElementById('cancelDeleteCategoryBtn').addEventListener('click', () => {
          categoryToDelete = null;
          hideModal(document.getElementById('deleteCategoryConfirmModal'));
        });

        // --- è¡¨æƒ…ç½‘æ ¼ç‚¹å‡»äº‹ä»¶ (å‘é€ æˆ– é€‰æ‹©) ---
        document.getElementById('user-sticker-grid').addEventListener('click', e => {
          const stickerItem = e.target.closest('.user-sticker-item');
          if (!stickerItem) return;

          if (isUserStickerManageMode) {
            // ç®¡ç†æ¨¡å¼ä¸‹ï¼šåˆ‡æ¢é€‰ä¸­çŠ¶æ€
            stickerItem.classList.toggle('selected');
          } else {
            // æ™®é€šæ¨¡å¼ä¸‹ï¼šå‘é€è¡¨æƒ…
            const originalIndex = parseInt(stickerItem.dataset.originalIndex, 10);
            sendUserSticker(originalIndex);
          }
        });

        // --- æ‰¹é‡åˆ é™¤æŒ‰é’® ---
        document.getElementById('user-sticker-delete-btn').addEventListener('click', async () => {
          const selectedItems = document.querySelectorAll('#user-sticker-grid .sticker-item.selected');
          if (selectedItems.length === 0) {
            alert('è¯·å…ˆé€‰æ‹©è¦åˆ é™¤çš„è¡¨æƒ…ï¼');
            return;
          }
          if (confirm(`ç¡®å®šè¦åˆ é™¤é€‰ä¸­çš„ ${selectedItems.length} ä¸ªè¡¨æƒ…å—ï¼Ÿ`)) {
            const idsToDelete = Array.from(selectedItems).map(item => parseInt(item.dataset.id, 10));
            await db.userStickers.bulkDelete(idsToDelete);
            await loadUserStickers(); // é‡æ–°åŠ è½½
            renderUserStickers(); // é‡æ–°æ¸²æŸ“
          }
        });

        // --- æ‰¹é‡åˆ†ç±»æŒ‰é’® ---
        document.getElementById('user-sticker-classify-btn').addEventListener('click', () => {
          const selectedItems = document.querySelectorAll('#user-sticker-grid .sticker-item.selected');
          if (selectedItems.length === 0) {
            alert('è¯·å…ˆé€‰æ‹©è¦åˆ†ç±»çš„è¡¨æƒ…ï¼');
            return;
          }

          const categoryList = document.getElementById('existing-categories-list');
          const categories = new Set(userStickers.map(s => s.category).filter(Boolean));

          categoryList.innerHTML = '<label>é€‰æ‹©å·²æœ‰åˆ†ç±»</label>';
          if (categories.size === 0) {
            categoryList.innerHTML += '<p style="font-size:12px; color: var(--text-secondary-color);">æš‚æ— åˆ†ç±»</p>';
          } else {
            // æ·»åŠ ä¸€ä¸ªâ€œæœªåˆ†ç±»â€çš„é€‰é¡¹
            categoryList.innerHTML += `
                    <label class="category-radio-item">
                        <input type="radio" name="sticker_category" value="æœªåˆ†ç±»"> æœªåˆ†ç±»
                    </label>`;
            categories.forEach(cat => {
              if (cat !== 'æœªåˆ†ç±»') {
                // é¿å…é‡å¤æ·»åŠ 
                categoryList.innerHTML += `
                        <label class="category-radio-item">
                            <input type="radio" name="sticker_category" value="${cat}"> ${cat}
                        </label>`;
              }
            });
          }

          document.getElementById('newStickerCategoryName').value = '';
          showModal(document.getElementById('stickerCategoryModal'));
        });

        // --- åˆ†ç±»å¼¹çª—çš„ "ç¡®å®š" æŒ‰é’® ---
        document.getElementById('confirmCategoryBtn').addEventListener('click', async () => {
          let targetCategory = document.getElementById('newStickerCategoryName').value.trim();
          if (!targetCategory) {
            const selectedRadio = document.querySelector('input[name="sticker_category"]:checked');
            if (selectedRadio) {
              targetCategory = selectedRadio.value;
            }
          }

          if (!targetCategory) {
            alert('è¯·é€‰æ‹©ä¸€ä¸ªå·²æœ‰åˆ†ç±»æˆ–è¾“å…¥ä¸€ä¸ªæ–°çš„åˆ†ç±»åï¼');
            return;
          }

          // å¦‚æœç”¨æˆ·é€‰æ‹©â€œæœªåˆ†ç±»â€ï¼Œåœ¨æ•°æ®åº“ä¸­æˆ‘ä»¬å°†å…¶å­˜ä¸º null æˆ– undefined ä¼šæ›´å¥½
          const finalCategory = targetCategory === 'æœªåˆ†ç±»' ? null : targetCategory;

          const selectedItems = document.querySelectorAll('#user-sticker-grid .sticker-item.selected');
          const idsToUpdate = Array.from(selectedItems).map(item => parseInt(item.dataset.id, 10));

          await db.userStickers.where('id').anyOf(idsToUpdate).modify({ category: finalCategory });

          hideModal(document.getElementById('stickerCategoryModal'));
          await loadUserStickers();
          activeUserStickerCategory = targetCategory; // ç§»åŠ¨åè‡ªåŠ¨åˆ‡æ¢åˆ°æ–°åˆ†ç±»
          renderUserStickers();
        });

        // --- åˆ†ç±»å¼¹çª—çš„ "å–æ¶ˆ" æŒ‰é’® ---
        document.getElementById('cancelCategoryBtn').addEventListener('click', () => {
          hideModal(document.getElementById('stickerCategoryModal'));
        });
        // --- åˆ†ç±»å¼¹çª—çš„ "å–æ¶ˆ" æŒ‰é’® ---ï¼ˆè¿™æ˜¯ä¸Šé¢çš„ä»£ç ï¼‰
        document.getElementById('cancelCategoryBtn').addEventListener('click', () => {
          hideModal(document.getElementById('stickerCategoryModal'));
        });

        // â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼ æŠŠæ–°ä»£ç ç²˜è´´åœ¨è¿™é‡Œ (å¼€å§‹) â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼
        
        // ================== ä¸­é—´å›¾æ ‡ä¸æ°”æ³¡è®¾ç½®é€»è¾‘ (å¯çˆ±åœ†æ¶¦ç‰ˆ) ==================
        
        // 1. å®šä¹‰å‡ºå‚é»˜è®¤é…ç½®
        const DEFAULT_THEME = {
            charBg: '#c1d0dc', charText: '#000000',
            userBg: '#f7e8e9', userText: '#000000',
            bottomBarBg: '#ffffff',
            inputBoxBg: '#e6e6e6', inputBoxText: '#363636',
            plusBtnBg: '#e6e6e6', plusBtnIcon: '#000000',
            
            sendBtnBg: '#ebdbdb',    // æŒ‰é’®èƒŒæ™¯è‰²
            sendBtnText: '#ffffff',  // æŒ‰é’®æ–‡å­—è‰²
            
            isRoundBtn: false, 
            stashIcon: 'https://cdn-icons-png.flaticon.com/512/25/25667.png',
            sendIcon: 'https://cdn-icons-png.flaticon.com/512/60/60525.png'
        };

        // 2. æ ¸å¿ƒåº”ç”¨å‡½æ•°
        window.applyGlobalBubbleColors = function(s) {
            if (!s) s = DEFAULT_THEME;

            const styleId = 'simple-bubble-style-override';
            let styleTag = document.getElementById(styleId);
            if (styleTag) styleTag.remove();
            
            // èŠå¤©æ æŒ‰é’®å½¢çŠ¶ï¼šåœ†æ¨¡å¼åˆ™50%(æ­£åœ†)ï¼Œå¦åˆ™4px(å¾®åœ†è§’)
            const chatBtnRadius = s.isRoundBtn ? '50%' : '4px';
            
            styleTag = document.createElement('style');
            styleTag.id = styleId;
            styleTag.innerHTML = `
                /* --- æ°”æ³¡æ ·å¼ --- */
                #qq-chat-page .char-message .message-content { background-color: ${s.charBg} !important; color: ${s.charText} !important; }
                #qq-chat-page .user-message .message-content { background-color: ${s.userBg} !important; color: ${s.userText} !important; }
                .voice-waveform span { background-color: currentColor !important; }
                
                /* --- åº•éƒ¨åº•æ èƒŒæ™¯ & è¾“å…¥æ¡† --- */
                .chat-input-area { background-color: ${s.bottomBarBg} !important; }
                #chat-input-box { background-color: ${s.inputBoxBg} !important; color: ${s.inputBoxText} !important; }
                #chat-input-box::placeholder { color: ${s.inputBoxText} !important; opacity: 0.5; }
                
                /* --- å·¦ä¾§åŠ å· --- */
                .chat-tool-btn { background-color: ${s.plusBtnBg} !important; color: ${s.plusBtnIcon} !important; border: none !important; }

                /* --- 1. èŠå¤©åº•æ çš„æŒ‰é’® (å—å¼€å…³æ§åˆ¶ï¼šæ–¹/åœ†) --- */
                .chat-input-area .chat-send-btn {
                    background-color: ${s.sendBtnBg} !important; 
                    color: ${s.sendBtnText} !important;
                    border-radius: ${chatBtnRadius} !important;
                    transition: all 0.2s;
                }
                
                /* --- 2. å¼¹çª—é‡Œçš„ä¿å­˜æŒ‰é’® (å¼ºåˆ¶å˜æˆå¯çˆ±çš„åœ†æ¶¦èƒ¶å›Š) --- */
                #middleSettingsModal .chat-send-btn {
                    background-color: ${s.sendBtnBg} !important; 
                    color: ${s.sendBtnText} !important;
                    border-radius: 50px !important; /* è¿™é‡Œæ”¹æˆ50pxï¼Œè¶…çº§åœ†æ¶¦ */
                    width: auto !important;
                    height: auto !important;
                    padding: 8px 20px !important; /* åŠ å¤§ä¸€ç‚¹å†…è¾¹è·ï¼Œæ›´å¥½çœ‹ */
                    box-shadow: 0 2px 5px rgba(0,0,0,0.1); /* åŠ ä¸€ç‚¹ç‚¹é˜´å½±å¢åŠ ç«‹ä½“æ„Ÿ */
                }
                
                /* --- åœ†å½¢æ¨¡å¼ä¸‹ï¼Œä»…è°ƒæ•´åº•æ æŒ‰é’®å¸ƒå±€ --- */
                ${s.isRoundBtn ? `
                    .chat-input-area .chat-send-btn {
                        width: 40px !important;
                        height: 40px !important;
                        padding: 0 !important;
                        display: flex !important;
                        align-items: center !important;
                        justify-content: center !important;
                        min-width: 40px !important; 
                        overflow: hidden;
                    }
                    .chat-buttons-container { gap: 8px !important; } 
                ` : ''}
            `;
            document.head.appendChild(styleTag);

            // B. å¤„ç†å†…å®¹ï¼šä»…å¤„ç†èŠå¤©æ çš„æŒ‰é’®ï¼ŒæŠŠå®ƒä»¬å˜å›¾ç‰‡
            const btns = document.querySelectorAll('.chat-input-area .chat-send-btn');
            
            btns.forEach(btn => {
                // å®‰å…¨æ£€æŸ¥ï¼šå¦‚æœè¿™ä¸ªæŒ‰é’®ä¸å°å¿ƒåœ¨å¼¹çª—é‡Œï¼Œå¿½ç•¥å®ƒ
                if (btn.closest('.modal-content')) return;

                const text = btn.innerText.trim();
                if(text === 'æš‚å­˜') btn.dataset.type = 'stash';
                if(text === 'å‘é€') btn.dataset.type = 'send';

                if (s.isRoundBtn) {
                    // å˜æˆå›¾ç‰‡
                    let iconUrl = '';
                    if (btn.dataset.type === 'stash') iconUrl = s.stashIcon || DEFAULT_THEME.stashIcon;
                    if (btn.dataset.type === 'send') iconUrl = s.sendIcon || DEFAULT_THEME.sendIcon;
                    
                    if (iconUrl) {
                        btn.innerHTML = `<img src="${iconUrl}" style="width: 20px; height: 20px; object-fit: contain; pointer-events: none;">`;
                    }
                } else {
                    // å˜å›æ–‡å­—
                    if (btn.dataset.type === 'stash') btn.innerText = 'æš‚å­˜';
                    if (btn.dataset.type === 'send') btn.innerText = 'å‘é€';
                }
            });
        };

        // 3. åˆå§‹åŒ–
        (async function initTheme() {
            try {
                const saved = await db.userSettings.get('simpleBubbleSettings');
                applyGlobalBubbleColors(saved && saved.value ? saved.value : DEFAULT_THEME);
            } catch (e) { applyGlobalBubbleColors(DEFAULT_THEME); }
        })();

        // ================== å¼¹çª—äº¤äº’é€»è¾‘ ==================
        const middleSettingsModal = document.getElementById('middleSettingsModal');
        const middleIconImg = document.getElementById('chat-middle-icon');

        if (middleIconImg) {
            middleIconImg.addEventListener('click', async () => {
                const currentIcon = middleIconImg.src;
                const previewEl = document.getElementById('middleIconPreview');
                if(previewEl) previewEl.src = currentIcon;

                let s = (await db.userSettings.get('simpleBubbleSettings'))?.value;
                if (!s) s = DEFAULT_THEME; 
                
                const setVal = (id, val) => {
                    const el = document.getElementById(id);
                    const hex = document.getElementById(id + 'Hex');
                    const safeVal = val || '#ffffff';
                    if(el) el.value = safeVal;
                    if(hex) hex.value = safeVal;
                };

                setVal('charBubbleBgColor', s.charBg); setVal('charBubbleTextColor', s.charText);
                setVal('userBubbleBgColor', s.userBg); setVal('userBubbleTextColor', s.userText);
                setVal('bottomBarBgColor', s.bottomBarBg);
                setVal('inputBoxBgColor', s.inputBoxBg); setVal('inputBoxTextColor', s.inputBoxText);
                setVal('plusBtnBgColor', s.plusBtnBg); setVal('plusBtnIconColor', s.plusBtnIcon);
                setVal('sendBtnBgColor', s.sendBtnBg); setVal('sendBtnTextColor', s.sendBtnText);

                const isRoundCheck = document.getElementById('useRoundBtnMode');
                if(isRoundCheck) isRoundCheck.checked = !!s.isRoundBtn;
                document.getElementById('stashIconPreview').src = s.stashIcon || DEFAULT_THEME.stashIcon;
                document.getElementById('sendIconPreview').src = s.sendIcon || DEFAULT_THEME.sendIcon;

                showModal(middleSettingsModal);
            });
        }

        const changeMiddleBtn = document.getElementById('changeMiddleIconBtn');
        const changeStashBtn = document.getElementById('changeStashIconBtn');
        const changeSendBtn = document.getElementById('changeSendIconBtn');

        if (changeMiddleBtn) {
            changeMiddleBtn.addEventListener('click', () => {
                currentEditingTarget = { type: 'middleIconPreview' };
                showModal(document.getElementById('imageChoiceModal'));
            });
        }
        if (changeStashBtn) {
            changeStashBtn.addEventListener('click', () => {
                currentEditingTarget = { type: 'stashIconPreview' };
                showModal(document.getElementById('imageChoiceModal'));
            });
        }
        if (changeSendBtn) {
            changeSendBtn.addEventListener('click', () => {
                currentEditingTarget = { type: 'sendIconPreview' };
                showModal(document.getElementById('imageChoiceModal'));
            });
        }

        function bindColorInput(id) {
            const picker = document.getElementById(id);
            const hex = document.getElementById(id + 'Hex');
            if(picker && hex) {
                picker.addEventListener('input', () => hex.value = picker.value);
                hex.addEventListener('change', () => picker.value = hex.value);
            }
        }
        ['charBubbleBgColor', 'charBubbleTextColor', 'userBubbleBgColor', 'userBubbleTextColor',
         'bottomBarBgColor', 'inputBoxBgColor', 'inputBoxTextColor', 
         'plusBtnBgColor', 'plusBtnIconColor', 'sendBtnBgColor', 'sendBtnTextColor'
        ].forEach(id => bindColorInput(id));

        const saveMiddleBtn = document.getElementById('saveMiddleSettingsBtn');
        if (saveMiddleBtn) {
            saveMiddleBtn.addEventListener('click', async () => {
                const previewEl = document.getElementById('middleIconPreview');
                if(previewEl && middleIconImg) {
                    middleIconImg.src = previewEl.src;
                    await db.userSettings.put({ id: 'middleIconUrl', value: previewEl.src });
                }

                const newSettings = {
                    charBg: document.getElementById('charBubbleBgColor').value,
                    charText: document.getElementById('charBubbleTextColor').value,
                    userBg: document.getElementById('userBubbleBgColor').value,
                    userText: document.getElementById('userBubbleTextColor').value,
                    bottomBarBg: document.getElementById('bottomBarBgColor').value,
                    inputBoxBg: document.getElementById('inputBoxBgColor').value,
                    inputBoxText: document.getElementById('inputBoxTextColor').value,
                    plusBtnBg: document.getElementById('plusBtnBgColor').value,
                    plusBtnIcon: document.getElementById('plusBtnIconColor').value,
                    sendBtnBg: document.getElementById('sendBtnBgColor').value,
                    sendBtnText: document.getElementById('sendBtnTextColor').value,

                    isRoundBtn: document.getElementById('useRoundBtnMode').checked,
                    stashIcon: document.getElementById('stashIconPreview').src,
                    sendIcon: document.getElementById('sendIconPreview').src
                };

                await db.userSettings.put({ id: 'simpleBubbleSettings', value: newSettings });
                applyGlobalBubbleColors(newSettings);
                hideModal(middleSettingsModal);
            });
        }

        const cancelMiddleBtn = document.getElementById('cancelMiddleSettingsBtn');
        if (cancelMiddleBtn) { cancelMiddleBtn.addEventListener('click', () => hideModal(middleSettingsModal)); }

        // ï¼ˆè¿™æ˜¯åŸæœ¬æœ€ä¸‹é¢çš„ä»£ç ï¼Œä¸éœ€è¦åŠ¨å®ƒï¼Œåªæ˜¯è®©ä½ ç¡®è®¤ä½ç½®ï¼‰
        init().catch(console.error); 
      });
    </script>

    <!-- æŠŠè¿™äº›ä»£ç åŠ åœ¨ </body> æ ‡ç­¾ä¹‹å‰ -->

    <!-- ================== èŒç³»å›¾ç‰‡é€‰æ‹©å¼¹çª— ================== -->
    <div id="imageChoiceModal" class="modal-overlay" style="display: none">
      <div class="modal-content cute-dialog">
        <h3>æ›´æ¢å›¾ç‰‡</h3>
        <p>è¯·é€‰æ‹©å›¾ç‰‡æ¥æº</p>
        <div class="modal-buttons">
          <button id="uploadLocalBtn">æœ¬åœ°æ–‡ä»¶</button>
          <button id="uploadUrlBtn">URLé“¾æ¥</button>
        </div>
        <button id="closeChoiceModal" class="close-btn">&times;</button>
      </div>
    </div>
<!-- ================== ä¸­é—´å›¾æ ‡ä¸æ°”æ³¡è®¾ç½®å¼¹çª— (ä¿®å¤é¢œè‰²ç‰ˆ) ================== -->
<div id="middleSettingsModal" class="modal-overlay" style="display: none">
  <div class="modal-content" style="max-height: 85vh; overflow-y: auto;">
    <h3>èŠå¤©å¤–è§‚è®¾ç½®</h3>
    
    <!-- 1. ä¸­é—´å›¾æ ‡ -->
    <div class="settings-section-divider"><label>ä¸­é—´å›¾æ ‡</label></div>
    <div class="settings-item-column">
      <div style="display: flex; align-items: center; gap: 15px; justify-content: center; margin-bottom: 10px;">
        <img id="middleIconPreview" src="" style="width: 60px; height: 60px; border-radius: 50%; object-fit: cover; border: 2px solid rgba(255,255,255,0.2);">
        <button id="changeMiddleIconBtn" style="padding: 6px 12px;">æ›´æ¢å›¾æ ‡</button>
      </div>
    </div>

    <!-- 2. æ°”æ³¡é¢œè‰² -->
    <div class="settings-section-divider"><label>æ°”æ³¡é¢œè‰²</label></div>
    <div class="settings-item">
      <label>Char èƒŒæ™¯</label>
      <div class="color-input-group"><input type="color" id="charBubbleBgColor"><input type="text" id="charBubbleBgColorHex" style="width: 70px;"></div>
    </div>
    <div class="settings-item">
      <label>Char æ–‡å­—</label>
      <div class="color-input-group"><input type="color" id="charBubbleTextColor"><input type="text" id="charBubbleTextColorHex" style="width: 70px;"></div>
    </div>
    <div class="settings-item">
      <label>User èƒŒæ™¯</label>
      <div class="color-input-group"><input type="color" id="userBubbleBgColor"><input type="text" id="userBubbleBgColorHex" style="width: 70px;"></div>
    </div>
    <div class="settings-item">
      <label>User æ–‡å­—</label>
      <div class="color-input-group"><input type="color" id="userBubbleTextColor"><input type="text" id="userBubbleTextColorHex" style="width: 70px;"></div>
    </div>

    <!-- 3. åº•éƒ¨åŸºç¡€è®¾ç½® -->
    <div class="settings-section-divider"><label>åº•éƒ¨ - åŸºç¡€é…è‰²</label></div>
    <div class="settings-item">
      <label>åº•æ èƒŒæ™¯</label>
      <div class="color-input-group"><input type="color" id="bottomBarBgColor"><input type="text" id="bottomBarBgColorHex" style="width: 70px;"></div>
    </div>
    <div class="settings-item">
      <label>è¾“å…¥æ¡†èƒŒæ™¯</label>
      <div class="color-input-group"><input type="color" id="inputBoxBgColor"><input type="text" id="inputBoxBgColorHex" style="width: 70px;"></div>
    </div>
    <div class="settings-item">
      <label>è¾“å…¥æ–‡å­—è‰²</label>
      <div class="color-input-group"><input type="color" id="inputBoxTextColor"><input type="text" id="inputBoxTextColorHex" style="width: 70px;"></div>
    </div>
    <div class="settings-item">
      <label>å·¦ä¾§åŠ å·èƒŒæ™¯</label>
      <div class="color-input-group"><input type="color" id="plusBtnBgColor"><input type="text" id="plusBtnBgColorHex" style="width: 70px;"></div>
    </div>
    <div class="settings-item">
      <label>å·¦ä¾§åŠ å·å›¾æ ‡</label>
      <div class="color-input-group"><input type="color" id="plusBtnIconColor"><input type="text" id="plusBtnIconColorHex" style="width: 70px;"></div>
    </div>

    <!-- â–¼â–¼â–¼ 4. å‘é€/æš‚å­˜æŒ‰é’®è®¾ç½® (é‡ç‚¹ä¿®å¤è¿™é‡Œ) â–¼â–¼â–¼ -->
    <div class="settings-section-divider"><label>åº•éƒ¨ - å‘é€/æš‚å­˜æŒ‰é’®</label></div>
    
    <!-- è¿™é‡Œæ˜¯ä½ è¦å›æ¥çš„é¢œè‰²è®¾ç½®ï¼ -->
    <div class="settings-item">
      <label>æŒ‰é’®èƒŒæ™¯é¢œè‰²</label>
      <div class="color-input-group"><input type="color" id="sendBtnBgColor"><input type="text" id="sendBtnBgColorHex" style="width: 70px;"></div>
    </div>
    <div class="settings-item">
      <label>æŒ‰é’®æ–‡å­—é¢œè‰²</label>
      <div class="color-input-group"><input type="color" id="sendBtnTextColor"><input type="text" id="sendBtnTextColorHex" style="width: 70px;"></div>
    </div>

    <!-- è¿™é‡Œæ˜¯å½¢çŠ¶å’Œå›¾ç‰‡è®¾ç½® -->
    <div class="settings-item" style="justify-content: flex-start; gap: 10px; margin-top: 15px; border-top: 1px dashed #ccc; padding-top: 10px;">
      <input type="checkbox" id="useRoundBtnMode" style="width: 20px; height: 20px;">
      <label for="useRoundBtnMode" style="margin: 0; cursor: pointer; font-weight: bold;">å¼€å¯åœ†å½¢å›¾æ ‡æ¨¡å¼</label>
    </div>
    <p style="font-size: 12px; opacity: 0.7; margin-bottom: 10px;">å¼€å¯åæŒ‰é’®å˜åœ†ï¼Œæ˜¾ç¤ºå›¾ç‰‡ï¼›å…³é—­åæ˜¾ç¤ºæ–‡å­—ã€‚èƒŒæ™¯è‰²å‡ä»¥ä¸Šé¢è®¾ç½®ä¸ºå‡†ã€‚</p>

    <!-- æš‚å­˜æŒ‰é’®å›¾ -->
    <div class="settings-item-column" id="stashIconArea">
      <div style="display: flex; align-items: center; justify-content: space-between;">
        <label>æš‚å­˜å›¾æ ‡</label>
        <div style="display: flex; align-items: center; gap: 10px;">
          <img id="stashIconPreview" src="" style="width: 32px; height: 32px; border-radius: 4px; border: 1px solid #ccc; object-fit: contain;">
          <button id="changeStashIconBtn" style="padding: 4px 8px; font-size: 12px;">ä¸Šä¼ </button>
        </div>
      </div>
    </div>

    <!-- å‘é€æŒ‰é’®å›¾ -->
    <div class="settings-item-column" id="sendIconArea" style="margin-top: 5px;">
      <div style="display: flex; align-items: center; justify-content: space-between;">
        <label>å‘é€å›¾æ ‡</label>
        <div style="display: flex; align-items: center; gap: 10px;">
          <img id="sendIconPreview" src="" style="width: 32px; height: 32px; border-radius: 4px; border: 1px solid #ccc; object-fit: contain;">
          <button id="changeSendIconBtn" style="padding: 4px 8px; font-size: 12px;">ä¸Šä¼ </button>
        </div>
      </div>
    </div>
    <!-- â–²â–²â–² ä¿®å¤ç»“æŸ â–²â–²â–² -->

    <div class="modal-buttons" style="margin-top: 25px;">
      <button id="saveMiddleSettingsBtn" class="chat-send-btn api">ä¿å­˜å¹¶åº”ç”¨</button>
      <button id="cancelMiddleSettingsBtn">å–æ¶ˆ</button>
    </div>
  </div>
</div>

    <!-- ================== èŒç³»æ–‡æœ¬ç¼–è¾‘å¼¹çª— ================== -->
    <div id="textEditModal" class="modal-overlay" style="display: none">
      <div class="modal-content cute-dialog">
        <h3 id="textEditTitle">ç¼–è¾‘å†…å®¹</h3>
        <textarea id="textEditArea"></textarea>
        <div class="modal-buttons">
          <button id="saveTextBtn">ä¿å­˜</button>
          <button id="cancelTextBtn">å–æ¶ˆ</button>
        </div>
      </div>
    </div>
    <input type="file" id="imageFileInput" accept="image/*" style="display: none" />
    <!-- æŠŠä¸‹é¢è¿™ä¸¤å¤§å—ä»£ç åŠ åœ¨ </body> æ ‡ç­¾ä¹‹å‰ -->
    <input type="file" id="cardFileInput" accept=".png,.json" style="display: none" />
    <!-- ================== å…¨æ–°çš„å¤–è§‚è®¾ç½®å¼¹çª— ================== -->
    <div id="settingsModal" class="modal-overlay" style="display: none">
      <div class="modal-content" style="max-height: 80vh; overflow-y: auto">
        <h3>å¤–è§‚è®¾ç½®</h3>

        <!-- å£çº¸è®¾ç½® -->
        <div class="settings-item">
          <label>ä¸»å±å¹•å£çº¸</label>
          <div class="wallpaper-preview-container">
            <div id="wallpaperPreview" class="wallpaper-preview"></div>
            <button id="changeWallpaperBtn">æ›´æ¢</button>
          </div>
        </div>

        <!-- â–¼â–¼â–¼ æ–°å¢ï¼šå…¨å±€èƒŒæ™¯è‰²è°ƒ â–¼â–¼â–¼ -->
        <div class="settings-item">
          <label for="bgColorPicker">å…¨å±€èƒŒæ™¯è‰²è°ƒ</label>
          <div class="color-input-group">
            <input type="color" id="bgColorPicker" />
            <input type="text" id="bgColorInput" placeholder="#0d0d0d" />
          </div>
        </div>
        <!-- â–²â–²â–² æ–°å¢ç»“æŸ â–²â–²â–² -->

        <!-- å­—ä½“é¢œè‰²è®¾ç½® -->
        <div class="settings-item">
          <label for="fontColorPicker">å…¨å±€å­—ä½“è‰²è°ƒ</label>
          <div class="color-input-group">
            <input type="color" id="fontColorPicker" />
            <input type="text" id="fontColorInput" placeholder="#f0f0f0" />
          </div>
        </div>

        <!-- å°ç»„ä»¶é¢œè‰²è®¾ç½® -->
        <div class="settings-item">
          <label for="bubbleColorPicker">ç»„ä»¶é¢œè‰²</label>
          <div class="color-input-group">
            <input type="color" id="bubbleColorPicker" />
            <input type="text" id="bubbleColorInput" placeholder="#ffffff" />
          </div>
        </div>

        <!-- å°ç»„ä»¶é€æ˜åº¦è®¾ç½® -->
        <div class="settings-item">
          <label for="bubbleOpacitySlider">ç»„ä»¶é€æ˜åº¦</label>
          <input type="range" id="bubbleOpacitySlider" min="0" max="1" step="0.05" />
        </div>

        <!-- App ç¼–è¾‘åˆ—è¡¨ -->
        <div class="settings-section-divider">
          <label>åº”ç”¨ç¼–è¾‘</label>
        </div>
        <ul id="editableAppList" class="editable-app-list">
          <!-- Appåˆ—è¡¨å°†ç”±JSåŠ¨æ€ç”Ÿæˆåœ¨è¿™é‡Œ -->
        </ul>

        <div class="modal-buttons">
          <button id="saveSettingsBtn">ä¿å­˜ç”Ÿæ•ˆ</button>
          <button id="cancelSettingsBtn">å–æ¶ˆ</button>
        </div>
      </div>
    </div>
    <!-- ================== ç¼–è¾‘å•ä¸ªAppçš„å¼¹çª— (ç®€åŒ–ç‰ˆ) ================== -->
    <div id="editAppModal" class="modal-overlay" style="display: none">
      <div class="modal-content">
        <h3>ç¼–è¾‘åº”ç”¨åç§°</h3>
        <div class="settings-item-column">
          <label for="editAppName">åº”ç”¨åç§°</label>
          <input type="text" id="editAppName" class="styled-input" />
        </div>
        <div class="modal-buttons">
          <button id="saveAppChangesBtn">ç¡®è®¤</button>
          <button id="cancelAppChangesBtn">å–æ¶ˆ</button>
        </div>
      </div>
    </div>
    <!-- ================== API è®¾ç½®å¼¹çª— ================== -->
    <div id="apiSettingsModal" class="modal-overlay" style="display: none">
      <div class="modal-content" style="max-height: 80vh; overflow-y: auto; text-align: left">
        <h3>API è®¾ç½®</h3>

        <!-- API æ ¸å¿ƒä¿¡æ¯ -->
        <div class="settings-item-column">
          <label for="apiUrlInput">API åœ°å€</label>
          <input type="text" id="apiUrlInput" class="styled-input" placeholder="ä¾‹å¦‚ï¼šhttps://api.openai.com/v1" />
        </div>
        <div class="settings-item-column">
          <label for="apiKeyInput">API Key</label>
          <input type="password" id="apiKeyInput" class="styled-input" placeholder="è¯·è¾“å…¥ä½ çš„ API Key" />
        </div>

        <!-- æ¨¡å‹åˆ—è¡¨ -->
        <div class="settings-item">
          <label for="modelSelect">é€‰æ‹©æ¨¡å‹</label>
          <select id="modelSelect" class="styled-input" style="flex-grow: 1; margin-right: 10px"></select>
          <button id="fetchModelsBtn" style="flex-shrink: 0">æ‹‰å–æ¨¡å‹</button>
        </div>

        <!-- é¢„è®¾ç®¡ç† -->
        <div class="settings-section-divider">
          <label>é¢„è®¾ç®¡ç†</label>
        </div>
        <div class="settings-item">
          <select id="presetSelect" class="styled-input" style="flex-grow: 1">
            <option value="">--é€‰æ‹©ä¸€ä¸ªé¢„è®¾--</option>
          </select>
        </div>
        <div class="settings-item-column">
          <label for="presetNameInput">æ–°é¢„è®¾åç§°</label>
          <input type="text" id="presetNameInput" class="styled-input" placeholder="è¾“å…¥åç§°ä»¥ä¿å­˜æˆ–æ›´æ–°" />
        </div>
        <div class="modal-buttons" style="margin-top: 15px">
          <button id="saveAsPresetBtn">å¦å­˜ä¸º</button>
          <button id="updatePresetBtn">æ›´æ–°é¢„è®¾</button>
          <button id="deletePresetBtn">åˆ é™¤é¢„è®¾</button>
        </div>

        <div class="modal-buttons" style="margin-top: 25px">
          <button id="closeApiSettingsBtn">å…³é—­</button>
        </div>
      </div>
    </div>
    <!-- ================== QQ é€šè®¯å½•é¡µé¢ ================== -->
    <div id="qq-contacts-page" class="app-page">
      <div class="app-header">
        <button id="contacts-back-btn" class="back-btn">&lt;</button>
        <span class="header-title">é€šè®¯å½•</span>
        <div class="header-actions">
          <svg
            id="groupManagementBtn"
            xmlns="http://www.w3.org/2000/svg"
            width="24"
            height="24"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
            style="margin-right: 15px; cursor: pointer"
          >
            <path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"></path>
          </svg>
          <!-- å³ä¸Šè§’åˆ—è¡¨SVGæŒ‰é’® -->
          <svg
            id="qq-menu-btn"
            xmlns="http://www.w3.org/2000/svg"
            width="24"
            height="24"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
          >
            <circle cx="12" cy="12" r="1"></circle>
            <circle cx="12" cy="5" r="1"></circle>
            <circle cx="12" cy="19" r="1"></circle>
          </svg>
        </div>
      </div>

      <!-- è”ç³»äººåˆ—è¡¨ -->
      <div class="contacts-list">
        <!-- è”ç³»äººåˆ—è¡¨å°†ç”± JavaScript åŠ¨æ€ç”Ÿæˆåœ¨è¿™é‡Œ -->
      </div>
    </div>

    <!-- ================== QQ èŠå¤©è¯¦æƒ…é¡µ ================== -->
    <div id="qq-chat-page" class="app-page">
      <!-- èŠå¤©é¡¶éƒ¨æ  -->
      <div class="chat-header">
        <button id="chat-back-btn" class="back-btn">&lt;</button>
        <!-- æ–°çš„HTMLç»“æ„ -->
        <div class="char-status-bar">
          <img
            id="chat-char-avatar"
            src="https://i.postimg.cc/h4yRTMGF/ed60bc4602ebd5cbc0d8961d6c4b4aac.jpg"
            class="header-avatar"
            alt="char avatar"
          />
          <img id="chat-middle-icon" src="https://picsum.photos/id/431/100" class="header-avatar" alt="middle icon" />
          <img
            id="chat-user-avatar"
            src="https://i.postimg.cc/ryn2xgwZ/5fc5b9ae74465344658ed8c7e508b8f5.jpg"
            class="header-avatar"
            alt="user avatar"
          />
        </div>
        <div class="chat-header-placeholder"></div>
        <!-- å ä½ç”¨ï¼Œä¿æŒflexå¸ƒå±€å¹³è¡¡ -->
      </div>

      <!-- èŠå¤©æ¶ˆæ¯åŒºåŸŸ -->
      <div class="chat-messages">
        <!-- ç¤ºä¾‹æ¶ˆæ¯ -->
        <div class="message char-message">
          <img src="https://picsum.photos/id/1027/100" class="message-avatar" alt="avatar" />
          <div class="message-content">ä½ å¥½å‘€ï¼ä»Šå¤©æœ‰ä»€ä¹ˆæƒ³èŠçš„å—ï¼Ÿ</div>
        </div>
        <div class="message user-message">
          <div class="message-content">ä½ å¥½ï¼Œæˆ‘æƒ³é—®ä¸€ä¸‹ä»Šå¤©å¤©æ°”æ€ä¹ˆæ ·ã€‚</div>
          <img src="https://picsum.photos/id/1005/100" class="message-avatar" alt="avatar" />
        </div>
      </div>

      <!-- â–¼â–¼â–¼ æ‰¾åˆ° id="user-sticker-panel" è¿™ä¸ª div, ç”¨ä¸‹é¢çš„ä»£ç æ›¿æ¢å®ƒ â–¼â–¼â–¼ -->
      <div id="user-sticker-panel" class="chat-tool-panel">
        <div class="user-sticker-panel-header">
          <span>æˆ‘çš„è¡¨æƒ…</span>
          <!-- æ™®é€šæ¨¡å¼ä¸‹çš„æŒ‰é’® -->
          <div id="user-sticker-normal-buttons" style="display: flex; gap: 8px">
            <button id="user-sticker-bulk-add-btn">æ‰¹é‡æ·»åŠ </button>
            <button id="manage-user-stickers-btn">ç®¡ç†</button>
          </div>
          <!-- ç®¡ç†æ¨¡å¼ä¸‹çš„æŒ‰é’® -->
          <div id="user-sticker-manage-buttons" style="display: none; gap: 8px">
            <button id="user-sticker-classify-btn">æ‰¹é‡åˆ†ç±»</button>
            <button id="user-sticker-delete-btn" style="background-color: #ff3b30; color: white">åˆ é™¤</button>
            <button id="user-sticker-cancel-manage-btn">å–æ¶ˆ</button>
          </div>
        </div>

        <!-- æ–°å¢ï¼šåˆ†ç±»æ  -->
        <div id="user-sticker-category-tabs" class="sticker-category-tabs">
          <!-- åˆ†ç±»å°†ç”± JS åŠ¨æ€åŠ è½½åˆ°è¿™é‡Œ -->
        </div>

        <!-- è¡¨æƒ…å±•ç¤ºç½‘æ ¼ -->
        <div
          id="user-sticker-grid"
          class="sticker-grid"
          style="padding: 10px; height: calc(100% - 85px); overflow-y: auto"
        >
          <!-- ç”¨æˆ·è¡¨æƒ…åŒ…å°†ç”± JS åŠ¨æ€åŠ è½½åˆ°è¿™é‡Œ -->
        </div>
      </div>
      <!-- â–²â–²â–² æ›¿æ¢å®Œæˆ â–²â–²â–² -->

      <!-- ä¸»å·¥å…·æ é¢æ¿ (é»˜è®¤éšè—) -->
      <div id="chat-toolbar-panel" class="chat-tool-panel">
        <div class="toolbar-grid">
          <!-- åŠŸèƒ½1: è¡¨æƒ…åŒ… -->
          <button id="toolbar-sticker-btn" class="toolbar-grid-item">
            <svg
              xmlns="http://www.w3.org/2000/svg"
              width="28"
              height="28"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
            >
              <path d="M8 14s1.5 2 4 2 4-2 4-2" />
              <line x1="9" y1="9" x2="9.01" y2="9" />
              <line x1="15" y1="9" x2="15.01" y2="9" />
              <circle cx="12" cy="12" r="10" />
            </svg>
            <span>è¡¨æƒ…</span>
          </button>
          <!-- â–¼â–¼â–¼ åœ¨è¿™é‡Œæ·»åŠ æ–°çš„å‘é€å›¾ç‰‡æŒ‰é’® â–¼â–¼â–¼ -->
          <button id="toolbar-image-btn" class="toolbar-grid-item">
            <svg
              xmlns="http://www.w3.org/2000/svg"
              width="28"
              height="28"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
            >
              <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
              <circle cx="8.5" cy="8.5" r="1.5"></circle>
              <polyline points="21 15 16 10 5 21"></polyline>
            </svg>
            <span>å›¾ç‰‡</span>
          </button>
          <!-- â–²â–²â–² æ·»åŠ ç»“æŸ â–²â–²â–² -->
          <!-- åŠŸèƒ½: è¯­éŸ³ (æ–°) -->
          <button id="toolbar-voice-btn" class="toolbar-grid-item">
            <svg
              xmlns="http://www.w3.org/2000/svg"
              width="28"
              height="28"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
            >
              <path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"></path>
              <path d="M19 10v2a7 7 0 0 1-14 0v-2"></path>
              <line x1="12" y1="19" x2="12" y2="22"></line>
            </svg>
            <span>è¯­éŸ³</span>
          </button>
          <!-- â–¼â–¼â–¼ åœ¨è¿™é‡Œæ·»åŠ æ–°çš„è§†é¢‘é€šè¯æŒ‰é’® â–¼â–¼â–¼ -->
          <button id="toolbar-video-call-btn" class="toolbar-grid-item">
            <svg
              xmlns="http://www.w3.org/2000/svg"
              width="28"
              height="28"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
            >
              <path
                d="M15.6 11.6L22 7v10l-6.4-4.6v-1zM4 5h9a2 2 0 0 1 2 2v10a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V7a2 2 0 0 1 2-2z"
              ></path>
            </svg>
            <span>è§†é¢‘é€šè¯</span>
          </button>
          <!-- â–²â–²â–² æ·»åŠ ç»“æŸ â–²â–²â–² -->
          <button id="toolbar-transfer-btn" class="toolbar-grid-item">
            <svg
              xmlns="http://www.w3.org/2000/svg"
              width="28"
              height="28"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
            >
              <path d="M12 19v-7L7 5"></path>
              <path d="M17 5l-5 7"></path>
              <path d="M8 13h8"></path>
              <path d="M8 17h8"></path>
            </svg>
            <span>è½¬è´¦</span>
          </button>
          <!-- â–²â–²â–² æ·»åŠ ç»“æŸ â–²â–²â–² -->
          <button id="toolbar-gift-btn" class="toolbar-grid-item">
            <svg
              xmlns="http://www.w3.org/2000/svg"
              width="28"
              height="28"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
            >
              <polyline points="20 12 20 22 4 22 4 12"></polyline>
              <rect x="2" y="7" width="20" height="5"></rect>
              <line x1="12" y1="22" x2="12" y2="7"></line>
              <path d="M12 7H7.5a2.5 2.5 0 0 1 0-5C11 2 12 7 12 7z"></path>
              <path d="M12 7h4.5a2.5 2.5 0 0 0 0-5C13 2 12 7 12 7z"></path>
            </svg>
            <span>ç¤¼ç‰©</span>
          </button>
          <!-- åŠŸèƒ½4: å ä½ -->
          <div class="toolbar-grid-item placeholder"></div>
        </div>
      </div>
      <!-- â–²â–²â–² æ·»åŠ ç»“æŸ â–²â–²â–² -->

      <!-- åº•éƒ¨è¾“å…¥åŒºåŸŸ -->
      <div class="chat-input-area">
        <!-- â–¼â–¼â–¼ åœ¨è¿™é‡Œæ·»åŠ æ–°çš„æŒ‰é’® â–¼â–¼â–¼ -->
        <button id="chat-toolbar-toggle" class="chat-tool-btn">
          <svg
            xmlns="http://www.w3.org/2000/svg"
            width="24"
            height="24"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
          >
            <path d="M12 5v14M5 12h14" />
          </svg>
        </button>
        <!-- â–²â–²â–² æ·»åŠ ç»“æŸ â–²â–²â–² -->
        <input type="text" id="chat-input-box" placeholder="è¾“å…¥æ¶ˆæ¯..." />
        <button id="chat-temp-send-btn" class="chat-send-btn">æš‚å­˜</button>
        <button id="chat-api-send-btn" class="chat-send-btn api">å‘é€</button>
      </div>
    </div>
    <!-- ================== Char è®¾ç½®é¢æ¿ ================== -->
    <div id="charSettingsModal" class="modal-overlay" style="display: none">
      <div class="modal-content" style="max-height: 80vh; overflow-y: auto; text-align: left">
        <h3>è§’è‰²è®¾ç½®</h3>

        <div class="settings-item-column">
          <label>å¤´åƒ</label>
          <div style="display: flex; align-items: center; gap: 10px">
            <img
              id="charSettingsAvatarPreview"
              src=""
              style="width: 60px; height: 60px; border-radius: 50%; object-fit: cover; background-color: #333"
            />
            <button id="changeCharAvatarBtn">æ›´æ¢å¤´åƒ</button>
          </div>
        </div>

        <div class="settings-item-column">
          <label for="charRealName">è§’è‰²æœ¬å</label>
          <input type="text" id="charRealName" class="styled-input" placeholder="è§’è‰²çš„çœŸå®å§“å" />
        </div>

        <div class="settings-item-column">
          <label for="charNickname">ç»™Taçš„å¤‡æ³¨ (æ˜¾ç¤ºåœ¨åˆ—è¡¨)</label>
          <input type="text" id="charNickname" class="styled-input" placeholder="ä½ ç»™è§’è‰²èµ·çš„æ˜µç§°" />
        </div>

        <div class="settings-item-column">
          <label for="charGender">æ€§åˆ«</label>
          <select id="charGender" class="styled-input">
            <option value="male">ç”·</option>
            <option value="female">å¥³</option>
            <option value="other">å…¶ä»–</option>
          </select>
        </div>

        <div class="settings-item-column">
          <label for="charPersona">äººè®¾ (Persona)</label>
          <textarea id="charPersona" class="styled-input" rows="4" placeholder="è§’è‰²çš„æ€§æ ¼ã€èƒŒæ™¯æ•…äº‹ç­‰..."></textarea>
        </div>

        <div class="settings-item-column">
          <label for="charMaxMemory">æœ€å¤§è®°å¿†æ¡æ•°</label>
          <input type="number" id="charMaxMemory" class="styled-input" value="50" />
        </div>
        <!-- â–¼â–¼â–¼ åœ¨è¿™é‡Œæ·»åŠ æ–°çš„ä»£ç å— â–¼â–¼â–¼ -->
        <div class="settings-item-column">
          <label for="charMinReply">å•æ¬¡å›æ¶ˆæ¯æ•°é‡åŒºé—´</label>
          <div style="display: flex; align-items: center; gap: 10px">
            <input type="number" id="charMinReply" class="styled-input" value="1" min="1" style="width: 45%" />
            <span>åˆ°</span>
            <input type="number" id="charMaxReply" class="styled-input" value="2" min="1" style="width: 45%" />
          </div>
          <p style="font-size: 12px; color: var(--text-secondary-color); margin-top: 5px">
            AIå°†å°è¯•åœ¨æ­¤èŒƒå›´å†…å›å¤æ¶ˆæ¯ã€‚
          </p>
        </div>
        <!-- â–²â–²â–² æ·»åŠ ç»“æŸ â–²â–²â–² -->

        <div class="settings-item-column">
          <label for="charGroup">å¥½å‹åˆ†ç±»</label>
          <!-- ä¸‹é¢è¿™è¡Œ input æ·»åŠ äº† list å±æ€§ -->
          <input
            list="group-list"
            id="charGroup"
            class="styled-input"
            placeholder="é€‰æ‹©æˆ–æ–°å»ºåˆ†ç»„"
            autocomplete="off"
          />
          <!-- ä¸‹é¢æ˜¯æ–°å¢çš„ datalistï¼Œå®ƒä¼šä¸ºè¾“å…¥æ¡†æä¾›å»ºè®®é€‰é¡¹ -->
          <datalist id="group-list">
            <!-- é€‰é¡¹å°†ç”± JavaScript åŠ¨æ€å¡«å…… -->
          </datalist>
        </div>

        <!-- â–¼â–¼â–¼ ç”¨ä¸‹é¢çš„ä»£ç æ›¿æ¢ä¸Šé¢çš„ div.settings-item-column â–¼â–¼â–¼ -->
        <div class="settings-item-column">
          <label>å…³è”ä¸–ç•Œä¹¦</label>
          <div
            id="charWorldBookDisplay"
            class="styled-input"
            style="min-height: 44px; padding-top: 12px; cursor: pointer"
          >
            <span style="color: var(--text-secondary-color); font-style: italic">ç‚¹å‡»é€‰æ‹©...</span>
          </div>
        </div>
        <!-- â–²â–²â–² æ›¿æ¢å®Œæˆ â–²â–²â–² -->
        <div class="settings-section-divider">
          <label>æ‰©å±•è®¾å®š</label>
        </div>
        <div class="modal-buttons" style="justify-content: flex-start; gap: 10px">
          <button id="openNpcLibraryBtn">NPCåº“</button>
          <button id="openStickerLibraryBtn">è¡¨æƒ…åŒ…åº“</button>
          <button id="openBubbleEditorBtn">è‡ªå®šä¹‰æ°”æ³¡</button>
        </div>
        <div class="settings-section-divider">
          <label>å·¥ä½œä¸é’±åŒ…</label>
        </div>

        <!-- å·¥ä½œè®¾å®š -->
        <div class="settings-item-column">
          <label for="charProfession">èŒä¸š</label>
          <input type="text" id="charProfession" class="styled-input" placeholder="ä¾‹å¦‚ï¼šä¾¦æ¢ã€å’–å•¡å¸ˆã€æ³•å¸ˆ..." />
        </div>
        <div class="settings-item-column">
          <label for="charWorkSchedule">ä¸€å‘¨å·¥ä½œè®¡åˆ’</label>
          <textarea
            id="charWorkSchedule"
            class="styled-input"
            rows="4"
            placeholder="å‘¨ä¸€ï¼š9-5ç‚¹ä¸Šç­ï¼Œå¤„ç†å§”æ‰˜&#10;å‘¨äºŒï¼šä¼‘æ¯æ—¥ï¼Œå»å›¾ä¹¦é¦†..."
          ></textarea>
          <button
            id="generateWorkScheduleBtn"
            style="margin-top: 8px; font-size: 12px; padding: 4px 12px; border-radius: 20px"
          >
            AI ç”Ÿæˆå·¥ä½œè®¡åˆ’
          </button>
        </div>

        <!-- é’±åŒ…è®¾å®š -->
        <div class="settings-item-column">
          <label for="charInitialBalanceRange">åˆå§‹ä½™é¢åŒºé—´ (å¯é€‰)</label>
          <div style="display: flex; gap: 10px">
            <input type="text" id="charInitialBalanceRange" class="styled-input" placeholder="ä¾‹å¦‚: 1000-5000" />
            <button id="generateInitialBalanceBtn" style="flex-shrink: 0; padding: 8px 15px">ç”Ÿæˆ/é‡ç½®ä½™é¢</button>
          </div>
        </div>
        <!-- åœ¨ charSettingsModal ä¸­æ‰¾åˆ°è¿™å—ä»£ç  -->
        <div class="settings-item-column">
          <label for="charCurrentBalance">å½“å‰ä½™é¢</label>
          <div style="display: flex; align-items: center; gap: 10px">
            <input
              type="text"
              id="charCurrentBalance"
              class="styled-input"
              readonly
              style="background-color: rgba(0, 0, 0, 0.3)"
            />
            <!-- â–¼â–¼â–¼ åœ¨è¿™é‡Œæ·»åŠ æ–°æŒ‰é’® â–¼â–¼â–¼ -->
            <button id="viewTransactionLogBtn" style="flex-shrink: 0; padding: 8px 12px">æŸ¥çœ‹è®°å½•</button>
            <!-- â–²â–²â–² æ·»åŠ ç»“æŸ â–²â–²â–² -->
          </div>
        </div>

        <!-- â–¼â–¼â–¼ åœ¨è¿™é‡Œæ·»åŠ æ–°çš„è®¾ç½®é¡¹ â–¼â–¼â–¼ -->
        <div class="settings-section-divider">
          <label>é€šè¯è®¾å®š</label>
          <button
            id="view-video-call-history-btn"
            style="
              background: none;
              border: 1px solid var(--capsule-bg);
              color: var(--text-color);
              padding: 2px 10px;
              border-radius: 20px;
              font-size: 12px;
              cursor: pointer;
              margin-left: 10px;
            "
          >
            é€šè¯è®°å½•
          </button>
        </div>
        <div class="settings-item-column">
          <label>è§†é¢‘é€šè¯å›¾ç‰‡</label>
          <div style="display: flex; align-items: center; gap: 10px">
            <img
              id="charVideoCallImagePreview"
              src=""
              style="width: 100px; height: 60px; border-radius: 8px; object-fit: cover; background-color: #333"
            />
            <button id="changeCharVideoCallImageBtn">æ›´æ¢</button>
          </div>
          <p style="font-size: 12px; color: var(--text-secondary-color); margin-top: 5px">è‹¥ä¸è®¾ç½®ï¼Œå°†ä½¿ç”¨è§’è‰²å¤´åƒã€‚</p>
        </div>
        <!-- â–²â–²â–² æ·»åŠ ç»“æŸ â–²â–²â–² -->
        <div class="modal-buttons" style="margin-top: 20px">
          <button id="saveCharSettingsBtn">ä¿å­˜</button>
          <button id="cancelCharSettingsBtn">å–æ¶ˆ</button>
        </div>
      </div>
    </div>

    <!-- ================== User è®¾ç½®é¢æ¿ (V2 - å¸¦é’±åŒ…åŠŸèƒ½) ================== -->
    <div id="userSettingsModal" class="modal-overlay" style="display: none">
      <div class="modal-content" style="max-height: 80vh; overflow-y: auto; text-align: left">
        <h3>æˆ‘çš„ä¿¡æ¯ (æœ¬æ¬¡å¯¹è¯)</h3>

        <!-- å¤´åƒ -->
        <div class="settings-item-column">
          <label>æˆ‘çš„å¤´åƒ (æœ¬æ¬¡å¯¹è¯)</label>
          <div style="display: flex; align-items: center; gap: 10px">
            <img
              id="userSettingsAvatarPreview"
              src=""
              style="width: 60px; height: 60px; border-radius: 50%; object-fit: cover; background-color: #333"
            />
            <button id="changeUserAvatarBtn">æ›´æ¢å¤´åƒ</button>
          </div>
        </div>

        <!-- åŸºç¡€ä¿¡æ¯ -->
        <div class="settings-item-column">
          <label for="userName">æˆ‘çš„åå­—</label>
          <input type="text" id="userName" class="styled-input" placeholder="ä½ åœ¨æ­¤æ¬¡å¯¹è¯ä¸­çš„åå­—" />
        </div>
        <div class="settings-item-column">
          <label for="userRelationToChar">æˆ‘å’ŒTaçš„å…³ç³»</label>
          <input type="text" id="userRelationToChar" class="styled-input" placeholder="ä¾‹å¦‚ï¼šæœ‹å‹ã€æ‹äººã€åŒå­¦..." />
        </div>
        <div class="settings-item-column">
          <label for="userGender">æˆ‘çš„æ€§åˆ«</label>
          <select id="userGender" class="styled-input">
            <option value="male">ç”·</option>
            <option value="female">å¥³</option>
            <option value="other">å…¶ä»–</option>
          </select>
        </div>
        <div class="settings-item-column">
          <label for="userPersona">æˆ‘çš„äººè®¾ (Persona)</label>
          <textarea
            id="userPersona"
            class="styled-input"
            rows="4"
            placeholder="ä½ åœ¨æ­¤æ¬¡å¯¹è¯ä¸­çš„è§’è‰²ã€èº«ä»½..."
          ></textarea>
        </div>

        <!-- é€šè¯è®¾å®š -->
        <div class="settings-section-divider">
          <label>é€šè¯è®¾å®š</label>
        </div>
        <div class="settings-item-column">
          <label>æˆ‘çš„è§†é¢‘é€šè¯å›¾ç‰‡</label>
          <div style="display: flex; align-items: center; gap: 10px">
            <img
              id="userVideoCallImagePreview"
              src=""
              style="width: 100px; height: 60px; border-radius: 8px; object-fit: cover; background-color: #333"
            />
            <button id="changeUserVideoCallImageBtn">æ›´æ¢</button>
          </div>
          <p style="font-size: 12px; color: var(--text-secondary-color); margin-top: 5px">è‹¥ä¸è®¾ç½®ï¼Œå°†ä½¿ç”¨æˆ‘çš„å¤´åƒã€‚</p>
        </div>

        <!-- â–¼â–¼â–¼ å…¨æ–°çš„å·¥ä½œä¸é’±åŒ…åŒºåŸŸ â–¼â–¼â–¼ -->
        <div class="settings-section-divider">
          <label>æˆ‘çš„å·¥ä½œä¸é’±åŒ…</label>
        </div>
        <div class="settings-item-column">
          <label for="userProfession">æˆ‘çš„èŒä¸š</label>
          <input type="text" id="userProfession" class="styled-input" placeholder="ä¾‹å¦‚ï¼šå­¦ç”Ÿã€ç¨‹åºå‘˜ã€è‡ªç”±èŒä¸šè€…..." />
        </div>
        <div class="settings-item-column">
          <label for="userDailySalary">æ¯æ—¥å·¥èµ„</label>
          <input type="number" id="userDailySalary" class="styled-input" placeholder="è¾“å…¥çº¯æ•°å­—ï¼Œä¾‹å¦‚: 300" />
        </div>
        <div class="settings-item-column">
          <label for="userInitialBalance">è®¾ç½®åˆå§‹ä½™é¢</label>
          <div style="display: flex; gap: 10px">
            <input type="number" id="userInitialBalance" class="styled-input" placeholder="è¾“å…¥çº¯æ•°å­—ï¼Œä¾‹å¦‚: 5000" />
            <button id="setUserInitialBalanceBtn" style="flex-shrink: 0; padding: 8px 15px">è®¾å®š/é‡ç½®</button>
          </div>
        </div>
        <div class="settings-item-column">
          <label for="userCurrentBalance">å½“å‰ä½™é¢</label>
          <div style="display: flex; align-items: center; gap: 10px">
            <input
              type="text"
              id="userCurrentBalance"
              class="styled-input"
              readonly
              style="background-color: rgba(0, 0, 0, 0.3)"
            />
            <button id="viewUserTransactionLogBtn" style="flex-shrink: 0; padding: 8px 12px">æŸ¥çœ‹è®°å½•</button>
          </div>
        </div>
        <!-- â–²â–²â–² å…¨æ–°çš„å·¥ä½œä¸é’±åŒ…åŒºåŸŸç»“æŸ â–²â–²â–² -->

        <!-- äººè®¾é¢„è®¾ -->
        <div class="settings-section-divider" style="margin-top: 25px">
          <label>æˆ‘çš„äººè®¾é¢„è®¾</label>
        </div>
        <div class="modal-buttons" style="margin-bottom: 15px; justify-content: flex-start">
          <button id="saveAsUserPresetBtn">ä¿å­˜å½“å‰ä¿¡æ¯ä¸ºé¢„è®¾</button>
        </div>
        <ul id="userPresetsList" style="max-height: 150px; overflow-y: auto; padding: 5px; list-style: none; margin: 0">
          <!-- é¢„è®¾åˆ—è¡¨å°†ç”±JSåŠ¨æ€ç”Ÿæˆåœ¨è¿™é‡Œ -->
        </ul>

        <!-- åº•éƒ¨æŒ‰é’® -->
        <div class="modal-buttons" style="margin-top: 20px">
          <button id="saveUserSettingsBtn">ä¿å­˜</button>
          <button id="cancelUserSettingsBtn">å–æ¶ˆ</button>
        </div>
      </div>
    </div>

    <!-- ================== æ·»åŠ æ–°äººç‰©å¼¹çª— (æ–°æ·»åŠ çš„) ================== -->
    <div id="addCharModal" class="modal-overlay" style="display: none">
      <div class="modal-content" style="max-height: 80vh; overflow-y: auto; text-align: left">
        <h3>æ·»åŠ æ–°äººç‰©</h3>

        <div class="settings-item-column">
          <label>å¤´åƒ</label>
          <div style="display: flex; align-items: center; gap: 10px">
            <img
              id="newCharAvatarPreview"
              src="https://i.postimg.cc/h4yRTMGF/ed60bc4602ebd5cbc0d8961d6c4b4aac.jpg"
              style="width: 60px; height: 60px; border-radius: 50%; object-fit: cover; background-color: #333"
            />
            <button id="changeNewCharAvatarBtn">æ›´æ¢å¤´åƒ</button>
          </div>
          <p style="font-size: 12px; color: var(--text-secondary-color); margin-top: 5px">
            è‹¥ä¸è®¾ç½®ï¼Œå°†ä½¿ç”¨æ­¤é»˜è®¤å¤´åƒã€‚
          </p>
        </div>

        <div class="settings-item-column">
          <label for="newCharRealName">æœ¬å</label>
          <input type="text" id="newCharRealName" class="styled-input" placeholder="è§’è‰²çš„çœŸå®å§“åï¼ˆå¯é€‰ï¼‰" />
        </div>

        <div class="settings-item-column">
          <label for="newCharNickname">å¤‡æ³¨ <span style="color: red">*</span></label>
          <input type="text" id="newCharNickname" class="styled-input" placeholder="æ˜¾ç¤ºåœ¨é€šè®¯å½•çš„åç§°ï¼ˆå¿…å¡«ï¼‰" />
        </div>

        <div class="settings-item-column">
          <label for="newCharPersona">äººè®¾ (Persona)</label>
          <textarea
            id="newCharPersona"
            class="styled-input"
            rows="4"
            placeholder="è§’è‰²çš„æ€§æ ¼ã€èƒŒæ™¯æ•…äº‹ç­‰..."
          ></textarea>
        </div>

        <div class="modal-buttons" style="margin-top: 20px; flex-wrap: wrap">
          <button id="createCharBtn" style="flex-grow: 1">åˆ›å»º</button>
          <!-- â–¼â–¼â–¼ æ–°å¢å¯¼å…¥æŒ‰é’® â–¼â–¼â–¼ -->
          <button id="importCardBtn" style="flex-grow: 1; background-color: #30d158; color: white">å¯¼å…¥è§’è‰²å¡</button>
          <!-- â–²â–²â–² æ–°å¢ç»“æŸ â–²â–²â–² -->
          <button id="cancelAddCharBtn" style="width: 100%; margin-top: 10px">å–æ¶ˆ</button>
        </div>
      </div>
    </div>
    <!-- ================== NPC åº“å¼¹çª— ================== -->
    <div id="npcLibraryModal" class="modal-overlay" style="display: none">
      <div class="modal-content" style="max-height: 80vh; overflow-y: auto; text-align: left">
        <h3>NPC åº“</h3>
        <p style="font-size: 13px; margin-top: -10px; margin-bottom: 15px">ç®¡ç†ä¸è¯¥è§’è‰²æœ‰å…³è”çš„å…¶ä»–äººç‰©ã€‚</p>

        <div id="npcList" class="editable-app-list" style="margin-bottom: 20px">
          <!-- NPC åˆ—è¡¨å°†ç”± JS åŠ¨æ€ç”Ÿæˆ -->
        </div>

        <div class="modal-buttons" style="justify-content: flex-start">
          <button id="addNewNpcBtn">åˆ›å»ºæ–°NPC</button>
          <button id="addExistingCharAsNpcBtn">é€‰æ‹©å·²æœ‰è§’è‰²</button>
        </div>

        <div class="modal-buttons" style="margin-top: 25px">
          <button id="closeNpcLibraryBtn">å…³é—­</button>
        </div>
      </div>
    </div>

    <!-- ================== ç¼–è¾‘/åˆ›å»º NPC å¼¹çª— ================== -->
    <div id="editNpcModal" class="modal-overlay" style="display: none">
      <div class="modal-content" style="max-height: 80vh; overflow-y: auto; text-align: left">
        <h3 id="editNpcModalTitle">åˆ›å»ºæ–° NPC</h3>

        <!-- ç”¨äºé€‰æ‹©å·²æœ‰è§’è‰²çš„ä¸‹æ‹‰æ¡†ï¼Œé»˜è®¤éšè— -->
        <div id="selectCharAsNpcSection" class="settings-item-column" style="display: none">
          <label for="existingCharSelect">é€‰æ‹©è§’è‰²</label>
          <select id="existingCharSelect" class="styled-input"></select>
        </div>

        <!-- ç”¨äºåˆ›å»ºæ–°NPCçš„è¾“å…¥æ¡†ï¼Œé»˜è®¤æ˜¾ç¤º -->
        <div id="createNewNpcSection">
          <div class="settings-item-column">
            <label>NPC å¤´åƒ</label>
            <div style="display: flex; align-items: center; gap: 10px">
              <img
                id="npcAvatarPreview"
                src="https://picsum.photos/seed/npc/100"
                style="width: 60px; height: 60px; border-radius: 50%; object-fit: cover; background-color: #333"
              />
              <button id="changeNpcAvatarBtn">æ›´æ¢</button>
            </div>
          </div>
          <div class="settings-item-column">
            <label for="npcNameInput">NPC åå­—</label>
            <input type="text" id="npcNameInput" class="styled-input" placeholder="NPCçš„åå­—" />
          </div>
          <div class="settings-item-column">
            <label for="npcPersonaInput">NPC äººè®¾</label>
            <textarea id="npcPersonaInput" class="styled-input" rows="3" placeholder="NPCçš„æ€§æ ¼ã€èƒŒæ™¯..."></textarea>
          </div>
        </div>

        <!-- é€šç”¨å…³ç³»è¾“å…¥æ¡† -->
        <div class="settings-item-column">
          <label for="npcRelationInput">ä¸ä¸»Charçš„å…³ç³»</label>
          <input type="text" id="npcRelationInput" class="styled-input" placeholder="ä¾‹å¦‚ï¼šæœ‹å‹, æ¯äº², å¯¹æ‰‹" />
        </div>

        <div class="modal-buttons" style="margin-top: 20px">
          <button id="saveNpcBtn">ä¿å­˜</button>
          <button id="cancelNpcBtn">å–æ¶ˆ</button>
        </div>
      </div>
    </div>

    <!-- ================== è¡¨æƒ…åŒ…åº“å¼¹çª— ================== -->
    <div id="stickerLibraryModal" class="modal-overlay" style="display: none">
      <div
        class="modal-content"
        style="width: 90%; max-width: 380px; max-height: 80vh; display: flex; flex-direction: column"
      >
        <h3>è¡¨æƒ…åŒ…åº“</h3>

        <!-- Tab åˆ‡æ¢ -->
        <div id="stickerTabs" style="display: flex; border-bottom: 1px solid #444; margin-bottom: 15px">
          <button class="sticker-tab-btn active" data-tab="exclusive">ä¸“å±è¡¨æƒ…</button>
          <button class="sticker-tab-btn" data-tab="common">é€šç”¨è¡¨æƒ…</button>
        </div>

        <!-- è¡¨æƒ…åŒ…å®¹å™¨ -->
        <div class="sticker-content-container" style="flex-grow: 1; overflow-y: auto">
          <!-- ä¸“å±è¡¨æƒ…åŒ… Tab -->
          <div id="exclusiveStickersTab" class="sticker-tab-content active">
            <div id="exclusiveStickerGrid" class="sticker-grid"></div>
          </div>
          <!-- é€šç”¨è¡¨æƒ…åŒ… Tab -->
          <div id="commonStickersTab" class="sticker-tab-content">
            <div id="commonStickerGrid" class="sticker-grid"></div>
          </div>
        </div>

        <div class="modal-buttons" style="margin-top: 20px; flex-shrink: 0" id="stickerNormalButtons">
          <button id="addStickersBtn">æ‰¹é‡æ·»åŠ </button>
          <button id="bulkManageStickersBtn">æ‰¹é‡ç®¡ç†</button>
          <button id="closeStickerLibraryBtn">å…³é—­</button>
        </div>
        <div class="modal-buttons" style="margin-top: 20px; flex-shrink: 0; display: none" id="stickerManageButtons">
          <button id="confirmDeleteStickersBtn" style="background-color: #ff3b30; color: white">ç¡®è®¤åˆ é™¤</button>
          <button id="cancelManageStickersBtn">å–æ¶ˆ</button>
        </div>
      </div>
    </div>

    <!-- ================== æ‰¹é‡æ·»åŠ è¡¨æƒ…åŒ…å¼¹çª— ================== -->
    <div id="addStickersModal" class="modal-overlay" style="display: none">
      <div class="modal-content">
        <h3 id="addStickersTitle">æ·»åŠ è¡¨æƒ…</h3>
        <p style="font-size: 13px; margin-bottom: 15px">
          æ¯è¡Œä¸€ä¸ªï¼Œæ ¼å¼ä¸ºâ€œæè¿°:URLâ€ï¼Œä¾‹å¦‚ï¼š<br />å¼€å¿ƒ:https://example.com/happy.png
        </p>
        <textarea id="stickerBulkAddArea" class="styled-input" style="height: 150px; resize: vertical"></textarea>
        <div class="modal-buttons">
          <button id="saveStickersBtn">ç¡®è®¤æ·»åŠ </button>
          <button id="cancelAddStickersBtn">å–æ¶ˆ</button>
        </div>
      </div>
    </div>
    <!-- â–¼â–¼â–¼ æŠŠä¸‹é¢è¿™ä¸ªå…¨æ–°çš„å¼¹çª—ä»£ç æ·»åŠ åˆ° </body> ä¹‹å‰ â–¼â–¼â–¼ -->

    <!-- ================== èŠå¤©æ°”æ³¡ç¼–è¾‘å™¨å¼¹çª— (V3 - è¶…çº§ç‰ˆ) ================== -->
    <div id="bubbleEditorModal" class="modal-overlay" style="display: none">
      <div
        class="modal-content"
        style="width: 95%; max-width: 420px; max-height: 85vh; display: flex; flex-direction: column"
      >
        <h3>è‡ªå®šä¹‰èŠå¤©æ°”æ³¡</h3>

        <!-- å®æ—¶é¢„è§ˆåŒºåŸŸ (ç»“æ„ä¸å˜) -->
        <div class="bubble-editor-preview-area">
          <div class="message char-message">
            <img src="https://picsum.photos/id/1027/100" class="message-avatar" alt="avatar" />
            <div class="message-content" id="charBubblePreview" style="position: relative; overflow: hidden">
              <span class="bubble-text">è¿™æ˜¯å¯¹æ–¹çš„æ°”æ³¡é¢„è§ˆæ•ˆæœã€‚</span>
            </div>
          </div>
          <div class="message user-message">
            <div class="message-content" id="userBubblePreview" style="position: relative; overflow: hidden">
              <span class="bubble-text">è¿™æ˜¯æˆ‘çš„æ°”æ³¡é¢„è§ˆæ•ˆæœã€‚</span>
            </div>
            <img src="https://picsum.photos/id/1005/100" class="message-avatar" alt="avatar" />
          </div>
        </div>

        <!-- ç¼–è¾‘å™¨æ ¸å¿ƒåŒºåŸŸ -->
        <div class="bubble-editor-controls">
          <!-- Tab åˆ‡æ¢ -->
          <div id="bubbleEditorTabs" class="sticker-tabs" style="margin-bottom: 10px">
            <button class="sticker-tab-btn active" data-tab="visual">å¯è§†åŒ–ç¼–è¾‘</button>
            <button class="sticker-tab-btn" data-tab="css">CSSä»£ç </button>
          </div>

          <!-- å¯è§†åŒ–ç¼–è¾‘ Tab -->
          <div id="visualEditorTab" class="sticker-tab-content active" style="font-size: 13px; text-align: left">
            <div class="bubble-target-selector">
              <label><input type="radio" name="editTarget" value="char" checked /> ç¼–è¾‘å¯¹æ–¹æ°”æ³¡</label>
              <label><input type="radio" name="editTarget" value="user" /> ç¼–è¾‘æˆ‘çš„æ°”æ³¡</label>
            </div>

            <!-- â–¼â–¼â–¼ èƒŒæ™¯è®¾ç½® (å¤§æ”¹ç‰ˆ) â–¼â–¼â–¼ -->
            <strong class="editor-section-title">èƒŒæ™¯</strong>
            <div class="settings-item-column">
              <label style="width: auto">èƒŒæ™¯ç±»å‹</label>
              <select id="bgTypeSelect" class="styled-input visual-editor-control" data-control="bgType">
                <option value="solid">çº¯è‰²</option>
                <option value="gradient">æ¸å˜</option>
                <option value="image">å›¾ç‰‡</option>
              </select>
            </div>

            <!-- çº¯è‰²æ§ä»¶ -->
            <div id="solidColorControls" class="control-group">
              <div class="settings-item">
                <label>é¢œè‰²</label>
                <div class="color-input-group">
                  <input type="color" id="bubbleBgColor" class="visual-editor-control" data-control="solid.color" />
                  <input
                    type="text"
                    id="bubbleBgColorHex"
                    class="styled-input visual-editor-control"
                    data-control="solid.color"
                    style="width: 100px"
                  />
                </div>
              </div>
            </div>

            <!-- æ¸å˜æ§ä»¶ -->
            <div id="gradientControls" class="control-group" style="display: none">
              <div class="settings-item">
                <label>èµ·å§‹è‰²</label>
                <div class="color-input-group">
                  <input
                    type="color"
                    id="gradientStartColor"
                    class="visual-editor-control"
                    data-control="gradient.start"
                  />
                  <input
                    type="text"
                    id="gradientStartColorHex"
                    class="styled-input visual-editor-control"
                    data-control="gradient.start"
                    style="width: 100px"
                  />
                </div>
              </div>
              <div class="settings-item">
                <label>ç»“æŸè‰²</label>
                <div class="color-input-group">
                  <input type="color" id="gradientEndColor" class="visual-editor-control" data-control="gradient.end" />
                  <input
                    type="text"
                    id="gradientEndColorHex"
                    class="styled-input visual-editor-control"
                    data-control="gradient.end"
                    style="width: 100px"
                  />
                </div>
              </div>
              <div class="settings-item-column">
                <label>æ–¹å‘</label>
                <select
                  id="gradientDirection"
                  class="styled-input visual-editor-control"
                  data-control="gradient.direction"
                >
                  <option value="to right">çº¿æ€§: ä»å·¦åˆ°å³ â†’</option>
                  <option value="to left">çº¿æ€§: ä»å³åˆ°å·¦ â†</option>
                  <option value="to bottom">çº¿æ€§: ä»ä¸Šåˆ°ä¸‹ â†“</option>
                  <option value="to top">çº¿æ€§: ä»ä¸‹åˆ°ä¸Š â†‘</option>
                  <option value="to bottom right">çº¿æ€§: åˆ°å³ä¸‹è§’ â†˜</option>
                  <option value="to bottom left">çº¿æ€§: åˆ°å·¦ä¸‹è§’ â†™</option>
                  <option value="radial-center-out">å¾„å‘: ç”±å†…å‘å¤–</option>
                  <option value="radial-edge-in">å¾„å‘: ç”±å¤–å‘å†…</option>
                </select>
              </div>
              <div class="settings-item">
                <label for="gradientBisection">å¯ç”¨äºŒåˆ†èƒŒæ™¯</label>
                <input
                  type="checkbox"
                  id="gradientBisection"
                  class="visual-editor-control"
                  data-control="gradient.bisection"
                  style="width: 20px; height: 20px"
                />
              </div>
            </div>

            <!-- å›¾ç‰‡æ§ä»¶ -->
            <div id="imageControls" class="control-group" style="display: none">
              <div class="settings-item-column">
                <label>å›¾ç‰‡ URL</label>
                <input
                  type="text"
                  id="imageUrlInput"
                  class="styled-input visual-editor-control"
                  data-control="image.url"
                  placeholder="ç²˜è´´å›¾ç‰‡é“¾æ¥..."
                />
              </div>
              <button id="uploadBgImageBtn" style="padding: 8px 15px; font-size: 13px">ä»æœ¬åœ°ä¸Šä¼ </button>
            </div>
            <!-- â–²â–²â–² èƒŒæ™¯è®¾ç½®ç»“æŸ â–²â–²â–² -->

            <!-- è¾¹æ¡†åœ†è§’ -->
            <strong class="editor-section-title">è¾¹æ¡†</strong>
            <div class="settings-item">
              <label>åœ†è§’åŠå¾„</label>
              <input
                type="range"
                id="bubbleBorderRadius"
                min="0"
                max="50"
                value="18"
                class="visual-editor-control"
                data-control="borderRadius"
                data-unit="px"
              />
              <span id="bubbleBorderRadiusValue" style="width: 30px; text-align: right">18px</span>
            </div>
            <!-- â–¼â–¼â–¼ åœ¨è¿™é‡Œæ’å…¥æ–°çš„æ¯›ç»ç’ƒæ•ˆæœæ§ä»¶ â–¼â–¼â–¼ -->
            <strong class="editor-section-title">æ¯›ç»ç’ƒæ•ˆæœ</strong>
            <div class="settings-item">
              <label for="glassEffectEnabled">å¯ç”¨æ•ˆæœ</label>
              <input
                type="checkbox"
                id="glassEffectEnabled"
                class="visual-editor-control"
                data-control="glass.enabled"
                style="width: 20px; height: 20px"
              />
            </div>
            <!-- â–¼â–¼â–¼ ç”¨è¿™ä¸ªæ–°ç‰ˆæœ¬æ›¿æ¢æ—§çš„ id="glassEffectControls" div â–¼â–¼â–¼ -->
            <div id="glassEffectControls" class="control-group">
              <!-- æ–°å¢ï¼šæ¯›ç»ç’ƒèƒŒæ™¯ç±»å‹é€‰æ‹© -->
              <div class="settings-item-column" style="margin-bottom: 10px">
                <label style="width: auto">èƒŒæ™¯ç±»å‹</label>
                <select id="glassBgTypeSelect" class="styled-input visual-editor-control" data-control="glass.bgType">
                  <option value="solid">çº¯è‰²</option>
                  <option value="gradient">æ¸å˜</option>
                </select>
              </div>

              <!-- æ¯›ç»ç’ƒçº¯è‰²æ§ä»¶ -->
              <div id="glassSolidColorControls">
                <div class="settings-item">
                  <label>å åŠ é¢œè‰²</label>
                  <div class="color-input-group">
                    <input
                      type="color"
                      id="glassEffectColor"
                      class="visual-editor-control"
                      data-control="glass.solid.color"
                    />
                    <input
                      type="text"
                      id="glassEffectColorHex"
                      class="styled-input visual-editor-control"
                      data-control="glass.solid.color"
                      style="width: 100px"
                    />
                  </div>
                </div>
              </div>

              <!-- æ–°å¢ï¼šæ¯›ç»ç’ƒæ¸å˜æ§ä»¶ -->
              <div id="glassGradientControls" style="display: none">
                <div class="settings-item">
                  <label>èµ·å§‹è‰²</label>
                  <div class="color-input-group">
                    <input
                      type="color"
                      id="glassGradientStartColor"
                      class="visual-editor-control"
                      data-control="glass.gradient.start"
                    />
                    <input
                      type="text"
                      id="glassGradientStartColorHex"
                      class="styled-input visual-editor-control"
                      data-control="glass.gradient.start"
                      style="width: 100px"
                    />
                  </div>
                </div>
                <div class="settings-item">
                  <label>ç»“æŸè‰²</label>
                  <div class="color-input-group">
                    <input
                      type="color"
                      id="glassGradientEndColor"
                      class="visual-editor-control"
                      data-control="glass.gradient.end"
                    />
                    <input
                      type="text"
                      id="glassGradientEndColorHex"
                      class="styled-input visual-editor-control"
                      data-control="glass.gradient.end"
                      style="width: 100px"
                    />
                  </div>
                </div>
                <div class="settings-item-column">
                  <label>æ–¹å‘</label>
                  <select
                    id="glassGradientDirection"
                    class="styled-input visual-editor-control"
                    data-control="glass.gradient.direction"
                  >
                    <option value="to right">çº¿æ€§: â†’</option>
                    <option value="to bottom">çº¿æ€§: â†“</option>
                    <option value="to bottom right">çº¿æ€§: â†˜</option>
                    <option value="radial-center-out">å¾„å‘: ç”±å†…å‘å¤–</option>
                  </select>
                </div>
              </div>

              <!-- é€šç”¨æ§ä»¶ -->
              <div class="settings-item">
                <label>ä¸é€æ˜åº¦</label>
                <input
                  type="range"
                  id="glassEffectOpacity"
                  min="0"
                  max="1"
                  step="0.05"
                  value="0.1"
                  class="visual-editor-control"
                  data-control="glass.opacity"
                />
                <span id="glassEffectOpacityValue" style="width: 35px; text-align: right">0.1</span>
              </div>
              <div class="settings-item">
                <label>æ¨¡ç³ŠåŠå¾„</label>
                <input
                  type="range"
                  id="glassEffectBlur"
                  min="0"
                  max="20"
                  value="10"
                  class="visual-editor-control"
                  data-control="glass.blur"
                  data-unit="px"
                />
                <span id="glassEffectBlurValue" style="width: 35px; text-align: right">10px</span>
              </div>
            </div>
            <!-- â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–² -->
            <!-- â–²â–²â–² æ’å…¥ç»“æŸ â–²â–²â–² -->
            <button
              id="generateCssFromVisual"
              style="font-size: 12px; padding: 4px 10px; margin-top: 5px; float: right"
            >
              ç”ŸæˆCSSåˆ°ä»£ç é¡µ
            </button>
          </div>

          <!-- CSSä»£ç ç¼–è¾‘ Tab -->
          <div id="cssEditorTab" class="sticker-tab-content">
            <p style="margin-bottom: 10px; font-size: 12px; color: var(--text-secondary-color)">
              åœ¨æ­¤å¤„ç›´æ¥ç¼–å†™åº”ç”¨äº <code>.message-content</code> çš„ CSSã€‚<b>æ³¨æ„ï¼šæ‰‹åŠ¨ä¿®æ”¹ä¸ä¼šåŒæ­¥å›å¯è§†åŒ–ç¼–è¾‘å™¨ã€‚</b>
            </p>
            <textarea
              id="bubbleCssInput"
              class="styled-input"
              style="height: 120px; resize: vertical; font-family: monospace"
            ></textarea>
          </div>
        </div>

        <!-- é¢„è®¾ç®¡ç†ä¸åº”ç”¨ -->
        <div class="settings-section-divider" style="margin-top: 15px">
          <label>é¢„è®¾ç®¡ç†</label>
        </div>
        <div style="display: flex; gap: 10px; align-items: center; margin-bottom: 15px">
          <select id="bubblePresetSelect" class="styled-input" style="flex-grow: 1">
            <option value="">-- åŠ è½½ä¸€ä¸ªé¢„è®¾ --</option>
          </select>
          <button id="deleteBubblePresetBtn" style="padding: 8px 10px; background-color: #ff3b30; color: white">
            åˆ é™¤
          </button>
        </div>
        <div class="modal-buttons" style="justify-content: flex-start">
          <button id="saveBubbleAsPresetBtn">å¦å­˜ä¸ºæ–°é¢„è®¾</button>
        </div>
        <div class="modal-buttons" style="margin-top: 25px">
          <button id="applyBubbleBtn" class="chat-send-btn api">åº”ç”¨åˆ°å½“å‰è§’è‰²</button>
          <button id="closeBubbleEditorBtn">å…³é—­</button>
        </div>
      </div>
    </div>
    <!-- ================== åˆ†ç»„ç®¡ç†å¼¹çª— (æ–°) ================== -->
    <div id="groupManagementModal" class="modal-overlay" style="display: none">
      <div class="modal-content" style="max-height: 80vh; overflow-y: auto; text-align: left">
        <h3>åˆ†ç»„ç®¡ç†</h3>

        <div class="settings-item-column">
          <label for="newGroupNameInput">æ–°å¢åˆ†ç»„</label>
          <div style="display: flex; gap: 10px">
            <input type="text" id="newGroupNameInput" class="styled-input" placeholder="è¾“å…¥æ–°åˆ†ç»„åç§°" />
            <button id="addNewGroupBtn" style="flex-shrink: 0">æ·»åŠ </button>
          </div>
        </div>

        <div class="settings-section-divider">
          <label>åˆ†ç»„åˆ—è¡¨</label>
        </div>
        <ul id="groupManagementList" class="editable-app-list" style="padding: 0; list-style: none; margin: 0">
          <!-- åˆ†ç»„åˆ—è¡¨å°†ç”±JSåŠ¨æ€ç”Ÿæˆ -->
        </ul>

        <div class="modal-buttons" style="margin-top: 25px">
          <button id="closeGroupManagementBtn">å…³é—­</button>
        </div>
      </div>
    </div>

    <!-- ================== åˆ é™¤åˆ†ç»„ç¡®è®¤å¼¹çª— (æ–°) ================== -->
    <div id="deleteGroupConfirmModal" class="modal-overlay" style="display: none">
      <div class="modal-content">
        <h3 id="deleteGroupConfirmTitle">ç¡®è®¤åˆ é™¤</h3>
        <p id="deleteGroupConfirmText" style="margin-bottom: 20px">è¯·é€‰æ‹©åˆ é™¤æ–¹å¼ï¼š</p>
        <div class="modal-buttons" style="flex-direction: column; gap: 10px">
          <button id="deleteGroupAndCharsBtn">åˆ é™¤åˆ†ç»„å’Œè¯¥åˆ†ç»„ä¸‹æ‰€æœ‰è§’è‰²</button>
          <button id="deleteGroupOnlyBtn">ä»…åˆ é™¤åˆ†ç»„ (è§’è‰²å˜ä¸ºæœªåˆ†ç»„)</button>
          <button id="cancelDeleteGroupBtn" style="margin-top: 10px">å–æ¶ˆ</button>
        </div>
      </div>
    </div>
    <!-- ================== è¡¨æƒ…åˆ†ç±»å¼¹çª— (å…¨æ–°) ================== -->
    <div id="stickerCategoryModal" class="modal-overlay" style="display: none">
      <div class="modal-content" style="text-align: left">
        <h3>é€‰æ‹©åˆ†ç±»</h3>
        <div id="existing-categories-list" class="settings-item-column">
          <!-- å·²æœ‰åˆ†ç±»å°†ç”± JS åŠ¨æ€åŠ è½½ -->
        </div>
        <div class="settings-section-divider">
          <label>æˆ–è€…ï¼Œåˆ›å»ºä¸€ä¸ªæ–°åˆ†ç±»</label>
        </div>
        <div class="settings-item-column">
          <label for="newStickerCategoryName">æ–°åˆ†ç±»å</label>
          <input type="text" id="newStickerCategoryName" class="styled-input" placeholder="è¾“å…¥æ–°åˆ†ç±»çš„åç§°" />
        </div>
        <div class="modal-buttons" style="margin-top: 20px">
          <button id="confirmCategoryBtn">ç¡®å®š</button>
          <button id="cancelCategoryBtn">å–æ¶ˆ</button>
        </div>
      </div>
    </div>
    <!-- ================== åˆ é™¤åˆ†ç±»ç¡®è®¤å¼¹çª— (å…¨æ–°) ================== -->
    <div id="deleteCategoryConfirmModal" class="modal-overlay" style="display: none">
      <div class="modal-content">
        <h3 id="deleteCategoryConfirmTitle">ç¡®è®¤åˆ é™¤</h3>
        <p>è¯·é€‰æ‹©åˆ é™¤æ–¹å¼ï¼š</p>
        <div class="modal-buttons" style="flex-direction: column; gap: 10px">
          <button id="deleteCategoryOnlyBtn">ä»…åˆ é™¤åˆ†ç±» (è¡¨æƒ…ç§»è‡³â€œæœªåˆ†ç±»â€)</button>
          <button id="deleteCategoryAndStickersBtn" style="background-color: #ff3b30; color: white">
            åˆ é™¤åˆ†ç±»å’Œæ‰€æœ‰è¡¨æƒ…
          </button>
          <button id="cancelDeleteCategoryBtn" style="margin-top: 10px">å–æ¶ˆ</button>
        </div>
      </div>
    </div>
    <div id="sendImageChoiceModal" class="modal-overlay" style="display: none">
      <div class="modal-content">
        <h3>å‘é€å›¾ç‰‡</h3>
        <p>è¯·é€‰æ‹©è¦å‘é€çš„å›¾ç‰‡ç±»å‹</p>
        <div class="modal-buttons" style="flex-direction: column; gap: 10px">
          <button id="sendRealImageBtn">å‘é€çœŸå®å›¾ç‰‡</button>
          <button id="sendTextImageBtn">å‘é€æ–‡å­—å›¾</button>
        </div>
        <button id="cancelSendImageChoiceBtn" class="close-btn">&times;</button>
      </div>
    </div>
    <!-- â–¼â–¼â–¼ æŠŠè¿™ä¸ªå…¨æ–°çš„â€œæ–‡å­—å›¾â€å¼¹çª—ä»£ç æ·»åŠ åˆ° </body> ä¹‹å‰ â–¼â–¼â–¼ -->

    <!-- ================== æ–‡å­—å›¾æè¿°è¾“å…¥å¼¹çª— ================== -->
    <div id="textImageModal" class="modal-overlay" style="display: none">
      <div class="modal-content">
        <h3>å‘é€æ–‡å­—å›¾</h3>
        <p style="font-size: 14px; margin-bottom: 15px">è¯·ä¸ºä½ çš„æ–‡å­—å›¾è¾“å…¥ä¸€æ®µæè¿°</p>
        <div class="settings-item-column">
          <textarea
            id="textImageDescriptionInput"
            class="styled-input"
            rows="3"
            placeholder="ä¾‹å¦‚ï¼šä¸€åªçŒ«çŒ«åœ¨æ‰“å“ˆæ¬ ..."
          ></textarea>
        </div>
        <div class="modal-buttons" style="margin-top: 20px">
          <button id="sendTextImageConfirmBtn" class="chat-send-btn api">ç¡®è®¤å‘é€</button>
          <button id="cancelTextImageBtn">å–æ¶ˆ</button>
        </div>
      </div>
    </div>
    <!-- ================== è¯­éŸ³è¾“å…¥å¼¹çª— (æ–°) ================== -->
    <div id="voiceInputModal" class="modal-overlay" style="display: none">
      <div class="modal-content">
        <h3>å‘é€è¯­éŸ³æ¶ˆæ¯</h3>
        <p style="font-size: 14px; margin-bottom: 20px">ğŸ™ï¸ è¯·åœ¨è¿™é‡Œè¾“å…¥ä½ æƒ³é€šè¿‡è¯­éŸ³å‘é€çš„å†…å®¹~</p>
        <div class="settings-item-column">
          <textarea id="voiceInputText" class="styled-input" rows="3" placeholder="è¯´ç‚¹ä»€ä¹ˆå§..."></textarea>
        </div>
        <div class="modal-buttons" style="margin-top: 20px">
          <button id="sendVoiceConfirmBtn" class="chat-send-btn api">ç¡®è®¤å‘é€</button>
          <button id="cancelVoiceInputBtn">å–æ¶ˆ</button>
        </div>
      </div>
    </div>

    <!-- â–²â–²â–² æ·»åŠ ç»“æŸ â–²â–²â–² -->
    <!-- ================== ä¸–ç•Œä¹¦åˆ—è¡¨é¡µé¢ (æ–°) ================== -->
    <div id="worldbook-list-page" class="app-page">
      <div class="app-header">
        <button id="worldbook-list-back-btn" class="back-btn">&lt;</button>
        <span class="header-title">ä¸–ç•Œä¹¦</span>
        <div class="header-actions"></div>
      </div>
      <div id="worldbook-list-container" style="flex-grow: 1; overflow-y: auto">
        <!-- ä¸–ç•Œä¹¦åˆ—è¡¨å°†ç”±JSåŠ¨æ€ç”Ÿæˆ -->
      </div>
      <div class="add-worldbook-btn-container">
        <button id="addNewWorldBookBtn" class="add-worldbook-btn">+ æ–°å»ºä¸–ç•Œä¹¦</button>
      </div>
    </div>

    <!-- ================== ä¸–ç•Œä¹¦è¯¦æƒ…é¡µé¢ (æ–°) ================== -->
    <div id="worldbook-detail-page" class="app-page">
      <div class="app-header">
        <button id="worldbook-detail-back-btn" class="back-btn">&lt;</button>
        <span id="worldbook-detail-title" class="header-title">ä¸–ç•Œä¹¦è¯¦æƒ…</span>
        <div class="header-actions"></div>
      </div>
      <div class="worldbook-entry-list" id="worldbook-entry-list-container">
        <!-- ä¸–ç•Œä¹¦æ¡ç›®å°†ç”±JSåŠ¨æ€ç”Ÿæˆ -->
      </div>
      <div class="add-worldbook-btn-container">
        <button id="addNewEntryBtn" class="add-worldbook-btn">+ æ–°å»ºæ¡ç›®</button>
      </div>
    </div>

    <!-- ================== ç¼–è¾‘/æ–°å»ºä¸–ç•Œä¹¦æ¡ç›®å¼¹çª— (æ–°) ================== -->
    <div id="editWorldBookEntryModal" class="modal-overlay" style="display: none">
      <div class="modal-content" style="max-height: 80vh; overflow-y: auto; text-align: left">
        <h3 id="editWorldBookEntryTitle">æ–°å»ºæ¡ç›®</h3>
        <div class="settings-item-column">
          <label for="entryNameInput">æ¡ç›®åç§°/Comment <span style="color: red">*</span></label>
          <input type="text" id="entryNameInput" class="styled-input" placeholder="ä¾‹å¦‚ï¼šä¸»è§’è®¾å®š" />
        </div>
        <div class="settings-item-column">
          <label for="entryKeysInput">å…³é”®è¯ (Key)</label>
          <input type="text" id="entryKeysInput" class="styled-input" placeholder="å¤šä¸ªå…³é”®è¯ç”¨è‹±æ–‡é€—å· , åˆ†éš”" />
        </div>
        <div class="settings-item-column">
          <label for="entryContentInput">å†…å®¹ (Content)</label>
          <textarea id="entryContentInput" class="styled-input" rows="5" placeholder="è¾“å…¥å…·ä½“çš„è®¾å®šå†…å®¹"></textarea>
        </div>
        <div class="settings-item-column">
          <label for="entryOrderInput">é¡ºåº (Order)</label>
          <input type="number" id="entryOrderInput" class="styled-input" value="100" />
        </div>
        <div class="settings-item-column">
          <label for="entryProbabilityInput">è§¦å‘æ¦‚ç‡ (Probability)</label>
          <input type="number" id="entryProbabilityInput" class="styled-input" value="100" min="0" max="100" />
        </div>
        <div class="modal-buttons" style="margin-top: 20px">
          <button id="saveWorldBookEntryBtn">ä¿å­˜</button>
          <button id="cancelWorldBookEntryBtn">å–æ¶ˆ</button>
        </div>
      </div>
    </div>
    <!-- ================== å…³è”ä¸–ç•Œä¹¦å¼¹çª— (æ–°) ================== -->
    <div id="associateWorldBookModal" class="modal-overlay" style="display: none">
      <div class="modal-content">
        <h3>å…³è”ä¸–ç•Œä¹¦</h3>
        <p style="font-size: 13px; margin-bottom: 15px">è¯·ä¸ºå½“å‰è§’è‰²é€‰æ‹©éœ€è¦å…³è”çš„ä¸–ç•Œä¹¦ï¼š</p>

        <ul id="worldbook-selection-list">
          <!-- ä¸–ç•Œä¹¦é€‰æ‹©åˆ—è¡¨å°†ç”±JSåŠ¨æ€ç”Ÿæˆ -->
        </ul>

        <div class="modal-buttons" style="margin-top: 20px">
          <button id="saveWorldBookAssociationBtn">ä¿å­˜</button>
          <button id="cancelWorldBookAssociationBtn">å–æ¶ˆ</button>
        </div>
      </div>
    </div>
    <!-- â–¼â–¼â–¼ æŠŠè¿™ä¸ªå…¨æ–°çš„è§†é¢‘é€šè¯UIä»£ç æ·»åŠ åˆ° </body> ä¹‹å‰ â–¼â–¼â–¼ -->
    <!-- ================== è§†é¢‘é€šè¯ UI ç•Œé¢ (æ–°) ================== -->
    <div id="video-call-screen" style="display: none">
      <div id="video-call-timer">00:00</div>
      <!-- å¤§å±ç”»é¢ (èƒŒæ™¯) -->
      <div id="video-call-large-view"></div>

      <!-- å°å±ç”»é¢ (æµ®åŠ¨) -->
      <div id="video-call-small-view"></div>

      <!-- å¯¹æ–¹ä¿¡æ¯/å¤´åƒ (æ— å›¾æ¨¡å¼) -->
      <div id="video-call-char-info">
        <img src="" alt="char avatar" />
        <span id="video-call-char-name"></span>
      </div>

      <!-- å¯¹è¯å†…å®¹åŒºåŸŸ -->
      <div id="video-call-dialogue-overlay">
        <!-- å¯¹è¯å†…å®¹ä¼šç”± JS åŠ¨æ€æ·»åŠ  -->
      </div>

      <!-- åº•éƒ¨æ§åˆ¶æ  -->
      <div id="video-call-controls">
        <button id="video-reroll-btn" class="video-control-btn">
          <svg
            xmlns="http://www.w3.org/2000/svg"
            width="24"
            height="24"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
          >
            <polyline points="23 4 23 10 17 10"></polyline>
            <path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"></path>
          </svg>
          <span>é‡Roll</span>
        </button>
        <button id="video-switch-btn" class="video-control-btn">
          <svg
            xmlns="http://www.w3.org/2000/svg"
            width="24"
            height="24"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
          >
            <path
              d="M8 3H5a2 2 0 0 0-2 2v3m18 0V5a2 2 0 0 0-2-2h-3m0 18h3a2 2 0 0 0 2-2v-3M3 16v3a2 2 0 0 0 2 2h3"
            ></path>
          </svg>
          <span>åˆ‡å±</span>
        </button>
        <button id="video-chat-btn" class="video-control-btn">
          <svg
            xmlns="http://www.w3.org/2000/svg"
            width="24"
            height="24"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
          >
            <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
          </svg>
          <span>èŠå¤©</span>
        </button>
        <button id="video-hangup-btn" class="video-control-btn hangup">
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
            <path
              d="M13.29 12l4.35-4.35a.996.996 0 1 0-1.41-1.41L11.88 10.59 7.53 6.24a.996.996 0 1 0-1.41 1.41L10.47 12l-4.35 4.35a.996.996 0 1 0 1.41 1.41L11.88 13.41l4.35 4.35a.996.996 0 1 0 1.41-1.41L13.29 12z"
            ></path>
          </svg>
          <span>æŒ‚æ–­</span>
        </button>
      </div>
    </div>
    <!-- â–¼â–¼â–¼ ç”¨è¿™ä¸ªæ–°ç‰ˆæœ¬æ›¿æ¢æ—§çš„ id="video-call-invite-modal" â–¼â–¼â–¼ -->
    <!-- ================== è§†é¢‘é€šè¯å‘¼å«/æ¥ç”µå¼¹çª— (ä¿®æ­£ç‰ˆ) ================== -->
    <div id="video-call-invite-modal" class="modal-overlay" style="display: none">
      <div class="modal-content">
        <!-- è§’è‰²ä¿¡æ¯åŒºåŸŸ (é€šç”¨) -->
        <div
          id="video-call-char-info-waiting"
          style="display: flex; flex-direction: column; align-items: center; gap: 15px; margin-bottom: 20px"
        >
          <img
            id="waiting-char-avatar"
            src=""
            alt="char avatar"
            style="width: 80px; height: 80px; border-radius: 50%; border: 2px solid rgba(255, 255, 255, 0.2)"
          />
          <span id="waiting-char-name" style="color: var(--text-color); font-size: 18px; font-weight: bold"></span>
        </div>

        <!-- çŠ¶æ€æ–‡æœ¬ (é€šç”¨) -->
        <p id="video-call-invite-text" style="margin-bottom: 20px">...</p>

        <!-- ã€æ¥ç”µæŒ‰é’®ç»„ã€‘ (é»˜è®¤éšè—) -->
        <div id="incoming-call-buttons" class="modal-buttons" style="display: none">
          <button id="accept-video-call-btn" style="background-color: #30d158; color: white">æ¥å¬</button>
          <button id="reject-video-call-btn" style="background-color: #ff3b30; color: white">æ‹’ç»</button>
        </div>

        <!-- ã€å‘¼å‡ºæŒ‰é’®ç»„ã€‘ -->
        <div id="outgoing-call-button" class="modal-buttons">
          <button id="cancel-video-call-btn" style="margin-top: 15px; width: 100%">æŒ‚æ–­</button>
        </div>
      </div>
    </div>

    <!-- ================== è§†é¢‘é€šè¯è®°å½•åˆ—è¡¨å¼¹çª— (æ–°) ================== -->
    <div id="videoCallHistoryModal" class="modal-overlay" style="display: none">
      <div class="modal-content" style="text-align: left">
        <h3>é€šè¯è®°å½•</h3>
        <div id="call-history-list" style="max-height: 60vh; overflow-y: auto">
          <!-- é€šè¯è®°å½•åˆ—è¡¨ä¼šç”±JSåŠ¨æ€ç”Ÿæˆåœ¨è¿™é‡Œ -->
        </div>
        <div class="modal-buttons" style="margin-top: 20px">
          <button id="closeCallHistoryBtn">å…³é—­</button>
        </div>
      </div>
    </div>

    <!-- ================== å•æ¬¡é€šè¯å†…å®¹æŸ¥çœ‹å¼¹çª— (æ–°) ================== -->
    <div id="callTranscriptModal" class="modal-overlay" style="display: none">
      <div class="modal-content" style="text-align: left; max-height: 80vh; display: flex; flex-direction: column">
        <h3 id="transcript-modal-title">é€šè¯è¯¦æƒ…</h3>
        <div
          id="transcript-modal-content"
          style="
            flex-grow: 1;
            overflow-y: auto;
            background-color: rgba(0, 0, 0, 0.2);
            border-radius: 10px;
            padding: 15px;
            font-size: 14px;
            line-height: 1.6;
          "
        >
          <!-- å•æ¬¡é€šè¯çš„è¯¦ç»†å†…å®¹ä¼šç”±JSåŠ¨æ€ç”Ÿæˆåœ¨è¿™é‡Œ -->
        </div>
        <div class="modal-buttons" style="margin-top: 20px">
          <button id="closeTranscriptBtn">å…³é—­</button>
        </div>
      </div>
    </div>
    <!-- â–¼â–¼â–¼ ç”¨è¿™ä¸ªæ–°ç‰ˆæœ¬æ›¿æ¢æ—§çš„ id="video-call-invite-modal" â–¼â–¼â–¼ -->
    <!-- ================== è§†é¢‘é€šè¯å‘¼å«/æ¥ç”µå¼¹çª— (æ–°ç‰ˆæœ¬) ================== -->
    <div id="video-call-invite-modal" class="modal-overlay" style="display: none">
      <div class="modal-content">
        <!-- è§’è‰²ä¿¡æ¯åŒºåŸŸ (é€šç”¨) -->
        <div
          id="video-call-char-info-waiting"
          style="display: flex; flex-direction: column; align-items: center; gap: 15px; margin-bottom: 20px"
        >
          <img
            id="waiting-char-avatar"
            src=""
            alt="char avatar"
            style="width: 80px; height: 80px; border-radius: 50%; border: 2px solid rgba(255, 255, 255, 0.2)"
          />
          <span id="waiting-char-name" style="color: var(--text-color); font-size: 18px; font-weight: bold"></span>
        </div>

        <!-- çŠ¶æ€æ–‡æœ¬ (é€šç”¨) -->
        <p id="video-call-invite-text" style="margin-bottom: 20px">...</p>

        <!-- ã€æ–°å¢ã€‘æ¥ç”µæŒ‰é’®ç»„ (é»˜è®¤éšè—) -->
        <div id="incoming-call-buttons" class="modal-buttons" style="display: none">
          <button id="accept-video-call-btn" style="background-color: #30d158; color: white">æ¥å¬</button>
          <button id="reject-video-call-btn" style="background-color: #ff3b30; color: white">æ‹’ç»</button>
        </div>

        <!-- ã€ä¿®æ”¹ã€‘å‘¼å‡ºæŒ‰é’® (ç°åœ¨åœ¨ä¸€ä¸ª div é‡Œ) -->
        <div id="outgoing-call-button" class="modal-buttons">
          <button id="cancel-video-call-btn" style="margin-top: 15px; width: 100%">æŒ‚æ–­</button>
        </div>
      </div>
    </div>
    <!-- ================== äº¤æ˜“è®°å½•å¼¹çª— (æ–°) ================== -->
    <div id="transactionLogModal" class="modal-overlay" style="display: none">
      <div class="modal-content" style="text-align: left">
        <h3>ä½™é¢å˜åŠ¨è®°å½•</h3>
        <ul id="transaction-log-list">
          <!-- è®°å½•å°†ç”± JS åŠ¨æ€ç”Ÿæˆåœ¨è¿™é‡Œ -->
        </ul>
        <div class="modal-buttons" style="margin-top: 20px">
          <button id="closeTransactionLogBtn">å…³é—­</button>
        </div>
      </div>
    </div>
    <!-- â–²â–²â–² æ·»åŠ ç»“æŸ â–²â–²â–² -->
    <!-- ================== ç”¨æˆ·äº¤æ˜“è®°å½•å¼¹çª— (æ–°) ================== -->
    <div id="userTransactionLogModal" class="modal-overlay" style="display: none">
      <div class="modal-content" style="text-align: left">
        <h3>æˆ‘çš„ä½™é¢å˜åŠ¨è®°å½•</h3>
        <ul id="user-transaction-log-list">
          <!-- è®°å½•å°†ç”± JS åŠ¨æ€ç”Ÿæˆåœ¨è¿™é‡Œ -->
        </ul>
        <div class="modal-buttons" style="margin-top: 20px">
          <button id="closeUserTransactionLogBtn">å…³é—­</button>
        </div>
      </div>
    </div>
    <!-- ================== è½¬è´¦è¾“å…¥å¼¹çª— (æ–°) ================== -->
    <div id="transferModal" class="modal-overlay" style="display: none">
      <div class="modal-content" style="text-align: left">
        <h3>å‘èµ·è½¬è´¦</h3>
        <p style="font-size: 14px; margin-bottom: 20px">
          å‘ <span id="transferRecipientName" style="font-weight: bold; color: var(--accent-color)"></span> è½¬è´¦
        </p>
        <div class="settings-item-column">
          <label for="transferAmountInput">è½¬è´¦é‡‘é¢ (Â¥)</label>
          <input type="number" id="transferAmountInput" class="styled-input" placeholder="0.00" />
        </div>
        <div class="settings-item-column">
          <label for="transferRemarkInput">è½¬è´¦å¤‡æ³¨ (å¯é€‰)</label>
          <input type="text" id="transferRemarkInput" class="styled-input" placeholder="æ­å–œå‘è´¢~" />
        </div>
        <div class="modal-buttons" style="margin-top: 20px">
          <button id="confirmTransferBtn" class="chat-send-btn api">ç¡®è®¤è½¬è´¦</button>
          <button id="cancelTransferBtn">å–æ¶ˆ</button>
        </div>
      </div>
    </div>

    <!-- ================== è½¬è´¦çŠ¶æ€è¯¦æƒ…å¼¹çª— (æ–°) ================== -->
    <div id="transferStatusModal" class="modal-overlay" style="display: none">
      <div class="modal-content" style="text-align: left">
        <h3 id="transferStatusTitle">è½¬è´¦è¯¦æƒ…</h3>
        <ul id="transfer-status-list" style="list-style: none; padding: 10px 0; color: var(--text-secondary-color)">
          <!-- è¯¦æƒ…å°†ç”± JS åŠ¨æ€ç”Ÿæˆ -->
        </ul>
        <div class="modal-buttons" style="margin-top: 20px">
          <button id="closeTransferStatusBtn">å…³é—­</button>
        </div>
      </div>
    </div>
    <!-- â–²â–²â–² æ·»åŠ ç»“æŸ â–²â–²â–² -->
    <!-- ================== ç¤¼ç‰©å•†åº—é¡µé¢ (æ–°) ================== -->
    <div id="gift-shop-page" class="app-page">
      <div class="app-header">
        <button id="gift-shop-back-btn" class="back-btn">&lt;</button>
        <span class="header-title">ç¤¼ç‰©å•†åº—</span>
        <div class="header-actions">
          <button
            id="open-cart-btn"
            style="background: none; border: none; color: white; position: relative; cursor: pointer"
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              width="24"
              height="24"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
            >
              <circle cx="9" cy="21" r="1"></circle>
              <circle cx="20" cy="21" r="1"></circle>
              <path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"></path>
            </svg>
            <span
              id="cart-item-count"
              style="
                position: absolute;
                top: -5px;
                right: -8px;
                background-color: red;
                color: white;
                border-radius: 50%;
                width: 18px;
                height: 18px;
                font-size: 11px;
                display: flex;
                align-items: center;
                justify-content: center;
                font-weight: bold;
              "
              >0</span
            >
          </button>
        </div>
      </div>
      <div class="gift-shop-controls" style="padding: 15px; display: flex; gap: 10px; flex-shrink: 0">
        <button id="ai-generate-gifts-btn" class="chat-send-btn api" style="flex: 1">AI ç”Ÿæˆç¤¼ç‰©</button>
        <button id="ai-search-gifts-btn" class="chat-send-btn" style="flex: 1">AI æœç´¢ç¤¼ç‰©</button>
      </div>
      <div id="gift-list-container" style="flex-grow: 1; overflow-y: auto; padding: 0 15px 15px 15px">
        <!-- ç¤¼ç‰©åˆ—è¡¨å°†ç”±JSåŠ¨æ€ç”Ÿæˆ -->
      </div>
    </div>

    <!-- ================== è´­ç‰©è½¦å¼¹çª— (æ–°) ================== -->
    <div id="shopping-cart-modal" class="modal-overlay" style="display: none">
      <div class="modal-content" style="text-align: left; max-height: 80vh; display: flex; flex-direction: column">
        <h3>æˆ‘çš„è´­ç‰©è½¦</h3>
        <ul id="cart-items-list" style="list-style: none; padding: 0; margin: 0; flex-grow: 1; overflow-y: auto">
          <!-- è´­ç‰©è½¦é¡¹ç›®å°†ç”±JSåŠ¨æ€ç”Ÿæˆ -->
        </ul>
        <div class="settings-section-divider" style="margin-top: auto">
          <div style="display: flex; justify-content: space-between; align-items: center; font-size: 16px">
            <span>æ€»è®¡:</span>
            <span id="cart-total-price" style="font-weight: bold; color: var(--accent-color)">Â¥ 0.00</span>
          </div>
        </div>
        <div class="modal-buttons" style="margin-top: 20px">
          <button id="checkout-btn" class="chat-send-btn api">ç»“ç®—é€å‡º</button>
          <button id="close-cart-btn">å…³é—­</button>
        </div>
      </div>
    </div>
    <!-- ================== ğŸ® å­—ä½“æ¸¸æˆæœº (æœ€ç»ˆèŒåŒ–ç‰ˆ) ğŸ® ================== -->
    <div id="fontManagerModal" class="modal-overlay" style="display: none">
      <div class="modal-content">
        <!-- å¤´éƒ¨ -->
        <div class="cute-header">
          <!-- åˆ æ‰äº† span æ ‡ç­¾ï¼Œç°åœ¨çš„è£…é¥°ç”± CSS çš„ ::before ç”Ÿæˆ -->
          <h3>å­—ä½“å°å±‹</h3>
          <button id="closeFontManagerBtn" class="cute-close-btn">Ã—</button>
        </div>

        <!-- å¯¼èˆª Tabs -->
        <div class="cute-tabs" id="fontManagerTabs">
          <button class="cute-tab-btn active" data-tab="library">Library</button>
          <button class="cute-tab-btn" data-tab="add-one">+ New</button>
          <button class="cute-tab-btn" data-tab="add-batch">Batch</button>
        </div>

        <!-- Tab 1: å­—ä½“åº“åˆ—è¡¨ -->
        <div id="tab-library" class="cute-tab-content active">
          <!-- â–¼â–¼â–¼ æ–°å¢ï¼šå­—ä½“å¤§å°è°ƒèŠ‚åŒºåŸŸ â–¼â–¼â–¼ -->
          <div class="cute-range-container">
            <div class="cute-range-header">
              <span>SIZE ADJUST (å­—ä½“å¤§å°)</span>
              <span id="fontSizeValueDisplay" style="color: #a0c4ff">+0px</span>
            </div>
            <!-- èŒƒå›´ä» -2 åˆ° 8ï¼Œæ­¥é•¿ä¸º 1 -->
            <input type="range" id="fontSizeSlider" class="cute-range" min="-2" max="8" step="1" value="0" />
          </div>
          <!-- â–²â–²â–² æ–°å¢ç»“æŸ â–²â–²â–² -->

          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px">
            <span style="font-size: 11px; color: #aaa; font-weight: bold">â— å·²ä¿å­˜çš„å­—ä½“</span>
            <button
              id="resetFontBtn"
              style="
                border: none;
                background: none;
                color: #a0c4ff;
                font-size: 11px;
                cursor: pointer;
                font-weight: bold;
              "
            >
              [ â†º Reset ]
            </button>
          </div>
          <div id="fontListContainer" class="font-list-container">
            <!-- åˆ—è¡¨ç”± JS ç”Ÿæˆ -->
          </div>
        </div>

        <!-- Tab 2: æ·»åŠ å•ä¸ª -->
        <div id="tab-add-one" class="cute-tab-content">
          <div class="cute-input-group">
            <label class="cute-label">NAME ğŸ·ï¸</label>
            <input type="text" id="newFontName" class="cute-input" placeholder="å–ä¸ªåå­—å§à²£" />
          </div>
          <div class="cute-input-group">
            <label class="cute-label">URL ğŸ”—</label>
            <input type="text" id="newFontUrl" class="cute-input" placeholder="http://..." />
          </div>
          <button id="addNewFontBtn" class="cute-btn-primary">START IMPORT !</button>
        </div>

        <!-- Tab 3: æ‰¹é‡å¯¼å…¥ -->
        <div id="tab-add-batch" class="cute-tab-content">
          <div class="batch-tip">
            -> á´— <- æ ¼å¼æç¤ºï¼š<br />
            <code>Name : URL</code>
          </div>
          <textarea
            id="batchFontInput"
            class="cute-textarea"
            placeholder="åå­— : http://...&#10;åå­— : http://..."
          ></textarea>
          <button id="batchAddFontBtn" class="cute-btn-primary">RUN BATCH >></button>
        </div>
      </div>
    </div>
  </body>
</html>
